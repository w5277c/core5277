
AVRASM ver. 2.2.8  C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm Wed Jan 04 10:09:59 2023

C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(10): Including file 'C:\repos\w5277c\core5277\./devices/atmega328.inc'
C:\repos\w5277c\core5277\./devices/atmega328.inc(40): Including file 'C:\repos\w5277c\core5277\/devices/_common.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(32): Including file 'C:\repos\w5277c\core5277\./core/core5277.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(247): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy.inc'
C:\repos\w5277c\core5277\./mem/ram_copy.inc(19): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy16.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(248): Including file 'C:\repos\w5277c\core5277\./mem/ram_fill16.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(250): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy_desc.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(251): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy16_desc.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(253): Including file 'C:\repos\w5277c\core5277\./conv/bitnum_to_num.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(255): Including file 'C:\repos\w5277c\core5277\./core/ui/input.inc'
C:\repos\w5277c\core5277\./core/ui/input.inc(29): Including file 'C:\repos\w5277c\core5277\./core/wait.inc'
C:\repos\w5277c\core5277\./core/wait.inc(16): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(281): Including file 'C:\repos\w5277c\core5277\./core/io/out_init.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(282): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_romstr.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/io/out_str.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(283): Including file 'C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_taskdump.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_byte.inc(13): Including file 'C:\repos\w5277c\core5277\./conv/byte_to_hex.inc'
C:\repos\w5277c\core5277\./core/io/out_byte.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_word.inc'
C:\repos\w5277c\core5277\./core/io/out_word.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(17): Including file 'C:\repos\w5277c\core5277\./core/io/out_cr.inc'
C:\repos\w5277c\core5277\./core/io/out_cr.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(18): Including file 'C:\repos\w5277c\core5277\./core/io/out_stackdump.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_word.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_bytes.inc'
C:\repos\w5277c\core5277\./core/io/out_bytes.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(17): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(18): Including file 'C:\repos\w5277c\core5277\./core/io/outstr_done.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(284): Including file 'C:\repos\w5277c\core5277\./core/io/out_corefault.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_word.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(297): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(35): Including file 'C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(16): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_offset.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(17): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc'
C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc(17): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc(13): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_used_block_mt.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc(14): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_check_stack.inc'
C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc(18): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc(13): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_used_block_mt.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc(14): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_used_block_lt.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc(15): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(18): Including file 'C:\repos\w5277c\core5277\./core/wait_1s.inc'
C:\repos\w5277c\core5277\./core/wait_1s.inc(16): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_mode_in.inc'
C:\repos\w5277c\core5277\./io/port_mode_in.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./io/port_offsets.inc(17): Including file 'C:\repos\w5277c\core5277\./conv/bitnum_to_num.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(20): Including file 'C:\repos\w5277c\core5277\./io/port_mode_out.inc'
C:\repos\w5277c\core5277\./io/port_mode_out.inc(18): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(21): Including file 'C:\repos\w5277c\core5277\./io/port_set_lo.inc'
C:\repos\w5277c\core5277\./io/port_set_lo.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(22): Including file 'C:\repos\w5277c\core5277\./io/port_set_hi.inc'
C:\repos\w5277c\core5277\./io/port_set_hi.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(23): Including file 'C:\repos\w5277c\core5277\./io/port_set.inc'
C:\repos\w5277c\core5277\./io/port_set.inc(17): Including file 'C:\repos\w5277c\core5277\./io/port_set_hi.inc'
C:\repos\w5277c\core5277\./io/port_set.inc(18): Including file 'C:\repos\w5277c\core5277\./io/port_set_lo.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(37): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_ocr.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_ocr.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r3r7.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(38): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_str_el.inc'
C:\repos\w5277c\core5277\./core/io/out_str_el.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_cr.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(39): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_csd.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_csd.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r1.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_csd.inc(11): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(10): Including file 'C:\repos\w5277c\core5277\./core/time32_mark.inc'
C:\repos\w5277c\core5277\./core/time32_mark.inc(15): Including file 'C:\repos\w5277c\core5277\./core/uptime_copy.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(11): Including file 'C:\repos\w5277c\core5277\./core/time32_delta.inc'
C:\repos\w5277c\core5277\./core/time32_delta.inc(15): Including file 'C:\repos\w5277c\core5277\./core/time32_mark.inc'
C:\repos\w5277c\core5277\./core/time32_delta.inc(16): Including file 'C:\repos\w5277c\core5277\./math/mul32x16.inc'
C:\repos\w5277c\core5277\./math/mul32x16.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/time32_delta.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul16x8.inc'
C:\repos\w5277c\core5277\./math/mul16x8.inc(18): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(12): Including file 'C:\repos\w5277c\core5277\./conv/crc16_xmodem.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(13): Including file 'C:\repos\w5277c\core5277\./conv/crc16_block.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_num32.inc'
C:\repos\w5277c\core5277\./core/io/out_num32.inc(13): Including file 'C:\repos\w5277c\core5277\./math/div32x16.inc'
C:\repos\w5277c\core5277\./core/io/out_num32.inc(14): Including file 'C:\repos\w5277c\core5277\./math/mul32x16.inc'
C:\repos\w5277c\core5277\./core/io/out_num32.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_num16.inc'
C:\repos\w5277c\core5277\./core/io/out_num16.inc(12): Including file 'C:\repos\w5277c\core5277\./math/div16x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num16.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_num.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(16): Including file 'C:\repos\w5277c\core5277\./math/div16x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(17): Including file 'C:\repos\w5277c\core5277\./math/div10.inc'
C:\repos\w5277c\core5277\./math/div10.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(18): Including file 'C:\repos\w5277c\core5277\./math/mul10.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(19): Including file 'C:\repos\w5277c\core5277\./math/mul100.inc'
C:\repos\w5277c\core5277\./math/mul100.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(20): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_cr.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(17): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(18): Including file 'C:\repos\w5277c\core5277\./core/io/out_str_el.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(19): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(20): Including file 'C:\repos\w5277c\core5277\./core/io/out_strn.inc'
C:\repos\w5277c\core5277\./core/io/out_strn.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(21): Including file 'C:\repos\w5277c\core5277\./core/io/out_bytes.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(42): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(17): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_offset.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(18): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(19): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_reset.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_reset.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r1.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(20): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_status.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_status.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r2.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(21): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r1.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(22): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r3r7.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(23): Including file 'C:\repos\w5277c\core5277\./core/time32_mark.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(24): Including file 'C:\repos\w5277c\core5277\./core/time32_delta.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(25): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(26): Including file 'C:\repos\w5277c\core5277\./conv/crc7_730.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(27): Including file 'C:\repos\w5277c\core5277\./conv/crc8_block.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(47): Including file 'C:\repos\w5277c\core5277\./io/port_mode_out.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(48): Including file 'C:\repos\w5277c\core5277\./io/port_set_hi.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(49): Including file 'C:\repos\w5277c\core5277\./io/port_set_lo.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(10): Including file 'C:\repos\w5277c\core5277\./devices/atmega328.inc'
C:\repos\w5277c\core5277\./devices/atmega328.inc(40): Including file 'C:\repos\w5277c\core5277\/devices/_common.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(32): Including file 'C:\repos\w5277c\core5277\./core/core5277.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(247): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy.inc'
C:\repos\w5277c\core5277\./mem/ram_copy.inc(19): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy16.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(248): Including file 'C:\repos\w5277c\core5277\./mem/ram_fill16.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(250): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy_desc.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(251): Including file 'C:\repos\w5277c\core5277\./mem/ram_copy16_desc.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(253): Including file 'C:\repos\w5277c\core5277\./conv/bitnum_to_num.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(255): Including file 'C:\repos\w5277c\core5277\./core/ui/input.inc'
C:\repos\w5277c\core5277\./core/ui/input.inc(29): Including file 'C:\repos\w5277c\core5277\./core/wait.inc'
C:\repos\w5277c\core5277\./core/wait.inc(16): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(281): Including file 'C:\repos\w5277c\core5277\./core/io/out_init.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(282): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_romstr.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/io/out_str.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(283): Including file 'C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_taskdump.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_byte.inc(13): Including file 'C:\repos\w5277c\core5277\./conv/byte_to_hex.inc'
C:\repos\w5277c\core5277\./core/io/out_byte.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_word.inc'
C:\repos\w5277c\core5277\./core/io/out_word.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(17): Including file 'C:\repos\w5277c\core5277\./core/io/out_cr.inc'
C:\repos\w5277c\core5277\./core/io/out_cr.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_taskdump.inc(18): Including file 'C:\repos\w5277c\core5277\./core/io/out_stackdump.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_word.inc'
C:\repos\w5277c\core5277\./core/io/out_stackdump.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_bytes.inc'
C:\repos\w5277c\core5277\./core/io/out_bytes.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(17): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/io/out_tasksdump.inc(18): Including file 'C:\repos\w5277c\core5277\./core/io/outstr_done.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(284): Including file 'C:\repos\w5277c\core5277\./core/io/out_corefault.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_word.inc'
C:\repos\w5277c\core5277\./core/io/out_corefault.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_romstr.inc'
C:\repos\w5277c\core5277\./core/core5277.inc(297): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(35): Including file 'C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(16): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_offset.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(17): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc'
C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc(17): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc(13): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_used_block_mt.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc(14): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_check_stack.inc'
C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc(18): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc(13): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_used_block_mt.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc(14): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_used_block_lt.inc'
C:\repos\w5277c\core5277\./core/ram/_ram_resize.inc(15): Including file 'C:\repos\w5277c\core5277\./core/ram/_ram_find_free_block.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(18): Including file 'C:\repos\w5277c\core5277\./core/wait_1s.inc'
C:\repos\w5277c\core5277\./core/wait_1s.inc(16): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_mode_in.inc'
C:\repos\w5277c\core5277\./io/port_mode_in.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./io/port_offsets.inc(17): Including file 'C:\repos\w5277c\core5277\./conv/bitnum_to_num.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(20): Including file 'C:\repos\w5277c\core5277\./io/port_mode_out.inc'
C:\repos\w5277c\core5277\./io/port_mode_out.inc(18): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(21): Including file 'C:\repos\w5277c\core5277\./io/port_set_lo.inc'
C:\repos\w5277c\core5277\./io/port_set_lo.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(22): Including file 'C:\repos\w5277c\core5277\./io/port_set_hi.inc'
C:\repos\w5277c\core5277\./io/port_set_hi.inc(19): Including file 'C:\repos\w5277c\core5277\./io/port_offsets.inc'
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(23): Including file 'C:\repos\w5277c\core5277\./io/port_set.inc'
C:\repos\w5277c\core5277\./io/port_set.inc(17): Including file 'C:\repos\w5277c\core5277\./io/port_set_hi.inc'
C:\repos\w5277c\core5277\./io/port_set.inc(18): Including file 'C:\repos\w5277c\core5277\./io/port_set_lo.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(37): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_ocr.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_ocr.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r3r7.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(38): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_str_el.inc'
C:\repos\w5277c\core5277\./core/io/out_str_el.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_cr.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(39): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_csd.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_csd.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r1.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_csd.inc(11): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(10): Including file 'C:\repos\w5277c\core5277\./core/time32_mark.inc'
C:\repos\w5277c\core5277\./core/time32_mark.inc(15): Including file 'C:\repos\w5277c\core5277\./core/uptime_copy.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(11): Including file 'C:\repos\w5277c\core5277\./core/time32_delta.inc'
C:\repos\w5277c\core5277\./core/time32_delta.inc(15): Including file 'C:\repos\w5277c\core5277\./core/time32_mark.inc'
C:\repos\w5277c\core5277\./core/time32_delta.inc(16): Including file 'C:\repos\w5277c\core5277\./math/mul32x16.inc'
C:\repos\w5277c\core5277\./math/mul32x16.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/time32_delta.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul16x8.inc'
C:\repos\w5277c\core5277\./math/mul16x8.inc(18): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(12): Including file 'C:\repos\w5277c\core5277\./conv/crc16_xmodem.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_block.inc(13): Including file 'C:\repos\w5277c\core5277\./conv/crc16_block.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_byte.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_num32.inc'
C:\repos\w5277c\core5277\./core/io/out_num32.inc(13): Including file 'C:\repos\w5277c\core5277\./math/div32x16.inc'
C:\repos\w5277c\core5277\./core/io/out_num32.inc(14): Including file 'C:\repos\w5277c\core5277\./math/mul32x16.inc'
C:\repos\w5277c\core5277\./core/io/out_num32.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(14): Including file 'C:\repos\w5277c\core5277\./core/io/out_num16.inc'
C:\repos\w5277c\core5277\./core/io/out_num16.inc(12): Including file 'C:\repos\w5277c\core5277\./math/div16x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num16.inc(13): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(15): Including file 'C:\repos\w5277c\core5277\./core/io/out_num.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(16): Including file 'C:\repos\w5277c\core5277\./math/div16x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(17): Including file 'C:\repos\w5277c\core5277\./math/div10.inc'
C:\repos\w5277c\core5277\./math/div10.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(18): Including file 'C:\repos\w5277c\core5277\./math/mul10.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(19): Including file 'C:\repos\w5277c\core5277\./math/mul100.inc'
C:\repos\w5277c\core5277\./math/mul100.inc(17): Including file 'C:\repos\w5277c\core5277\./math/mul8x8.inc'
C:\repos\w5277c\core5277\./core/io/out_num.inc(20): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(16): Including file 'C:\repos\w5277c\core5277\./core/io/out_cr.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(17): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(18): Including file 'C:\repos\w5277c\core5277\./core/io/out_str_el.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(19): Including file 'C:\repos\w5277c\core5277\./core/io/out_str.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(20): Including file 'C:\repos\w5277c\core5277\./core/io/out_strn.inc'
C:\repos\w5277c\core5277\./core/io/out_strn.inc(12): Including file 'C:\repos\w5277c\core5277\./core/io/out_char.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(21): Including file 'C:\repos\w5277c\core5277\./core/io/out_bytes.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(42): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(17): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_offset.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(18): Including file 'C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(19): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_reset.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_reset.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r1.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(20): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_status.inc'
C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_status.inc(10): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r2.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(21): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r1.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(22): Including file 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_get_r3r7.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(23): Including file 'C:\repos\w5277c\core5277\./core/time32_mark.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(24): Including file 'C:\repos\w5277c\core5277\./core/time32_delta.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(25): Including file 'C:\repos\w5277c\core5277\./core/wait_2ms.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(26): Including file 'C:\repos\w5277c\core5277\./conv/crc7_730.inc'
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(27): Including file 'C:\repos\w5277c\core5277\./conv/crc8_block.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(47): Including file 'C:\repos\w5277c\core5277\./io/port_mode_out.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(48): Including file 'C:\repos\w5277c\core5277\./io/port_set_hi.inc'
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(49): Including file 'C:\repos\w5277c\core5277\./io/port_set_lo.inc'
                                 
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;20.11.2022	konstantin@5277.ru		Первая версия
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 	.EQU	FW_VERSION										= 1	;0-255
                                 	.SET	CORE_FREQ										= 16	;2-20Mhz
                                 	.SET	REPORT_INCLUDES								= 1	;0-1
                                 	;---подключаем библиотеку устройства---
                                 	.INCLUDE "./devices/atmega328.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;02.05.2020	w5277c@gmail.com			Начало
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;19.01.2021	w5277c@gmail.com			Обновлен блок EEPROM
                                 ;21.01.2021	w5277c@gmail.com			Добавлены порты для инструкций SBI,CBI...
                                 ;05.06.2021	w5277c@gmail.com			Добавлены регистры SPI
                                 ;29.01.2022	w5277c@gmail.com			C5_RES_QUEUE_SIZE задается в ядре на основе _C5_TASKS_MAX_QNT
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 ;---DESCRIPTION------------------------------------------
                                 ;core5277 for ATMega328 (32Kb ROM, 1Kb EEPROM, 2Kb SRAM) at 16MHz (LITTLE ENDIAN)
                                 ;avrdude -p m328 -c avrispmkII -U flash:w:main.hex
                                 ;Ext crystal 8.0-..., 1K CK/14 CK + 4.1ms, CKDIV8 disabled, BOD 4.3V, SPI enabled:
                                 ;avrdude -p m328p -c avrispmkII -U lfuse:w:0xdf:m -U hfuse:w:0xd9:m -U efuse:w:0xff:m
                                 
                                 	;---SPECIFY-DEVICE---
                                 	.DEVICE ATmega328P
                                 
                                 	.equ	FLASHEND	= 0x3fff	; Note: Word address
                                 	.equ	IOEND	= 0x00ff
                                 	.equ	SRAM_START	= 0x0100
                                 	.equ	SRAM_SIZE	= 2048
                                 	.equ	XRAMEND	= 0x0000
                                 	.equ	E2END	= 0x03ff
                                 	.equ	EEPROMEND	= 0x03ff
                                 	.equ	EEADRBITS	= 10
                                 
                                 	#pragma AVRPART MEMORY PROG_FLASH 32768
                                 	#pragma AVRPART MEMORY INT_SRAM SIZE 2048
                                 	#pragma AVRPART MEMORY INT_SRAM START_ADDR 0x100
                                 	#pragma AVRPART MEMORY EEPROM 1024
                                 
                                 	.EQU	BOOT_512W_ADDR							= 0x3e00			;Начальный адрес килобайтного бутлоадера в словах
                                 	.EQU	FLASH_PAGESIZE							= 0x0080			;128 байт - размер страницы FLASH
                                 	.EQU	EEPROM_SIZE								= 0x0400			;1K
                                 	.EQU	FLASH_SIZE								= 0x8000			;32K
                                 
                                 	.include "/devices/_common.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;26.10.2020	w5277c@gmail.com			Начало
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;21.01.2020	w5277c@gmail.com			Вынесен блок определений пинов для процедур PORT_...
                                 ;29.05.2021	w5277c@gmail.com			Ввод параметров TS_MODE и MUL_SUPPORT
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DEVICES_COMMON
                                 .else
                                 .set DEF_DEVICES_COMMON = 1
                                 
                                 	.EQU	ATTINY25									= 0x00
                                 	.EQU	ATMEGA8									= 0x01
                                 	.EQU	ATMEGA16									= 0x02
                                 	.EQU	ATMEGA48									= 0x03
                                 	.EQU	ATTINY13A								= 0x04
                                 
                                 ;---TASK-SWITCHING-MODES---------------------------------;Режимы работы ядра
                                 	.EQU	TS_MODE_NO								= 0xff			;Простое переключение, механизмы ядра для переключения задач отсутствуют
                                 	.EQU	TS_MODE_EVENT							= 0x00			;Кооперативная
                                 	.EQU	TS_MODE_TIME							= 0x01			;Вытесняющая многозадачность
                                 ;---LOGGING----------------------------------------------;Параметры логирования
                                 	.EQU	LOGGING_LVL_DIS						= 0x00
                                 	.EQU	LOGGING_LVL_ERR						= 0x01
                                 	.EQU	LOGGING_LVL_WRN						= 0x02
                                 	.EQU	LOGGING_LVL_INF						= 0x03
                                 	.EQU	LOGGING_LVL_DBG						= 0x04
                                 	.EQU	LOGGING_LVL_PNC						= 0x05
                                 	.SET	LOGGING_LEVEL							= LOGGING_LVL_INF
                                 
                                 	.SET	BUFFER_SIZE								= 0x0000
                                 
                                 .ifdef REPORT_INCLUDES
                                 .else
                                 .endif
                                 .ifdef TIMER_C_ENABLE
                                 .else
                                 	.SET	TIMER_C_ENABLE							= 0x00
                                 .endif
                                 	.SET	REALTIME									= 0x00
                                 	.SET	TIMERS									= 0x00
                                 	.SET	TIMERS16									= 0x00
                                 .ifdef AVRA
                                 .else
                                 	.SET	AVRA										= 0x00
                                 .endif
                                 	.SET	MUL_SUPPORT								= 0x01
                                 
                                 .ifdef CORE_FREQ
                                 	.EQU	TIMERS_SPEED_50US						= (3125*CORE_FREQ*2)/1000	;2-20МГц(реком. 4,8,12,16,20)
                                 	.EQU	TIMERS_SPEED_25US						= (3125*CORE_FREQ)/1000		;2-20МГц(реком. 8,16)
                                 	.SET	TIMERS_SPEED							= TIMERS_SPEED_50US
                                 	.SET	INPUT_BUFFER_SIZE						= 0x80			;Размер буфера ввода (не менее 2)
                                 ;---PROC-ID-OPTIONS--------------------------------------;Не изменяемые опции процесса размещаемые в идентификаторе процесса
                                 	.EQU	C5_PROCID_OPT_NOSUSP					= 0x04			;Запрещено диспетчеру прерывать выполнение
                                 	.EQU	C5_PROCID_OPT_TIMER					= 0x05			;Таймер, повторяет выполнение с указанным периодом
                                 	.EQU	C5_PROCID_OPT_RESERV2				= 0x06			;Зарезервировано
                                 	.EQU	C5_PROCID_OPT_DRV						= 0x07			;Драйвер
                                 .endif
                                 
                                 	.EQU	PA0										= (0x00<<4)|0x00
                                 	.EQU	PA1										= (0x00<<4)|0x01
                                 	.EQU	PA2										= (0x00<<4)|0x02
                                 	.EQU	PA3										= (0x00<<4)|0x03
                                 	.EQU	PA4										= (0x00<<4)|0x04
                                 	.EQU	PA5										= (0x00<<4)|0x05
                                 	.EQU	PA6										= (0x00<<4)|0x06
                                 	.EQU	PA7										= (0x00<<4)|0x07
                                 	.EQU	PB0										= (0x01<<4)|0x00
                                 	.EQU	PB1										= (0x01<<4)|0x01
                                 	.EQU	PB2										= (0x01<<4)|0x02
                                 	.EQU	PB3										= (0x01<<4)|0x03
                                 	.EQU	PB4										= (0x01<<4)|0x04
                                 	.EQU	PB5										= (0x01<<4)|0x05
                                 	.EQU	PB6										= (0x01<<4)|0x06
                                 	.EQU	PB7										= (0x01<<4)|0x07
                                 	.EQU	PC0										= (0x02<<4)|0x00
                                 	.EQU	PC1										= (0x02<<4)|0x01
                                 	.EQU	PC2										= (0x02<<4)|0x02
                                 	.EQU	PC3										= (0x02<<4)|0x03
                                 	.EQU	PC4										= (0x02<<4)|0x04
                                 	.EQU	PC5										= (0x02<<4)|0x05
                                 	.EQU	PC6										= (0x02<<4)|0x06
                                 	.EQU	PC7										= (0x02<<4)|0x07
                                 	.EQU	PD0										= (0x03<<4)|0x00
                                 	.EQU	PD1										= (0x03<<4)|0x01
                                 	.EQU	PD2										= (0x03<<4)|0x02
                                 	.EQU	PD3										= (0x03<<4)|0x03
                                 	.EQU	PD4										= (0x03<<4)|0x04
                                 	.EQU	PD5										= (0x03<<4)|0x05
                                 	.EQU	PD6										= (0x03<<4)|0x06
                                 	.EQU	PD7										= (0x03<<4)|0x07
                                 	.EQU	PE0										= (0x04<<4)|0x00
                                 	.EQU	PE1										= (0x04<<4)|0x01
                                 	.EQU	PE2										= (0x04<<4)|0x02
                                 	.EQU	PE3										= (0x04<<4)|0x03
                                 	.EQU	PE4										= (0x04<<4)|0x04
                                 	.EQU	PE5										= (0x04<<4)|0x05
                                 	.EQU	PE6										= (0x04<<4)|0x06
                                 	.EQU	PE7										= (0x04<<4)|0x07
                                 	.EQU	PF0										= (0x05<<4)|0x00
                                 	.EQU	PF1										= (0x05<<4)|0x01
                                 	.EQU	PF2										= (0x05<<4)|0x02
                                 	.EQU	PF3										= (0x05<<4)|0x03
                                 	.EQU	PF4										= (0x05<<4)|0x04
                                 	.EQU	PF5										= (0x05<<4)|0x05
                                 	.EQU	PF6										= (0x05<<4)|0x06
                                 	.EQU	PF7										= (0x05<<4)|0x07
                                 	.EQU	PG0										= (0x06<<4)|0x00
                                 	.EQU	PG1										= (0x06<<4)|0x01
                                 	.EQU	PG2										= (0x06<<4)|0x02
                                 	.EQU	PG3										= (0x06<<4)|0x03
                                 	.EQU	PG4										= (0x06<<4)|0x04
                                 	.EQU	PG5										= (0x06<<4)|0x05
                                 	.EQU	PG6										= (0x06<<4)|0x06
                                 	.EQU	PG7										= (0x06<<4)|0x07
                                 
                                 	.EQU	C5_ISC_LOW_LEVEL						= 0x00
                                 	.EQU	C5_ISC_ANY_CHANGE						= 0x01
                                 	.EQU	C5_ISC_FALLING_EDGE					= 0x02
                                 	.EQU	C5_ISC_RISING_EDGE					= 0x03
                                 
                                 	.SET	INT0_PORT								= 0xff
                                 	.SET	INT1_PORT								= 0xff
                                 	.SET	INT2_PORT								= 0xff
                                 	.SET	INT3_PORT								= 0xff
                                 	.SET	INT4_PORT								= 0xff
                                 	.SET	INT5_PORT								= 0xff
                                 	.SET	INT6_PORT								= 0xff
                                 	.SET	INT7_PORT								= 0xff
                                 
                                 	.DEF	C0x00										= r7				;Константа 0x00
                                 	.DEF	C0xff										= r8				;Константа 0xff
                                 	.DEF	TEMP_L									= r16				;Младший регистр общего назначения
                                 	.DEF	TEMP_H									= r17				;Старший регистр общего назначения
                                 	.DEF	TEMP										= r18				;Регистр общего назначения
                                 	.DEF	TEMP_EL									= r19				;Младший расширенный регистр общего назначения
                                 	.DEF	TEMP_EH									= r20				;Старший расширенный регистр общего назначения
                                 	.DEF	LOOP_CNTR								= r21				;Регистр счета циклов
                                 	.DEF	FLAGS										= r22				;Регистр флагов
                                 	.DEF	TRY_CNTR									= r23				;Счетчик ошибок
                                 	.DEF	ACCUM										= r24				;Аккумулятор
                                 	.DEF	PID										= r25				;ид процедуры
                                 	.DEF	XL											= r26
                                 	.DEF	XH											= r27
                                 	.DEF	YL											= r28
                                 	.DEF	YH											= r29
                                 	.DEF	ZL											= r30
                                 	.DEF	ZH											= r31
                                 
                                 	;---Часто-используемые-константы-для-частот-программного-таймера---
                                 ;TODO делить на 2?
                                 .ifdef TIMERS_SPEED
                                 .if TIMERS_SPEED == TIMERS_SPEED_50US							;Необходимо учитывать старший бит(0.002c или 0.000 050с)
                                 	.EQU	TIMER_FREQ_20KHz						= 1
                                 	.EQU	TIMER_FREQ_10KHz						= 2
                                 	.EQU	TIMER_FREQ_5KHz						= 4
                                 	.EQU	TIMER_FREQ_4KHz						= 5
                                 	.EQU	TIMER_FREQ_2KHz						= 10
                                 	.EQU	TIMER_FREQ_1KHz						= 20
                                 	.EQU	TIMER_FREQ_500Hz						= 40
                                 	.EQU	TIMER_FREQ_250Hz						= 80
                                 	.EQU	TIMER_FREQ_100Hz						= 128+5
                                 .else
                                 .endif
                                 .endif
                                 .ifdef CORE_FREQ
                                 	;---Часто-используемые-константы-для-частот-таймера-С---
                                 	.EQU	TIMER_C_BAUDRATE_115200				= CORE_FREQ*125000/115200-1
                                 	.EQU	TIMER_C_BAUDRATE_76800				= CORE_FREQ*125000/76800-1
                                 	.EQU	TIMER_C_BAUDRATE_74880 				= CORE_FREQ*125000/74880-1
                                 	.EQU	TIMER_C_BAUDRATE_57600				= CORE_FREQ*125000/57600-1
                                 	.EQU	TIMER_C_BAUDRATE_38400				= CORE_FREQ*125000/38400-1
                                 	.EQU	TIMER_C_BAUDRATE_28800				= CORE_FREQ*125000/28800-1
                                 	.EQU	TIMER_C_BAUDRATE_19200				= CORE_FREQ*125000/19200-1
                                 	.EQU	TIMER_C_BAUDRATE_14400				= CORE_FREQ*125000/14400-1
                                 	.EQU	TIMER_C_BAUDRATE_9600				= CORE_FREQ*125000/9600-1
                                 	;---
                                 	.EQU	TIMER_C_FREQ_40KHz					= (CORE_FREQ*125000/(40000*2))-1
                                 	.EQU	TIMER_C_FREQ_38KHz					= (CORE_FREQ*125000/(38000*2))-1
                                 	.EQU	TIMER_C_FREQ_36KHz					= (CORE_FREQ*125000/(36000*2))-1
                                 	.EQU	TIMER_C_FREQ_20KHz					= (CORE_FREQ*125000/(20000*2))-1
                                 	.EQU	TIMER_C_FREQ_10KHz					= (CORE_FREQ*125000/(10000*2))-1
                                 	.EQU	TIMER_C_FREQ_5KHz						= (CORE_FREQ*125000/(5000*2))-1
                                 .IF CORE_FREQ < 20
                                 	.EQU	TIMER_C_FREQ_4800Hz					= (CORE_FREQ*125000/(4800*2))-1
                                 .ENDIF
                                 	;---
                                 .endif
                                 	.MACRO _C5_MACRO__PUSH_RDS
                                 		PUSH r16
                                 		PUSH r17
                                 		PUSH r18
                                 		PUSH r19
                                 		PUSH r20
                                 		PUSH r21
                                 		PUSH r22
                                 		PUSH r23
                                 		PUSH r24
                                 		PUSH r25
                                 		PUSH r26
                                 		PUSH r27
                                 		PUSH r28
                                 		PUSH r29
                                 		PUSH r30
                                 		PUSH r31
                                 	.ENDMACRO
                                 
                                 	.MACRO _C5_MACRO__POP_RDS
                                 		POP r31
                                 		POP r30
                                 		POP r29
                                 		POP r28
                                 		POP r27
                                 		POP r26
                                 		POP r25
                                 		POP r24
                                 		POP r23
                                 		POP r22
                                 		POP r21
                                 		POP r20
                                 		POP r19
                                 		POP r18
                                 		POP r17
                                 		POP r16
                                 	.ENDMACRO
                                 
                                 .MACRO PUSH_X
                                 	PUSH XH
                                 	PUSH XL
                                 .ENDMACRO
                                 .MACRO POP_X
                                 	POP XL
                                 	POP XH
                                 .ENDMACRO
                                 .MACRO PUSH_Y
                                 	PUSH YH
                                 	PUSH YL
                                 .ENDMACRO
                                 .MACRO POP_Y
                                 	POP YL
                                 	POP YH
                                 .ENDMACRO
                                 .MACRO PUSH_Z
                                 	PUSH ZH
                                 	PUSH ZL
                                 .ENDMACRO
                                 .MACRO POP_Z
                                 	POP ZL
                                 	POP ZH
                                 .ENDMACRO
                                 
                                 .ifdef CORE_FREQ
                                 .MACRO C5_WAIT_500NS
                                 	PUSH TEMP
                                 	LDI TEMP,low((@0-36)/(16/CORE_FREQ))
                                 	.if ((@0-36)/(16/CORE_FREQ)) > 0
                                 		MCALL _C5_WAIT_500NS
                                 	.endif
                                 	POP TEMP
                                 .ENDMACRO
                                 .endif
                                 
                                 .MACRO LDI_X
                                 	LDI XH,high(@0)
                                 	LDI XL,low(@0)
                                 .ENDMACRO
                                 .MACRO LDI_Y
                                 	LDI YH,high(@0)
                                 	LDI YL,low(@0)
                                 .ENDMACRO
                                 .MACRO LDI_Z
                                 	LDI ZH,high(@0)
                                 	LDI ZL,low(@0)
                                 .ENDMACRO
                                 .MACRO PUSH_THL
                                 	PUSH TEMP_H
                                 	PUSH TEMP_L
                                 .ENDMACRO
                                 .MACRO POP_THL
                                 	POP TEMP_L
                                 	POP TEMP_H
                                 .ENDMACRO
                                 .MACRO PUSH_TEHL
                                 	PUSH TEMP_EH
                                 	PUSH TEMP_EL
                                 .ENDMACRO
                                 .MACRO POP_TEHL
                                 	POP TEMP_EL
                                 	POP TEMP_EH
                                 .ENDMACRO
                                 .MACRO PUSH_FT
                                 	PUSH TEMP_EH
                                 	PUSH TEMP_EL
                                 	PUSH TEMP_H
                                 	PUSH TEMP_L
                                 	PUSH TEMP
                                 .ENDMACRO
                                 .MACRO POP_FT
                                 	POP TEMP
                                 	POP TEMP_L
                                 	POP TEMP_H
                                 	POP TEMP_EL
                                 	POP TEMP_EH
                                 .ENDMACRO
                                 
                                 .endif
                                 
                                 ;---CONSTANTS--------------------------------------------
                                 	.SET	DEVICE_FAMILY							= ATMEGA48
C:\repos\w5277c\core5277\./devices/atmega328.inc(44): ######## DEVICE ATmega328
                                 	.MESSAGE "######## DEVICE ATmega328"
                                 	.EQU	_MCALL_SIZE								= 0x02			;Размер MCALL
                                 	.EQU	_C5_DRIVERS_MAX_QNT					= 0x10			;Максимальное количество драйверов
                                 	.EQU	_C5_TASKS_MAX_QNT						= 0x10			;Максимальное количество задач
                                 	.SET	C5_DRIVERS_QNT							= _C5_DRIVERS_MAX_QNT
                                 	.SET	C5_TASKS_QNT							= _C5_TASKS_MAX_QNT
                                 	.EQU	_C5_IR_QNT								= 0x1a			;Количество перырваний(без RESET)
                                 	.EQU	_C5_PCINT_PORTS_QNT					= 0x03			;Количество портов поддерживающих внешние прерывания(PCINT)
                                 	.EQU	_C5_RAM_BORDER_SIZE					= 0x08			;Минимальное допустимое расстояние между вершинами FREE_RAM и STACK
                                 	.EQU	_C5_STACK_SIZE							= 0x40			;Стек ядра
                                 	.EQU	RAMSTART									= 0x0100
                                 	.EQU	RAMEND									= 0x08ff
                                 	.SET	INPUT_BUFFER_SIZE						= 0x80			;Размер буфера ввода (не менее 2)
                                 
                                 	;---IR---
                                 	.EQU	C5_IR_INT0								= 0x01
                                 	.EQU	C5_IR_INT1								= 0x02
                                 	.EQU	C5_IR_PCINT0							= 0x03
                                 	.EQU	C5_IR_PCINT1							= 0x04
                                 	.EQU	C5_IR_PCINT2							= 0x05
                                 	.EQU	C5_IR_WDT								= 0x06
                                 	.EQU	C5_IR_TIMER2_COMPA					= 0x07
                                 	.EQU	C5_IR_TIMER2_COMPB					= 0x08
                                 	.EQU	C5_IR_TIMER2_OVF						= 0x09
                                 	.EQU	C5_IR_TIMER1_CAPT						= 0x0a
                                 	.EQU	C5_IR_TIMER1_COMPA					= 0x0b
                                 	.EQU	C5_IR_TIMER1_COMPB					= 0x0c
                                 	.EQU	C5_IR_TIMER1_OVF						= 0x0d
                                 	.EQU	C5_IR_RESERVED_CORE_TIMER1			= 0x0e
                                 	.EQU	C5_IR_RESERVED_CORE_TIMER2			= 0x0f
                                 	.EQU	C5_IR_TIMER0_OVF						= 0x10
                                 	.EQU	C5_IR_SPI								= 0x11
                                 	.EQU	C5_IR_UART_RX							= 0x12
                                 	.EQU	C5_IR_UART_UDRE						= 0x13
                                 	.EQU	C5_IR_UART_TX							= 0x14
                                 	.EQU	C5_IR_ADC								= 0x15
                                 	.EQU	C5_IR_EE_READY							= 0x16
                                 	.EQU	C5_IR_ANALOG_COMP						= 0x17
                                 	.EQU	C5_IR_TWI								= 0x18
                                 	.EQU	C5_IR_SPM_READY						= 0x19
                                 
                                 	;SBI/CBI/SBIS/SBIC port defines
                                 	.EQU	PORTA										= 0xff
                                 	.EQU	DDRA										= 0xff
                                 	.EQU	PINA										= 0xff
                                 	.EQU	PORTB										= 0x05
                                 	.EQU	DDRB										= 0x04
                                 	.EQU	PINB										= 0x03
                                 	.EQU	PORTC										= 0x08
                                 	.EQU	DDRC										= 0x07
                                 	.EQU	PINC										= 0x06
                                 	.EQU	PORTD										= 0x0b
                                 	.EQU	DDRD										= 0x0a
                                 	.EQU	PIND										= 0x09
                                 	.EQU	PORTE										= 0xff
                                 	.EQU	DDRE										= 0xff
                                 	.EQU	PINE										= 0xff
                                 	.EQU	PORTF										= 0xff
                                 	.EQU	DDRF										= 0xff
                                 	.EQU	PINF										= 0xff
                                 	.EQU	PORTG										= 0xff
                                 	.EQU	DDRG										= 0xff
                                 	.EQU	PING										= 0xff
                                 
                                 	.EQU	SDA										= PC4
                                 	.EQU	SCL										= PC5
                                 	.EQU	RXD										= PD0
                                 	.EQU	TXD										= PD1
                                 	.EQU	RXD0										= RXD
                                 	.EQU	TXD0										= TXD
                                 	.EQU	SCK										= PB5
                                 	.EQU	MISO										= PB4
                                 	.EQU	MOSI										= PB3
                                 	.EQU	SS											= PB2
                                 	.EQU	OC2A										= PB3
                                 
                                 	;---IO-REGISTERS---------------------------------------
                                 	.EQU	SREG										= 0x5f
                                 	.EQU	SPH										= 0x5e
                                 	.EQU	SPL										= 0x5d
                                 	.EQU	MCUCSR									= 0x54
                                 	.EQU	MCUSR										= MCUCSR
                                 	.EQU		WDRF									= 0x03
                                 	.EQU		BORF									= 0x02
                                 	.EQU		EXTRF									= 0x01
                                 	.EQU		PORF									= 0x00
                                 	.EQU	PRR										= 0x64
                                 	.EQU		PRTWI									= 0x07
                                 	.EQU		PRTIM2								= 0x06
                                 	.EQU		PRTIM0								= 0x05
                                 	.EQU		PRTIM1								= 0x03
                                 	.EQU		PRSPI									= 0x02
                                 	.EQU		PRUSART0								= 0x01
                                 	.EQU		PRADC									= 0x00
                                 	;---TWI---
                                 	.EQU	TWCR										= 0xbc
                                 	.EQU		TWINT									= 0x07
                                 	.EQU		TWEA									= 0x06
                                 	.EQU		TWSTA									= 0x05
                                 	.EQU		TWSTO									= 0x04
                                 	.EQU		TWWC									= 0x03
                                 	.EQU		TWEN									= 0x02
                                 	.EQU		TWIE									= 0x00
                                 	.EQU	TWDR										= 0xbb
                                 	.EQU	TWAR										= 0xba
                                 	.EQU		TWGCE									= 0x00
                                 	.EQU	TWSR										= 0xb9
                                 	.EQU		TWPS1									= 0x01
                                 	.EQU		TWPS0									= 0x00
                                 	.EQU	TWBR										= 0xb8
                                 	;---TIMER0---
                                 	.EQU	TIMSK0									= 0x6e
                                 	.EQU		OCIE0B								= 0x02
                                 	.EQU		OCIE0A								= 0x01
                                 	.EQU		TOIE0									= 0x00
                                 	.EQU	TCCR0A									= 0x44
                                 	.EQU		COM0A1								= 0x07
                                 	.EQU		COM0A0								= 0x06
                                 	.EQU		COM0B1								= 0x05
                                 	.EQU		COM0B0								= 0x04
                                 	.EQU		WGM01									= 0x01
                                 	.EQU		WGM00									= 0x00
                                 	.EQU	TCCR0B									= 0x45
                                 	.EQU		FOC0A									= 0x07
                                 	.EQU		FOC0B									= 0x06
                                 	.EQU		WGM02									= 0x03
                                 	.EQU		CS02									= 0x02
                                 	.EQU		CS01									= 0x01
                                 	.EQU		CS00									= 0x00
                                 	.EQU	TCNT0										= 0x46
                                 	.EQU	OCR0A										= 0x47
                                 	.EQU	OCR0B										= 0x48
                                 	.EQU	TIFR0										= 0x35
                                 	.EQU		OCF0B									= 0x02
                                 	.EQU		OCF0A									= 0x01
                                 	.EQU		TOV0									= 0x00
                                 	;---TIMER1---
                                 	.EQU	TIMSK1									= 0x6f
                                 	.EQU		ICIE1									= 0x05
                                 	.EQU		OCIE1B								= 0x02
                                 	.EQU		OCIE1A								= 0x01
                                 	.EQU		TOIE1									= 0x00
                                 	.EQU	TCCR1A									= 0x80
                                 	.EQU		COM1A1								= 0x07
                                 	.EQU		COM1A0								= 0x06
                                 	.EQU		COM1B1								= 0x05
                                 	.EQU		COM1B0								= 0x04
                                 	.EQU		WGM11									= 0x01
                                 	.EQU		WGM10									= 0x00
                                 	.EQU	TCCR1B									= 0x81
                                 	.EQU		ICNC1									= 0x07
                                 	.EQU		ICES1									= 0x06
                                 	.EQU		WGM13									= 0x04
                                 	.EQU		WGM12									= 0x03
                                 	.EQU		CS12									= 0x02
                                 	.EQU		CS11									= 0x01
                                 	.EQU		CS10									= 0x00
                                 	.EQU	TCCR1C									= 0x82
                                 	.EQU		FOC1A									= 0x07
                                 	.EQU		FOC1B									= 0x06
                                 	.EQU	TCNT1H									= 0x85
                                 	.EQU	TCNT1L									= 0x84
                                 	.EQU	OCR1AH									= 0x89
                                 	.EQU	OCR1AL									= 0x88
                                 	.EQU	OCR1BH									= 0x8b
                                 	.EQU	OCR1BL									= 0x8a
                                 	.EQU	TIFR1										= 0x36
                                 	.EQU		ICF1									= 0x05
                                 	.EQU		OCF1B									= 0x02
                                 	.EQU		OCF1A									= 0x01
                                 	.EQU		TOV1									= 0x00
                                 	;---TIMER2---
                                 	.EQU	TIMSK2									= 0x70
                                 	.EQU		OCIE2B								= 0x02
                                 	.EQU		OCIE2A								= 0x01
                                 	.EQU		TOIE2									= 0x00
                                 	.EQU	TCCR2A									= 0xb0
                                 	.EQU		COM2A1								= 0x07
                                 	.EQU		COM2A0								= 0x06
                                 	.EQU		COM2B1								= 0x05
                                 	.EQU		COM2B0								= 0x04
                                 	.EQU		WGM21									= 0x01
                                 	.EQU		WGM20									= 0x00
                                 	.EQU	TCCR2B									= 0xb1
                                 	.EQU		FOC2A									= 0x07
                                 	.EQU		FOC2B									= 0x06
                                 	.EQU		WGM22									= 0x03
                                 	.EQU		CS22									= 0x02
                                 	.EQU		CS21									= 0x01
                                 	.EQU		CS20									= 0x00
                                 	.EQU	TCNT2										= 0xb2
                                 	.EQU	OCR2A										= 0xb3
                                 	.EQU	OCR2B										= 0xb4
                                 	.EQU	TIFR2										= 0x37
                                 	.EQU		OCF2B									= 0x02
                                 	.EQU		OCF2A									= 0x01
                                 	.EQU		TOV2									= 0x00
                                 	;---UART---
                                 	.EQU	UDR0										= 0xc6
                                 	.EQU	UCSR0A									= 0xc0
                                 	.EQU		RXC0									= 0x07
                                 	.EQU		TXC0									= 0x06
                                 	.EQU		UDRE0									= 0x05
                                 	.EQU		FE0									= 0x04
                                 	.EQU		DOR0									= 0x03
                                 	.EQU		UPE0									= 0x02
                                 	.EQU		U2X0									= 0x01
                                 	.EQU		MPCM0									= 0x00
                                 	.EQU	UCSR0B									= 0xc1
                                 	.EQU		RXCIE0								= 0x07
                                 	.EQU		TXCIE0								= 0x06
                                 	.EQU		UDRIE0								= 0x05
                                 	.EQU		RXEN0									= 0x04
                                 	.EQU		TXEN0									= 0x03
                                 	.EQU		UCSZ02								= 0x02
                                 	.EQU		RXB80									= 0x01
                                 	.EQU		TXB80									= 0x00
                                 	.EQU	UCSR0C									= 0xc2
                                 	.EQU		UMSEL01								= 0x07
                                 	.EQU		UMSEL00								= 0x06
                                 	.EQU		UPM01									= 0x05
                                 	.EQU		UPM00									= 0x04
                                 	.EQU		USBS0									= 0x03
                                 	.EQU		UCSZ01								= 0x02
                                 	.EQU		UDCRD0								= 0x02
                                 	.EQU		UCSZ00								= 0x01
                                 	.EQU		UCPHA0								= 0x01
                                 	.EQU		UCPOL0								= 0x00
                                 	.EQU		URSEL0								= 0x08			;Для совместимости
                                 	.EQU	UBRR0H									= 0xc5
                                 	.EQU	UBRR0L									= 0xc4
                                 	;---PCINT---
                                 	.EQU	PCICR										= 0x68
                                 	.EQU		PCIE2									= 0x02
                                 	.EQU		PCIE1									= 0x01
                                 	.EQU		PCIE0									= 0x00
                                 	.EQU	PCIFR										= 0x3b
                                 	.EQU		PCIF2									= 0x02
                                 	.EQU		PCIF1									= 0x02
                                 	.EQU		PCIF0									= 0x00
                                 	.EQU	PCMSK0									= 0x6b
                                 	.EQU		PCINT7								= 0x07
                                 	.EQU		PCINT6								= 0x06
                                 	.EQU		PCINT5								= 0x05
                                 	.EQU		PCINT4								= 0x04
                                 	.EQU		PCINT3								= 0x03
                                 	.EQU		PCINT2								= 0x02
                                 	.EQU		PCINT1								= 0x01
                                 	.EQU		PCINT0								= 0x00
                                 	.EQU	PCMSK1									= 0x6c
                                 	.EQU		PCINT14								= 0x06
                                 	.EQU		PCINT13								= 0x05
                                 	.EQU		PCINT12								= 0x04
                                 	.EQU		PCINT11								= 0x03
                                 	.EQU		PCINT10								= 0x02
                                 	.EQU		PCINT9								= 0x01
                                 	.EQU		PCINT8								= 0x00
                                 	.EQU	PCMSK2									= 0x6d
                                 	.EQU		PCINT23								= 0x07
                                 	.EQU		PCINT22								= 0x06
                                 	.EQU		PCINT21								= 0x05
                                 	.EQU		PCINT20								= 0x04
                                 	.EQU		PCINT19								= 0x03
                                 	.EQU		PCINT18								= 0x02
                                 	.EQU		PCINT17								= 0x01
                                 	.EQU		PCINT16								= 0x00
                                 	;---INT---
                                 	.EQU	EICRA										= 0x69
                                 	.EQU		ISC11									= 0x03
                                 	.EQU		ISC10									= 0x02
                                 	.EQU		ISC01									= 0x01
                                 	.EQU		ISC00									= 0x00
                                 	.EQU	EIMSK										= 0x3d
                                 	.EQU		INT0									= 0x00
                                 	.EQU		INT1									= 0x01
                                 	.EQU	EIFR										= 0x3c
                                 	.EQU		INTF0									= 0x00
                                 	.EQU		INTF1									= 0x01
                                 
                                 	;---EEPROM---
                                 	.EQU	EEARH										= 0x42
                                 	.EQU	EEARL										= 0x41
                                 	.EQU	EEDR										= 0x40
                                 	.EQU	EECR										= 0x3F
                                 	.EQU		EEPM1									= 0x05
                                 	.EQU		EEPM0									= 0x04
                                 	.EQU		EERIE									= 0x03
                                 	.EQU		EEMPE									= 0x02
                                 	.EQU		EEMWE									= EEMPE
                                 	.EQU		EEPE									= 0x01
                                 	.EQU		EEWE									= EEPE
                                 	.EQU		EERE									= 0x00
                                 	;---ADC---
                                 	.EQU	ADMUX										= 0x7c
                                 	.EQU		REFS1									= 0x07
                                 	.EQU		REFS0									= 0x06
                                 	.EQU		ADLAR									= 0x05
                                 	.EQU		MUX3									= 0x03
                                 	.EQU		MUX2									= 0x02
                                 	.EQU		MUX1									= 0x01
                                 	.EQU		MUX0									= 0x00
                                 	.EQU	ADCSRA									= 0x7a
                                 	.EQU		ADEN									= 0x07
                                 	.EQU		ADSC									= 0x06
                                 	.EQU		ADATE									= 0x05
                                 	.EQU		ADIF									= 0x04
                                 	.EQU		ADIE									= 0x03
                                 	.EQU		ADPS2									= 0x02
                                 	.EQU		ADPS1									= 0x01
                                 	.EQU		ADPS0									= 0x00
                                 	.EQU	ADCSRB									= 0x7b
                                 	.EQU		ACME									= 0x06
                                 	.EQU		ADTS2									= 0x02
                                 	.EQU		ADTS1									= 0x01
                                 	.EQU		ADTS0									= 0x00
                                 	.EQU	ADCL										= 0x78
                                 	.EQU	ADCH										= 0x79
                                 	.EQU	ADC0										= 0x00
                                 	.EQU	ADC1										= 0x01
                                 	.EQU	ADC2										= 0x02
                                 	.EQU	ADC3										= 0x03
                                 	.EQU	ADC4										= 0x04
                                 	.EQU	ADC5										= 0x05
                                 	.EQU	ADC6										= 0x06
                                 	.EQU	ADC7										= 0x07
                                 	.EQU	ADCT										= 0x08
                                 	;--SPI---
                                 	.EQU	SPCR										= 0x4c
                                 	.EQU		SPIE									= 0x07
                                 	.EQU		SPE									= 0x06
                                 	.EQU		DORD									= 0x05
                                 	.EQU		MSTR									= 0x04
                                 	.EQU		CPOL									= 0x03
                                 	.EQU		CPHA									= 0x02
                                 	.EQU		SPR1									= 0x01
                                 	.EQU		SPR0									= 0x00
                                 	.EQU	SPSR										= 0x4d
                                 	.EQU		SPIF									= 0x07
                                 	.EQU		WCOL									= 0x06
                                 	.EQU		SPI2X									= 0x00
                                 	.EQU	SPDR										= 0x4e
                                 	;--SPM---
                                 	.EQU	SPMCSR									= 0x57
                                 	.EQU	SPMCR										= SPMCSR
                                 	.EQU		SPMIE									= 0x07
                                 	.EQU		RWWSB									= 0x06
                                 	.EQU		SIGRD									= 0x05
                                 	.EQU		RWWSRE								= 0x04
                                 	.EQU		BLBSET								= 0x03
                                 	.EQU		PGWRT									= 0x02
                                 	.EQU		PGERS									= 0x01
                                 	.EQU		SPMEN									= 0x00
                                 	;---WATCHDOG---
                                 	.EQU	WDTCR										= 0x60
                                 	.EQU		WDIF									= 0x07
                                 	.EQU		WDIE									= 0x06
                                 	.EQU		WDP3									= 0x05
                                 	.EQU		WDCE									= 0x04
                                 	.EQU		WDE									= 0x03
                                 	.EQU		WDP2									= 0x02
                                 	.EQU		WDP1									= 0x01
                                 	.EQU		WDP0									= 0x00
                                 
                                 	;---ADC-VOLTAGE-REFERENCE---
                                 	.EQU	ADC_VREF_AREF							= (0<<REFS1)|(0<<REFS0)
                                 	.EQU	ADC_VREF_AVCC							= (0<<REFS1)|(1<<REFS0)
                                 	.EQU	ADC_VREF_1_1_CAP						= (1<<REFS1)|(1<<REFS0)
                                 	;---ADC-PRESCALLER---
                                 	.EQU	ADC_PRESC_X1							= 0x00
                                 	.EQU	ADC_PRESC_X2							= 0x01
                                 	.EQU	ADC_PRESC_X4							= 0x02
                                 	.EQU	ADC_PRESC_X8							= 0x03
                                 	.EQU	ADC_PRESC_X16							= 0x04
                                 	.EQU	ADC_PRESC_X32							= 0x05
                                 	.EQU	ADC_PRESC_X64							= 0x06
                                 	.EQU	ADC_PRESC_X128							= 0x07
                                 ;---TIMER-C-COMPARE-OUTPUT-MODES---
                                 	.EQU	TIMER_C_COM_DISCONNECTED			= 0x00<<0x06
                                 	.EQU	TIMER_C_COM_TOGGLE					= 0x01<<0x06
                                 	.EQU	TIMER_C_COM_CLEAR						= 0x02<<0x06
                                 	.EQU	TIMER_C_COM_SET						= 0x03<<0x06
                                 
                                 	.SET	INT0_PORT								= PD2
                                 	.SET	INT1_PORT								= PD3
                                 
                                 .ORG 0x0000
000000 940c 003d                 	JMP	_INIT															; Reset Handler
000002 940e 03e0                 	CALL	_C5_IR														; External Interrupt0 Handler
000004 940e 03e0                 	CALL	_C5_IR														; External Interrupt1 Handler
000006 940e 03e0                 	CALL	_C5_IR														; Pin Change Interrupt Request 0
000008 940e 03e0                 	CALL	_C5_IR														; Pin Change Interrupt Request 1
00000a 940e 03e0                 	CALL	_C5_IR														; Pin Change Interrupt Request 2
00000c 940e 03e0                 	CALL	_C5_IR														; Watchdog Time-out Interrupt
                                 .IF TIMER_C_ENABLE == 0x01
                                 .ELSE
00000e 940e 03e0                 	CALL	_C5_IR														; Timer/Counter2 Compare Match A
                                 .ENDIF
000010 940e 03e0                 	CALL	_C5_IR														; Timer/Counter2 Compare Match B
000012 940e 03e0                 	CALL	_C5_IR														; Timer/Counter2 Overflow
000014 940e 03e0                 	CALL	_C5_IR														; Timer/Counter1 Capture Event
000016 940e 03e0                 	CALL	_C5_IR														; Timer/Counter1 Compare Match A
000018 940e 03e0                 	CALL	_C5_IR														; Timer/Counter1 Compare Match B
00001a 940e 03e0                 	CALL	_C5_IR														; Timer/Counter1 Overflow
00001c 940c 0409                 	JMP	_C5_TIMER_A_IR												; Timer/Counter0 Compare Match A
00001e 940c 0534                 	JMP	_C5_TIMER_B_IR												; Timer/Counter0 Compare Match B
000020 940e 03e0                 	CALL	_C5_IR														; Timer/Counter0 Overflow
000022 940e 03e0                 	CALL	_C5_IR														; SPI Serial Transfer Complete
000024 940e 03e0                 	CALL	_C5_IR														; USART Rx Complete
000026 940e 03e0                 	CALL	_C5_IR														; USART, Data Register Empty
000028 940e 03e0                 	CALL	_C5_IR														; USART, Tx Complete
00002a 940e 03e0                 	CALL	_C5_IR														; ADC Conversion Complete
00002c 940e 03e0                 	CALL	_C5_IR														; EEPROM Ready
00002e 940e 03e0                 	CALL	_C5_IR														; Analog Comparator
000030 940e 03e0                 	CALL	_C5_IR														; 2-wire Serial Interface
000032 940e 03e0                 	CALL	_C5_IR														; Store Program Memory Ready
                                 
                                 PORTS_TABLE:															;Таблица из адресов IO регистров (A,B,C,D), поочередно PORTA,DDRA,PINA,PORTB,DDRB,PINB и т.д.
000034 0000
000035 2500
000036 2324
000037 2728
000038 2b26
000039 292a                      	.db	0x00,0x00,0x00,0x25,0x24,0x23,0x28,0x27,0x26,0x2b,0x2a,0x29
                                 PCINT_TABLE:
00003a 6b00
00003b 6d6c                      	.db	0x00,PCMSK0,PCMSK1,PCMSK2
                                 INT_TABLE:
00003c 0201                      	.db	(1<<INT0),(1<<INT1)
                                 _INIT:
00003d 94f8                      	CLI
                                 	;Инициализация стека
00003e e028                      	LDI TEMP,high(RAMEND)
00003f 9320 005e                 	STS SPH,TEMP
000041 ef2f                      	LDI TEMP,low(RAMEND)
000042 9320 005d                 	STS SPL,TEMP
000044 2477                      	EOR C0x00,C0x00
000045 ef2f                      	LDI TEMP,0xff
000046 2e82                      	MOV C0xff,TEMP
000047 940c 126b                 	JMP MAIN
                                 APPLICATION_BLOCK:
                                 
                                 .MACRO MCALL
                                 	CALL @0
                                 .ENDMACRO
                                 .MACRO MJMP
                                 	JMP @0
                                 .ENDMACRO
                                 
                                 .MACRO _C5_TIMERA_INIT
                                 	_C5_POWER_ON PRTIM0												;Подпитываю TIMER0
                                 
                                 	LDI TEMP,(0<<WGM01)|(0<<WGM00)
                                 	STS TCCR0A,TEMP
                                 	LDI TEMP,(0<<CS02)|(1<<CS01)|(0<<CS00)						;/8 - for 16MHz
                                 	STS TCCR0B,TEMP
                                 	CLR TEMP
                                 	STS TCNT0,TEMP
                                 	LDI TEMP,TIMERS_SPEED-0x01										;0x64 - 100(16MHz)
                                 	STS OCR0A,TEMP
                                 	LDI TEMP,(1<<OCF0A)
                                 	STS TIFR0,TEMP
                                 .ENDMACRO
                                 
                                 .MACRO _CORRE5277_TIMERA_START
                                 	LDS TEMP,TIMSK0
                                 	ORI TEMP,(1<<OCIE0A)
                                 	STS TIMSK0,TEMP
                                 .ENDMACRO
                                 
                                 .MACRO _CORRE5277_TIMERA_CORRECTOR
                                 	PUSH ACCUM
                                 	LDS ACCUM,TCNT0
                                 	ADD ACCUM,@0
                                 	STS OCR0A,ACCUM
                                 	LDI ACCUM,(1<<OCF0A)
                                 	STS TIFR0,ACCUM
                                 	POP ACCUM
                                 .ENDMACRO
                                 
                                 .MACRO _C5_TIMERB
                                 	LDS TEMP_L,TCNT0
                                 	ADD TEMP_L,TEMP
                                 	STS OCR0B,TEMP_L
                                 	LDS TEMP_H,TIFR0
                                 	ORI TEMP_H,(1<<OCF0B)
                                 	STS TIFR0,TEMP_H
                                 	;Установка флага
                                 	LDI TEMP_H,(1<<_CFL_TIMER_B_USE)
                                 	OR _C5_COREFLAGS,TEMP_H
                                 	;Запуск таймера
                                 	LDS TEMP_H,TIMSK0
                                 	ORI TEMP_H,(1<<OCIE0B)
                                 	STS TIMSK0,TEMP_H
                                 	SBRC _C5_COREFLAGS,_CFL_TIMER_B_USE
                                 	RJMP PC-0x01
                                 	;Останов таймера
                                 	LDS TEMP_H,TIMSK0
                                 	ANDI TEMP_H,~(1<<OCIE0B)
                                 	STS TIMSK0,TEMP_H
                                 .ENDMACRO
                                 
                                 .MACRO _C5_TIMERC_INIT
                                 	_C5_POWER_ON PRTIM2
                                 	LDI TEMP,(1<<WGM21)|(0<<WGM20)
                                 	STS TCCR2A,TEMP
                                 	LDI TEMP,(0<<CS22)|(1<<CS21)|(0<<CS20)						;/8
                                 	STS TCCR2B,TEMP
                                 	STS TCNT2,C0x00
                                 	LDS TEMP,SREG
                                 	PUSH TEMP
                                 	CLI
                                 	LDS TEMP,TIFR2
                                 	ORI TEMP,(1<<OCF2A)
                                 	STS TIFR2,TEMP
                                 	POP TEMP
                                 	STS SREG,TEMP
                                 .ENDMACRO
                                 .MACRO _C5_TIMERC_SET_PERIOD
                                 	STS TCNT2,C0x00
                                 	STS OCR2A,TEMP
                                 .ENDMACRO
                                 .MACRO _C5_TIMERC_START
                                 	LDS TEMP,TIFR2
                                 	ORI TEMP,(1<<OCF2A)
                                 	STS TIFR2,TEMP
                                 	LDS TEMP,SREG
                                 	PUSH TEMP
                                 	CLI
                                 	LDS TEMP,TCCR2A
                                 	ANDI TEMP,0b00111111
                                 	STS TCCR2A,TEMP
                                 	LDS TEMP,TIMSK2
                                 	ORI TEMP,(1<<OCIE2A)
                                 	STS TIMSK2,TEMP
                                 	POP TEMP
                                 	STS SREG,TEMP
                                 .ENDMACRO
                                 .MACRO _C5_TIMERC_STOP
                                 	LDS TEMP,SREG
                                 	PUSH TEMP
                                 	CLI
                                 	LDS TEMP,TIMSK2
                                 	ANDI TEMP,~(1<<OCIE2A)
                                 	STS TIMSK2,TEMP
                                 	POP TEMP
                                 	STS SREG,TEMP
                                 .ENDMACRO
                                 .MACRO _C5_TIMERC_SET_COM
                                 	LDS TEMP,SREG
                                 	PUSH TEMP
                                 	CLI
                                 	LDS TEMP,TCCR2A
                                 	ANDI TEMP,0b00111111
                                 	OR TEMP,TEMP_H
                                 	STS TCCR2A,TEMP
                                 	STS TCNT2,C0x00
                                 	POP TEMP
                                 	STS SREG,TEMP
                                 .ENDMACRO
                                 .MACRO _C5_POWER_ON
                                 	PUSH TEMP
                                 	LDS TEMP,PRR
                                 	ANDI TEMP,low(~(1<<@0))
                                 	STS PRR,TEMP
                                 	POP TEMP
                                 .ENDMACRO
                                 .MACRO _C5_POWER_OFF
                                 	PUSH TEMP
                                 	LDS TEMP,PRR
                                 	ORI TEMP,low(1<<@0)
                                 	STS PRR,TEMP
                                 	POP TEMP
                                 .ENDMACRO
                                 
                                 .MACRO _C5_TIMER_TCNT
                                 	LDS @0,TCNT0
                                 .ENDMACRO
                                 
                                 	;---CONSTANTS--------------------------------------------
                                 	.EQU	INIT_LED_PORT									= PB2		;Порт индикации пройденной инициализации
                                 	.EQU	ACT_LED_PORT									= PD5		;Порт индикации активности
                                 
                                 	;Идентификаторы драйверов(0-7|0-15)
                                 ;	.EQU	PID_SPI_DRV								= 0|(1<<C5_PROCID_OPT_DRV)
                                 	.EQU	PID_SD_DRV								= 1|(1<<C5_PROCID_OPT_DRV)
                                 	;Идентификаторы задач(0-3|0-15)
                                 	.EQU	PID_TASK									= 0
                                 	;---
                                 
                                 ;---CORE-SETTINGS----------------------------------------
                                 	.SET	TS_MODE											= TS_MODE_EVENT
                                 	.SET	TIMERS_SPEED									= TIMERS_SPEED_50US	;25/50us
                                 	.SET	TIMERS											= 0		;0-...
                                 	.SET	BUFFER_SIZE										= 0x200	;Размер общего (буфер драйвера SD карты)
                                 	.SET	LOGGING_PORT									= SDA		;STDOUT
                                 	.SET	C5_IN_PORT										= SCL	;STDIN
                                 
                                 ;---INCLUDES---------------------------------------------
                                 	.INCLUDE "./core/core5277.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;02.08.2020	w5277c@gmail.com			Тут просто дохрена изменений
                                 ;09.08.2020	w5277c@gmail.com			Тут просто дохрена изменений
                                 ;06.09.2020	w5277c@gmail.com			Восстановлены механизмы многопоточности
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;28.10.2020	w5277c@gmail.com			Багфикс программных таймеров
                                 ;10.11.2020	w5277c@gmail.com			Исправлена критическая ошибка в _C5_STACK_TO_TOP
                                 ;11.11.2020	w5277c@gmail.com			Добавлена метка реинициализации (не влияет на UPTIME)
                                 ;22.11.2020	w5277c@gmail.com			v0.2.8	Механизм выдерживания паузы использует время запуска задачи вместо дельты
                                 ;															времени
                                 ;22.12.2020	w5277c@gmail.com			Исправлена работа TIMER-TASK
                                 ;06.01.2021	w5277c@gmail.com			v0.2.9	Исправлена критическая ошибка в _C5_RESUME (перетирался SREG задачи)
                                 ;22.01.2021	w5277c@gmail.com			v0.3.0	Различные мелкие (и не очень) изменения
                                 ;01.02.2021	w5277c@gmail.com			v0.3.1	Учтено разное начало RAM, мелкие доработки
                                 ;06.02.2021	w5277c@gmail.com			v0.3.2	Примитивы и проверка на отсутствие драйверов
                                 ;16.04.2021	w5277c@gmail.com			v0.3.3	Вынесен C5_WAIT_2MS из диспетчера, дефолтное значение для BUFFER_SIZE
                                 ;24.05.2021	w5277c@gmail.com			v0.3.4	Исправлена ошибка в работе программных таймеров
                                 ;29.05.2021	w5277c@gmail.com			v0.3.5	Ввод TS_MODE, выделены константы C0x00,C0xff и прочее.
                                 ;31.05.2021	w5277c@gmail.com			v0.3.6	Корректная проверка на выход стека в зону выделяемой памяти
                                 ;14.06.2021	w5277c@gmail.com			v0.3.7	Запрещены прерывания при обработке таймеров, конечный обработчик сам
                                 ;															принимает решение для разрешения прерываний. Иначе возникают трудно
                                 ;															разрешимые коллизии.
                                 ;29.06.2021	w5277c@gmail.com			v0.3.8	Множественные, мелкие изменения в основном TIMER_C, введен OPT_MODE
                                 ;22.08.2021	w5277c@gmail.com			Атомарная операция записи адреса вершины стека.
                                 ;05.09.2021	w5277c@gmail.com			INPUT_PORT->C5_IN_PORT
                                 ;16.09.2021	w5277c@gmail.com			v0.3.9	Множественные, незначительные изменения.
                                 ;22.09.2021	w5277c@gmail.com			v0.4.0	Все программные таймеры содержат адрес выделенной памяти
                                 ;09.10.2021	w5277c@gmail.com			v0.4.1	Оптимизация, убраны NOP из макросов MCALL и MJMP
                                 ;31.01.2022	w5277c@gmail.com			v0.4.2	Исправлена ошибка проверки таймаута в диспетчере
                                 ;04.09.2022	konstantin@5277.ru		v0.4.3	Убраны из ядра процедуры таймера C
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;Задача имеет свой собственный стек, драйвер нет. Задача вызывает драйвер, диспетчер оперирует задачами.
                                 ;Стеки задач и выделяемая память динамические, сверху стеки задач, свободное пространство, затем выделяемая память.
                                 ;Для завершения задачи достаточно вызвать RET
                                 ;Драйвер не имеет персональных регистров и стека как у задачи, выполнение кода драйвера обеспечивается прерываниями или вызовами
                                 ;из задач или других драйверов.
                                 ;Идентификатор задачи или драйвера назначается разработчиком
                                 ;Выполнение процедуры драйвера может быть первано диспетчером, так как работает в инстантсе задачи.
                                 ;Все процедуры вызываемые прерываниями должны быт максимально короткими(иначе могут негативно влиять друг на друга)
                                 ;Ядро использует один из таймеров, обычно TIMER0, остальные - свободны(если не заявлено использование timer C).
                                 ;Стоит использовать только в исключительных ситуациях, т.к. использование не универсально и не имеет отношения к ядру
                                 ;В пределах процедуры можно использовать RJMP, в остальных случаях макросы MJMP и MCALL
                                 ;Осторожно с записями типа 'BREQ PC+0x02' макрос MJMP и MCALL занимает 1/2 слова, т.е. BREQ PC+0x01+_MCALL_SIZE
                                 ;Некоторые драйверы имеют жесткую привязку к портам, например SD, так как процедуры PORT... для них слишком медленны
                                 ;Функционал драйверов (также как и различные дополнительные процедуры) дорабатывается по мере необходимости
                                 
                                 ;Обработчики программных таймеров и таймера C могут не сохранять значения регистров ZH,ZL
                                 
                                 ;TODO нужна еще одна модель динамической памяти но с 16 битным размером. Плюс возможность задавать модель в main-е.
                                 ;TODO проверить использование _PID, специално введен, чтобы драйвер знал кто его вызвал (не нужно передавать отдельно
                                 ;как параметр)
                                 ;TODO добавить проверку на превышение максимального кол-ва задач и драйверов при создании процесса
                                 ;TODO проинспектировать код ядра на необходимость блокировки ресурсов, проверить процедуры вида C5_RES_LOCK.
                                 ;TODO в таблице прерываний отсчет начинается с 1, похоже выделяю памяти на 3 байта больше, чем нужно
                                 ;TODO убрать работу с таймером C в блоке инициализации драйверов
                                 ;TODO добавить блокировку ресурса 'таймер B' и 'таймер C' в драйвера
                                 ;TODO добавить в процедуры работы с программными таймерами  TIMER_B. Сделать так, чтобы была возможность использовать
                                 ;драйвера без прерываний по таймеру. Например I2C_MS - нет необходимости использовать таймеры, достаточно разрешить
                                 ;диспетчер и использовать паузы из таймера B(TID_TIMER_B = 0x82?)
                                 ;TODO Поддержка драйверами различных таймеров(A,B или C), пусть разработчик верхнего уровня сам выбирает какой таймер
                                 ;использовать. Вынести функционал различных таймеров из драйверов в процедуры типа TIMER_START и прочее. Если
                                 ;это вообще реально(тамеры различного типа поддерживают разные диапазны)
                                 ;TODO Считать идентификатор PID_RTC_DRV общеизвестным
                                 ;TODO Написать инструкцию по работе с таймерами, уделить внимание TIMERS_SPEED_25US/50US!
                                 ;TODO Отказаться от TIMERS_SPEED_25US/50US в пользу таймера C и 16бит таймеров
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 .ifdef TS_MODE
                                 .else
                                 	.ifdef REALTIME
                                 	.else
                                 	.endif
                                 .endif
                                 
                                 ;---CORE-PUBLIC-PROCS------------------------------------;Доступные процедуры ядра
                                 	.EQU	C5_PROC_EXEC							= 0x01			;Запуск процедуры драйвера
                                 	.EQU	C5_PROC_WAIT_2MS						= 0x02			;Ожидание *2мс
                                 	.EQU	C5_PROC_DISPATCHER_LOCK				= 0x03			;Блокировка диспетчера
                                 	.EQU	C5_PROC_DISPATCHER_UNLOCK			= 0x04			;Разблокировка диспетчера
                                 	.EQU	C5_PROC_SUSPEND						= 0x05			;Передать управление следующей задаче
                                 
                                 ;---PROC-STATES------------------------------------------;Состояния задачи (PROC-STATES-младший ниббл, PROC-MODE-старший ниббл)
                                 	.EQU	_C5_PROC_STATE_ABSENT				= 0x00			;Нет задачи
                                 	.EQU	_C5_PROC_STATE_GHOST					= 0x01			;Инициализируется или деактивация
                                 	.EQU	_C5_PROC_STATE_BUSY					= 0x02			;Выполняется
                                 	.EQU	_C5_PROC_STATE_TIME_WAIT			= 0x03			;Ждет истечения времени(только для задач)
                                 	.EQU	_C5_PROC_STATE_TIMER_WAIT			= 0x04			;Ждет истечения времени для нового запуска
                                 	.EQU	_C5_PROC_STATE_READY					= 0x05			;Готова к выполнению
                                 ;---PROC-STATE-OPTIONS-----------------------------------;Опции процесса, размещаемые в статусе процесса(старшйи ниббл)
                                 	.EQU	_C5_PROCST_OPT_NOSUSP				= 0x04			;Запрещено диспетчеру прерывать выполнение
                                 	.EQU	_C5_PROCST_OPT_RESERV1				= 0x05			;Зарезервировано
                                 	.EQU	_C5_PROCST_OPT_RESERV2				= 0x06			;Зарезервировано
                                 	.EQU	_C5_PROCST_OPT_RESERV3				= 0x07			;Зарезервировано
                                 
                                 ;---TIMER-STRUCTURE--------------------------------------;Структура таймера(8B)
                                 	.EQU	_C5_TIMER_STRUCT_SIZE				= 0x08			;Длина блока таймера
                                 	.EQU	_C5_TIMER_PROC_ID						= 0x00			;1B-ид процедуры(0-..., 0xff - не исп.)
                                 	.EQU	_C5_TIMER_HANDLER						= 0x01			;2B-адрес обработчика
                                 	.EQU	_C5_TIMER_RAM_ADDR					= 0x03			;2B-адрес на выделенную память
                                 	.EQU	_C5_TIMER_CNTR							= 0x05			;1B-счетчик таймера
                                 	.EQU	_C5_TIMER_DEFAULT						= 0x06			;1B-порог 0x01-0x7f, 7-бит:период отсчета,H:0.002s,L:0.00005s)
                                 	.EQU	_C5_TIMER_RESERVED					= 0x07			;1B-зарезервировано
                                 
                                 ;---TIMER16-STRUCTURE------------------------------------;Структура таймера 16бит(9B)
                                 	.EQU	_C5_TIMER16_STRUCT_SIZE				= 0x09			;Длина блока таймера
                                 	.EQU	_C5_TIMER16_PROC_ID					= 0x00			;1B-ид процедуры(0-..., 0xff - не исп.)
                                 	.EQU	_C5_TIMER16_HANDLER					= 0x01			;2B-адрес обработчика
                                 	.EQU	_C5_TIMER16_RAM_ADDR					= 0x03			;2B-адрес на выделенную память
                                 	.EQU	_C5_TIMER16_CNTR						= 0x05			;2B-счетчик таймера
                                 	.EQU	_C5_TIMER16_DEFAULT					= 0x07			;2B-порог(период отсчета 0.00005s)
                                 
                                 ;---PROC-STRUCTURE---------------------------------------;Заголовок процедуры(6B-драйвер, 11B-задача)
                                 	.EQU	_C5_PROC_STATE							= 0x00			;1B-статус процедуры(младший ниббл) и опции(старший ниббл)
                                 	.EQU	_C5_PROC_RAM_OFFSET					= 0x01			;2B-адрес начала выделенной памяти
                                 	.EQU	_C5_PROC_RAM_SIZE						= 0x03			;1B-размер выделенной памяти
                                 	.EQU	_C5_DRIVER_OFFSET						= 0x04			;2B-адрес процедуры драйвера или
                                 	.EQU	_C5_TASK_STACK_OFFSET				= 0x04			;2B-адрес начала стека задачи
                                 	.EQU	_C5_TASK_STACK_SIZE					= 0x06			;1B-размер стека задачи
                                 	.EQU	_C5_TASK_TIMESTAMP					= 0x07			;1B-мекта времени переключения на задачу
                                 	.EQU	_C5_TASK_EXECTIME						= 0x08			;3B-время запуска задачи(~9 часов максимум, тик в 2мс)
                                 
                                 ;---DRIVER-RESULT----------------------------------------;Идентификаторы результата работы драйвера
                                 	.EQU	DRV_RESULT_OK							= 0x80			;Ок
                                 	.EQU	DRV_RESULT_ABSENT						= 0x81			;Датчик отсутствует
                                 	.EQU	DRV_RESULT_ERROR						= 0x82			;Ошибка выполнения
                                 	.EQU	DRV_RESULT_TIMEOUT					= 0x83			;Не получен ответ за определенный таймаут
                                 	.EQU	DRV_RESULT_INVALID_DATA				= 0x84			;Не корректные данные(например, не сошлось CRC)
                                 	.EQU	DRV_RESULT_UNSUPPORTED				= 0x85			;Не поддерживается
                                 	.EQU	DRV_RESULT_INVALID_RESOURCE		= 0x86			;Не коректный ресурс(например PID драйвера)
                                 	.EQU	DRV_RESULT_INVALID_NAME				= 0x87			;Не корректное имя ресурса(например файла)
                                 	.EQU	DRV_RESULT_WRONG_BLOCK				= 0x88			;Ошибочный(не существующий) блок(например SD карты)
                                 
                                 ;---CONSTANTS--------------------------------------------
                                 	.EQU	_C5_DRIVER_HEADER_SIZE				= 0x06			;Размер заголовка драйвера
                                 	.EQU	_C5_TASK_HEADER_SIZE					= 0x0b			;Размер заголовка задачи
                                 .IF TIMERS_SPEED == TIMERS_SPEED_25US
                                 .ELSE
                                 	.EQU	_C5_TIMER_PERIOD						= 0x28			;40, т.е. 0.000050*40=0.002=2мс
                                 .ENDIF
                                 	.EQU	_C5_TASK_STACK_DEF_SIZE				= 0x13			;Размер стека задачи при создании (16 регистров+SREG+точка возврата)
                                 	.EQU	_C5_TASKS_ACTIVE_TIME				= 0x01			;Время работы задачи 1*2=2мс
                                 	.EQU	_C5_IRV_TABLE_SIZE					= 0x4b			;Размер таблицы прерываний
                                 	.EQU	_C5_RES_QUEUE_SIZE					= _C5_TASKS_MAX_QNT*0x02	;Размер очереди к ресурсам
                                 	.EQU	TID_TIMER_C								= 0x83			;Идентификатор тамера C
                                 	;---CORE-FAULTS---
                                 	.EQU	_C5_FAULT_HUGE_STACK					= 0x01			;Стек перешел границу выделяемой памяти
                                 	.EQU	_C5_FAULT_HUGE_TASK_STACK			= 0x02			;Размер стека задачи более 255 байт
                                 	.EQU	_C5_FAULT_HUGE_TASK_STACK2			= 0x03			;Размер стека задачи более 255 байт
                                 	;---CORE-RESOURCES---											;Идентфикаторы ресурсов, 0-127 отданы пользователю, старшие-ядру(0xff-конец очереди)
                                 	.EQU	C5_RES_TIMER_B							= 0xFE			;Таймер B
                                 	.EQU	C5_RES_ADC								= 0xFD			;ADC
                                 	;---
                                 ;---CORE-FLAGS-------------------------------------------
                                 	.EQU	_CFL_TIMER_B_USE						= 0x00			;Флаг запущенного таймера B
                                 	.EQU	_CFL_TIMER_UART_CORRECTION			= 0x01			;Корректировка таймера для соответствия частотам UART
                                 	.EQU	_CFL_DISPATCHER_ORDER				= 0x02			;Заявка на отработку диспетчера(формируется когда диспетчер заблокирован)
                                 	.EQU	CFL_VIDEO_SYNC							= 0x03			;
                                 
                                 ;---RAM-OFFSETS------------------------------------------
                                 	.EQU	_C5_UPTIME								= RAMSTART+0x00;5B-отсчет времени (~75 лет при тике каждые 0.002мс)
                                 	.EQU	_C5_CORE_STACK							= RAMSTART+0x05;2B-хранит смещение стека ядра
                                 	.EQU	_C5_TOP_OF_STACK						= RAMSTART+0x07;2B-хранит вершину стека
                                 	.EQU	_C5_TOP_OF_FREE_RAM					= RAMSTART+0x09;2B-хранит вершину свободной памяти
                                 	.EQU	_C5_FLAGS								= RAMSTART+0x0b;4B-флагов (32 флага)
                                 	.EQU	_C5_TIMER_C_PID						= RAMSTART+0x0f;1B-PID задачи использующей таймер C
                                 	.EQU	_C5_MAIN_TIMER_CNTR					= _C5_TIMER_C_PID+0x01
                                 																			;1B-счетчик таймера ядра (каждые 0.000050с)
                                 	.EQU	_C5_MAIN_TIMER_TRHLD					= _C5_MAIN_TIMER_CNTR+0x01
                                 																			;1B-порог срабатывания таймера ядра
                                 .IFDEF C5_IN_PORT
                                 	.EQU	_C5_INPUT_BUFFER						= _C5_MAIN_TIMER_TRHLD+0x01
                                 																			;xB-буфер ввода
                                 	.EQU	_C5_INPUT_BUFFER_POS					= _C5_INPUT_BUFFER+INPUT_BUFFER_SIZE
                                 																			;1B-позиция в буфере на свободный элемент
                                 	.EQU	_C5_TIMERS								= _C5_INPUT_BUFFER+INPUT_BUFFER_SIZE+0x01
                                 																			;xB-таблица таймеров
                                 .ELSE
                                 .ENDIF
                                 	.EQU	_C5_TIMERS16							= _C5_TIMERS+TIMERS*_C5_TIMER_STRUCT_SIZE
                                 																			;xB-таблица 16бит таймеров
                                 	.EQU	_C5_IR_VECTORS_TABLE					= _C5_TIMERS16+TIMERS16*_C5_TIMER16_STRUCT_SIZE
                                 																			;xB-таблица прерываний (_C5_IR_QNT*3 для каждого прерывания, исключая RESET)
                                 	.EQU	_C5_DRIVERS_HEADER					= _C5_IR_VECTORS_TABLE+_C5_IR_QNT*3
                                 																			;xB-заголовки драйвера (X=C5_DRIVERS_QNT*_C5_DRIVER_HEADER_SIZE)
                                 	.EQU	_C5_TASKS_HEADER						= _C5_DRIVERS_HEADER+C5_DRIVERS_QNT*_C5_DRIVER_HEADER_SIZE
                                 																			;xB-заголовки задач (X=C5_TASKS_QNT*_C5_TASK_HEADER_SIZE)
                                 	.EQU	_C5_RESOURCE_QUEUE					= _C5_TASKS_HEADER+C5_TASKS_QNT*_C5_TASK_HEADER_SIZE
                                 																			;xB-очередь задач к ресурсам(1B-RES_ID, 1B-TASK_ID...)
                                 	.EQU	C5_BUFFER								= _C5_RESOURCE_QUEUE+_C5_RES_QUEUE_SIZE
                                 	.EQU	_C5_FREE_RAM							= C5_BUFFER+BUFFER_SIZE
                                 	.EQU	_C5_STACK_END							= RAMEND-_C5_STACK_SIZE	;xB-стек ядра, далее буфер, стек задач и выделяемая память
                                 														;TODO проверить что стек не перетирает первый байт буфера
                                 .IF AVRA == 0x01
                                 	.IF BUFFER_SIZE > 0x00
                                 	.ENDIF
                                 	.IF TIMERS_SPEED == TIMERS_SPEED_50US
                                 	.ELSE
                                 	.ENDIF
                                 .ELSE
                                 	.IF TIMERS_SPEED == TIMERS_SPEED_50US
C:\repos\w5277c\core5277\./core/core5277.inc(221): ######## TIMERS NORMAL SPEED
                                 		.MESSAGE "######## TIMERS NORMAL SPEED"
                                 	.ELSE
                                 		.IF TIMERS_SPEED == TIMERS_SPEED_25US
                                 		.ELSE
                                 		.ENDIF
                                 	.ENDIF
                                 .ENDIF
                                 .IF TIMER_C_ENABLE == 0x01
                                 .ENDIF
                                 
                                 ;---REGISTERS--------------------------------------------;r0-r14 выделено для нужд ядра
                                 	.DEF	_RESULT_L								= r0
                                 	.DEF	_RESULT_H								= r1
                                 	;...r2-r6 используются в диспетчере
                                 	.DEF	_C5_DISPATCHER_LOCK_CNTR			= r9				;Счетчик вложенных блокировок диспетчера
                                 	.DEF	_C5_DRIVER_EXEC_ZH					= r10
                                 	.DEF	_C5_DRIVER_EXEC_ZL					= r11
                                 	.DEF	_C5_TEMP_H								= r12
                                 	.DEF	_C5_TEMP_L								= r13
                                 	.DEF	_C5_COREFLAGS							= r14				;Флаги ядра
                                 	.DEF	_PID										= r15				;ИД корневого процесса(обычно задачи)
                                 
                                 
                                 	.INCLUDE	"./mem/ram_copy.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO: убрать 8 из имени у всех 8битных процедур, число нужно только не 8битным процедурам
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_RAM_COPY
                                 .else
                                 .set DEF_RAM_COPY = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./mem/ram_copy.inc(16): included RAM_COPY
                                 .message "included RAM_COPY"
                                 .endif
                                 
                                 .include	"./mem/ram_copy16.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;15.08.2020	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_RAM_COPY16
                                 .else
                                 .set DEF_RAM_COPY16 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./mem/ram_copy16.inc(15): included RAM_COPY16
                                 .message "included RAM_COPY16"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 RAM_COPY16:
                                 ;--------------------------------------------------------
                                 ;Копирование блока памяти
                                 ;IN: X-SRC адрес, Z-DST адрес,
                                 ;TEMP_H,TEMP_L-длина(1-65535,0=65536)
                                 ;--------------------------------------------------------
000049 93bf
00004a 93af                      	PUSH_X
00004b 93df
00004c 93cf                      	PUSH_Y
00004d 93ff
00004e 93ef                      	PUSH_Z
00004f 932f                      	PUSH TEMP
                                 
000050 2fd1                      	MOV YH,TEMP_H
000051 2fc0                      	MOV YL,TEMP_L
                                 _RAM_COPY16__LOOP:
000052 912d                      	LD TEMP,X+
000053 9321                      	ST Z+,TEMP
000054 9721                      	SBIW YL,0x01
000055 f7e1                      	BRNE _RAM_COPY16__LOOP
                                 
000056 912f                      	POP TEMP
000057 91ef
000058 91ff                      	POP_Z
000059 91cf
00005a 91df                      	POP_Y
00005b 91af
00005c 91bf                      	POP_X
00005d 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 RAM_COPY:
                                 ;--------------------------------------------------------
                                 ;Копирование блока памяти
                                 ;IN: X-SRC адрес, Z-DST адрес, LOOP_CNTR-длина
                                 ;--------------------------------------------------------
00005e 931f                      	PUSH TEMP_H
00005f 930f                      	PUSH TEMP_L
000060 2711                      	CLR TEMP_H
000061 2f05                      	MOV TEMP_L,LOOP_CNTR
000062 940e 0049                 	MCALL RAM_COPY16
000064 910f                      	POP TEMP_L
000065 911f                      	POP TEMP_H
000066 9508                      	RET
                                 .endif
                                 	.INCLUDE	"./mem/ram_fill16.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			с5
                                 ;15.08.2020	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_RAM_FILL16
                                 .else
                                 .set DEF_RAM_FILL16 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./mem/ram_fill16.inc(15): included RAM_FILL16
                                 .message "included RAM_FILL16"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 RAM_FILL16:
                                 ;--------------------------------------------------------
                                 ;Заполнение блока памяти значением
                                 ;IN: X-адрес, TEMP-значение, TEMP_H/TEMP_L-длина
                                 ;--------------------------------------------------------
000067 93bf
000068 93af                      	PUSH_X
000069 93df
00006a 93cf                      	PUSH_Y
                                 
00006b 2fd1                      	MOV YH,TEMP_H
00006c 2fc0                      	MOV YL,TEMP_L
                                 _RAM_FILL16__LOOP:
00006d 932d                      	ST X+,TEMP
00006e 9721                      	SBIW YL,0x01
00006f f7e9                      	BRNE _RAM_FILL16__LOOP
                                 
000070 91cf
000071 91df                      	POP_Y
000072 91af
000073 91bf                      	POP_X
000074 9508                      	RET
                                 .endif
                                 .if TS_MODE != TS_MODE_NO
                                 	.INCLUDE "./mem/ram_copy_desc.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_RAM_COPY_DESC
                                 .else
                                 .set DEF_RAM_COPY_DESC = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./mem/ram_copy_desc.inc(14): included RAM_COPY_DESC
                                 .message "included RAM_COPY_DESC"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 RAM_COPY_DESC:
                                 ;--------------------------------------------------------
                                 ;Копирование блока памяти(с декрементом смещений)
                                 ;IN: X-SRC адрес, Z-DST адрес, LOOP_CNTR-длина
                                 ;--------------------------------------------------------
000075 93bf
000076 93af                      	PUSH_X
000077 93ff
000078 93ef                      	PUSH_Z
000079 935f                      	PUSH LOOP_CNTR
00007a 932f                      	PUSH TEMP
                                 
00007b 9611                      	ADIW XL,0x01
00007c 9631                      	ADIW ZL,0x01
                                 _RAM_COPY_DESC__LOOP:
00007d 912e                      	LD TEMP,-X
00007e 9322                      	ST -Z,TEMP
00007f 955a                      	DEC LOOP_CNTR
000080 f7e1                      	BRNE _RAM_COPY_DESC__LOOP
                                 
000081 912f                      	POP TEMP
000082 915f                      	POP LOOP_CNTR
000083 91ef
000084 91ff                      	POP_Z
000085 91af
000086 91bf                      	POP_X
000087 9508                      	RET
                                 .endif
                                 	.INCLUDE "./mem/ram_copy16_desc.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;15.08.2020	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_RAM_COPY16_DESC
                                 .else
                                 .set DEF_RAM_COPY16_DESC = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./mem/ram_copy16_desc.inc(15): included RAM_COPY16_DESC
                                 .message "included RAM_COPY16_DESC"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 RAM_COPY16_DESC:
                                 ;--------------------------------------------------------
                                 ;Копирование блока памяти(с декременом смещений)
                                 ;IN: X-SRC адрес, Z-DST адрес,
                                 ;TEMP_H,TEMP_L-длина(1-65535,0=65536)
                                 ;--------------------------------------------------------
000088 93bf
000089 93af                      	PUSH_X
00008a 93df
00008b 93cf                      	PUSH_Y
00008c 93ff
00008d 93ef                      	PUSH_Z
00008e 932f                      	PUSH TEMP
                                 
00008f 2fd1                      	MOV YH,TEMP_H
000090 2fc0                      	MOV YL,TEMP_L
000091 9611                      	ADIW XL,0x01
000092 9631                      	ADIW ZL,0x01
                                 _RAM_COPY16_DESC__LOOP:
000093 912e                      	LD TEMP,-X
000094 9322                      	ST -Z,TEMP
000095 9721                      	SBIW YL,0x01
000096 f7e1                      	BRNE _RAM_COPY16_DESC__LOOP
                                 
000097 912f                      	POP TEMP
000098 91ef
000099 91ff                      	POP_Z
00009a 91cf
00009b 91df                      	POP_Y
00009c 91af
00009d 91bf                      	POP_X
00009e 9508                      	RET
                                 .endif
                                 .endif
                                 	.INCLUDE "./conv/bitnum_to_num.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;28.12.2020	w5277c@gmail.com			;Переделал на табличный вариант
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 .ifdef DEF_BITNUM_TO_NUM
                                 .else
                                 .set DEF_BITNUM_TO_NUM = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./conv/bitnum_to_num.inc(16): included BITNUM_TO_NUM
                                 .message "included BITNUM_TO_NUM"
                                 .endif
                                 
                                 
                                 _BITNUM_TO_NUM_TABLE:
00009f 0201
0000a0 0804
0000a1 2010
0000a2 8040                      	.db	0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80
                                 ;--------------------------------------------------------
                                 BITNUM_TO_NUM:
                                 ;--------------------------------------------------------
                                 ;Номер бита в число(2^n)
                                 ;IN: TEMP-номер бита(0-7)
                                 ;OUT: TEMP-число(1,2,4,8,16,32,64,128)
                                 ;--------------------------------------------------------
0000a3 93ff
0000a4 93ef                      	PUSH_Z										;4
0000a5 e0f1
0000a6 e3ee                      	LDI_Z _BITNUM_TO_NUM_TABLE*2			;2
0000a7 0fe2                      	ADD ZL,TEMP									;1
0000a8 1df7                      	ADC ZH,C0x00								;1
0000a9 9124                      	LPM TEMP,Z									;3
0000aa 91ef
0000ab 91ff                      	POP_Z											;4,total:15t
0000ac 9508                      	RET
                                 .endif
                                 
                                 .IFDEF C5_IN_PORT
                                 	.INCLUDE "./core/ui/input.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;29.01.2021  w5277c@gmail.com			Начало
                                 ;09.02.2021  w5277c@gmail.com			Поддержка фонового режима (буфер в 1 байт)
                                 ;08.04.2021  w5277c@gmail.com			Новая реализация, использую буфер ввода, не оттестировано
                                 ;09.04.2021  w5277c@gmail.com			Оттестирвано на INT0 и исправлены баги
                                 ;12.04.2021  w5277c@gmail.com			Оттестирвана программаня часть и исправлены баги
                                 ;22.04.2021  w5277c@gmail.com			Реализовано чтение непрерывного блока данных(COPY/PASTE), оттестировано на INT0
                                 ;05.09.2021	w5277c@gmail.com			INPUT_PORT->C5_IN_PORT
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;Читаем с порта UART последовательность, BAUDRATE идентичен логированию.
                                 ;Если порт поддержтвает внешние прерывания(INT0,...), то при ожидании старта прерывания будут разрешены,
                                 ;диспетчер также не блокируется, т.е. многопоточность не нарушается.
                                 ;Если порт не поддерживает внешние прерывания, то периодически выполняется проверка на UART START.
                                 ;Механизм без прерываний не надежен, может пропускать некоторые символы.
                                 ;Функционал имеет наивысший приоритет, т.е. при передаче по UART последовательности без пауз не выполняется ни одно
                                 ;прерывание, в качестве решения можно задать 2 для INPUT_BUFFER_SIZE(при TIMERS_SPEED_25US теряем 1 тик).
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef C5_IN_PORT
                                 .ifdef DEF_INPUT
                                 .else
                                 .set DEF_INPUT = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/ui/input.inc(26): included IN v0.2
                                 .message "included IN v0.2"
                                 .endif
                                 
                                 .include	"./core/wait.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019  w5277c@gmail.com			Начало
                                 ;09.08.2020  w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_WAIT
                                 .else
                                 .set DEF_C5_WAIT = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/wait.inc(13): included C5_WAIT
                                 .message "included C5_WAIT"
                                 .endif
                                 
                                 .include "./core/wait_2ms.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;09.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;22.01.2020	w5277c@gmail.com			Учет CORE_FREQ
                                 ;31.05.2021	w5277c@gmail.com			Реализация на таймере
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_WAIT_2MS
                                 .else
                                 .set DEF_C5_WAIT_2MS = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/wait_2ms.inc(15): included C5_WAIT_2MS
                                 .message "included C5_WAIT_2MS"
                                 .endif
                                 
                                 ;TODO TIMER_MARK?
                                 ;--------------------------------------------------------
                                 C5_WAIT_2MS:
                                 ;--------------------------------------------------------
                                 ;Ждем истечения времени с момента прошлого сна или
                                 ;с момента вызова C5_TIMER_MARK
                                 ;IN TEMP_H,TEMP_L,TEMP - время в 0.002s
                                 ;--------------------------------------------------------
                                 .if TS_MODE == TS_MODE_TIME
                                 .else
0000ad 931f                      	PUSH TEMP_H
0000ae 930f                      	PUSH TEMP_L
0000af 932f                      	PUSH TEMP
0000b0 938f                      	PUSH ACCUM
0000b1 936f                      	PUSH FLAGS
                                 
0000b2 9180 0104                 	LDS ACCUM,_C5_UPTIME+0x04
                                 C5_WAIT_2MS__LOOP:
0000b4 9160 0104                 	LDS FLAGS,_C5_UPTIME+0x04
0000b6 1b68                      	SUB FLAGS,ACCUM
0000b7 f3e1                      	BREQ C5_WAIT_2MS__LOOP
                                 
0000b8 9180 0104                 	LDS ACCUM,_C5_UPTIME+0x04
0000ba 1b26                      	SUB TEMP,FLAGS
0000bb 0907                      	SBC TEMP_L,C0x00
0000bc 0917                      	SBC TEMP_H,C0x00
0000bd f7b0                      	BRCC C5_WAIT_2MS__LOOP
                                 
0000be 916f                      	POP FLAGS
0000bf 918f                      	POP ACCUM
0000c0 912f                      	POP TEMP
0000c1 910f                      	POP TEMP_L
0000c2 911f                      	POP TEMP_H
                                 .endif
0000c3 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_WAIT:
                                 ;--------------------------------------------------------
                                 ;Ждем 3 кванта времени
                                 ;--------------------------------------------------------
0000c4 931f                      	PUSH TEMP_H
                                 	;Не делаем WAIT если диспетчер заблокирован
0000c5 e010                      	LDI TEMP_H,0x00
0000c6 1691                      	CP _C5_DISPATCHER_LOCK_CNTR,TEMP_H
0000c7 f449                      	BRNE _C5_WAIT__DISPATCHER_LOCKED
0000c8 930f                      	PUSH TEMP_L
0000c9 932f                      	PUSH TEMP
0000ca e010                      	LDI TEMP_H,0x00
0000cb e000                      	LDI TEMP_L,0x00
0000cc e023                      	LDI TEMP,0x03
0000cd 940e 00ad                 	MCALL C5_WAIT_2MS
0000cf 912f                      	POP TEMP
0000d0 910f                      	POP TEMP_L
                                 _C5_WAIT__DISPATCHER_LOCKED:
0000d1 911f                      	POP TEMP_H
0000d2 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_INPUT_INIT:
                                 ;--------------------------------------------------------
0000d3 938f                      	PUSH ACCUM
0000d4 93ff
0000d5 93ef                      	PUSH_Z
                                 
0000d6 d023                      	RCALL C5_INPUT_CLEAR
                                 
0000d7 e0f0                      	LDI ZH,high(PORTS_TABLE*2+((C5_IN_PORT>>4)*0x03+0x01))
0000d8 e6ef                      	LDI ZL,low(PORTS_TABLE*2+((C5_IN_PORT>>4)*0x03+0x01))
0000d9 91e4                      	LPM ZL,Z
0000da 27ff                      	CLR ZH
0000db 8180                      	LD ACCUM,Z
0000dc 7d8f                      	ANDI ACCUM,~(EXP2(C5_IN_PORT & 0x0f))
0000dd 8380                      	ST Z,ACCUM
                                 
0000de e0f0                      	LDI ZH,high(PORTS_TABLE*2+((C5_IN_PORT>>4)*0x03))
0000df e6ee                      	LDI ZL,low(PORTS_TABLE*2+((C5_IN_PORT>>4)*0x03))
0000e0 91e4                      	LPM ZL,Z
0000e1 27ff                      	CLR ZH
0000e2 8180                      	LD ACCUM,Z
0000e3 6280                      	ORI ACCUM,EXP2(C5_IN_PORT & 0x0f)
0000e4 8380                      	ST Z,ACCUM
                                 
                                 .IF	C5_IN_PORT == INT0_PORT || C5_IN_PORT == INT1_PORT || C5_IN_PORT == INT2_PORT || C5_IN_PORT == INT3_PORT || C5_IN_PORT == INT4_PORT || C5_IN_PORT == INT5_PORT || C5_IN_PORT == INT6_PORT || C5_IN_PORT == INT7_PORT
                                 .IF	C5_IN_PORT == INT0_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT1_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT2_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT3_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT4_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT5_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT6_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT7_PORT
                                 .ENDIF
                                 .ENDIF
0000e5 91ef
0000e6 91ff                      	POP_Z
0000e7 918f                      	POP ACCUM
0000e8 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_INPUT_GET:
                                 ;--------------------------------------------------------
                                 ;Извлекаем символ из буфера
                                 ;OUT: TEMP-символ
                                 ;--------------------------------------------------------
0000e9 940e 0100                 	MCALL _C5_INPUT_SHIFT
                                 .IF	C5_IN_PORT != INT0_PORT && C5_IN_PORT != INT1_PORT && C5_IN_PORT != INT2_PORT && C5_IN_PORT != INT3_PORT && C5_IN_PORT != INT4_PORT && C5_IN_PORT != INT5_PORT && C5_IN_PORT != INT6_PORT && C5_IN_PORT != INT7_PORT
0000eb 3020                      	CPI TEMP,0x00
0000ec f421                      	BRNE _C5_INPUT_GET__END
0000ed 940e 0120                 	MCALL _C5_INPUT_READ_BYTES
0000ef 940e 0100                 	MCALL _C5_INPUT_SHIFT
                                 _C5_INPUT_GET__END:
                                 .ENDIF
0000f1 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_INPUT_WAIT:
                                 ;--------------------------------------------------------
                                 ;Ожидаем и извлекаем символ из буфера
                                 ;OUT: TEMP-символ
                                 ;--------------------------------------------------------
                                 _C5_INPUT_WAIT__LOOP:
0000f2 940e 0100                 	MCALL _C5_INPUT_SHIFT
0000f4 3020                      	CPI TEMP,0x00
0000f5 f419                      	BRNE _C5_INPUT_WAIT_DONE
                                 .IF	C5_IN_PORT == INT0_PORT || C5_IN_PORT == INT1_PORT || C5_IN_PORT == INT2_PORT || C5_IN_PORT == INT3_PORT || C5_IN_PORT == INT4_PORT || C5_IN_PORT == INT5_PORT || C5_IN_PORT == INT6_PORT || C5_IN_PORT == INT7_PORT
                                 .ELSE
0000f6 940e 0120                 	MCALL _C5_INPUT_READ_BYTES
                                 .ENDIF
0000f8 cff9                      	RJMP _C5_INPUT_WAIT__LOOP
                                 _C5_INPUT_WAIT_DONE:
0000f9 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_INPUT_CLEAR:
                                 ;--------------------------------------------------------
                                 ;Очищаем буфер
                                 ;--------------------------------------------------------
0000fa 932f                      	PUSH TEMP
                                 
0000fb e020                      	LDI TEMP,0x00
0000fc 9320 0192                 	STS _C5_INPUT_BUFFER_POS,TEMP
                                 
0000fe 912f                      	POP TEMP
0000ff 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _C5_INPUT_SHIFT:
                                 ;--------------------------------------------------------
                                 ;Сдвигаем данные в буфере
                                 ;OUT: TEMP-первый символ
                                 ;--------------------------------------------------------
000100 93ff
000101 93ef                      	PUSH_Z
000102 938f                      	PUSH ACCUM
000103 935f                      	PUSH LOOP_CNTR
                                 
000104 9180 005f                 	LDS ACCUM,SREG
000106 938f                      	PUSH ACCUM
000107 94f8                      	CLI
                                 
000108 e020                      	LDI TEMP,0x00
000109 9150 0192                 	LDS LOOP_CNTR,_C5_INPUT_BUFFER_POS
00010b 3050                      	CPI LOOP_CNTR,0x00
00010c f059                      	BREQ _C5_INPUT_SHIFT__END
00010d 2f85                      	MOV ACCUM,LOOP_CNTR
00010e 958a                      	DEC ACCUM
00010f 9380 0192                 	STS _C5_INPUT_BUFFER_POS,ACCUM
000111 e0f1
000112 e1e2                      	LDI_Z _C5_INPUT_BUFFER
000113 8120                      	LD TEMP,Z
                                 _C5_INPUT_SHIFT__LOOP:
000114 8181                      	LDD ACCUM,Z+0x01
000115 9381                      	ST Z+,ACCUM
000116 955a                      	DEC LOOP_CNTR
000117 f7e1                      	BRNE _C5_INPUT_SHIFT__LOOP
                                 
                                 _C5_INPUT_SHIFT__END:
000118 918f                      	POP ACCUM
000119 9380 005f                 	STS SREG,ACCUM
00011b 915f                      	POP LOOP_CNTR
00011c 918f                      	POP ACCUM
00011d 91ef
00011e 91ff                      	POP_Z
00011f 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _C5_INPUT_READ_BYTES:
                                 ;--------------------------------------------------------
                                 ;Ожидаем бит START UART'а
                                 ;--------------------------------------------------------
                                 .IF	C5_IN_PORT != INT0_PORT && C5_IN_PORT != INT1_PORT && C5_IN_PORT != INT2_PORT && C5_IN_PORT != INT3_PORT && C5_IN_PORT != INT4_PORT && C5_IN_PORT != INT5_PORT && C5_IN_PORT != INT6_PORT && C5_IN_PORT != INT7_PORT
000120 932f                      	PUSH TEMP
000121 938f                      	PUSH ACCUM
000122 93ff
000123 93ef                      	PUSH_Z
000124 93df
000125 93cf                      	PUSH_Y
                                 
000126 e0f0                      	LDI ZH,high(PORTS_TABLE*2+(((C5_IN_PORT>>4)*0x03)+0x02))
000127 e7e0                      	LDI ZL,low(PORTS_TABLE*2+(((C5_IN_PORT>>4)*0x03)+0x02))
000128 91e4                      	LPM ZL,Z
000129 27ff                      	CLR ZH
                                 
00012a 94f8                      	CLI
00012b efdf
00012c efcf                      	LDI_Y 0xffff
                                 _C5_INPUT_READ_BYTES__LOOP:
00012d 9721                      	SBIW YL,0x01
00012e f0a1                      	BREQ _C5_INPUT_READ_BYTES__DONE
00012f 8120                      	LD TEMP,Z
000130 7220                      	ANDI TEMP,EXP2 (C5_IN_PORT & 0x0f)
000131 f7d9                      	BRNE _C5_INPUT_READ_BYTES__LOOP
                                 
000132 e0d0
000133 e2c0                      	LDI_Y 0x0020
                                 
000134 e181                      	LDI ACCUM,0x11
000135 958a                      	DEC ACCUM
000136 f7f1                      	BRNE PC-0x01
                                 
000137 93ff
000138 93ef                      	PUSH_Z
000139 940e 014b                 	MCALL _C5_INPUT_READ_PACKET
00013b 91ef
00013c 91ff                      	POP_Z
                                 
00013d 3020                      	CPI TEMP,0x00
00013e f021                      	BREQ _C5_INPUT_READ_BYTES__DONE
00013f 9180 0191                 	LDS ACCUM,_C5_INPUT_BUFFER+INPUT_BUFFER_SIZE-0x01
000141 3080                      	CPI ACCUM,0x00
000142 f351                      	BREQ _C5_INPUT_READ_BYTES__LOOP
                                 _C5_INPUT_READ_BYTES__DONE:
                                 
000143 91cf
000144 91df                      	POP_Y
000145 91ef
000146 91ff                      	POP_Z
000147 918f                      	POP ACCUM
000148 912f                      	POP TEMP
000149 9508                      	RET
                                 .ENDIF
00014a 9508                      	RET
                                 ;--------------------------------------------------------
                                 _C5_INPUT_READ_PACKET:
                                 ;--------------------------------------------------------
                                 ;Читаем биты данных и проверям STOP бит UART'а
                                 ;OUT:TEMP последний считанный символ
                                 ;--------------------------------------------------------
00014b 935f                      	PUSH LOOP_CNTR
00014c 938f                      	PUSH ACCUM
00014d 937f                      	PUSH TRY_CNTR
                                 
00014e 9170 0192                 	LDS TRY_CNTR,_C5_INPUT_BUFFER_POS
                                 _C5_INPUT_READ_PACKET__BYTES_LOOP:
                                 	;DATA BITS
000150 e058                      	LDI LOOP_CNTR,0x08
                                 _C5_INPUT_READ_PACKET__BITES_LOOP:
000151 8180                      	LD ACCUM,Z
000152 9526                      	LSR TEMP
000153 0000                      	NOP
000154 0000                      	NOP
000155 0000                      	NOP
000156 0000                      	NOP
000157 7280                      	ANDI ACCUM,EXP2 (C5_IN_PORT & 0x0f)
000158 f009                      	BREQ PC+0x02
000159 6820                      	ORI TEMP,0x80
                                 	;WAIT
00015a e183                      	LDI ACCUM,0x13
00015b 958a                      	DEC ACCUM
00015c f7f1                      	BRNE PC-0x01
                                 
00015d 955a                      	DEC LOOP_CNTR
00015e f791                      	BRNE _C5_INPUT_READ_PACKET__BITES_LOOP
                                 	;STOP BIT
00015f 8180                      	LD ACCUM,Z
000160 7280                      	ANDI ACCUM,EXP2 (C5_IN_PORT & 0x0f)
000161 f0c9                      	BREQ _C5_INPUT_READ_PACKET__DONE
                                 
000162 3870                      	CPI TRY_CNTR,INPUT_BUFFER_SIZE
000163 f0b1                      	BREQ _C5_INPUT_READ_PACKET__ERROR
000164 e0f1
000165 e1e2                      	LDI_Z _C5_INPUT_BUFFER
000166 0fe7                      	ADD ZL,TRY_CNTR
000167 2788                      	CLR ACCUM
000168 1ff8                      	ADC ZH,ACCUM
000169 8320                      	ST Z,TEMP
00016a 9573                      	INC TRY_CNTR
                                 
00016b e0f0                      	LDI ZH,high(PORTS_TABLE*2+(((C5_IN_PORT>>4)*0x03)+0x02))
00016c e7e0                      	LDI ZL,low(PORTS_TABLE*2+(((C5_IN_PORT>>4)*0x03)+0x02))
00016d 91e4                      	LPM ZL,Z
00016e 27ff                      	CLR ZH
                                 
00016f e05a                      	LDI LOOP_CNTR,0x0a
                                 _C5_INPUT_READ_PACKET__NEXT_START_WAIT:
000170 8180                      	LD ACCUM,Z
000171 7280                      	ANDI ACCUM,EXP2 (C5_IN_PORT & 0x0f)
000172 f019                      	BREQ _C5_INPUT_READ_PACKET__GOT_NEXT_START
000173 955a                      	DEC LOOP_CNTR
000174 f7d9                      	BRNE _C5_INPUT_READ_PACKET__NEXT_START_WAIT
000175 c005                      	RJMP _C5_INPUT_READ_PACKET__DONE
                                 _C5_INPUT_READ_PACKET__GOT_NEXT_START:
                                 	;WAIT
000176 e186                      	LDI ACCUM,0x16;0x13
000177 958a                      	DEC ACCUM
000178 f7f1                      	BRNE PC-0x01
000179 cfd6                      	RJMP _C5_INPUT_READ_PACKET__BYTES_LOOP
                                 _C5_INPUT_READ_PACKET__ERROR:
00017a e020                      	LDI TEMP,0x00
                                 _C5_INPUT_READ_PACKET__DONE:
00017b 9370 0192                 	STS _C5_INPUT_BUFFER_POS,TRY_CNTR
00017d 917f                      	POP TRY_CNTR
00017e 918f                      	POP ACCUM
00017f 915f                      	POP LOOP_CNTR
000180 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _C5_INPUT_INT_HANDLER:
                                 ;--------------------------------------------------------
                                 ;Обработчик внешнего прерывания
                                 ;--------------------------------------------------------
                                 
000181 932f                      	PUSH TEMP
000182 9120 005f                 	LDS TEMP,SREG
000184 94f8                      	CLI
                                 
000185 93ff
000186 93ef                      	PUSH_Z
000187 932f                      	PUSH TEMP
000188 e0f0
000189 e7e0                      	LDI_Z PORTS_TABLE*2+(((C5_IN_PORT>>4)*0x03)+0x02)
00018a 91e4                      	LPM ZL,Z
00018b 27ff                      	CLR ZH
                                 
00018c 940e 014b                 	MCALL _C5_INPUT_READ_PACKET
                                 
00018e 9120 003c                 	LDS TEMP,EIFR
                                 .IF	C5_IN_PORT == INT0_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT1_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT2_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT3_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT4_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT5_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT6_PORT
                                 .ENDIF
                                 .IF	C5_IN_PORT == INT7_PORT
                                 .ENDIF
000190 9320 003c                 	STS EIFR,TEMP
                                 
000192 912f                      	POP TEMP
000193 91ef
000194 91ff                      	POP_Z
                                 
000195 9320 005f                 	STS SREG,TEMP
000197 912f                      	POP TEMP
000198 9508                      	RET
                                 .ENDIF
                                 .ENDIF
                                 .ENDIF
                                 
                                 ;---OPTIONS-ANALYZE--------------------------------------
                                 .IF AVRA == 0x01
                                 .ENDIF
                                 ;TODO unexpected INTEGER, expecting STRING in AtmelStudio
                                 ; 	.MESSAGE 28800*CORE_FREQ
                                 .IFDEF LOGGING_PORT
C:\repos\w5277c\core5277\./core/core5277.inc(265): ######## LOGGING ENABLED
                                 	.MESSAGE "######## LOGGING ENABLED"
                                 	OUTSTR_CORE:
000199 0a0d
00019a 6f50
00019b 6577
00019c 6572
00019d 2064
00019e 7962
00019f 6320
0001a0 726f
0001a1 3565
0001a2 3732
0001a3 2037
0001a4 3076
0001a5 342e
0001a6 322e
0001a7 5b20
0001a8 0000                      	.db   0x0d,0x0a,"Powered by core5277 v0.4.2 [",0x00,0x00
                                 	OUTSTR_MCUSR_NO:
0001a9 4f4e
0001aa 0020                      	.db   "NO ",0x00
                                 	OUTSTR_MCUSR_WD:
0001ab 4457
0001ac 0020                      	.db   "WD ",0x00
                                 	OUTSTR_MCUSR_BO:
0001ad 4f42
0001ae 0020                      	.db   "BO ",0x00
                                 	OUTSTR_MCUSR_EX:
0001af 5845
0001b0 0020                      	.db   "EX ",0x00
                                 	OUTSTR_MCUSR_PO:
0001b1 4f50
0001b2 0020                      	.db   "PO ",0x00
                                 	OUTSTR_MCUSR_RESET:
0001b3 6572
0001b4 6573
0001b5 5d74
0001b6 0a0d
0001b7 0000                      	.db   "reset]",0x0d,0x0a,0x00,0x00
                                 
                                 	.INCLUDE "./core/io/out_init.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;02.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_INIT
                                 .else
                                 .set DEF_C5_OUT_INIT = 1
                                 .ifdef LOGGING_PORT
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_INIT:
                                 ;--------------------------------------------------------
                                 ;Инициализация порта логирования
                                 ;--------------------------------------------------------
0001b8 93ff
0001b9 93ef                      	PUSH_Z
0001ba 938f                      	PUSH ACCUM
                                 
0001bb e0f0
0001bc e6ee                      	LDI_Z (PORTS_TABLE*2+((LOGGING_PORT>>4)*0x03))
0001bd 91e4                      	LPM ZL,Z
0001be 27ff                      	CLR ZH
0001bf 8180                      	LD ACCUM,Z
0001c0 6180                      	ORI ACCUM,EXP2(LOGGING_PORT & 0x0f)
0001c1 8380                      	ST Z,ACCUM
                                 
0001c2 e0f0
0001c3 e6ef                      	LDI_Z (PORTS_TABLE*2+((LOGGING_PORT>>4)*0x03+0x01))
0001c4 91e4                      	LPM ZL,Z
0001c5 27ff                      	CLR ZH
0001c6 8180                      	LD ACCUM,Z
0001c7 6180                      	ORI ACCUM,EXP2(LOGGING_PORT & 0x0f)
0001c8 8380                      	ST Z,ACCUM
                                 
0001c9 918f                      	POP ACCUM
0001ca 91ef
0001cb 91ff                      	POP_Z
0001cc 9508                      	RET
                                 .endif
                                 .endif
                                 	.INCLUDE	"./core/io/out_romstr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com			Начало
                                 ;02.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_ROMSTR
                                 .else
                                 .set DEF_C5_OUT_ROMSTR = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_str.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STR
                                 .else
                                 .set DEF_C5_OUT_STR = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .set DEF_C5_OUT_CHAR = 1
                                 .ifdef LOGGING_PORT
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_CHAR:
                                 ;--------------------------------------------------------
                                 ;Логирование символа
                                 ;IN: TEMP-байт
                                 ;--------------------------------------------------------
0001cd 93ff
0001ce 93ef                      	PUSH_Z
0001cf 938f                      	PUSH ACCUM
0001d0 935f                      	PUSH LOOP_CNTR
0001d1 932f                      	PUSH TEMP
0001d2 936f                      	PUSH FLAGS
                                 
0001d3 e0f0
0001d4 e6ee                      	LDI_Z (PORTS_TABLE*2+((LOGGING_PORT>>4)*0x03))
0001d5 91e4                      	LPM ZL,Z
0001d6 27ff                      	CLR ZH
                                 
0001d7 8180                      	LD ACCUM,Z
0001d8 6180                      	ORI ACCUM,(EXP2 (LOGGING_PORT & 0x0f))
0001d9 8380                      	ST Z,ACCUM
0001da e184                      	LDI ACCUM,0x14;0x08
0001db 958a                      	DEC ACCUM
0001dc f7f1                      	BRNE PC-0x01
                                 
0001dd 9160 005f                 	LDS FLAGS,SREG
0001df 94f8                      	CLI
0001e0 8180                      	LD ACCUM,Z
0001e1 7e8f                      	ANDI ACCUM,~(EXP2 (LOGGING_PORT & 0x0f))
0001e2 8380                      	ST Z,ACCUM
0001e3 e184                      	LDI ACCUM,0x14;0x08
0001e4 958a                      	DEC ACCUM
0001e5 f7f1                      	BRNE PC-0x01
                                 
                                 	;DATA BITS
0001e6 e058                      	LDI LOOP_CNTR,0x08
                                 _C5_OUT_PROC__BITES_LOOP:
                                 
0001e7 8180                      	LD ACCUM,Z
0001e8 fd20                      	SBRC TEMP,0x00
0001e9 6180                      	ORI ACCUM,(EXP2 (LOGGING_PORT & 0x0f))
0001ea ff20                      	SBRS TEMP,0x00
0001eb 7e8f                      	ANDI ACCUM,~(EXP2 (LOGGING_PORT & 0x0f))
0001ec 9526                      	LSR TEMP
0001ed 8380                      	ST Z,ACCUM
                                 
0001ee 0000                      	NOP
0001ef e183                      	LDI ACCUM,0x13;0x07
0001f0 958a                      	DEC ACCUM
0001f1 f7f1                      	BRNE PC-0x01
0001f2 955a                      	DEC LOOP_CNTR
0001f3 f799                      	BRNE _C5_OUT_PROC__BITES_LOOP
                                 	;STOP
0001f4 8180                      	LD ACCUM,Z
0001f5 6180                      	ORI ACCUM,(EXP2 (LOGGING_PORT & 0x0f))
0001f6 8380                      	ST Z,ACCUM
                                 
0001f7 9360 005f                 	STS SREG,FLAGS
0001f9 916f                      	POP FLAGS
0001fa 912f                      	POP TEMP
0001fb 915f                      	POP LOOP_CNTR
0001fc 918f                      	POP ACCUM
0001fd 91ef
0001fe 91ff                      	POP_Z
0001ff 9508                      	RET
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_STR:
                                 ;--------------------------------------------------------
                                 ;Логирование строки, конец определяется по 0x00
                                 ;IN: Z-адрес на строку(15-ый бит false-RAM, true-ROM)
                                 ;--------------------------------------------------------
000200 932f                      	PUSH TEMP
000201 93ff
000202 93ef                      	PUSH_Z
000203 938f                      	PUSH ACCUM
                                 
                                 	;Умножаем на 2 адрес рабоыт с ROM
000204 fff7                      	SBRS ZH,0x07
000205 c003                      	RJMP PC+0x04
000206 0fee                      	LSL ZL
000207 1fff                      	ROL ZH
000208 68f0                      	ORI ZH,0x80
000209 2f8f                      	MOV ACCUM,ZH
00020a 77ff                      	ANDI ZH,0x7f
                                 _C5_OUT_STR__LOG_STR_EL_CODEPOINT:
                                 _C5_OUT_STR__BYTES_LOOP:
                                 	;Считываем байт
00020b ff87                      	SBRS ACCUM,0x07
00020c 9121                      	LD TEMP,Z+
00020d fd87                      	SBRC ACCUM,0x07
00020e 9125                      	LPM TEMP,Z+
00020f 3020                      	CPI TEMP,0x00
000210 f019                      	BREQ _C5_OUT_STR__END
000211 940e 01cd                 	MCALL C5_OUT_CHAR
000213 cff7                      	RJMP _C5_OUT_STR__BYTES_LOOP
                                 
                                 _C5_OUT_STR__END:
000214 918f                      	POP ACCUM
000215 91ef
000216 91ff                      	POP_Z
000217 912f                      	POP TEMP
000218 9508                      	RET
                                 .endif
                                 .endif
                                 
                                 .MACRO C5_OUT_ROMSTR
                                 	PUSH_Z
                                 	LDI_Z @0|0x8000
                                 	MCALL C5_OUT_STR
                                 	POP_Z
                                 .ENDMACRO
                                 .endif
                                 .endif
                                 	.INCLUDE	"./core/io/out_tasksdump.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;02.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;30.08.2020	w5277c@gmail.com        Устранены основные ошибки
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_TASKSDUMP
                                 .else
                                 .set DEF_C5_OUT_TASKSDUMP = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_taskdump.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;30.08.2020	w5277c@gmail.com        Начало
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_TASKDUMP
                                 .else
                                 .set DEF_C5_OUT_TASKDUMP = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_byte.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTE
                                 .else
                                 .set DEF_C5_OUT_BYTE = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./conv/byte_to_hex.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019  w5277c@gmail.com			Начало
                                 ;01.08.2020  w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020  w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_BYTE_TO_HEX
                                 .else
                                 .set DEF_BYTE_TO_HEX = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./conv/byte_to_hex.inc(14): included BYTE_TO_HEX
                                 .message "included BYTE_TO_HEX"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 BYTE_TO_HEX:
                                 ;--------------------------------------------------------
                                 ;Конвертирование байта в HEX(два ASCII символа)
                                 ;IN: TEMP - байт
                                 ;OUT: TEMP_H,TEMP_L - ASCII
                                 ;--------------------------------------------------------
000219 2f02                      	MOV TEMP_L,TEMP
00021a 700f                      	ANDI TEMP_L,0x0f
00021b 300a                      	CPI TEMP_L,0x0a
00021c f008                      	BRCS PC+0x02
00021d 5f09                      	SUBI TEMP_L,(0x100-0x07)											;+0x07
00021e 5d00                      	SUBI TEMP_L,(0x100-0x30)											;+0x30
00021f 2f12                      	MOV TEMP_H,TEMP
000220 9512                      	SWAP TEMP_H
000221 701f                      	ANDI TEMP_H,0x0f
000222 301a                      	CPI TEMP_H,0x0a
000223 f008                      	BRCS PC+0x02
000224 5f19                      	SUBI TEMP_H,(0x100-0x07)											;+0x07
000225 5d10                      	SUBI TEMP_H,(0x100-0x30)											;+0x30
000226 9508                      	RET
                                 .endif
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_BYTE:
                                 ;--------------------------------------------------------
                                 ;Логирование байта
                                 ;IN: TEMP-байт
                                 ;--------------------------------------------------------
000227 932f                      	PUSH TEMP
000228 931f                      	PUSH TEMP_H
000229 930f                      	PUSH TEMP_L
                                 
00022a 940e 0219                 	MCALL BYTE_TO_HEX
00022c 2f21                      	MOV TEMP,TEMP_H
00022d 940e 01cd                 	MCALL C5_OUT_CHAR
00022f 2f20                      	MOV TEMP,TEMP_L
000230 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
000232 910f                      	POP TEMP_L
000233 911f                      	POP TEMP_H
000234 912f                      	POP TEMP
000235 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_word.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_WORD
                                 .else
                                 .set DEF_C5_OUT_WORD = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_byte.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTE
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_WORD:
                                 ;--------------------------------------------------------
                                 ;Логирование слова как HEX строки
                                 ;IN: TEMP_H/TEMP_L-слово
                                 ;--------------------------------------------------------
000236 932f                      	PUSH TEMP
000237 2f21                      	MOV TEMP,TEMP_H
000238 940e 0227                 	MCALL C5_OUT_BYTE
00023a 2f20                      	MOV TEMP,TEMP_L
00023b 940e 0227                 	MCALL C5_OUT_BYTE
00023d 912f                      	POP TEMP
00023e 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_romstr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com			Начало
                                 ;02.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_ROMSTR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_cr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CR
                                 .else
                                 .set DEF_C5_OUT_CR = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_CR:
                                 ;--------------------------------------------------------
                                 ;Перевод на новую строку
                                 ;--------------------------------------------------------
00023f 932f                      	PUSH TEMP
000240 e02d                      	LDI TEMP,0x0d
000241 940e 01cd                 	MCALL C5_OUT_CHAR
000243 e02a                      	LDI TEMP,0x0a
000244 940e 01cd                 	MCALL C5_OUT_CHAR
000246 912f                      	POP TEMP
000247 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_stackdump.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.09.2020	w5277c@gmail.com        Начало
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STACKDUMP
                                 .else
                                 .set DEF_C5_OUT_STACKDUMP = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_byte.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTE
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_word.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_WORD
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_romstr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com			Начало
                                 ;02.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_ROMSTR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 _OUTSTR_INVALID:
000248 4e49
000249 4156
00024a 494c
00024b 0044                      	.db   "INVALID",0x00
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_STACKDUMP:
                                 ;--------------------------------------------------------
                                 ;Логирование информации о задаче
                                 ;IN: Z-адрес на заголовок задачи
                                 ;--------------------------------------------------------
00024c 932f                      	PUSH TEMP
00024d 935f                      	PUSH LOOP_CNTR
00024e 93ff                      	PUSH ZH
00024f 93ef                      	PUSH ZL
                                 
000250 8156                      	LDD LOOP_CNTR,Z+_C5_TASK_STACK_SIZE
000251 8125                      	LDD TEMP,Z+_C5_TASK_STACK_OFFSET+0x01
000252 81f4                      	LDD ZH,Z+_C5_TASK_STACK_OFFSET+0x00
000253 2fe2                      	MOV ZL,TEMP
                                 
000254 3050                      	CPI LOOP_CNTR,0x00
000255 f119                      	BREQ _C5_OUT_STACKDUMP__END
                                 
000256 30f8                      	CPI ZH,high(_C5_STACK_END)
000257 f020                      	BRCS PC+0x05
000258 f491                      	BRNE _C5_OUT_STACKDUMP__INVALID
000259 3bef                      	CPI ZL,low(_C5_STACK_END)
00025a f008                      	BRCS PC+0x02
00025b f479                      	BRNE _C5_OUT_STACKDUMP__INVALID
00025c 30f5                      	CPI ZH,high(_C5_FREE_RAM)
00025d f068                      	BRCS _C5_OUT_STACKDUMP__INVALID
00025e f411                      	BRNE PC+0x03
00025f 31e1                      	CPI ZL,low(_C5_FREE_RAM)
000260 f050                      	BRCS _C5_OUT_STACKDUMP__INVALID
                                 
000261 e52b                      	LDI TEMP,'['
000262 940e 01cd                 	MCALL C5_OUT_CHAR
000264 9121                      	LD TEMP,Z+
                                 _C5_OUT_STACKDUMP__LOOP:
000265 9122                      	LD TEMP,-Z
000266 940e 0227                 	MCALL C5_OUT_BYTE
000268 955a                      	DEC LOOP_CNTR
000269 f7d9                      	BRNE _C5_OUT_STACKDUMP__LOOP
00026a c00b                      	RJMP _C5_OUT_STACKDUMP__DONE
                                 
                                 _C5_OUT_STACKDUMP__INVALID:
00026b e52b                      	LDI TEMP,'['
00026c 940e 01cd                 	MCALL C5_OUT_CHAR
00026e 93ff
00026f 93ef
000270 e8f2
000271 e4e8
000272 940e 0200
000274 91ef
000275 91ff                      	C5_OUT_ROMSTR _OUTSTR_INVALID
                                 
                                 _C5_OUT_STACKDUMP__DONE:
000276 e52d                      	LDI TEMP,']'
000277 940e 01cd                 	MCALL C5_OUT_CHAR
                                 _C5_OUT_STACKDUMP__END:
000279 91ef                      	POP ZL
00027a 91ff                      	POP ZH
00027b 915f                      	POP LOOP_CNTR
00027c 912f                      	POP TEMP
00027d 9508                      	RET
                                 .endif
                                 .endif
                                 
                                 _OUTSTR_TID:
00027e 4954
00027f 3a44
000280 0000                      	.db   "TID:",0x00,0x00
                                 _OUTSTR_STATE:
000281 5453
000282 3a41
000283 0000                      	.db   "STA:",0x00,0x00
                                 _OUTSTR_RAM:
000284 4152
000285 3a4d
000286 0000                      	.db   "RAM:",0x00,0x00
                                 _OUTSTR_TIME:
000287 4954
000288 3a4d
000289 0000                      	.db   "TIM:",0x00,0x00
                                 _OUTSTR_STACK:
00028a 5453
00028b 3a4b
00028c 0000                      	.db   "STK:",0x00,0x00
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_TASKDUMP:
                                 ;--------------------------------------------------------
                                 ;Логирование информации о задаче
                                 ;IN: PID
                                 ;--------------------------------------------------------
00028d 932f                      	PUSH TEMP
00028e 931f                      	PUSH TEMP_H
00028f 930f                      	PUSH TEMP_L
000290 93ff
000291 93ef                      	PUSH_Z
                                 
000292 940e 061d                 	MCALL _C5_PROC_HEADER_GET
000294 8120                      	LDD TEMP,Z+_C5_PROC_STATE
000295 702f                      	ANDI TEMP,0x0f
000296 3020                      	CPI TEMP,_C5_PROC_STATE_ABSENT
000297 f409                      	BRNE PC+0x02
000298 c05d                      	RJMP _C5_OUT_TASKDUMP__END
                                 
000299 940e 023f                 	MCALL C5_OUT_CR
                                 
00029b 93ff
00029c 93ef
00029d e8f2
00029e e7ee
00029f 940e 0200
0002a1 91ef
0002a2 91ff                      	C5_OUT_ROMSTR _OUTSTR_TID
0002a3 2f29                      	MOV TEMP,PID
0002a4 940e 0227                 	MCALL C5_OUT_BYTE
0002a6 e220                      	LDI TEMP,' '
0002a7 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
0002a9 8120                      	LDD TEMP,Z+_C5_PROC_STATE
0002aa 93ff
0002ab 93ef
0002ac e8f2
0002ad e8e1
0002ae 940e 0200
0002b0 91ef
0002b1 91ff                      	C5_OUT_ROMSTR _OUTSTR_STATE
0002b2 940e 0227                 	MCALL C5_OUT_BYTE
                                 
0002b4 e220                      	LDI TEMP,' '
0002b5 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
0002b7 8111                      	LDD TEMP_H,Z+_C5_PROC_RAM_OFFSET+0x00
0002b8 8102                      	LDD TEMP_L,Z+_C5_PROC_RAM_OFFSET+0x01
0002b9 8123                      	LDD TEMP,Z+_C5_PROC_RAM_SIZE
0002ba 93ff
0002bb 93ef
0002bc e8f2
0002bd e8e4
0002be 940e 0200
0002c0 91ef
0002c1 91ff                      	C5_OUT_ROMSTR _OUTSTR_RAM
0002c2 940e 0236                 	MCALL C5_OUT_WORD
0002c4 932f                      	PUSH TEMP
0002c5 e22e                      	LDI TEMP,'.'
0002c6 940e 01cd                 	MCALL C5_OUT_CHAR
0002c8 912f                      	POP TEMP
0002c9 940e 0227                 	MCALL C5_OUT_BYTE
0002cb e220                      	LDI TEMP,' '
0002cc 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
0002ce 8510                      	LDD TEMP_H,Z+_C5_TASK_EXECTIME+0x00
0002cf 8501                      	LDD TEMP_L,Z+_C5_TASK_EXECTIME+0x01
0002d0 8522                      	LDD TEMP,Z+_C5_TASK_EXECTIME+0x02
0002d1 93ff
0002d2 93ef
0002d3 e8f2
0002d4 e8e7
0002d5 940e 0200
0002d7 91ef
0002d8 91ff                      	C5_OUT_ROMSTR _OUTSTR_TIME
0002d9 940e 0236                 	MCALL C5_OUT_WORD
0002db 940e 0227                 	MCALL C5_OUT_BYTE
0002dd e220                      	LDI TEMP,' '
0002de 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
0002e0 8114                      	LDD TEMP_H,Z+_C5_TASK_STACK_OFFSET+0x00
0002e1 8105                      	LDD TEMP_L,Z+_C5_TASK_STACK_OFFSET+0x01
0002e2 8126                      	LDD TEMP,Z+_C5_TASK_STACK_SIZE
0002e3 93ff
0002e4 93ef
0002e5 e8f2
0002e6 e8ea
0002e7 940e 0200
0002e9 91ef
0002ea 91ff                      	C5_OUT_ROMSTR _OUTSTR_STACK
0002eb 940e 0236                 	MCALL C5_OUT_WORD
0002ed 932f                      	PUSH TEMP
0002ee e22e                      	LDI TEMP,'.'
0002ef 940e 01cd                 	MCALL C5_OUT_CHAR
0002f1 912f                      	POP TEMP
0002f2 940e 0227                 	MCALL C5_OUT_BYTE
                                 
0002f4 940e 024c                 	MCALL C5_OUT_STACKDUMP
                                 
                                 _C5_OUT_TASKDUMP__END:
0002f6 91ef
0002f7 91ff                      	POP_Z
0002f8 910f                      	POP TEMP_L
0002f9 911f                      	POP TEMP_H
0002fa 912f                      	POP TEMP
0002fb 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_bytes.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;13.09.2020	w5277c@gmail.com        Восстанавливаем Y
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTES
                                 .else
                                 .set DEF_C5_OUT_BYTES = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_byte.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTE
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 ;--------------------------------------------------------
                                 C5_OUT_BYTES:
                                 ;--------------------------------------------------------
                                 ;Логируем блок данных
                                 ;IN: Z-адрес начала блока, TEMP-длина блока
                                 ;--------------------------------------------------------
0002fc 932f                      	PUSH TEMP
0002fd 935f                      	PUSH LOOP_CNTR
0002fe 93ff
0002ff 93ef                      	PUSH_Z
                                 
000300 2f52                      	MOV LOOP_CNTR,TEMP
                                 _C5_OUT_BYTES__LOOP:
000301 9121                      	LD TEMP,Z+
000302 940e 0227                 	MCALL C5_OUT_BYTE
000304 955a                      	DEC LOOP_CNTR
000305 f7d9                      	BRNE _C5_OUT_BYTES__LOOP
                                 
000306 91ef
000307 91ff                      	POP_Z
000308 915f                      	POP LOOP_CNTR
000309 912f                      	POP TEMP
00030a 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_romstr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com			Начало
                                 ;02.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_ROMSTR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/outstr_done.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;02.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUTSTR_DONE
                                 .else
                                 .set DEF_C5_OUTSTR_DONE = 1
                                 .ifdef LOGGING_PORT
                                 
                                 OUTSTR_DONE:
00030b 0a0d
00030c 2d2d
00030d 442d
00030e 4e4f
00030f 0d45
000310 000a                      	.db   0x0d,0x0a,"---DONE",0x0d,0x0a,0x00
                                 .endif
                                 .endif
                                 
                                 _OUTSTR_TASKSDUMP:
000311 0a0d
000312 2d2d
000313 542d
000314 5341
000315 534b
000316 5544
000317 504d
000318 003a                      	.db   0x0d,0x0a,"---TASKSDUMP:",0x00
                                 _OUTSTR_RES_QUEUE:
000319 0a0d
00031a 5152
00031b 3a44
00031c 0000                      	.db   0x0d,0x0a,"RQD:",0x00,0x00
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_TASKSDUMP:
                                 ;--------------------------------------------------------
                                 ;Логирование информации о задачах
                                 ;--------------------------------------------------------
00031d 932f                      	PUSH TEMP
00031e 93ff
00031f 93ef                      	PUSH_Z
000320 939f                      	PUSH PID
                                 
000321 93ff
000322 93ef
000323 e8f3
000324 e1e1
000325 940e 0200
000327 91ef
000328 91ff                      	C5_OUT_ROMSTR _OUTSTR_TASKSDUMP
                                 
                                 ;;TODO вводить причину рестарта
                                 ;;	;Выводим дамп ядра, если перезагрузка не по питанию и не по пину сброса
                                 ;;	IN TEMP,MCUSR
                                 ;;	ANDI TEMP,(1<<BORF)|(1<<EXTRF)|(1<<PORF)
                                 ;;	BRNE PC+0x03
                                 
                                 
000329 93ff
00032a 93ef
00032b e8f3
00032c e1e9
00032d 940e 0200
00032f 91ef
000330 91ff                      	C5_OUT_ROMSTR _OUTSTR_RES_QUEUE
000331 e0f2
000332 efe1                      	LDI_Z _C5_RESOURCE_QUEUE
000333 e220                      	LDI TEMP,_C5_RES_QUEUE_SIZE
000334 940e 02fc                 	MCALL C5_OUT_BYTES
                                 
000336 e090                      	LDI PID,0x00
                                 _C5_OUT_TASKSDUMP__TASK_LOOP:
000337 940e 028d                 	MCALL C5_OUT_TASKDUMP
000339 9593                      	INC PID
00033a 3190                      	CPI PID,C5_TASKS_QNT
00033b f7d9                      	BRNE _C5_OUT_TASKSDUMP__TASK_LOOP
00033c 93ff
00033d 93ef
00033e e8f3
00033f e0eb
000340 940e 0200
000342 91ef
000343 91ff                      	C5_OUT_ROMSTR OUTSTR_DONE
                                 
000344 919f                      	POP PID
000345 91ef
000346 91ff                      	POP_Z
000347 912f                      	POP TEMP
000348 9508                      	RET
                                 .endif
                                 .endif
                                 	.INCLUDE "./core/io/out_corefault.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;02.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_COREFAULT
                                 .else
                                 .set DEF_C5_OUT_COREFAULT = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_byte.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTE
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_word.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_WORD
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_romstr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com			Начало
                                 ;02.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_ROMSTR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 _OUTSTR_COREFAULT:
000349 0a0d
00034a 2d2d
00034b 432d
00034c 524f
00034d 4645
00034e 5541
00034f 544c
000350 202c
000351 4143
000352 4c4c
000353 5245
000354 003a                      	.db 0x0d,0x0a,"---COREFAULT, CALLER:",0x00
                                 _OUTSTR_COREFAULT_TID:
000355 202c
000356 4954
000357 3a44
000358 0000                      	.db ", TID:",0x00,0x00
                                 _OUTSTR_COREFAULT_DID:
000359 202c
00035a 4944
00035b 3a44
00035c 0000                      	.db ", DID:",0x00,0x00
                                 _OUTSTR_CORE_TYPE_0x01:
00035d 202c
00035e 5548
00035f 4547
000360 535f
000361 4154
000362 4b43
000363 202c
000364 4953
000365 455a
000366 003a                      	.db ", HUGE_STACK, SIZE:",0x00
                                 _OUTSTR_CORE_TYPE_0x02:
000367 202c
000368 5548
000369 4547
00036a 545f
00036b 5341
00036c 5f4b
00036d 5453
00036e 4341
00036f 2c4b
000370 4f20
000371 4646
000372 4553
000373 3a54
000374 0000                      	.db ", HUGE_TASK_STACK, OFFSET:",0x00,0x00
                                 _OUTSTR_CORE_TYPE_0x03:
000375 202c
000376 5548
000377 4547
000378 545f
000379 5341
00037a 5f4b
00037b 5453
00037c 4341
00037d 5f4b
00037e 2c32
00037f 4f20
000380 4646
000381 4553
000382 3a54
000383 0000                      	.db ", HUGE_TASK_STACK_2, OFFSET:",0x00,0x00
                                 
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_COREFAULT:
                                 ;--------------------------------------------------------
                                 ;Логирование сбоя
                                 ;IN PID-ид задачи, TEMP-код сбоя,
                                 ;TEMP_H/TEMP_L-размер стека либо его позиция
                                 ;--------------------------------------------------------
000384 94f8                      	CLI
000385 2f41                      	MOV TEMP_EH,TEMP_H
000386 2f30                      	MOV TEMP_EL,TEMP_L
000387 911f                      	POP TEMP_H
000388 910f                      	POP TEMP_L
000389 5002                      	SUBI TEMP_L,0x02
00038a 4010                      	SBCI TEMP_H,0x00
00038b 93ff
00038c 93ef
00038d e8f3
00038e e4e9
00038f 940e 0200
000391 91ef
000392 91ff                      	C5_OUT_ROMSTR _OUTSTR_COREFAULT
000393 940e 0236                 	MCALL C5_OUT_WORD
000395 93ff
000396 93ef
000397 e8f3
000398 e5e5
000399 940e 0200
00039b 91ef
00039c 91ff                      	C5_OUT_ROMSTR _OUTSTR_COREFAULT_TID
00039d 932f                      	PUSH TEMP
00039e 2d2f                      	MOV TEMP,_PID
00039f 940e 0227                 	MCALL C5_OUT_BYTE
0003a1 93ff
0003a2 93ef
0003a3 e8f3
0003a4 e5e9
0003a5 940e 0200
0003a7 91ef
0003a8 91ff                      	C5_OUT_ROMSTR _OUTSTR_COREFAULT_DID
0003a9 2f29                      	MOV TEMP,PID
0003aa 940e 0227                 	MCALL C5_OUT_BYTE
0003ac 912f                      	POP TEMP
0003ad 2f14                      	MOV TEMP_H,TEMP_EH
0003ae 2f03                      	MOV TEMP_L,TEMP_EL
0003af 3021                      	CPI TEMP,_C5_FAULT_HUGE_STACK
0003b0 f459                      	BRNE _C5_OUT_COREFAULT__NO_TYPE_0x01
0003b1 93ff
0003b2 93ef
0003b3 e8f3
0003b4 e5ed
0003b5 940e 0200
0003b7 91ef
0003b8 91ff                      	C5_OUT_ROMSTR _OUTSTR_CORE_TYPE_0x01
0003b9 940e 0236                 	MCALL C5_OUT_WORD
0003bb c021                      	RJMP _C5_OUT_COREFAULT__TYPE_LOGGED
                                 _C5_OUT_COREFAULT__NO_TYPE_0x01:
0003bc 3022                      	CPI TEMP,_C5_FAULT_HUGE_TASK_STACK
0003bd f459                      	BRNE _C5_OUT_COREFAULT__NO_TYPE_0x02
0003be 93ff
0003bf 93ef
0003c0 e8f3
0003c1 e6e7
0003c2 940e 0200
0003c4 91ef
0003c5 91ff                      	C5_OUT_ROMSTR _OUTSTR_CORE_TYPE_0x02
0003c6 940e 0236                 	MCALL C5_OUT_WORD
0003c8 c014                      	RJMP _C5_OUT_COREFAULT__TYPE_LOGGED
                                 _C5_OUT_COREFAULT__NO_TYPE_0x02:
0003c9 3023                      	CPI TEMP,_C5_FAULT_HUGE_TASK_STACK2
0003ca f459                      	BRNE _C5_OUT_COREFAULT__NO_TYPE_0x03
0003cb 93ff
0003cc 93ef
0003cd e8f3
0003ce e7e5
0003cf 940e 0200
0003d1 91ef
0003d2 91ff                      	C5_OUT_ROMSTR _OUTSTR_CORE_TYPE_0x03
0003d3 940e 0236                 	MCALL C5_OUT_WORD
0003d5 c007                      	RJMP _C5_OUT_COREFAULT__TYPE_LOGGED
                                 _C5_OUT_COREFAULT__NO_TYPE_0x03:
                                 
0003d6 940e 0227                 	MCALL C5_OUT_BYTE
0003d8 e32a                      	LDI TEMP,':'
0003d9 940e 01cd                 	MCALL C5_OUT_CHAR
0003db 940e 0236                 	MCALL C5_OUT_WORD
                                 _C5_OUT_COREFAULT__TYPE_LOGGED:
0003dd 940c 126b                 	MJMP MAIN
                                 .endif
                                 .endif
                                 .ELSE
                                 .ENDIF
                                 .IFDEF C5_IN_PORT
C:\repos\w5277c\core5277\./core/core5277.inc(290): ######## INPUT ENABLED
                                 	.MESSAGE "######## INPUT ENABLED"
                                 .ENDIF
                                 .IF TS_MODE == TS_MODE_TIME
                                 .ELSE
C:\repos\w5277c\core5277\./core/core5277.inc(296): ######## DISPATCHER DISABLED
                                 	.MESSAGE "######## DISPATCHER DISABLED"
                                 	.INCLUDE "./core/wait_2ms.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;09.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;22.01.2020	w5277c@gmail.com			Учет CORE_FREQ
                                 ;31.05.2021	w5277c@gmail.com			Реализация на таймере
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_WAIT_2MS
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .if TS_MODE == TS_MODE_TIME
                                 .else
                                 .endif
                                 .endif
                                 C5_DISPATCHER_LOCK:
                                 C5_DISPATCHER_UNLOCK:
0003df 9508                      	RET
                                 .ENDIF
                                 
                                 .IF TIMERS > 0x00 || TIMER_C_ENABLE == 1
                                 .ENDIF
                                 .IF TIMERS16 > 0x00
                                 .ENDIF
                                 .IF TIMERS == 0x00 && TIMERS16 == 0 && TIMER_C_ENABLE ==0
C:\repos\w5277c\core5277\./core/core5277.inc(318): ######## TIMERS DISABLED
                                 	.MESSAGE "######## TIMERS DISABLED"
                                 .ENDIF
                                 
                                 ;========================================================================
                                 ;===Обработка прерываний=================================================
                                 ;========================================================================
                                 ;--------------------------------------------------------
                                 _C5_IR:
                                 ;--------------------------------------------------------
                                 ;Обработчик всех прерываний
                                 ;--------------------------------------------------------
                                 	;Получаем адрес по которому определяем тип прерывания
0003e0 90cf                      	POP _C5_TEMP_H
0003e1 90df                      	POP _C5_TEMP_L
                                 
                                 	;Сохраняем регистры
0003e2 932f                      	PUSH TEMP
0003e3 9120 005f                 	LDS TEMP,SREG
0003e5 94f8                      	CLI
0003e6 932f                      	PUSH TEMP
0003e7 93ff
0003e8 93ef                      	PUSH_Z
0003e9 939f                      	PUSH PID
0003ea 938f                      	PUSH ACCUM
                                 	;Находим смещение в таблице прерываний _C5_IR_VECTORS_TABLE
0003eb e0f1
0003ec e9e3                      	LDI_Z _C5_IR_VECTORS_TABLE
                                 
                                 .if _MCALL_SIZE == 2
0003ed 94d6                      	LSR _C5_TEMP_L
                                 .endif
0003ee 94da                      	DEC _C5_TEMP_L														;Получено на базе адреса выхода из процедуры(не входа), т.е. увеличен на 1
                                 
0003ef 2d8d                      	MOV ACCUM,_C5_TEMP_L												;Номер строки в таблице перываний
0003f0 94da                      	DEC _C5_TEMP_L														;Первая запись в таблице прерываний не используется
0003f1 f019                      	BREQ PC+0x04
0003f2 2d2d                      	MOV TEMP,_C5_TEMP_L												;Умножаем на 3(1B-PID, 2B-адрес перехода)
0003f3 0cdd                      	LSL _C5_TEMP_L
0003f4 0ed2                      	ADD _C5_TEMP_L,TEMP
                                 
0003f5 0ded                      	ADD ZL,_C5_TEMP_L
0003f6 9191                      	LD PID,Z+
0003f7 3f9f                      	CPI PID,0xff
0003f8 f039                      	BREQ _C5_IR__END
                                 
0003f9 9121                      	LD TEMP,Z+
0003fa 81e0                      	LD ZL,Z
0003fb 2ff2                      	MOV ZH,TEMP
                                 	;Корневой процесс - текущий и единственный
0003fc 92ff                      	PUSH _PID
0003fd 2ef9                      	MOV _PID,PID
                                 	;Переходим, если адрес указан(в ACCUM номер строки таблицы прерываний)
0003fe 9509                      	ICALL																	;Возвращаться надо по RET(не RETI), TEMP и SREG сохранять не нужно
0003ff 90ff                      	POP _PID
                                 _C5_IR__END:
                                 	;Восстанавливаем регистры и выходим
000400 918f                      	POP ACCUM
000401 919f                      	POP PID
000402 91ef
000403 91ff                      	POP_Z
000404 912f                      	POP TEMP
000405 9320 005f                 	STS SREG,TEMP
000407 912f                      	POP TEMP
000408 9518                      	RETI
                                 
                                 ;--------------------------------------------------------
                                 _C5_TIMER_A_IR:
                                 ;--------------------------------------------------------
                                 ;Обработчик прерывания основного таймера
                                 ;--------------------------------------------------------
000409 932f                      	PUSH TEMP
00040a 9120 005f                 	LDS TEMP,SREG
00040c 932f                      	PUSH TEMP
                                 
00040d e622                      	LDI TEMP,TIMERS_SPEED-0x02
00040e fce1                      	SBRC _C5_COREFLAGS,_CFL_TIMER_UART_CORRECTION
00040f e626                      	LDI TEMP,TIMERS_SPEED+0x02
000410 938f
000411 9180 0046
000413 0f82
000414 9380 0047
000416 e082
000417 9380 0035
000419 918f                      	_CORRE5277_TIMERA_CORRECTOR TEMP
                                 
00041a 93ff
00041b 93ef                      	PUSH_Z
                                 
                                 .IF TIMERS16 > 0x0
                                 .ENDIF
                                 .IF TIMERS > 0x00
                                 .ENDIF
                                 _C5_TIMER_IR__DISPATCHER:
                                 
00041c 938f                      	PUSH ACCUM
00041d 9180 0110                 	LDS ACCUM,_C5_MAIN_TIMER_CNTR
00041f 9583                      	INC ACCUM
000420 9380 0110                 	STS _C5_MAIN_TIMER_CNTR,ACCUM
000422 9120 0111                 	LDS TEMP,_C5_MAIN_TIMER_TRHLD
000424 1728                      	CP TEMP,ACCUM
000425 918f                      	POP ACCUM
000426 f019                      	BREQ PC+0x04
000427 91ef
000428 91ff                      	POP_Z
000429 c020                      	RJMP _C5_TIMER_A_IR__END
00042a 5d28                      	SUBI TEMP,(0x100-_C5_TIMER_PERIOD)
00042b 9320 0111                 	STS _C5_MAIN_TIMER_TRHLD,TEMP
                                 
                                 	;Тик 1 кванта
00042d e0e1                      	LDI ZL,0x01
00042e 91f0 0104                 	LDS ZH,_C5_UPTIME+0x04
000430 0ffe                      	ADD ZH,ZL
000431 93f0 0104                 	STS _C5_UPTIME+0x04,ZH
000433 e0e0                      	LDI ZL,0x00
000434 91f0 0103                 	LDS ZH,_C5_UPTIME+0x03
000436 1ffe                      	ADC ZH,ZL
000437 93f0 0103                 	STS _C5_UPTIME+0x03,ZH
000439 91f0 0102                 	LDS ZH,_C5_UPTIME+0x02
00043b 1ffe                      	ADC ZH,ZL
00043c 93f0 0102                 	STS _C5_UPTIME+0x02,ZH
00043e 91f0 0101                 	LDS ZH,_C5_UPTIME+0x01
000440 1ffe                      	ADC ZH,ZL
000441 93f0 0101                 	STS _C5_UPTIME+0x01,ZH
000443 91f0 0100                 	LDS ZH,_C5_UPTIME+0x00
000445 1ffe                      	ADC ZH,ZL
000446 93f0 0100                 	STS _C5_UPTIME+0x00,ZH
                                 
                                 .IF TIMERS > 0x00
                                 .ENDIF
                                 
000448 91ef
000449 91ff                      	POP_Z
                                 
                                 .IF TS_MODE == TS_MODE_TIME
                                 .ENDIF
                                 _C5_TIMER_A_IR__END:
                                 
00044a 912f                      	POP TEMP
00044b 9320 005f                 	STS SREG,TEMP
00044d 912f                      	POP TEMP
00044e 9518                      	RETI
                                 
                                 
                                 .IF TIMER_C_ENABLE == 0x01
                                 .ENDIF
                                 
                                 ;========================================================================
                                 ;===Базовые процедуры ядра===============================================
                                 ;========================================================================
                                 ;--------------------------------------------------------
                                 C5_INIT:
                                 ;--------------------------------------------------------
                                 ;Инициализация ядра
                                 ;--------------------------------------------------------
                                 	;Запрещение прерываний
00044f 94f8                      	CLI
000450 9160 0054                 	LDS FLAGS,MCUSR
                                 
                                 	;WATCHDOG STOP
000452 95a8                      	WDR
000453 9180 0054                 	LDS ACCUM,MCUSR
000455 7f87                      	ANDI ACCUM,~(1<<WDRF)
000456 9380 0054                 	STS MCUSR,ACCUM
000458 9180 0060                 	LDS ACCUM,WDTCR
00045a 6188                      	ORI ACCUM,(1<<WDCE)|(1<<WDE)
00045b 9380 0060                 	STS WDTCR,ACCUM
00045d e080                      	LDI ACCUM,(0<<WDE)
00045e 9380 0060                 	STS WDTCR,ACCUM
                                 
                                 	;Инициализация логирования
                                 .ifdef LOGGING_PORT
000460 940e 01b8                 	MCALL C5_OUT_INIT
                                 
000462 e8f1
000463 e9e9                      	LDI_Z OUTSTR_CORE|0x8000
000464 940e 0200                 	MCALL C5_OUT_STR
000466 ff63                      	SBRS FLAGS,WDRF
000467 c004                      	RJMP PC+0x03+_MCALL_SIZE
000468 e8f1
000469 eaeb                      	LDI_Z OUTSTR_MCUSR_WD|0x8000
00046a 940e 0200                 	MCALL C5_OUT_STR
00046c ff62                      	SBRS FLAGS,BORF
00046d c004                      	RJMP PC+0x03+_MCALL_SIZE
00046e e8f1
00046f eaed                      	LDI_Z OUTSTR_MCUSR_BO|0x8000
000470 940e 0200                 	MCALL C5_OUT_STR
000472 ff61                      	SBRS FLAGS,EXTRF
000473 c004                      	RJMP PC+0x03+_MCALL_SIZE
000474 e8f1
000475 eaef                      	LDI_Z OUTSTR_MCUSR_EX|0x8000
000476 940e 0200                 	MCALL C5_OUT_STR
000478 ff60                      	SBRS FLAGS,PORF
000479 c004                      	RJMP PC+0x03+_MCALL_SIZE
00047a e8f1
00047b ebe1                      	LDI_Z OUTSTR_MCUSR_PO|0x8000
00047c 940e 0200                 	MCALL C5_OUT_STR
00047e 2f26                      	MOV TEMP,FLAGS
00047f 702f                      	ANDI TEMP,(1<<WDRF)|(1<<BORF)|(1<<EXTRF)|(1<<PORF)
000480 f421                      	BRNE PC+0x03+_MCALL_SIZE
000481 e8f1
000482 eae9                      	LDI_Z OUTSTR_MCUSR_NO|0x8000
000483 940e 0200                 	MCALL C5_OUT_STR
000485 e8f1
000486 ebe3                      	LDI_Z OUTSTR_MCUSR_RESET|0x8000
000487 940e 0200                 	MCALL C5_OUT_STR
                                 
000489 fd60                      	SBRC FLAGS,PORF
00048a c002                      	RJMP PC+0x01+_MCALL_SIZE
00048b 940e 031d                 	MCALL C5_OUT_TASKSDUMP
                                 .endif
                                 
                                 	;Сбрасываем флаги причины сброса
00048d 2722                      	CLR TEMP
00048e 9320 0054                 	STS MCUSR,TEMP
                                 
                                 .IF TIMER_C_ENABLE == 0x01
                                 .ENDIF
                                 
                                 	;Заполнение всей памяти 0xF7 значением (для диагностики)
000490 ef27                      	LDI TEMP,0xF7
000491 e017                      	LDI TEMP_H,high(RAMEND-0x010f)									;RAM_SIZE-16(stack)
000492 ef00                      	LDI TEMP_L,low(RAMEND-0x010f)
000493 e0b1
000494 e0a0                      	LDI_X 0x0100
000495 940e 0067                 	MCALL RAM_FILL16
                                 
                                 	;Сброс счетчика времени
000497 e020                      	LDI TEMP,0x00
000498 e010                      	LDI TEMP_H,0x00
000499 e005                      	LDI TEMP_L,0x05
00049a e0b1
00049b e0a0                      	LDI_X _C5_UPTIME
00049c 940e 0067                 	MCALL RAM_FILL16
                                 ;--------------------------------------------------------
                                 C5_REINIT:
                                 ;--------------------------------------------------------
                                 ;Повторная инициализация ядра
                                 ;--------------------------------------------------------
                                 	;Чистка таблицы прерываний
00049e ef2f                      	LDI TEMP,0xff
00049f e010                      	LDI TEMP_H,0x00
0004a0 e40b                      	LDI TEMP_L,_C5_IRV_TABLE_SIZE									;IV_VECTORS_TABLE
0004a1 e0b1
0004a2 e9a3                      	LDI_X _C5_IR_VECTORS_TABLE
0004a3 940e 0067                 	MCALL RAM_FILL16
                                 	;Чистка очереди
0004a5 ef2f                      	LDI TEMP,0xff
0004a6 e010                      	LDI TEMP_H,0x00
0004a7 e200                      	LDI TEMP_L,_C5_RES_QUEUE_SIZE
0004a8 e0b2
0004a9 efa1                      	LDI_X _C5_RESOURCE_QUEUE
0004aa 940e 0067                 	MCALL RAM_FILL16
                                 	;Чистка переменных в памяти
0004ac 24ee                      	CLR _C5_COREFLAGS
                                 	;Задаем вершину стека
0004ad e0b8
0004ae ebaf                      	LDI_X _C5_STACK_END
0004af 93b0 0107                 	STS _C5_TOP_OF_STACK+0x00,XH
0004b1 93a0 0108                 	STS _C5_TOP_OF_STACK+0x01,XL
                                 	;Задаем вершину свободной памяти
0004b3 e0b5
0004b4 e1a1                      	LDI_X _C5_FREE_RAM
0004b5 93b0 0109                 	STS _C5_TOP_OF_FREE_RAM+0x00,XH
0004b7 93a0 010a                 	STS _C5_TOP_OF_FREE_RAM+0x01,XL
                                 	;Чистка флагов
0004b9 9270 010b                 	STS _C5_FLAGS+0x00,C0x00
0004bb 9270 010c                 	STS _C5_FLAGS+0x01,C0x00
0004bd 9270 010d                 	STS _C5_FLAGS+0x02,C0x00
0004bf 9270 010e                 	STS _C5_FLAGS+0x03,C0x00
                                 	;Задаем счетчик основному таймеру
0004c1 9270 0110                 	STS _C5_MAIN_TIMER_CNTR,C0x00
0004c3 e228                      	LDI TEMP,_C5_TIMER_PERIOD
0004c4 9320 0111                 	STS _C5_MAIN_TIMER_TRHLD,TEMP
                                 .IFDEF C5_IN_PORT
0004c6 940e 00d3                 	MCALL C5_INPUT_INIT
                                 .ENDIF
                                 .IF TIMERS > 0x00
                                 .ENDIF
                                 .IF TIMERS16 > 0x00
                                 .ENDIF
                                 	;Чистка заголовков драйверов
                                 .IF	0x00 != C5_DRIVERS_QNT
0004c8 e0b1
0004c9 eea1                      	LDI_X _C5_DRIVERS_HEADER
0004ca e010                      	LDI TEMP_H,high(_C5_DRIVER_HEADER_SIZE*C5_DRIVERS_QNT)
0004cb e600                      	LDI TEMP_L,low(_C5_DRIVER_HEADER_SIZE*C5_DRIVERS_QNT)
0004cc e020                      	LDI TEMP,_C5_PROC_STATE_ABSENT
0004cd 940e 0067                 	MCALL RAM_FILL16
                                 .ENDIF
                                 	;Чистка заголовков задач
0004cf e0b2
0004d0 e4a1                      	LDI_X _C5_TASKS_HEADER
0004d1 e010                      	LDI TEMP_H,high(_C5_TASK_HEADER_SIZE*C5_TASKS_QNT)
0004d2 eb00                      	LDI TEMP_L,low(_C5_TASK_HEADER_SIZE*C5_TASKS_QNT)
0004d3 e020                      	LDI TEMP,_C5_PROC_STATE_ABSENT
0004d4 940e 0067                 	MCALL RAM_FILL16
                                 	;Чистка регистров
0004d6 2499                      	CLR _C5_DISPATCHER_LOCK_CNTR
                                 	;Инициализируем таймер (0.000050s - 800 тактов)
0004d7 932f
0004d8 9120 0064
0004da 7d2f
0004db 9320 0064
0004dd 912f
0004de e020
0004df 9320 0044
0004e1 e022
0004e2 9320 0045
0004e4 2722
0004e5 9320 0046
0004e7 e623
0004e8 9320 0047
0004ea e022
0004eb 9320 0035                 	_C5_TIMERA_INIT
0004ed 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_IR_VECTOR_SET:
                                 ;--------------------------------------------------------
                                 ;Устанавливаем адрес перехода для прерывания
                                 ;IN: PID-ид процесса,
                                 ;ACCUM-номер прерывания (1-...), TEMP_H,TEMP_L-
                                 ;адрес перехода (0-не использовать перерывание)
                                 ;--------------------------------------------------------
0004ee 93ff
0004ef 93ef                      	PUSH_Z
0004f0 91e0 005f                 	LDS ZL,SREG
0004f2 93ef                      	PUSH ZL
0004f3 938f                      	PUSH ACCUM
                                 
0004f4 3080                      	CPI ACCUM,0x00
0004f5 f061                      	BREQ _C5_IR_VECTOR_SET__END
                                 
0004f6 94f8                      	CLI
0004f7 958a                      	DEC ACCUM
0004f8 2fe8                      	MOV ZL,ACCUM
0004f9 0f88                      	LSL ACCUM
0004fa 0f8e                      	ADD ACCUM,ZL
0004fb e0f1
0004fc e9e3                      	LDI_Z _C5_IR_VECTORS_TABLE
0004fd 0fe8                      	ADD ZL,ACCUM
0004fe 1df7                      	ADC ZH,C0x00
0004ff 8390                      	STD Z+0x00,PID
000500 8311                      	STD Z+0x01,TEMP_H
000501 8302                      	STD Z+0x02,TEMP_L
                                 
                                 _C5_IR_VECTOR_SET__END:
000502 918f                      	POP ACCUM
000503 91ef                      	POP ZL
000504 93e0 005f                 	STS SREG,ZL
000506 91ef
000507 91ff                      	POP_Z
000508 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_SOFT_UART_MODE_SET:
                                 ;--------------------------------------------------------
                                 ;Установка режима программного UART
                                 ;--------------------------------------------------------
000509 932f                      	PUSH TEMP
00050a e022                      	LDI TEMP,(1<<_CFL_TIMER_UART_CORRECTION)
00050b 2ae2                      	OR _C5_COREFLAGS,TEMP
00050c 912f                      	POP TEMP
00050d 9508                      	RET
                                 ;--------------------------------------------------------
                                 C5_SOFT_UART_MODE_RESET:
                                 ;--------------------------------------------------------
                                 ;Снятие режима программного UART
                                 ;--------------------------------------------------------
00050e 932f                      	PUSH TEMP
00050f ef2d                      	LDI TEMP,~((1<<_CFL_TIMER_UART_CORRECTION))
000510 22e2                      	AND _C5_COREFLAGS,TEMP
000511 912f                      	POP TEMP
000512 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_TCNT_GET:
                                 ;--------------------------------------------------------
                                 ;Получаем значение счетчика таймера
                                 ;Отсчет кратный 0.000 000 5s
                                 ;OUT: TEMP-значение счетчика таймера
                                 ;--------------------------------------------------------
000513 9120 0046                 	_C5_TIMER_TCNT TEMP
000515 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _C5_WAIT_500NS:
                                 ;--------------------------------------------------------
                                 ;Ждем истечения времени
                                 ;IN TEMP-время в 0.000 000 5s(>=40 ~20us, <=248)
                                 ;--------------------------------------------------------
000516 931f                      	PUSH TEMP_H
000517 930f                      	PUSH TEMP_L
                                 
                                 	;Корректировка на время исполнения кода
000518 5027                      	SUBI TEMP,0x07
                                 	;Настройка таймера
000519 9100 0046
00051b 0f02
00051c 9300 0048
00051e 9110 0035
000520 6014
000521 9310 0035
000523 e011
000524 2ae1
000525 9110 006e
000527 6014
000528 9310 006e
00052a fce0
00052b cffe
00052c 9110 006e
00052e 7f1b
00052f 9310 006e                 	_C5_TIMERB
                                 
000531 910f                      	POP TEMP_L
000532 911f                      	POP TEMP_H
000533 9508                      	RET
                                 
                                 _C5_TIMER_B_IR:
000534 932f                      	PUSH TEMP
000535 9120 005f                 	LDS TEMP,SREG
000537 932f                      	PUSH TEMP
                                 
                                 	;Сброс флага
000538 ef2e                      	LDI TEMP,~(1<<_CFL_TIMER_B_USE)
000539 22e2                      	AND _C5_COREFLAGS,TEMP
                                 
00053a 912f                      	POP TEMP
00053b 9320 005f                 	STS SREG,TEMP
00053d 912f                      	POP TEMP
00053e 9518                      	RETI
                                 
                                 ;--------------------------------------------------------
                                 C5_START:
                                 ;--------------------------------------------------------
                                 ;Запуск ядра
                                 ;--------------------------------------------------------
                                 	;Запуск таймера
00053f 9120 006e
000541 6022
000542 9320 006e                 	_CORRE5277_TIMERA_START
                                 	;Разрешаем прерывания
000544 9478                      	SEI
                                 .if TS_MODE == TS_MODE_NO
                                 .endif
                                 .if TS_MODE != TS_MODE_NO
                                 _C5_START__LOOP:
000545 e090                      	LDI PID,0x00													;Счетчик задач
000546 e060                      	LDI FLAGS,0x00
                                 _C5_START__TASKS_LOOP:
000547 940e 061d                 	MCALL _C5_PROC_HEADER_GET
000549 8120                      	LDD TEMP,Z+_C5_PROC_STATE
00054a 702f                      	ANDI TEMP,0x0f
00054b 3025                      	CPI TEMP,_C5_PROC_STATE_READY
00054c f441                      	BRNE _C5_START__NEXT_TASK
00054d 939f                      	PUSH PID
00054e 2ef9                      	MOV _PID,PID
00054f 936f                      	PUSH FLAGS
000550 940e 0636                 	MCALL _C5_RESUME												;Возвращаемся по C5_SUSPEND
000552 916f                      	POP FLAGS
000553 919f                      	POP PID
000554 6061                      	ORI FLAGS,0x01
                                 _C5_START__NEXT_TASK:
000555 9593                      	INC PID
000556 3190                      	CPI PID,C5_TASKS_QNT
000557 f779                      	BRNE _C5_START__TASKS_LOOP
000558 ff60                      	SBRS FLAGS,0x00
000559 9588                      	SLEEP
00055a cfea                      	RJMP _C5_START__LOOP
                                 .endif
                                 ;========================================================================
                                 ;===Процедуры работы с задачами и драйверами=============================
                                 ;========================================================================
                                 ;--------------------------------------------------------
                                 C5_CREATE:
                                 ;--------------------------------------------------------
                                 ;Создание процесса(задачи или драйвера).
                                 ;После создания будет выполнен переход на процесс
                                 ;для инициализации. После инициализации процесса
                                 ;необходимо вызвать процедуру C5_READY
                                 ;IN: PID, Z-точка входа, TEMP_H,TEMP_L,TEMP - время в 2мс
                                 ;для опции задачи C5_PROCID_OPT_TIMER
                                 ;--------------------------------------------------------
00055b 93ff
00055c 93ef                      	PUSH_Z
00055d 932f                      	PUSH TEMP
                                 
00055e 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
                                 	;Записываем состояние и опции задачи
000560 2f29                      	MOV TEMP,PID
000561 7720                      	ANDI TEMP,0x70														;Исключаем флаг драйвера
000562 6021                      	ORI TEMP,_C5_PROC_STATE_GHOST
000563 8320                      	STD Z+_C5_PROC_STATE,TEMP
                                 	;Обнуляем адрес выделенной памяти и размер
000564 8271                      	STD Z+_C5_PROC_RAM_OFFSET+0x00,C0x00
000565 8272                      	STD Z+_C5_PROC_RAM_OFFSET+0x01,C0x00
000566 8273                      	STD Z+_C5_PROC_RAM_SIZE,C0x00
                                 
                                 	;Проверяем на признак драйвера, пропускаем блок кода для задачи, если признак есть
000567 fd97                      	SBRC PID,C5_PROCID_OPT_DRV
000568 c047                      	RJMP _C5_CREATE__TASK_CODE_SKIP
                                 
                                 	;Записываем начало стека на базе вершины стека задач
000569 9000 0107                 	LDS r0,_C5_TOP_OF_STACK+0x00
00056b 8204                      	STD Z+_C5_TASK_STACK_OFFSET+0x00,r0
00056c 9010 0108                 	LDS r1,_C5_TOP_OF_STACK+0x01
00056e 8215                      	STD Z+_C5_TASK_STACK_OFFSET+0x01,r1
                                 	;Записываем размер стека
00056f 8276                      	STD Z+_C5_TASK_STACK_SIZE,C0x00
                                 	;Восстанавливаем все регистры из стека
000570 912f                      	POP TEMP
                                 
000571 ff95                      	SBRS PID,C5_PROCID_OPT_TIMER
000572 c015                      	RJMP _C5_CREATE__TIMER_CODE_SKIP1
                                 	;Записываем время окончания паузы
000573 938f                      	PUSH ACCUM
000574 9180 005f                 	LDS ACCUM,SREG
000576 938f                      	PUSH ACCUM
000577 94f8                      	CLI
000578 9180 0104                 	LDS ACCUM,_C5_UPTIME+0x04
00057a 0f82                      	ADD ACCUM,TEMP
00057b 8782                      	STD Z+_C5_TASK_EXECTIME+0x02,ACCUM
00057c 9180 0103                 	LDS ACCUM,_C5_UPTIME+0x03
00057e 1f80                      	ADC ACCUM,TEMP_L
00057f 8781                      	STD Z+_C5_TASK_EXECTIME+0x01,ACCUM
000580 9180 0102                 	LDS ACCUM,_C5_UPTIME+0x02
000582 1f81                      	ADC ACCUM,TEMP_H
000583 8780                      	STD Z+_C5_TASK_EXECTIME+0x00,ACCUM
000584 918f                      	POP ACCUM
000585 9380 005f                 	STS SREG,ACCUM
000587 918f                      	POP ACCUM
                                 _C5_CREATE__TIMER_CODE_SKIP1:
                                 
000588 91ef
000589 91ff                      	POP_Z
                                 	;Запоминаем текущее положение стека
00058a 9020 005e                 	LDS r2,SPH
00058c 9220 0105                 	STS _C5_CORE_STACK+0x00,r2
00058e 9020 005d                 	LDS r2,SPL
000590 9220 0106                 	STS _C5_CORE_STACK+0x01,r2
                                 	;Переключаемся на стек задачи
000592 9200 005e                 	STS SPH,r0
000594 9210 005d                 	STS SPL,r1
                                 
                                 	;Если таймер - записываем таймаут в стек для восстановления
000596 ff95                      	SBRS PID,C5_PROCID_OPT_TIMER
000597 c011                      	RJMP _C5_CREATE__TIMER_CODE_SKIP2
000598 931f                      	PUSH TEMP_H
000599 930f                      	PUSH TEMP_L
00059a 932f                      	PUSH TEMP
00059b 9010 005f                 	LDS r1,SREG
00059d 94f8                      	CLI
00059e 9120 0102                 	LDS TEMP,_C5_UPTIME+0x02
0005a0 932f                      	PUSH TEMP															;Выделяем дополнительно 3 байта для хранения временной метки,
0005a1 9120 0103                 	LDS TEMP,_C5_UPTIME+0x03
0005a3 932f                      	PUSH TEMP															;используется при вызове процедуры RESUME,
0005a4 9120 0104                 	LDS TEMP,_C5_UPTIME+0x04
0005a6 932f                      	PUSH TEMP															;т.к. EXECTIME может быть перезаписан процедурами WAIT
0005a7 9210 005f                 	STS SREG,r1
                                 _C5_CREATE__TIMER_CODE_SKIP2:
                                 
                                 	;Помещаем точку возврата
0005a9 2e02                      	MOV r0,TEMP
                                 .if TS_MODE == TS_MODE_NO
                                 .endif
                                 .if TS_MODE != TS_MODE_NO
0005aa e720                      	LDI TEMP,low(_C5_TASK_ENDPOINT)
                                 .endif
0005ab 932f                      	PUSH TEMP
                                 .if TS_MODE == TS_MODE_NO
                                 .endif
                                 .if TS_MODE != TS_MODE_NO
0005ac e026                      	LDI TEMP,high(_C5_TASK_ENDPOINT)
                                 .endif
0005ad 932f                      	PUSH TEMP
0005ae 2d20                      	MOV TEMP,r0
0005af c003                      	RJMP _C5_CREATE__DRIVER_CODE_SKIP
                                 
                                 _C5_CREATE__TASK_CODE_SKIP:
0005b0 912f                      	POP TEMP
0005b1 91ef
0005b2 91ff                      	POP_Z
                                 _C5_CREATE__DRIVER_CODE_SKIP:
                                 	;Единственный процесс, нет предков
0005b3 789f                      	ANDI PID,(1<<C5_PROCID_OPT_DRV)|0x0f
0005b4 2ef9                      	MOV _PID,PID
                                 	;Переходим на нашу процедуру
0005b5 93ef                      	PUSH ZL
0005b6 93ff                      	PUSH ZH
0005b7 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_READY:
                                 ;--------------------------------------------------------
                                 ;Вызывается процессом после инициализации. В стеке должен
                                 ;лежать только адрес возврата. Т.е. стек задачи должен
                                 ;быть пуст, а данная процедура вызвана через CALL. При
                                 ;этом, после CALL должно быть размещено тело процесса.
                                 ;--------------------------------------------------------
0005b8 9000 005f                 	LDS r0,SREG
                                 
0005ba fd97                      	SBRC PID,C5_PROCID_OPT_DRV
0005bb c032                      	RJMP _C5_READY__IS_DRIVER
                                 
                                 	;Записываем в стек 16 старших регистров(могут быть проинициализированы при вызове процедуры)
0005bc 930f
0005bd 931f
0005be 932f
0005bf 933f
0005c0 934f
0005c1 935f
0005c2 936f
0005c3 937f
0005c4 938f
0005c5 939f
0005c6 93af
0005c7 93bf
0005c8 93cf
0005c9 93df
0005ca 93ef
0005cb 93ff                      	_C5_MACRO__PUSH_RDS
                                 	;Записываем SREG (при RESUME будут насильно разрешены прерывания)
0005cc 920f                      	PUSH r0
                                 
                                 	;Обновляем вершину стека задач
0005cd 9000 005e                 	LDS r0,SPH
0005cf 9010 005d                 	LDS r1,SPL
0005d1 9200 0107                 	STS _C5_TOP_OF_STACK+0x00,r0
0005d3 9210 0108                 	STS _C5_TOP_OF_STACK+0x01,r1
                                 
                                 	;Могли затереть PID, восстанавливаем
0005d5 2d9f                      	MOV PID,_PID
0005d6 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
                                 	;Обновляем размер стека
0005d8 8114                      	LDD TEMP_H,Z+_C5_TASK_STACK_OFFSET+0x00
0005d9 8105                      	LDD TEMP_L,Z+_C5_TASK_STACK_OFFSET+0x01
0005da 1901                      	SUB TEMP_L,r1
0005db 0910                      	SBC TEMP_H,r0
                                 	;Проверка на размер стека более 255 байт
0005dc 2311                      	TST TEMP_H
0005dd f019                      	BREQ PC+0x02+_MCALL_SIZE
0005de e022                      	LDI TEMP,_C5_FAULT_HUGE_TASK_STACK
0005df 940e 0384                 	MCALL C5_OUT_COREFAULT
0005e1 8306                      	STD Z+_C5_TASK_STACK_SIZE,TEMP_L
                                 
                                 	;Запись временной метки
0005e2 9120 0104                 	LDS TEMP,_C5_UPTIME+0x04
0005e4 8327                      	STD Z+_C5_TASK_TIMESTAMP,TEMP
                                 
                                 	;Восстанавливем стек ядра
0005e5 9050 0105                 	LDS r5,_C5_CORE_STACK+0x00
0005e7 9250 005e                 	STS SPH,r5
0005e9 9050 0106                 	LDS r5,_C5_CORE_STACK+0x01
0005eb 9250 005d                 	STS SPL,r5
0005ed c007                      	RJMP _C5_READY__END
                                 
                                 _C5_READY__IS_DRIVER:
0005ee 900f                      	POP r0
0005ef 901f                      	POP r1
                                 	;Извлекаем точку входа на сновной код драйвера
0005f0 2d9f                      	MOV PID,_PID
0005f1 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
                                 	;Записываем адрес основной процедуры драйвера
0005f3 8204                      	STD Z+_C5_DRIVER_OFFSET+0x00,r0
0005f4 8215                      	STD Z+_C5_DRIVER_OFFSET+0x01,r1
                                 
                                 _C5_READY__END:
                                 	;Записываем состояние не меняя опций
0005f5 8120                      	LDD TEMP,Z+_C5_PROC_STATE
0005f6 7f20                      	ANDI TEMP,0xf0
                                 	;READY для задачи или драйвера, TIMER_WAIT - для задачи-таймера
0005f7 ff25                      	SBRS TEMP,C5_PROCID_OPT_TIMER
0005f8 6025                      	ORI TEMP,_C5_PROC_STATE_READY
0005f9 fd25                      	SBRC TEMP,C5_PROCID_OPT_TIMER
0005fa 6024                      	ORI TEMP,_C5_PROC_STATE_TIMER_WAIT
                                 
0005fb 8320                      	STD Z+_C5_PROC_STATE,TEMP
                                 	;Выхожу из процедуры C5_CREATE
0005fc 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_EXEC:
                                 ;--------------------------------------------------------
                                 ;Выполнение процедуры драйвера
                                 ;IN: TEMP-ид вызываемого драйвера
                                 ;OUT: как минимум TEMP-DRV_RESULT_...
                                 ;--------------------------------------------------------
                                 	;Процедура применима только для драйвера
0005fd ff27                      	SBRS TEMP,C5_PROCID_OPT_DRV
0005fe c01c                      	RJMP _C5_EXEC__ERROR
0005ff 3f2f                      	CPI TEMP,0xff
000600 f0d1                      	BREQ _C5_EXEC__ERROR
                                 
000601 939f                      	PUSH PID
000602 940e 03df                 	MCALL C5_DISPATCHER_LOCK
                                 	;Сохраняем значение Z
000604 2eaf                      	MOV _C5_DRIVER_EXEC_ZH,ZH
000605 2ebe                      	MOV _C5_DRIVER_EXEC_ZL,ZL
                                 	;Помещаем в стек адрес возврата из вызываемой процедуры
000606 e0f6
000607 e1e9                      	LDI_Z _C5_EXEC__DONE
000608 93ef                      	PUSH ZL
000609 93ff                      	PUSH ZH
                                 	;Получаем заголовок вызываемого драйвера
00060a 2f92                      	MOV PID,TEMP
00060b 940e 061d                 	MCALL _C5_PROC_HEADER_GET
00060d 932f                      	PUSH TEMP
00060e 8124                      	LDD TEMP,Z+_C5_DRIVER_OFFSET+0x00
00060f 81e5                      	LDD ZL,Z+_C5_DRIVER_OFFSET+0x01
000610 2ff2                      	MOV ZH,TEMP
000611 912f                      	POP TEMP
                                 	;Помещаем в стек адрес перехода на процедуру вызываемого драйвера
000612 93ef                      	PUSH ZL
000613 93ff                      	PUSH ZH
                                 	;Восстанавливаем значение Z
000614 2dfa                      	MOV ZH,_C5_DRIVER_EXEC_ZH
000615 2deb                      	MOV ZL,_C5_DRIVER_EXEC_ZL
000616 940e 03df                 	MCALL C5_DISPATCHER_UNLOCK
                                 	;Переходим на процедуру драйвера
000618 9508                      	RET
                                 _C5_EXEC__DONE:
000619 919f                      	POP PID
00061a 9508                      	RET
                                 _C5_EXEC__ERROR:
00061b e825                      	LDI TEMP,DRV_RESULT_UNSUPPORTED
00061c 9508                      	RET
                                 ;--------------------------------------------------------
                                 _C5_PROC_HEADER_GET:
                                 ;--------------------------------------------------------
                                 ;Возвращает смещение на заголовок процесса
                                 ;IN:PID-ид процеса
                                 ;OUT:Z-смещение
                                 ;--------------------------------------------------------
00061d 931f                      	PUSH TEMP_H
00061e 930f                      	PUSH TEMP_L
                                 
00061f 2f19                      	MOV TEMP_H,PID
000620 701f                      	ANDI TEMP_H,0x0f
000621 ff97                      	SBRS PID,C5_PROCID_OPT_DRV
000622 c006                      	RJMP _C5_PROC_HEADER_GET__TASK
                                 _C5_PROC_HEADER_GET__DRIVER:
000623 e0f1
000624 eee1                      	LDI_Z _C5_DRIVERS_HEADER
000625 0f11                      	LSL TEMP_H														;Умножаем на 0x06(_C5_DRIVER_HEADER_SIZE)
000626 2f01                      	MOV TEMP_L,TEMP_H
000627 0f11                      	LSL TEMP_H
000628 c007                      	RJMP _C5_PROC_HEADER_GET__END
                                 _C5_PROC_HEADER_GET__TASK:
000629 e0f2
00062a e4e1                      	LDI_Z _C5_TASKS_HEADER
00062b 2f01                      	MOV TEMP_L,TEMP_H												;Умножаем на 0x0b(_C5_TASK_HEADER_SIZE)
00062c 0f00                      	LSL TEMP_L
00062d 0f10                      	ADD TEMP_H,TEMP_L
00062e 0f00                      	LSL TEMP_L
00062f 0f00                      	LSL TEMP_L
                                 _C5_PROC_HEADER_GET__END:
000630 0f01                      	ADD TEMP_L,TEMP_H
000631 0fe0                      	ADD ZL,TEMP_L
000632 1df7                      	ADC ZH,C0x00
                                 
000633 910f                      	POP TEMP_L
000634 911f                      	POP TEMP_H
000635 9508                      	RET
                                 
                                 .if TS_MODE != TS_MODE_NO
                                 ;--------------------------------------------------------
                                 _C5_RESUME:
                                 ;--------------------------------------------------------
                                 ;Продолжаем выполнение задачи
                                 ;IN: PID-ид задачи, Z-адрес заголовка задачи
                                 ;--------------------------------------------------------
000636 940e 03df                 	MCALL C5_DISPATCHER_LOCK
                                 	;Записываем адрес стека ядра
000638 9120 005e                 	LDS TEMP,SPH
00063a 9320 0105                 	STS _C5_CORE_STACK+0x00,TEMP
00063c 9120 005d                 	LDS TEMP,SPL
00063e 9320 0106                 	STS _C5_CORE_STACK+0x01,TEMP
                                 
000640 9120 0104                 	LDS TEMP,_C5_UPTIME+0x04
000642 8327                      	STD Z+_C5_TASK_TIMESTAMP,TEMP
                                 
000643 8120                      	LDD TEMP,Z+_C5_PROC_STATE
000644 7f20                      	ANDI TEMP,0xf0
000645 6022                      	ORI TEMP,_C5_PROC_STATE_BUSY
000646 8320                      	STD Z+_C5_PROC_STATE,TEMP
                                 
                                 	;Переключаем стек на вершину стека, он же стек текущей задачи
000647 940e 06ee                 	MCALL _C5_STACK_TO_TOP
000649 8126                      	LDD TEMP, Z+_C5_TASK_STACK_SIZE
00064a 8105                      	LDD TEMP_L,Z+_C5_TASK_STACK_OFFSET+0x01
00064b 8114                      	LDD TEMP_H,Z+_C5_TASK_STACK_OFFSET+0x00
00064c 1b02                      	SUB TEMP_L,TEMP
00064d 4010                      	SBCI TEMP_H,0x00
00064e 94f8                      	CLI
00064f 9310 005e                 	STS SPH,TEMP_H
000651 9300 005d                 	STS SPL,TEMP_L
                                 
                                 	;Восстанавливаем SREG
000653 912f                      	POP TEMP
000654 9320 005f                 	STS SREG,TEMP
000656 91ff
000657 91ef
000658 91df
000659 91cf
00065a 91bf
00065b 91af
00065c 919f
00065d 918f
00065e 917f
00065f 916f
000660 915f
000661 914f
000662 913f
000663 912f
000664 911f
000665 910f                      	_C5_MACRO__POP_RDS
000666 9478                      	SEI
000667 932f                      	PUSH TEMP
000668 9120 005f                 	LDS TEMP,SREG
00066a 940e 03df                 	MCALL C5_DISPATCHER_UNLOCK
00066c 9320 005f                 	STS SREG,TEMP
00066e 912f                      	POP TEMP
00066f 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _C5_TASK_ENDPOINT:
                                 ;--------------------------------------------------------
                                 ;Отрабатывает при завершении задачи
                                 ;--------------------------------------------------------
000670 940e 03df                 	MCALL C5_DISPATCHER_LOCK
                                 
000672 2d9f                      	MOV PID,_PID
000673 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
000675 e020                      	LDI TEMP,0x00
000676 8326                      	STD Z+_C5_TASK_STACK_SIZE,TEMP
000677 940e 06ee                 	MCALL _C5_STACK_TO_TOP
000679 e020                      	LDI TEMP,_C5_PROC_STATE_ABSENT
00067a 8320                      	STD Z+_C5_PROC_STATE,TEMP
                                 
00067b 94f8                      	CLI
00067c 9120 0105                 	LDS TEMP,_C5_CORE_STACK+0x00
00067e 9320 005e                 	STS SPH,TEMP
000680 9120 0106                 	LDS TEMP,_C5_CORE_STACK+0x01
000682 9320 005d                 	STS SPL,TEMP
000684 9478                      	SEI
000685 940e 03df                 	MCALL C5_DISPATCHER_UNLOCK
000687 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 C5_SUSPEND:
                                 ;--------------------------------------------------------
                                 ;Приостанавливаем текущую задачу
                                 ;IN: _PID
                                 ;--------------------------------------------------------
000688 9000 005f                 	LDS r0,SREG
                                 	;Помещаем в стек 16 старших регистров(могут быть проинициализированы при вызове процедуры)
00068a 930f
00068b 931f
00068c 932f
00068d 933f
00068e 934f
00068f 935f
000690 936f
000691 937f
000692 938f
000693 939f
000694 93af
000695 93bf
000696 93cf
000697 93df
000698 93ef
000699 93ff                      	_C5_MACRO__PUSH_RDS
                                 	;Записываем SREG
00069a 920f                      	PUSH r0
                                 
00069b 2d9f                      	MOV PID,_PID														;Затираем PID, так как он уже записан в стек
00069c 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
00069e 8120                      	LDD TEMP,Z+_C5_PROC_STATE
00069f ff25                      	SBRS TEMP,C5_PROCID_OPT_TIMER
0006a0 c011                      	RJMP __C5_SUSPEND_NO_TIMER
                                 	;Записываем новую временную метку запуска задачи на базе времени текущего запуска и времени ожидания
0006a1 81d4                      	LDD YH,Z+_C5_TASK_STACK_OFFSET+0x00
0006a2 81c5                      	LDD YL,Z+_C5_TASK_STACK_OFFSET+0x01
0006a3 9725                      	SBIW YL,0x05
0006a4 8128                      	LDD TEMP,Y+0x00
0006a5 818b                      	LDD ACCUM,Y+0x3
0006a6 0f28                      	ADD TEMP,ACCUM
0006a7 8722                      	STD Z+_C5_TASK_EXECTIME+0x02,TEMP
0006a8 8129                      	LDD TEMP,Y+0x01
0006a9 818c                      	LDD ACCUM,Y+0x4
0006aa 1f28                      	ADC TEMP,ACCUM
0006ab 8721                      	STD Z+_C5_TASK_EXECTIME+0x01,TEMP
0006ac 812a                      	LDD TEMP,Y+0x02
0006ad 818d                      	LDD ACCUM,Y+0x05
0006ae 1f28                      	ADC TEMP,ACCUM
0006af 8720                      	STD Z+_C5_TASK_EXECTIME+0x00,TEMP
                                 
0006b0 e024                      	LDI TEMP,_C5_PROC_STATE_TIMER_WAIT
0006b1 c001                      	RJMP __C5_SUSPEND_TIMER
                                 __C5_SUSPEND_NO_TIMER:
0006b2 e025                      	LDI TEMP,_C5_PROC_STATE_READY
                                 __C5_SUSPEND_TIMER:
0006b3 940e 06b6                 	MCALL _C5_SUSPEND__BODY
0006b5 9508                      	RET
                                 ;--------------------------------------------------------
                                 _C5_SUSPEND__BODY:
0006b6 2d9f                      	MOV PID,_PID														;Затираем PID, так как он уже должен быть записан в стек
0006b7 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
0006b9 8180                      	LDD ACCUM,Z+_C5_PROC_STATE
0006ba 7f80                      	ANDI ACCUM,0xf0
0006bb 2b82                      	OR ACCUM,TEMP
0006bc 8380                      	STD Z+_C5_PROC_STATE,ACCUM
                                 
0006bd 94f8                      	CLI
                                 	;Выгружаю и запоминаю адрес процедуры, которая нас вызвала
0006be 901f                      	POP _RESULT_H
0006bf 900f                      	POP _RESULT_L
                                 
                                 	;Получаем текущую позицию в стеке задачи
0006c0 9110 005e                 	LDS TEMP_H,SPH
0006c2 9100 005d                 	LDS TEMP_L,SPL
                                 	;Стек задачи сформирован полностью, можно переключаться на стек ядра
                                 	;Восстанавливаем стек ядра
                                 	;Значение регистров не существенно, диспетчер нужные регистры уже сохранил в стек
                                 	;После прерывания вернемся в диспетчер(после вызова TASK_RESUME)
0006c4 9120 0105                 	LDS TEMP,_C5_CORE_STACK+0x00
0006c6 9320 005e                 	STS SPH,TEMP
0006c8 9120 0106                 	LDS TEMP,_C5_CORE_STACK+0x01
0006ca 9320 005d                 	STS SPL,TEMP
                                 
                                 	;Проверяем на выход стека в зону выделяемой памяти
                                 	;TODO нет проверки на защитный порог(_C5_RAM_BORDER_SIZE)
0006cc 9120 0109                 	LDS TEMP,_C5_TOP_OF_FREE_RAM+0x00
0006ce 1721                      	CP TEMP,TEMP_H
0006cf f050                      	BRCS _C5_SUSPEND__CORRECT_STACK_SIZE
0006d0 f421                      	BRNE _C5_SUSPEND__HUGE_STACK
0006d1 9120 010a                 	LDS TEMP,_C5_TOP_OF_FREE_RAM+0x01
0006d3 1720                      	CP TEMP,TEMP_L
0006d4 f028                      	BRCS _C5_SUSPEND__CORRECT_STACK_SIZE
                                 _C5_SUSPEND__HUGE_STACK:
0006d5 e021                      	LDI TEMP,_C5_FAULT_HUGE_STACK
0006d6 940c 0384                 	MJMP C5_OUT_COREFAULT											;Стеки значения не имеют, ядро упало
0006d8 9120 010a                 	LDS TEMP,_C5_TOP_OF_FREE_RAM+0x01
                                 _C5_SUSPEND__CORRECT_STACK_SIZE:
                                 
                                 	;Получаем начало стека задачи
0006da 8144                      	LDD TEMP_EH,Z+_C5_TASK_STACK_OFFSET+0x00
0006db 8135                      	LDD TEMP_EL,Z+_C5_TASK_STACK_OFFSET+0x01
                                 	;Считаем новую длину
0006dc 1b30                      	SUB TEMP_EL,TEMP_L
0006dd 0b41                      	SBC TEMP_EH,TEMP_H
0006de 2344                      	TST TEMP_EH
0006df f019                      	BREQ PC+0x02+_MCALL_SIZE
0006e0 e023                      	LDI TEMP,_C5_FAULT_HUGE_TASK_STACK2
0006e1 940e 0384                 	MCALL C5_OUT_COREFAULT											;Стеки значения не имеют, ядро упало
                                 
                                 	;Обновляем длину стека задачи
0006e3 8336                      	STD Z+_C5_TASK_STACK_SIZE,TEMP_EL
                                 	;Обновляем вершину стека задач
0006e4 9310 0107                 	STS _C5_TOP_OF_STACK+0x00,TEMP_H
0006e6 9300 0108                 	STS _C5_TOP_OF_STACK+0x01,TEMP_L
                                 
0006e8 940e 03df                 	MCALL C5_DISPATCHER_UNLOCK
                                 	;Восстанавливаем адрес процедуры, которая нас вызвала
0006ea 920f                      	PUSH _RESULT_L
0006eb 921f                      	PUSH _RESULT_H
0006ec 9478                      	SEI
0006ed 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _C5_STACK_TO_TOP:
                                 ;--------------------------------------------------------
                                 ;Переносим стек задачи наверх
                                 ;IN: Z-адрес на заголовок задачи
                                 ;--------------------------------------------------------
0006ee 93ff
0006ef 93ef                      	PUSH_Z
0006f0 939f                      	PUSH PID
                                 	;Проверка, если стек задачи и так наверху
                                 	;Получаем размер стека текущей задачи
0006f1 8136                      	LDD TEMP_EL,Z+_C5_TASK_STACK_SIZE
0006f2 8114                      	LDD TEMP_H,Z+_C5_TASK_STACK_OFFSET+0x00
0006f3 8105                      	LDD TEMP_L,Z+_C5_TASK_STACK_OFFSET+0x01
0006f4 1b03                      	SUB TEMP_L,TEMP_EL
0006f5 4010                      	SBCI TEMP_H,0x00
0006f6 9120 0107                 	LDS TEMP,_C5_TOP_OF_STACK+0x00
0006f8 1712                      	CP TEMP_H,TEMP
0006f9 f419                      	BRNE PC+0x04
0006fa 9120 0108                 	LDS TEMP,_C5_TOP_OF_STACK+0x01
0006fc 1702                      	CP TEMP_L,TEMP
0006fd f1c9                      	BREQ _C5_STACK_TO_TOP__END
                                 
                                 	;Получаем старое смещение на стек текущей задачи
0006fe 81b4                      	LDD XH,Z+_C5_TASK_STACK_OFFSET+0x00
0006ff 81a5                      	LDD XL,Z+_C5_TASK_STACK_OFFSET+0x01
                                 
                                 	;Получаем вершину стека задач
000700 9110 0107                 	LDS TEMP_H,_C5_TOP_OF_STACK+0x00
000702 9100 0108                 	LDS TEMP_L,_C5_TOP_OF_STACK+0x01
000704 8314                      	STD Z+_C5_TASK_STACK_OFFSET+0x00,TEMP_H
000705 8305                      	STD Z+_C5_TASK_STACK_OFFSET+0x01,TEMP_L
000706 2ff1                      	MOV ZH,TEMP_H
000707 2fe0                      	MOV ZL,TEMP_L
000708 93ff
000709 93ef                      	PUSH_Z
                                 	;Копируем стек задачи наверх
                                 	;TODO из смещений нужно вычесть длину стека задачи(+/-1)
00070a 2f53                      	MOV LOOP_CNTR,TEMP_EL
00070b 940e 0075                 	MCALL RAM_COPY_DESC
                                 
                                 	;Записываем старое смещение на стек текущей задачи
00070d 2ffb                      	MOV ZH,XH
00070e 2fea                      	MOV ZL,XL
                                 	;Получаем смещение на следующий стек задачи
00070f 1ba3                      	SUB XL,TEMP_EL
000710 40b0                      	SBCI XH,0x00
                                 
000711 910f                      	POP TEMP_L
000712 911f                      	POP TEMP_H
                                 
                                 	;Вычисляем размер копируемых данных(Z-старый адрес стека задачи, TEMP_H/L-вершина стека задач)
000713 93ff
000714 93ef                      	PUSH_Z
000715 1be0                      	SUB ZL,TEMP_L
000716 0bf1                      	SBC ZH,TEMP_H
000717 2f1f                      	MOV TEMP_H,ZH
000718 2f0e                      	MOV TEMP_L,ZL
000719 91ef
00071a 91ff                      	POP_Z
00071b 93ff
00071c 93ef                      	PUSH_Z
                                 	;Копируем данные
00071d 940e 0088                 	MCALL RAM_COPY16_DESC
00071f 91af
000720 91bf                      	POP_X																	;X теперь хранит страое смещение на стек задачи
                                 
000721 e090                      	LDI PID,0x00
                                 _C5_STACK_TO_TOP__LOOP:
000722 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 
                                 	;Если задачи нет, пропускаем
000724 8120                      	LDD TEMP,Z+_C5_PROC_STATE
000725 702f                      	ANDI TEMP,0x0f
000726 3020                      	CPI TEMP,_C5_PROC_STATE_ABSENT
000727 f061                      	BREQ _C5_STACK_TO_TOP__NEXT_TASK
                                 
                                 	;Проверка, если адрес стека задачи в цикле больше чем адрес стека основной задачи(X), то пропускаем(равенство исключено)
000728 8114                      	LDD TEMP_H,Z+_C5_TASK_STACK_OFFSET+0x00
000729 8105                      	LDD TEMP_L,Z+_C5_TASK_STACK_OFFSET+0x01
00072a 17b1                      	CP XH,TEMP_H
00072b f040                      	BRCS _C5_STACK_TO_TOP__NEXT_TASK
00072c f411                      	BRNE _C5_STACK_TO_TOP__CHANGE_OFFSET
00072d 17a0                      	CP XL,TEMP_L
00072e f028                      	BRCS _C5_STACK_TO_TOP__NEXT_TASK
                                 
                                 _C5_STACK_TO_TOP__CHANGE_OFFSET:
                                 	;Изменяем смещение на длину стека основной задачи
00072f 0f03                      	ADD TEMP_L,TEMP_EL
000730 2722                      	CLR TEMP
000731 1f12                      	ADC TEMP_H,TEMP
000732 8314                      	STD Z+_C5_TASK_STACK_OFFSET+0x00,TEMP_H
000733 8305                      	STD Z+_C5_TASK_STACK_OFFSET+0x01,TEMP_L
                                 
                                 _C5_STACK_TO_TOP__NEXT_TASK:
000734 9593                      	INC PID
000735 3190                      	CPI PID,C5_TASKS_QNT
000736 f759                      	BRNE _C5_STACK_TO_TOP__LOOP
                                 
                                 _C5_STACK_TO_TOP__END:
000737 919f                      	POP PID
000738 91ef
000739 91ff                      	POP_Z
00073a 9508                      	RET
                                 .endif
                                 	;---
                                 	;Блок драйверов
                                 	.INCLUDE "./core/drivers/spi_ms.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.11.2020	w5277c@gmail.com			Начало
                                 ;04.06.2021	w5277c@gmail.com			Исправлены смещения переходов
                                 ;04.07.2021	w5277c@gmail.com			Z->Y, необходимо тестирование
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO реализовать прием данных
                                 ;TODO объединить с кодом ведомого?
                                 
                                 .ifdef DEF__C5_DRV_SPI_MS
                                 .else
                                 .set DEF__C5_DRV_SPI_MS = 1
C:\repos\w5277c\core5277\./core/drivers/spi_ms.inc(14): Included driver software SPI master v0.3
                                 .message "Included driver software SPI master v0.3"
                                 
                                 .include	"./core/ram/ram_offset.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			+Z,+Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 .ifdef DEF_C5_RAM_OFFSET
                                 .else
                                 .set DEF_C5_RAM_OFFSET = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/ram/ram_offset.inc(15): included C5_RAM_OFFSET
                                 .message "included C5_RAM_OFFSET"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_RAM_OFFSET:
                                 ;--------------------------------------------------------
                                 ;Получаем адрес выделенной памяти
                                 ;IN: PID-ид задачи или драйвера
                                 ;OUT: Y-смещение на начало выделенной памяти
                                 ;--------------------------------------------------------
00073b 93ff
00073c 93ef                      	PUSH_Z
00073d 940e 061d                 	MCALL _C5_PROC_HEADER_GET
00073f 81d1                      	LDD YH,Z+_C5_PROC_RAM_OFFSET+0x00
000740 81c2                      	LDD YL,Z+_C5_PROC_RAM_OFFSET+0x01
000741 91ef
000742 91ff                      	POP_Z
000743 9508                      	RET
                                 .endif
                                 .include	"./core/ram/ram_realloc.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_REALLOC
                                 .else
                                 .set DEF_C5_RAM_REALLOC = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/ram/ram_realloc.inc(14): included C5_RAM_REALLOC
                                 .message "included C5_RAM_REALLOC"
                                 .endif
                                 
                                 .include	"./core/ram/_ram_find_free_block.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_FIND_FREE_BLOCK
                                 .else
                                 .set DEF_C5_RAM_FIND_FREE_BLOCK = 1
                                 
                                 .include	"./core/ram/_ram_find_used_block_mt.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;06.02.2021	w5277c@gmail.com			Проверка на отсутствие драйверов
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_FIND_USED_BLOCK_MT
                                 .else
                                 .set DEF_C5_RAM_FIND_USED_BLOCK_MT = 1
                                 
                                 ;--------------------------------------------------------
                                 _C5_RAM_FIND_USED_BLOCK_MT:
                                 ;--------------------------------------------------------
                                 ;Ищем ближайший занятый блок выделяемой памяти в задачах,
                                 ;адрес которого будет больше, чем указанный адрес
                                 ;IN: Y-адрес текущего блока
                                 ;OUT: Y-адрес найденного блока, ACCUM-длина блока,
                                 ;flag Z-результат(true-найдено)
                                 ;--------------------------------------------------------
000744 93bf
000745 93af                      	PUSH_X
000746 93ff
000747 93ef                      	PUSH_Z
000748 931f                      	PUSH TEMP_H
000749 930f                      	PUSH TEMP_L
00074a 932f                      	PUSH TEMP
00074b 935f                      	PUSH LOOP_CNTR
                                 
00074c 2788                      	CLR ACCUM
00074d efbf
00074e efaf                      	LDI_X 0xffff
                                 
                                 .IF	0x00 != C5_DRIVERS_QNT
00074f e050                      	LDI LOOP_CNTR,0x00
000750 e0f1
000751 eee1                      	LDI_Z _C5_DRIVERS_HEADER
                                 _C5_RAM_FIND_USED_BLOCK_MT__LOOP1:
000752 940e 0772                 	MCALL _C5_RAM_FIND_USED_BLOCK_MT__BODY
000754 9636                      	ADIW ZL,_C5_DRIVER_HEADER_SIZE
000755 9553                      	INC LOOP_CNTR
000756 3150                      	CPI LOOP_CNTR,C5_DRIVERS_QNT
000757 f7d1                      	BRNE _C5_RAM_FIND_USED_BLOCK_MT__LOOP1
                                 .ENDIF
                                 
000758 e050                      	LDI LOOP_CNTR,0x00
000759 e0f2
00075a e4e1                      	LDI_Z _C5_TASKS_HEADER
                                 _C5_RAM_FIND_USED_BLOCK_MT__LOOP2:
00075b 940e 0772                 	MCALL _C5_RAM_FIND_USED_BLOCK_MT__BODY
00075d 963b                      	ADIW ZL,_C5_TASK_HEADER_SIZE
00075e 9553                      	INC LOOP_CNTR
00075f 3150                      	CPI LOOP_CNTR,C5_TASKS_QNT
000760 f7d1                      	BRNE _C5_RAM_FIND_USED_BLOCK_MT__LOOP2
                                 
000761 3fbf                      	CPI XH,0xff
000762 f421                      	BRNE _C5_RAM_FIND_USED_BLOCK_MT__OK
000763 3faf                      	CPI XL,0xff
000764 f411                      	BRNE _C5_RAM_FIND_USED_BLOCK_MT__OK
000765 9498                      	CLZ
000766 c002                      	RJMP _C5_RAM_FIND_USED_BLOCK_MT__END
                                 _C5_RAM_FIND_USED_BLOCK_MT__OK:
000767 01ed                      	MOVW YL,XL
000768 9418                      	SEZ
                                 _C5_RAM_FIND_USED_BLOCK_MT__END:
000769 915f                      	POP LOOP_CNTR
00076a 912f                      	POP TEMP
00076b 910f                      	POP TEMP_L
00076c 911f                      	POP TEMP_H
00076d 91ef
00076e 91ff                      	POP_Z
00076f 91af
000770 91bf                      	POP_X
000771 9508                      	RET
                                 
                                 _C5_RAM_FIND_USED_BLOCK_MT__BODY:
                                 	;Проверяем на активную задачу
000772 8120                      	LDD TEMP,Z+_C5_PROC_STATE
000773 702f                      	ANDI TEMP,0x0f
000774 3020                      	CPI TEMP,_C5_PROC_STATE_ABSENT
000775 f0b1                      	BREQ _C5_RAM_FIND_USED_BLOCK_MT__NEXT
000776 8111                      	LDD TEMP_H,Z+_C5_PROC_RAM_OFFSET+0x00
000777 8102                      	LDD TEMP_L,Z+_C5_PROC_RAM_OFFSET+0x01
000778 8123                      	LDD TEMP,Z+_C5_PROC_RAM_SIZE
                                 	;Проверяем на нули
000779 3010                      	CPI TEMP_H,0x00
00077a f411                      	BRNE PC+0x03
00077b 3000                      	CPI TEMP_L,0x00
00077c f079                      	BREQ _C5_RAM_FIND_USED_BLOCK_MT__NEXT
00077d 3020                      	CPI TEMP,0x00
00077e f069                      	BREQ _C5_RAM_FIND_USED_BLOCK_MT__NEXT
                                 	;Проверям, что адрес найденного блока больше заданного
00077f 17d1                      	CP YH,TEMP_H
000780 f009                      	BREQ PC+0x02
000781 f450                      	BRCC _C5_RAM_FIND_USED_BLOCK_MT__NEXT
000782 17c0                      	CP YL,TEMP_L
000783 f440                      	BRCC _C5_RAM_FIND_USED_BLOCK_MT__NEXT
                                 	;Заменяем результат, если полученный адрес меньше предыдущего
000784 17b1                      	CP XH,TEMP_H
000785 f030                      	BRCS _C5_RAM_FIND_USED_BLOCK_MT__NEXT
000786 f411                      	BRNE PC+0x03
000787 17a0                      	CP XL,TEMP_L
000788 f018                      	BRCS _C5_RAM_FIND_USED_BLOCK_MT__NEXT
000789 2fb1                      	MOV XH,TEMP_H
00078a 2fa0                      	MOV XL,TEMP_L
00078b 2f82                      	MOV ACCUM,TEMP
                                 _C5_RAM_FIND_USED_BLOCK_MT__NEXT:
00078c 9508                      	RET
                                 .endif
                                 .include	"./core/ram/_ram_check_stack.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_CHECK_STACK
                                 .else
                                 .set DEF_C5_RAM_CHECK_STACK = 1
                                 
                                 ;--------------------------------------------------------
                                 _C5_RAM_CHECK_STACK:
                                 ;--------------------------------------------------------
                                 ;Проверяем на влияние на стек
                                 ;IN: Y-адрес блока, ACCUM - длина
                                 ;OUT: flag Z(true-влияния нет)
                                 ;--------------------------------------------------------
00078d 93bf
00078e 93af                      	PUSH_X
00078f 93df
000790 93cf                      	PUSH_Y
                                 
                                 	;Считаем конец блока
000791 0fc8                      	ADD YL,ACCUM
000792 1dd7                      	ADC YH,C0x00
                                 	;Получаем адрес вершины стека
000793 91b0 0107                 	LDS XH,_C5_TOP_OF_STACK+0x00
000795 91a0 0108                 	LDS XL,_C5_TOP_OF_STACK+0x01
                                 	;Находим разницу
000797 1bac                      	SUB XL,YL
000798 0bbd                      	SBC XH,YH
000799 f020                      	BRCS _C5_RAM_CHECK_STACK__FAIL
                                 	;Учитываем минимально допустимый размер
00079a 9718                      	SBIW XL,_C5_RAM_BORDER_SIZE
00079b f010                      	BRCS _C5_RAM_CHECK_STACK__FAIL
00079c 9418                      	SEZ
00079d c001                      	RJMP _C5_RAM_CHECK_STACK__END
                                 _C5_RAM_CHECK_STACK__FAIL:
00079e 9498                      	CLZ
                                 _C5_RAM_CHECK_STACK__END:
00079f 91cf
0007a0 91df                      	POP_Y
0007a1 91af
0007a2 91bf                      	POP_X
0007a3 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _C5_RAM_FIND_FREE_BLOCK:
                                 ;--------------------------------------------------------
                                 ;Ищем блок свободной памяти запрошенного размера
                                 ;IN: ACCUM-размер запрошенного блока
                                 ;OUT: Y-адрес блока, flag Z-результат(true-найдено)
                                 ;--------------------------------------------------------
0007a4 93bf
0007a5 93af                      	PUSH_X
0007a6 93ff
0007a7 93ef                      	PUSH_Z
0007a8 932f                      	PUSH TEMP
0007a9 938f                      	PUSH ACCUM
0007aa 935f                      	PUSH LOOP_CNTR
                                 
0007ab e0d5
0007ac e1c0                      	LDI_Y _C5_FREE_RAM-0x01
0007ad e021                      	LDI TEMP,0x01
                                 
                                 _C5_RAM_FIND_FREE_BLOCK__LOOP:
0007ae 2f52                      	MOV LOOP_CNTR,TEMP
0007af 01de                      	MOVW XL,YL
0007b0 938f                      	PUSH ACCUM
0007b1 940e 0744                 	MCALL _C5_RAM_FIND_USED_BLOCK_MT
0007b3 2f28                      	MOV TEMP,ACCUM
0007b4 918f                      	POP ACCUM
0007b5 f471                      	BRNE _C5_RAM_FIND_FREE_BLOCK__ON_TOP
0007b6 01fe                      	MOVW ZL,YL
0007b7 1bea                      	SUB ZL,XL
0007b8 0bfb                      	SBC ZH,XH															;!!! не влияет на флаг Z
0007b9 1be5                      	SUB ZL,LOOP_CNTR
0007ba 09f7                      	SBC ZH,C0x00
0007bb f390                      	BRCS _C5_RAM_FIND_FREE_BLOCK__LOOP
0007bc 30f0                      	CPI ZH,0x00
0007bd f411                      	BRNE _C5_RAM_FIND_FREE_BLOCK__GOT_BLOCK
0007be 1be8                      	SUB ZL,ACCUM
0007bf f370                      	BRCS _C5_RAM_FIND_FREE_BLOCK__LOOP
                                 _C5_RAM_FIND_FREE_BLOCK__GOT_BLOCK:
0007c0 01ed                      	MOVW YL,XL
0007c1 940e 078d                 	MCALL _C5_RAM_CHECK_STACK
0007c3 c008                      	RJMP _C5_RAM_FIND_FREE_BLOCK__END
                                 _C5_RAM_FIND_FREE_BLOCK__ON_TOP:
0007c4 91d0 0109                 	LDS YH,_C5_TOP_OF_FREE_RAM+0x00
0007c6 91c0 010a                 	LDS YL,_C5_TOP_OF_FREE_RAM+0x01
0007c8 940e 078d                 	MCALL _C5_RAM_CHECK_STACK
0007ca c001                      	RJMP _C5_RAM_FIND_FREE_BLOCK__END
                                 _C5_RAM_FIND_FREE_BLOCK__FAIL:
0007cb 9498                      	CLZ
                                 _C5_RAM_FIND_FREE_BLOCK__END:
0007cc 915f                      	POP LOOP_CNTR
0007cd 918f                      	POP ACCUM
0007ce 912f                      	POP TEMP
0007cf 91ef
0007d0 91ff                      	POP_Z
0007d1 91af
0007d2 91bf                      	POP_X
0007d3 9508                      	RET
                                 .endif
                                 .include	"./core/ram/_ram_resize.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5__RAM_RESIZE
                                 .else
                                 .set DEF_C5__RAM_RESIZE = 1
                                 
                                 .include	"./core/ram/_ram_find_used_block_mt.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;06.02.2021	w5277c@gmail.com			Проверка на отсутствие драйверов
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_FIND_USED_BLOCK_MT
                                 .else
                                 .IF	0x00 != C5_DRIVERS_QNT
                                 .ENDIF
                                 .endif
                                 .include	"./core/ram/_ram_find_used_block_lt.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;06.02.2021	w5277c@gmail.com			Проверка на отсутствие драйверов
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_FIND_USED_BLOCK_LT
                                 .else
                                 .set DEF_C5_RAM_FIND_USED_BLOCK_LT = 1
                                 
                                 ;--------------------------------------------------------
                                 _C5_RAM_FIND_USED_BLOCK_LT:
                                 ;--------------------------------------------------------
                                 ;Ищем ближайший занятый блок выделяемой памяти в задачах,
                                 ;адрес которого будет меньше, чем указанный адрес
                                 ;IN: Y-адрес текущего блока
                                 ;OUT: Y-адрес найденного блока, ACCUM-длина блока,
                                 ;flag Z-результат(true-найдено)
                                 ;--------------------------------------------------------
0007d4 93bf
0007d5 93af                      	PUSH_X
0007d6 93ff
0007d7 93ef                      	PUSH_Z
0007d8 931f                      	PUSH TEMP_H
0007d9 930f                      	PUSH TEMP_L
0007da 932f                      	PUSH TEMP
0007db 935f                      	PUSH LOOP_CNTR
                                 
0007dc e0b0
0007dd e0a0                      	LDI_X 0x0000
                                 
                                 .IF	0x00 != C5_DRIVERS_QNT
0007de e050                      	LDI LOOP_CNTR,0x00
0007df e0f1
0007e0 eee1                      	LDI_Z _C5_DRIVERS_HEADER
                                 _C5_RAM_FIND_USED_BLOCK_LT__LOOP1:
0007e1 940e 0801                 	MCALL _C5_RAM_FIND_USED_BLOCK_LT__BODY
0007e3 9636                      	ADIW ZL,_C5_DRIVER_HEADER_SIZE
0007e4 9553                      	INC LOOP_CNTR
0007e5 3150                      	CPI LOOP_CNTR,C5_DRIVERS_QNT
0007e6 f7d1                      	BRNE _C5_RAM_FIND_USED_BLOCK_LT__LOOP1
                                 .ENDIF
                                 
0007e7 e050                      	LDI LOOP_CNTR,0x00
0007e8 e0f2
0007e9 e4e1                      	LDI_Z _C5_TASKS_HEADER
                                 _C5_RAM_FIND_USED_BLOCK_LT__LOOP2:
0007ea 940e 0801                 	MCALL _C5_RAM_FIND_USED_BLOCK_LT__BODY
0007ec 963b                      	ADIW ZL,_C5_TASK_HEADER_SIZE
0007ed 9553                      	INC LOOP_CNTR
0007ee 3150                      	CPI LOOP_CNTR,C5_TASKS_QNT
0007ef f7d1                      	BRNE _C5_RAM_FIND_USED_BLOCK_LT__LOOP2
                                 
0007f0 3fbf                      	CPI XH,0xff
0007f1 f421                      	BRNE _C5_RAM_FIND_USED_BLOCK_LT__OK
0007f2 3faf                      	CPI XL,0xff
0007f3 f411                      	BRNE _C5_RAM_FIND_USED_BLOCK_LT__OK
0007f4 9498                      	CLZ
0007f5 c002                      	RJMP _C5_RAM_FIND_USED_BLOCK_LT__END
                                 _C5_RAM_FIND_USED_BLOCK_LT__OK:
0007f6 01ed                      	MOVW YL,XL
0007f7 9418                      	SEZ
                                 _C5_RAM_FIND_USED_BLOCK_LT__END:
0007f8 915f                      	POP LOOP_CNTR
0007f9 912f                      	POP TEMP
0007fa 910f                      	POP TEMP_L
0007fb 911f                      	POP TEMP_H
0007fc 91ef
0007fd 91ff                      	POP_Z
0007fe 91af
0007ff 91bf                      	POP_X
000800 9508                      	RET
                                 
                                 _C5_RAM_FIND_USED_BLOCK_LT__BODY:
                                 	;Проверяем на активную задачу
000801 8120                      	LDD TEMP,Z+_C5_PROC_STATE
000802 702f                      	ANDI TEMP,0x0f
000803 3020                      	CPI TEMP,_C5_PROC_STATE_ABSENT
000804 f081                      	BREQ _C5_RAM_FIND_USED_BLOCK_LT__NEXT
000805 8111                      	LDD TEMP_H,Z+_C5_PROC_RAM_OFFSET+0x00
000806 8102                      	LDD TEMP_L,Z+_C5_PROC_RAM_OFFSET+0x01
000807 8123                      	LDD TEMP,Z+_C5_PROC_RAM_SIZE
                                 	;Проверям, что адрес найденного блока меньше заданного
000808 17d1                      	CP YH,TEMP_H
000809 f058                      	BRCS _C5_RAM_FIND_USED_BLOCK_LT__NEXT
00080a f411                      	BRNE PC+0x03
00080b 170c                      	CP TEMP_L,YL
00080c f440                      	BRCC _C5_RAM_FIND_USED_BLOCK_LT__NEXT
                                 	;Заменяем результат, если полученный адрес больше предыдущего
00080d 17b1                      	CP XH,TEMP_H
00080e f009                      	BREQ PC+0x02
00080f f428                      	BRCC _C5_RAM_FIND_USED_BLOCK_LT__NEXT
000810 17a0                      	CP XL,TEMP_L
000811 f418                      	BRCC _C5_RAM_FIND_USED_BLOCK_LT__NEXT
000812 2fb1                      	MOV XH,TEMP_H
000813 2fa0                      	MOV XL,TEMP_L
000814 2f82                      	MOV ACCUM,TEMP
                                 _C5_RAM_FIND_USED_BLOCK_LT__NEXT:
000815 9508                      	RET
                                 .endif
                                 .include	"./core/ram/_ram_find_free_block.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_FIND_FREE_BLOCK
                                 .else
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _C5_RAM_RESIZE:
                                 ;--------------------------------------------------------
                                 ;Изменение размера выделенного блока
                                 ;IN:Y-адрес блока, TEMP-новый размер
                                 ;OUT:Y-новый адрес блока
                                 ;--------------------------------------------------------
000816 93bf
000817 93af                      	PUSH_X
000818 93ff
000819 93ef                      	PUSH_Z
00081a 932f                      	PUSH TEMP
00081b 938f                      	PUSH ACCUM
                                 
00081c 01de                      	MOVW XL,YL
                                 
                                 	;Находим следующий блок
00081d 940e 0744                 	MCALL _C5_RAM_FIND_USED_BLOCK_MT
                                 	;Z=true - блок найден, иначе находимся на вершине
00081f f019                      	BREQ PC+0x04
000820 01ed                      	MOVW YL,XL
000821 2f82                      	MOV ACCUM,TEMP
000822 c012                      	RJMP _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP
                                 
                                 	;Считаем дельту между блоками
000823 1bca                      	SUB YL,XL
000824 0bdb                      	SBC YH,XH
000825 30d0                      	CPI YH,0x00
000826 f411                      	BRNE PC+0x03
000827 17c2                      	CP YL,TEMP
000828 f018                      	BRCS PC+0x04
000829 01ed                      	MOVW YL,XL
00082a 2f82                      	MOV ACCUM,TEMP
                                 	;Свободной памяти между текущими блоками достаточно для расширения
00082b f4d9                      	BRNE _C5_RAM_RESIZE__SUCCESS
                                 
                                 	;Выполняем поиск свободного блока
00082c 2f82                      	MOV ACCUM,TEMP
00082d 940e 07a4                 	MCALL _C5_RAM_FIND_FREE_BLOCK
                                 	;Если даже блок не найден, то процедура возвращает адрес вершины блоков
                                 
                                 	;Копируем старый блок на новое место
00082f 935f                      	PUSH LOOP_CNTR
000830 2f58                      	MOV LOOP_CNTR,ACCUM
000831 01fe                      	MOVW ZL,YL
000832 940e 005e                 	MCALL RAM_COPY
000834 915f                      	POP LOOP_CNTR
                                 
                                 _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP:
000835 940e 078d                 	MCALL _C5_RAM_CHECK_STACK
000837 f489                      	BRNE _C5_RAM_RESIZE__ERROR
                                 
                                 
                                 	;Проверяем на полное освобождение (нужно учесть, что перед текущим блоком может быть пустое пространство)
000838 3080                      	CPI ACCUM,0x00
000839 f431                      	BRNE _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP2
00083a 940e 07d4                 	MCALL _C5_RAM_FIND_USED_BLOCK_LT
00083c f019                      	BREQ _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP2
                                 	;Блок не найден, значит восстанавливаю изначальное состояние
00083d e0d5
00083e e1c1                      	LDI_Y _C5_FREE_RAM
00083f c000                      	RJMP _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP2
                                 _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP__HAVE_BLOCK:
                                 
                                 _C5_RAM_RESIZE__HEADER_UPDATE_ON_TOP2:
                                 	;Обновляем вершину безусловно, так как мы на вершине
000840 01de                      	MOVW XL,YL
000841 0fa8                      	ADD XL,ACCUM
000842 1db7                      	ADC XH,C0x00
000843 93b0 0109                 	STS _C5_TOP_OF_FREE_RAM+0x00,XH
000845 93a0 010a                 	STS _C5_TOP_OF_FREE_RAM+0x01,XL
                                 
                                 _C5_RAM_RESIZE__SUCCESS:
000847 9418                      	SEZ
000848 c001                      	RJMP _C5_RAM_RESIZE__END
                                 _C5_RAM_RESIZE__ERROR:
000849 9498                      	CLZ
                                 _C5_RAM_RESIZE__END:
00084a 918f                      	POP ACCUM
00084b 912f                      	POP TEMP
00084c 91ef
00084d 91ff                      	POP_Z
00084e 91af
00084f 91bf                      	POP_X
000850 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_RAM_REALLOC:
                                 ;--------------------------------------------------------
                                 ;Перевыделяем память(в том числе освобождаем)
                                 ;IN: PID, ACCUM-общий размер памяти
                                 ;OUT: Y-адрес на выделенную часть
                                 ;flag Z(false-error,owerflow)
                                 ;--------------------------------------------------------
000851 93bf
000852 93af                      	PUSH_X
000853 93ff
000854 93ef                      	PUSH_Z
000855 938f                      	PUSH ACCUM
000856 932f                      	PUSH TEMP
000857 940e 03df                 	MCALL C5_DISPATCHER_LOCK
                                 
                                 	;Получаем заголовок
000859 940e 061d                 	MCALL _C5_PROC_HEADER_GET
                                 	;Точка входа для C5_RAM_EXTEND
                                 _C5_RAM_REALLOC__EP2:
                                 	;Читаем адрес первой свободной ячейки выделяемой памяти
00085b 81d1                      	LDD YH,Z+_C5_PROC_RAM_OFFSET+0x00
00085c 81c2                      	LDD YL,Z+_C5_PROC_RAM_OFFSET+0x01
                                 	;Проверяем на уже выделенную память
00085d 30d0                      	CPI YH,0x00
00085e f4b1                      	BRNE _C5_RAM_REALLOC__ALLOCATED
00085f 30c0                      	CPI YL,0x00
000860 f4a1                      	BRNE _C5_RAM_REALLOC__ALLOCATED
                                 
000861 2f28                      	MOV TEMP,ACCUM
000862 940e 07a4                 	MCALL _C5_RAM_FIND_FREE_BLOCK
000864 f4e9                      	BRNE _C5_RAM_REALLOC__ERROR
                                 
                                 	;Проверяем, нужно ли обновлять вершину выделяемой памяти
000865 01de                      	MOVW XL,YL
000866 0fa8                      	ADD XL,ACCUM
000867 1db7                      	ADC XH,C0x00
000868 9180 0109                 	LDS ACCUM,_C5_TOP_OF_FREE_RAM+0x00
00086a 178b                      	CP ACCUM,XH
00086b f020                      	BRCS PC+0x05
00086c 9180 010a                 	LDS ACCUM,_C5_TOP_OF_FREE_RAM+0x01
00086e 178a                      	CP ACCUM,XL
00086f f448                      	BRCC _C5_RAM_REALLOC__SUCCESS
                                 	;Обновляем адрес вершины выделяемой памяти в ядре
000870 93b0 0109                 	STS _C5_TOP_OF_FREE_RAM+0x00,XH
000872 93a0 010a                 	STS _C5_TOP_OF_FREE_RAM+0x01,XL
000874 c004                      	RJMP _C5_RAM_REALLOC__SUCCESS
                                 
                                 _C5_RAM_REALLOC__ALLOCATED:
000875 2f28                      	MOV TEMP,ACCUM
000876 940e 0816                 	MCALL _C5_RAM_RESIZE
000878 f449                      	BRNE _C5_RAM_REALLOC__ERROR
                                 _C5_RAM_REALLOC__SUCCESS:
                                 	;Обновляем заголовок
                                 	;Если длина нулевая, то и адрес блока нулевой
000879 3020                      	CPI TEMP,0x00
00087a f411                      	BRNE PC+0x03
00087b 27dd                      	CLR YH
00087c 27cc                      	CLR YL
00087d 83d1                      	STD Z+_C5_PROC_RAM_OFFSET+0x00,YH
00087e 83c2                      	STD Z+_C5_PROC_RAM_OFFSET+0x01,YL
00087f 8323                      	STD Z+_C5_PROC_RAM_SIZE,TEMP
000880 9418                      	SEZ
000881 c001                      	RJMP _C5_RAM_REALLOC__END
                                 _C5_RAM_REALLOC__ERROR:
000882 9498                      	CLZ
                                 _C5_RAM_REALLOC__END:
000883 940e 03df                 	MCALL C5_DISPATCHER_UNLOCK
000885 912f                      	POP TEMP
000886 918f                      	POP ACCUM
000887 91ef
000888 91ff                      	POP_Z
000889 91af
00088a 91bf                      	POP_X
00088b 9508                      	RET
                                 .endif
                                 .include	"./core/wait_1s.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019  w5277c@gmail.com        Начало
                                 ;09.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_WAIT_1S
                                 .else
                                 .set DEF_C5_WAIT_1S = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/wait_1s.inc(13): included C5_WAIT_1S
                                 .message "included C5_WAIT_1S"
                                 .endif
                                 
                                 .include "./core/wait_2ms.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;09.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;22.01.2020	w5277c@gmail.com			Учет CORE_FREQ
                                 ;31.05.2021	w5277c@gmail.com			Реализация на таймере
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_WAIT_2MS
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .if TS_MODE == TS_MODE_TIME
                                 .else
                                 .endif
                                 .endif
                                 ;--------------------------------------------------------
                                 C5_WAIT_1S:
                                 ;--------------------------------------------------------
                                 ;Ждем
                                 ;IN TEMP - время в 1s
                                 ;--------------------------------------------------------
00088c 931f                      	PUSH TEMP_H
00088d 930f                      	PUSH TEMP_L
00088e 932f                      	PUSH TEMP
00088f 935f                      	PUSH LOOP_CNTR
                                 
000890 2f52                      	MOV LOOP_CNTR,TEMP
                                 _C5_WAIT_SEC__LOOP:
000891 2711                      	CLR TEMP_H
000892 e001                      	LDI TEMP_L,0x01
000893 ef24                      	LDI TEMP,0xf4
000894 940e 00ad                 	MCALL C5_WAIT_2MS
000896 955a                      	DEC LOOP_CNTR
000897 f7c9                      	BRNE _C5_WAIT_SEC__LOOP
                                 
                                 _C5_WAIT_SEC__END:
000898 915f                      	POP LOOP_CNTR
000899 912f                      	POP TEMP
00089a 910f                      	POP TEMP_L
00089b 911f                      	POP TEMP_H
00089c 9508                      	RET
                                 .endif
                                 .include	"./io/port_mode_in.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_MODE_IN
                                 .else
                                 .set DEF_PORT_MODE_IN = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./io/port_mode_in.inc(16): included PORT_MODE_IN
                                 .message "included PORT_MODE_IN"
                                 .endif
                                 
                                 .include	"./io/port_offsets.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_OFFSETS
                                 .else
                                 .set DEF_PORT_OFFSETS = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./io/port_offsets.inc(14): included PORT_OFFSETS
                                 .message "included PORT_OFFSETS"
                                 .endif
                                 
                                 .include	"./conv/bitnum_to_num.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;28.12.2020	w5277c@gmail.com			;Переделал на табличный вариант
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 .ifdef DEF_BITNUM_TO_NUM
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 
                                 
                                 ;--------------------------------------------------------
                                 PORT_OFFSETS:
                                 ;--------------------------------------------------------
                                 ;Возвращаем адреса для PORTx, DDRx и PINx,
                                 ;а также пин в виде числа(1,2,4,8,16,32,64,128)
                                 ;IN: ACCUM-сдвоенный порт и пин (PA0, PC7 и т.п.)
                                 ;OUT: TEMP_H-адрес регистра PORTx,
                                 ;TEMP_L-адрес регистра DDRx,
                                 ;TEMP-адрес регистра PINx
                                 ;ACCUM-пин в виде числа
                                 ;--------------------------------------------------------
00089d 93ff
00089e 93ef                      	PUSH_Z
                                 
00089f e0f0
0008a0 e6e8                      	LDI_Z (PORTS_TABLE*2)
0008a1 2f28                      	MOV TEMP,ACCUM
0008a2 9582                      	SWAP ACCUM
0008a3 708f                      	ANDI ACCUM,0x0f
0008a4 2f18                      	MOV TEMP_H,ACCUM
0008a5 0f88                      	LSL ACCUM
0008a6 0f81                      	ADD ACCUM,TEMP_H
0008a7 0fe8                      	ADD ZL,ACCUM
0008a8 1df7                      	ADC ZH,C0x00
0008a9 9115                      	LPM TEMP_H,Z+
0008aa 9105                      	LPM TEMP_L,Z+
0008ab 9184                      	LPM ACCUM,Z
0008ac 938f                      	PUSH ACCUM
0008ad 702f                      	ANDI TEMP,0x0f
0008ae 940e 00a3                 	MCALL BITNUM_TO_NUM
0008b0 2f82                      	MOV ACCUM,TEMP
0008b1 912f                      	POP TEMP
                                 
0008b2 91ef
0008b3 91ff                      	POP_Z
0008b4 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 PORT_MODE_IN:
                                 ;--------------------------------------------------------
                                 ;Устанвливаем порт на вход
                                 ;IN: ACCUM-порт
                                 ;--------------------------------------------------------
0008b5 3f8f                      	CPI ACCUM,0xff
0008b6 f409                      	BRNE PC+0x02
0008b7 9508                      	RET
                                 
0008b8 93ff
0008b9 93ef                      	PUSH_Z
0008ba 931f
0008bb 930f                      	PUSH_THL
0008bc 932f                      	PUSH TEMP
0008bd 938f                      	PUSH ACCUM
                                 
0008be 940e 089d                 	MCALL PORT_OFFSETS
0008c0 2df7                      	MOV ZH,C0x00
0008c1 2fe0                      	MOV ZL,TEMP_L
                                 
0008c2 9580                      	COM ACCUM
0008c3 9100 005f                 	LDS TEMP_L,SREG
0008c5 94f8                      	CLI
0008c6 8120                      	LD TEMP,Z
0008c7 2328                      	AND TEMP,ACCUM
0008c8 8320                      	ST Z,TEMP
0008c9 9300 005f                 	STS SREG,TEMP_L
                                 
0008cb 918f                      	POP ACCUM
0008cc 912f                      	POP TEMP
0008cd 910f
0008ce 911f                      	POP_THL
0008cf 91ef
0008d0 91ff                      	POP_Z
0008d1 9508                      	RET
                                 .endif
                                 .include	"./io/port_mode_out.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_MODE_OUT
                                 .else
                                 .set DEF_PORT_MODE_OUT = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./io/port_mode_out.inc(15): included PORT_MODE_OUT
                                 .message "included PORT_MODE_OUT"
                                 .endif
                                 
                                 .include	"./io/port_offsets.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_OFFSETS
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 PORT_MODE_OUT:
                                 ;--------------------------------------------------------
                                 ;Устанвливаем порт на выход
                                 ;IN: ACCUM-порт
                                 ;--------------------------------------------------------
0008d2 3f8f                      	CPI ACCUM,0xff
0008d3 f409                      	BRNE PC+0x02
0008d4 9508                      	RET
                                 
0008d5 93ff
0008d6 93ef                      	PUSH_Z
0008d7 931f
0008d8 930f                      	PUSH_THL
0008d9 932f                      	PUSH TEMP
0008da 938f                      	PUSH ACCUM
                                 
0008db 940e 089d                 	MCALL PORT_OFFSETS
0008dd 2df7                      	MOV ZH,C0x00
0008de 2fe0                      	MOV ZL,TEMP_L
                                 
0008df 9100 005f                 	LDS TEMP_L,SREG
0008e1 94f8                      	CLI
0008e2 8120                      	LD TEMP,Z
0008e3 2b28                      	OR TEMP,ACCUM
0008e4 8320                      	ST Z,TEMP
0008e5 9300 005f                 	STS SREG,TEMP_L
                                 
0008e7 918f                      	POP ACCUM
0008e8 912f                      	POP TEMP
0008e9 910f
0008ea 911f                      	POP_THL
0008eb 91ef
0008ec 91ff                      	POP_Z
0008ed 9508                      	RET
                                 .endif
                                 .include	"./io/port_set_lo.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET_LO
                                 .else
                                 .set DEF_PORT_SET_LO = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./io/port_set_lo.inc(16): included PORT_SET_LO
                                 .message "included PORT_SET_LO"
                                 .endif
                                 
                                 .include	"./io/port_offsets.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_OFFSETS
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 PORT_SET_LO:
                                 ;--------------------------------------------------------
                                 ;Устанвливаем порту низкий уровень
                                 ;IN: ACCUM-порт
                                 ;--------------------------------------------------------
0008ee 3f8f                      	CPI ACCUM,0xff
0008ef f409                      	BRNE PC+0x02
0008f0 9508                      	RET
                                 
0008f1 93ff
0008f2 93ef                      	PUSH_Z
0008f3 931f
0008f4 930f                      	PUSH_THL
0008f5 932f                      	PUSH TEMP
0008f6 938f                      	PUSH ACCUM
                                 
0008f7 940e 089d                 	MCALL PORT_OFFSETS
0008f9 2df7                      	MOV ZH,C0x00
0008fa 2fe1                      	MOV ZL,TEMP_H
                                 
0008fb 9580                      	COM ACCUM
0008fc 9100 005f                 	LDS TEMP_L,SREG
0008fe 94f8                      	CLI
0008ff 8120                      	LD TEMP,Z
000900 2328                      	AND TEMP,ACCUM
000901 8320                      	ST Z,TEMP
000902 9300 005f                 	STS SREG,TEMP_L
                                 
000904 918f                      	POP ACCUM
000905 912f                      	POP TEMP
000906 910f
000907 911f                      	POP_THL
000908 91ef
000909 91ff                      	POP_Z
00090a 9508                      	RET
                                 .endif
                                 .include	"./io/port_set_hi.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET_HI
                                 .else
                                 .set DEF_PORT_SET_HI = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./io/port_set_hi.inc(16): included PORT_SET_HI
                                 .message "included PORT_SET_HI"
                                 .endif
                                 
                                 .include	"./io/port_offsets.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_OFFSETS
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 PORT_SET_HI:
                                 ;--------------------------------------------------------
                                 ;Устанвливаем порту высокий уровень
                                 ;IN: ACCUM-порт
                                 ;--------------------------------------------------------
00090b 3f8f                      	CPI ACCUM,0xff
00090c f409                      	BRNE PC+0x02
00090d 9508                      	RET
                                 
00090e 93ff
00090f 93ef                      	PUSH_Z
000910 931f
000911 930f                      	PUSH_THL
000912 932f                      	PUSH TEMP
000913 938f                      	PUSH ACCUM
                                 
000914 940e 089d                 	MCALL PORT_OFFSETS
000916 2df7                      	MOV ZH,C0x00
000917 2fe1                      	MOV ZL,TEMP_H
                                 
000918 9100 005f                 	LDS TEMP_L,SREG
00091a 94f8                      	CLI
00091b 8120                      	LD TEMP,Z
00091c 2b28                      	OR TEMP,ACCUM
00091d 8320                      	ST Z,TEMP
00091e 9300 005f                 	STS SREG,TEMP_L
                                 
000920 918f                      	POP ACCUM
000921 912f                      	POP TEMP
000922 910f
000923 911f                      	POP_THL
000924 91ef
000925 91ff                      	POP_Z
000926 9508                      	RET
                                 .endif
                                 .include	"./io/port_set.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET
                                 .else
                                 .set DEF_PORT_SET = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./io/port_set.inc(14): included PORT_SET
                                 .message "included PORT_SET"
                                 .endif
                                 
                                 .include	"./io/port_set_hi.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET_HI
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./io/port_set_lo.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET_LO
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 PORT_SET:
                                 ;--------------------------------------------------------
                                 ;Установка состояния порта
                                 ;IN: ACCUM-порт
                                 ;flag C-состояние порта(true = HI)
                                 ;--------------------------------------------------------
000927 f410                      	BRCC PC+0x01+_MCALL_SIZE
000928 940c 090b                 	MJMP PORT_SET_HI
00092a 940c 08ee                 	MJMP PORT_SET_LO
                                 .endif
                                 
                                 ;---CONSTANTS--------------------------------------------
                                 	.EQU	_DRV_SPI_MS_SCK_PORT								= 0x00;1b - Порт SCK
                                 	.EQU	_DRV_SPI_MS_MISO_PORT							= 0x01;1b - Порт MISO
                                 	.EQU	_DRV_SPI_MS_MOSI_PORT							= 0x02;1b - Порт MOSI
                                 	.EQU	_DRV_SPI_MS_CS_PORT								= 0x03;1b - Порт CS
                                 	.EQU	_DRV_SPI_MS_CHIP_QNT								= 0x04;1b - Количество чипов на шине
                                 	.EQU	_DRV_SPI_MS_PACKET_SZIE							= 0x05;1b - Размер пакета в байтах
                                 	.EQU	_DRV_SPI_MS_WAIT_TIME							= 0x06;1b - Время выдерживания паузы (0x00 - не использовать)
                                 
                                 	.EQU	_DRV_SPI_MS_RAM_SIZE								= 0x07;7 байт необходимо выделить
                                 
                                 ;Драйвер шины SPI (Master,Software)
                                 ;--------------------------------------------------------
                                 DRV_SPI_MS_INIT:
                                 ;--------------------------------------------------------
                                 ;Инициализация драйвера в режиме ведущего(MASTER)
                                 ;IN: XH - тактовый выход(SCK),
                                 ;XL - вход ведущего (MISO),
                                 ;YH - выход ведущего (MOSI),
                                 ;YL - выход, конец данных (СS)
                                 ;TEMP_H - кол-во чипов на шине,
                                 ;TEMP_L - размер пакета в байтах,
                                 ;ACCUM - время выдерживания паузы
                                 ;--------------------------------------------------------
00092c 01fe                      	MOVW ZL,YL
00092d 938f                      	PUSH ACCUM
00092e e087                      	LDI ACCUM,_DRV_SPI_MS_RAM_SIZE
00092f 940e 0851                 	MCALL C5_RAM_REALLOC
000931 918f                      	POP ACCUM
                                 
000932 83b8                      	STD Y+_DRV_SPI_MS_SCK_PORT,XH
000933 83a9                      	STD Y+_DRV_SPI_MS_MISO_PORT,XL
000934 83fa                      	STD Y+_DRV_SPI_MS_MOSI_PORT,ZH
000935 83eb                      	STD Y+_DRV_SPI_MS_CS_PORT,ZL
000936 831c                      	STD Y+_DRV_SPI_MS_CHIP_QNT,TEMP_H
000937 831d                      	STD Y+_DRV_SPI_MS_PACKET_SZIE,TEMP_H
000938 838e                      	STD Y+_DRV_SPI_MS_WAIT_TIME,ACCUM
                                 
                                 	;Инициализируем порт SCK
000939 2f8b                      	MOV ACCUM,XH
00093a 940e 08d2                 	MCALL PORT_MODE_OUT
00093c 940e 08ee                 	MCALL PORT_SET_LO
                                 	;Инициализируем порт MISO
00093e 2f8a                      	MOV ACCUM,XL
00093f 940e 08b5                 	MCALL PORT_MODE_IN
000941 940e 090b                 	MCALL PORT_SET_HI
                                 	;Инициализируем порт MOSI
000943 2f8f                      	MOV ACCUM,ZH
000944 940e 08d2                 	MCALL PORT_MODE_OUT
000946 940e 08ee                 	MCALL PORT_SET_LO
                                 	;Инициализируем порт CS
000948 2f8e                      	MOV ACCUM,ZL
000949 940e 08d2                 	MCALL PORT_MODE_OUT
00094b 940e 090b                 	MCALL PORT_SET_HI
                                 
00094d 940e 05b8                 	MCALL C5_READY
                                 ;--------------------------------------------------------
                                 ;Основной код, передача данных
                                 ;IN: Z-адрес на блок данных на запись
                                 ;(15-ый бит false-RAM, true-ROM)
                                 ;TEMP_H-номер чипа(0-...), TEMP_L-количество пакетов
                                 ;--------------------------------------------------------
00094f 93df
000950 93cf                      	PUSH_Y
000951 93ff
000952 93ef                      	PUSH_Z
000953 938f                      	PUSH ACCUM
000954 932f                      	PUSH TEMP
000955 935f                      	PUSH LOOP_CNTR
                                 
                                 	;Загружаем в Y адрес на выделенный блок памяти
000956 940e 073b                 	MCALL C5_RAM_OFFSET
                                 
                                 	;Умножаем Z на 2 адрес рабоыт с ROM
000958 fff7                      	SBRS ZH,0x07
000959 c003                      	RJMP PC+0x04
00095a 0fee                      	LSL ZL
00095b 1fff                      	ROL ZH
00095c 68f0                      	ORI ZH,0x80
                                 
00095d 818b                      	LDD ACCUM,Y+_DRV_SPI_MS_CS_PORT
                                 	;Перебираем все пакеты
00095e 2f50                      	MOV LOOP_CNTR,TEMP_L
                                 _DRV_SPI_MS_PACKETS_LOOP:
00095f 940e 08ee                 	MCALL PORT_SET_LO
000961 940e 09a6                 	MCALL _DRV_SPI_MS_WAIT
                                 
                                 	;Перебираем все чипы
000963 935f                      	PUSH LOOP_CNTR
000964 815c                      	LDD LOOP_CNTR,Y+_DRV_SPI_MS_CHIP_QNT
000965 955a                      	DEC LOOP_CNTR
                                 _DRV_SPI_MS_CHIP_LOOP:
000966 1715                      	CP TEMP_H,LOOP_CNTR
000967 f049                      	BREQ _DRV_SPI_MS_SELECTED_CHIP
                                 
                                 	;Если данное устройство не выбрано, то передаем данные пустого пакета
000968 935f                      	PUSH LOOP_CNTR
000969 815d                      	LDD LOOP_CNTR,Y+_DRV_SPI_MS_PACKET_SZIE
00096a e020                      	LDI TEMP,0x00
                                 _DRV_SPI_MS_EMPTY_DATA_LOOP:
00096b 940e 0991                 	MCALL _DRV_SPI_MS_BYTE
00096d 955a                      	DEC LOOP_CNTR
00096e f7e1                      	BRNE _DRV_SPI_MS_EMPTY_DATA_LOOP
00096f 915f                      	POP LOOP_CNTR
000970 c00e                      	RJMP _DRV_SPI_MS_PACKET_BYTES_END
                                 
                                 	;Если данный чип выбран, то передаем реальные данные
                                 _DRV_SPI_MS_SELECTED_CHIP:
                                 	;Перебираем байты пакета
000971 935f                      	PUSH LOOP_CNTR
000972 815d                      	LDD LOOP_CNTR,Y+_DRV_SPI_MS_PACKET_SZIE
                                 _DRV_SPI_MS_PACKET_BYTES_LOOP:
                                 	;Получаю байт
000973 fdf7                      	SBRC ZH,0x07
000974 c002                      	RJMP PC+0x03
000975 9121                      	LD TEMP,Z+
000976 c003                      	RJMP PC+04
000977 77ff                      	ANDI ZH,0b01111111
000978 9125                      	LPM TEMP,Z+
000979 68f0                      	ORI ZH,0b10000000
00097a 940e 0991                 	MCALL _DRV_SPI_MS_BYTE
00097c 955a                      	DEC LOOP_CNTR
00097d f7a9                      	BRNE _DRV_SPI_MS_PACKET_BYTES_LOOP
00097e 915f                      	POP LOOP_CNTR
                                 
                                 _DRV_SPI_MS_PACKET_BYTES_END:
00097f 955a                      	DEC LOOP_CNTR
000980 3f5f                      	CPI LOOP_CNTR,0xff
000981 f721                      	BRNE _DRV_SPI_MS_CHIP_LOOP
000982 915f                      	POP LOOP_CNTR
                                 
000983 940e 090b                 	MCALL PORT_SET_HI
000985 940e 09a6                 	MCALL _DRV_SPI_MS_WAIT
000987 955a                      	DEC LOOP_CNTR
000988 f6b1                      	BRNE _DRV_SPI_MS_PACKETS_LOOP
                                 
000989 915f                      	POP LOOP_CNTR
00098a 912f                      	POP TEMP
00098b 918f                      	POP ACCUM
00098c 91ef
00098d 91ff                      	POP_Z
00098e 91cf
00098f 91df                      	POP_Y
000990 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SPI_MS_BYTE:
                                 ;--------------------------------------------------------
                                 ;Коммуникация (передача и прием байта)
                                 ;IN: Y-адрес на выделенную память
                                 ;TEMP-Данные
                                 ;OUT: ??? TODO
                                 ;--------------------------------------------------------
000991 938f                      	PUSH ACCUM
000992 935f                      	PUSH LOOP_CNTR
                                 	;Цикл, передача байта
000993 e058                      	LDI LOOP_CNTR,0x08
                                 _DRV_SPI_MS_BYTE_LOOP:
                                 	;DATA
000994 0f22                      	LSL TEMP
000995 818a                      	LDD ACCUM,Y+_DRV_SPI_MS_MOSI_PORT
000996 940e 0927                 	MCALL PORT_SET
000998 940e 09a6                 	MCALL _DRV_SPI_MS_WAIT
                                 	;CLK hi
00099a 8188                      	LDD ACCUM,Y+_DRV_SPI_MS_SCK_PORT
00099b 940e 090b                 	MCALL PORT_SET_HI
00099d 940e 09a6                 	MCALL _DRV_SPI_MS_WAIT
                                 
                                 	;TODO RECIEVE DATA
                                 	;TODO SAVE RECEIVED DATA
                                 
                                 	;CLK lo
00099f 940e 08ee                 	MCALL PORT_SET_LO
                                 	;Следующий бит
0009a1 955a                      	DEC LOOP_CNTR
0009a2 f789                      	BRNE _DRV_SPI_MS_BYTE_LOOP
0009a3 915f                      	POP LOOP_CNTR
0009a4 918f                      	POP ACCUM
0009a5 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SPI_MS_WAIT:
                                 ;--------------------------------------------------------
                                 ;Выдерживаем паузу
                                 ;IN: Y-адрес на выделенную память
                                 ;TEMP-время паузы(*500нс), не может быть менее 40
                                 ;--------------------------------------------------------
0009a6 932f                      	PUSH TEMP
0009a7 812e                      	LDD TEMP,Y+_DRV_SPI_MS_WAIT_TIME
0009a8 3228                      	CPI TEMP,40
0009a9 f010                      	BRCS PC+0x01+_MCALL_SIZE
0009aa 940e 0516                 	MCALL _C5_WAIT_500NS
0009ac 912f                      	POP TEMP
0009ad 9508                      	RET
                                 .endif
                                 
                                 	.include "./core/drivers/sd/sd_get_ocr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_OCR
                                 .else
                                 .set DEF_DRIVER_SD_GET_OCR = 1
                                 
                                 .include	"./core/drivers/sd/sd_get_r3r7.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_R3R7
                                 .else
                                 .set DEF_DRIVER_SD_GET_R3R7 = 1
                                 
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_GET_R3R7:
                                 ;--------------------------------------------------------
                                 ;Прием R3R7
                                 ;IN: X-адрес на буфер
                                 ;OUT: ACCUM
                                 ;--------------------------------------------------------
0009ae 937f                      	PUSH TRY_CNTR
0009af 932f                      	PUSH TEMP
                                 
0009b0 e170                      	LDI TRY_CNTR,0x10
                                 _DRV_SD_GET_R7__LOOP:
0009b1 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
0009b3 ff27                      	SBRS TEMP,0x07
0009b4 c002                      	RJMP _DRV_SD_GET_R7__GOT_R1
0009b5 957a                      	DEC TRY_CNTR
0009b6 f7d1                      	BRNE _DRV_SD_GET_R7__LOOP
                                 _DRV_SD_GET_R7__GOT_R1:
0009b7 2f82                      	MOV ACCUM,TEMP
                                 
0009b8 e024                      	LDI TEMP,0x04
0009b9 940e 125b                 	MCALL _DRV_SD_BYTES_RECV
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
0009bb 912f                      	POP TEMP
0009bc 917f                      	POP TRY_CNTR
0009bd 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_OP_GET_OCR:
                                 ;--------------------------------------------------------
                                 ;Получить OCR
                                 ;IN: X-адрес на буффер
                                 ;OUT: ACCUM-R1 ответ
                                 ;--------------------------------------------------------
0009be 932f                      	PUSH TEMP
0009bf 930f                      	PUSH TEMP_L
0009c0 93df
0009c1 93cf                      	PUSH_Y
                                 
0009c2 01ed                      	MOVW YL,XL
                                 
0009c3 982a                      	CBI PORTB,SS & 0x0f
0009c4 e32a                      	LDI TEMP,_DRV_SD_CMD58
0009c5 93bf
0009c6 93af                      	PUSH_X
0009c7 932d                      	ST X+,TEMP
0009c8 927d                      	ST X+,C0x00
0009c9 927d                      	ST X+,C0x00
0009ca 927d                      	ST X+,C0x00
0009cb 927d                      	ST X+,C0x00
0009cc 91af
0009cd 91bf                      	POP_X
0009ce e005                      	LDI TEMP_L,0x05
0009cf 940e 1205                 	MCALL _DRV_SD__SEND_CMD
0009d1 940e 09ae                 	MCALL _DRV_SD_GET_R3R7
0009d3 9a2a                      	SBI PORTB,SS & 0x0f
                                 _DRV_SD_OP_GET_OCR__END:
                                 
0009d4 91cf
0009d5 91df                      	POP_Y
0009d6 910f                      	POP TEMP_L
0009d7 912f                      	POP TEMP
0009d8 9508                      	RET
                                 .endif
                                 	.include "./core/drivers/sd/sd_log_ocr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_SD_LOG_OCR
                                 .else
                                 .set DEF_C5_SD_LOG_OCR = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_str.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_str_el.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STR_EL
                                 .else
                                 .set DEF_C5_OUT_STR_EL = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_str.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_STR_EL:
                                 ;--------------------------------------------------------
                                 ;Логирование элемента массива строк. Конец каждого
                                 ;элемента определяется по 0x00
                                 ;IN: Z-адрес на массив строк (15-ый бит false-RAM,
                                 ;true-ROM), TEMP-номер элемента
                                 ;--------------------------------------------------------
0009d9 932f                      	PUSH TEMP
0009da 93ff
0009db 93ef                      	PUSH_Z
0009dc 938f                      	PUSH ACCUM
0009dd 935f                      	PUSH LOOP_CNTR
                                 
                                 	;Умножаем на 2 адрес рабоыт с ROM
0009de fff7                      	SBRS ZH,0x07
0009df c003                      	RJMP PC+0x04
0009e0 0fee                      	LSL ZL
0009e1 1fff                      	ROL ZH
0009e2 68f0                      	ORI ZH,0x80
0009e3 2f8f                      	MOV ACCUM,ZH
0009e4 77ff                      	ANDI ZH,0x7f
                                 
0009e5 3020                      	CPI TEMP,0x00
0009e6 f049                      	BREQ _C5_OUT_STR_EL__LOG_STR
0009e7 2f52                      	MOV LOOP_CNTR,TEMP
                                 _C5_OUT_STR_EL__LOOP:
0009e8 ff87                      	SBRS ACCUM,0x07
0009e9 9121                      	LD TEMP,Z+
0009ea fd87                      	SBRC ACCUM,0x07
0009eb 9125                      	LPM TEMP,Z+
0009ec 3020                      	CPI TEMP,0x00
0009ed f7d1                      	BRNE _C5_OUT_STR_EL__LOOP
0009ee 955a                      	DEC LOOP_CNTR
0009ef f7c1                      	BRNE _C5_OUT_STR_EL__LOOP
                                 
                                 _C5_OUT_STR_EL__LOG_STR:
0009f0 915f                      	POP LOOP_CNTR
0009f1 940c 020b                 	MJMP _C5_OUT_STR__LOG_STR_EL_CODEPOINT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_cr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 _DRV_SD_LOG_STR_OCR:
0009f3 434f
0009f4 2052
0009f5 6572
0009f6 6967
0009f7 7473
0009f8 7265
0009f9 0d3a
0009fa 000a                      	.db "OCR register:",0x0d,0x0a,0x00
                                 _DRV_SD_LOG_STR_OCR_VOLTAGES:
0009fb 3220
0009fc 372e
0009fd 322d
0009fe 382e
0009ff 2000
000a00 2e32
000a01 2d38
000a02 2e32
000a03 0039
000a04 3220
000a05 392e
000a06 332d
000a07 302e
000a08 2000
000a09 2e33
000a0a 2d30
000a0b 2e33
000a0c 0031
000a0d 3320
000a0e 312e
000a0f 332d
000a10 322e
000a11 2000
000a12 2e33
000a13 2d32
000a14 2e33
000a15 0033
000a16 3320
000a17 332e
000a18 332d
000a19 342e
000a1a 2000
000a1b 2e33
000a1c 2d34
000a1d 2e33
000a1e 0035
000a1f 3320
000a20 352e
000a21 332d
000a22 362e
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(19): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(38): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc' included form here
000a23 0000                      	.db " 2.7-2.8",0x00," 2.8-2.9",0x00," 2.9-3.0",0x00," 3.0-3.1",0x00," 3.1-3.2",0x00," 3.2-3.3",0x00," 3.3-3.4",0x00," 3.4-3.5",0x00," 3.5-3.6",0x00
                                 _DRV_SD_LOG_STR_OCR_24:
000a24 5320
000a25 6977
000a26 6374
000a27 6968
000a28 676e
000a29 7420
000a2a 206f
000a2b 2e31
000a2c 5638
000a2d 4120
000a2e 6363
000a2f 7065
000a30 6574
000a31 2064
000a32 5328
000a33 3831
000a34 2941
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(21): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(38): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc' included form here
000a35 0000                      	.db " Switching to 1.8V Accepted (S18A)",0x00
                                 _DRV_SD_LOG_STR_OCR_27:
000a36 4f20
000a37 6576
000a38 2072
000a39 5432
000a3a 2042
000a3b 7573
000a3c 7070
000a3d 726f
000a3e 2074
000a3f 7453
000a40 7461
000a41 7375
000a42 2820
000a43 4f43
000a44 5432
000a45 0029                      	.db " Over 2TB support Status (CO2T)",0x00
                                 _DRV_SD_LOG_STR_OCR_29:
000a46 5520
000a47 5348
000a48 492d
000a49 2049
000a4a 6143
000a4b 6472
000a4c 5320
000a4d 6174
000a4e 7574
000a4f 0073                      	.db " UHS-II Card Status",0x00
                                 _DRV_SD_LOG_STR_OCR_30:
000a50 4320
000a51 7261
000a52 2064
000a53 6143
000a54 6170
000a55 6963
000a56 7974
000a57 5320
000a58 6174
000a59 7574
000a5a 2073
000a5b 4328
000a5c 5343
000a5d 0029                      	.db " Card Capacity Status (CCS)",0x00
                                 _DRV_SD_LOG_STR_OCR_31:
000a5e 4320
000a5f 7261
000a60 2064
000a61 6f70
000a62 6577
000a63 2072
000a64 7075
000a65 7320
000a66 6174
000a67 7574
000a68 2073
000a69 6962
000a6a 2074
000a6b 6228
000a6c 7375
000a6d 2979
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc(29): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(38): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_ocr.inc' included form here
000a6e 0000                      	.db " Card power up status bit (busy)",0x00
                                 
                                 ;--------------------------------------------------------
                                 DRV_SD_LOG_OCR:
                                 ;Логирование OCR
                                 ;IN: X-адрес на блок данных
                                 ;--------------------------------------------------------
000a6f 93ff
000a70 93ef                      	PUSH_Z
000a71 93df
000a72 93cf                      	PUSH_Y
000a73 932f                      	PUSH TEMP
000a74 938f                      	PUSH ACCUM
                                 
000a75 01ed                      	MOVW YL,XL
                                 
000a76 e8f9
000a77 efe3                      	LDI_Z _DRV_SD_LOG_STR_OCR|0x8000
000a78 940e 0200                 	MCALL C5_OUT_STR
                                 
000a7a 812a                      	LDD TEMP,Y+0x02
000a7b ff27                      	SBRS TEMP,0x07
000a7c c007                      	RJMP PC+0x04+(2*_MCALL_SIZE)
000a7d e8f9
000a7e efeb                      	LDI_Z _DRV_SD_LOG_STR_OCR_VOLTAGES|0x8000
000a7f e020                      	LDI TEMP,0x00
000a80 940e 09d9                 	MCALL C5_OUT_STR_EL
000a82 940e 023f                 	MCALL C5_OUT_CR
                                 
000a84 8189                      	LDD ACCUM,Y+0x01
000a85 e021                      	LDI TEMP,0x01
                                 _DRV_SD_LOG_OCR__VOLTAGES_LOOP:
000a86 9586                      	LSR ACCUM
000a87 f420                      	BRCC PC+0x01+(2*_MCALL_SIZE)
000a88 940e 09d9                 	MCALL C5_OUT_STR_EL
000a8a 940e 023f                 	MCALL C5_OUT_CR
000a8c 9523                      	INC TEMP
000a8d 3029                      	CPI TEMP,0x09
000a8e f7b9                      	BRNE _DRV_SD_LOG_OCR__VOLTAGES_LOOP
                                 
000a8f 8128                      	LDD TEMP,Y+0x00
000a90 ff27                      	SBRS TEMP,0x07
000a91 f430                      	BRCC PC+0x03+(2*_MCALL_SIZE)
000a92 e8fa
000a93 e2e4                      	LDI_Z _DRV_SD_LOG_STR_OCR_24|0x8000
000a94 940e 0200                 	MCALL C5_OUT_STR
000a96 940e 023f                 	MCALL C5_OUT_CR
000a98 ff24                      	SBRS TEMP,0x04
000a99 f430                      	BRCC PC+0x03+(2*_MCALL_SIZE)
000a9a e8fa
000a9b e3e6                      	LDI_Z _DRV_SD_LOG_STR_OCR_27|0x8000
000a9c 940e 0200                 	MCALL C5_OUT_STR
000a9e 940e 023f                 	MCALL C5_OUT_CR
000aa0 ff22                      	SBRS TEMP,0x02
000aa1 f430                      	BRCC PC+0x03+(2*_MCALL_SIZE)
000aa2 e8fa
000aa3 e4e6                      	LDI_Z _DRV_SD_LOG_STR_OCR_29|0x8000
000aa4 940e 0200                 	MCALL C5_OUT_STR
000aa6 940e 023f                 	MCALL C5_OUT_CR
000aa8 ff21                      	SBRS TEMP,0x01
000aa9 f430                      	BRCC PC+0x03+(2*_MCALL_SIZE)
000aaa e8fa
000aab e5e0                      	LDI_Z _DRV_SD_LOG_STR_OCR_30|0x8000
000aac 940e 0200                 	MCALL C5_OUT_STR
000aae 940e 023f                 	MCALL C5_OUT_CR
000ab0 ff20                      	SBRS TEMP,0x00
000ab1 f430                      	BRCC PC+0x03+(2*_MCALL_SIZE)
000ab2 e8fa
000ab3 e5ee                      	LDI_Z _DRV_SD_LOG_STR_OCR_31|0x8000
000ab4 940e 0200                 	MCALL C5_OUT_STR
000ab6 940e 023f                 	MCALL C5_OUT_CR
                                 
000ab8 918f                      	POP ACCUM
000ab9 912f                      	POP TEMP
000aba 91cf
000abb 91df                      	POP_Y
000abc 91ef
000abd 91ff                      	POP_Z
000abe 9508                      	RET
                                 .endif
                                 .endif
                                 	.include "./core/drivers/sd/sd_get_csd.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_CSD
                                 .else
                                 .set DEF_DRIVER_SD_GET_CSD = 1
                                 
                                 .include	"./core/drivers/sd/sd_get_r1.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_R1
                                 .else
                                 .set DEF_DRIVER_SD_GET_R1 = 1
                                 
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_GET_R1:
                                 ;--------------------------------------------------------
                                 ;Прием R1
                                 ;OUT: ACCUM
                                 ;--------------------------------------------------------
000abf 937f                      	PUSH TRY_CNTR
000ac0 932f                      	PUSH TEMP
000ac1 935f                      	PUSH LOOP_CNTR
                                 
000ac2 e070                      	LDI TRY_CNTR,0x00
                                 _DRV_SD_GET_R1__LOOP:
000ac3 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
000ac5 ff27                      	SBRS TEMP,0x07
000ac6 c003                      	RJMP _DRV_SD_GET_R1__DONE1
000ac7 957a                      	DEC TRY_CNTR
000ac8 f7d1                      	BRNE _DRV_SD_GET_R1__LOOP
000ac9 c002                      	RJMP _DRV_SD_GET_R1__FAIL
                                 _DRV_SD_GET_R1__DONE1:
000aca 2f82                      	MOV ACCUM,TEMP
                                 
                                 
                                 ;	LDI LOOP_CNTR,0x00
                                 ;_DRV_SD_GET_R1__LOOP2:
                                 ;	LDI TRY_CNTR,0x00
                                 ;_DRV_SD_GET_R1__LOOP3:
                                 ;	MCALL _DRV_SD_BYTE_RECV
                                 ;	CPI TEMP,0xff
                                 ;	BREQ _DRV_SD_GET_R1__DONE
                                 ;	DEC TRY_CNTR
                                 ;	BRNE _DRV_SD_GET_R1__LOOP3
                                 ;	DEC LOOP_CNTR
                                 ;	BRNE _DRV_SD_GET_R1__LOOP2
                                 ;	LDI ACCUM,0xff
000acb c001                      	RJMP _DRV_SD_GET_R1__DONE
                                 _DRV_SD_GET_R1__FAIL:
000acc ef8f                      	LDI ACCUM,0xff
                                 _DRV_SD_GET_R1__DONE:
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 
000acd 915f                      	POP LOOP_CNTR
000ace 912f                      	POP TEMP
000acf 917f                      	POP TRY_CNTR
000ad0 9508                      	RET
                                 .endif
                                 .include	"./core/drivers/sd/sd_get_block.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_BLOCK
                                 .else
                                 .set DEF_DRIVER_SD_GET_BLOCK = 1
                                 
                                 .include	"./core/time32_mark.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;02.02.2021  w5277c@gmail.com			Начало
                                 ;16.09.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_TIME32_MARK
                                 .else
                                 .set DEF_C5_TIME32_MARK = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/time32_mark.inc(12): included C5_TIME32_MARK
                                 .message "included C5_TIME32_MARK"
                                 .endif
                                 
                                 .include	"./core/uptime_copy.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;14.11.2020	w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_UPTIME_COPY
                                 .else
                                 .set DEF_C5_UPTIME_COPY = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/uptime_copy.inc(11): included C5_UPTIME_COPY
                                 .message "included C5_UPTIME_COPY"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_UPTIME_COPY:
                                 ;--------------------------------------------------------
                                 ;Записываем в память 5 байт UPTIME
                                 ;IN: Y-адрес для записи
                                 ;--------------------------------------------------------
000ad1 932f                      	PUSH TEMP
000ad2 9120 005f                 	LDS TEMP,SREG
000ad4 932f                      	PUSH TEMP
000ad5 94f8                      	CLI
000ad6 9120 0100                 	LDS TEMP,_C5_UPTIME+0x00
000ad8 8328                      	STD Y+0x00,TEMP
000ad9 9120 0101                 	LDS TEMP,_C5_UPTIME+0x01
000adb 8329                      	STD Y+0x01,TEMP
000adc 9120 0102                 	LDS TEMP,_C5_UPTIME+0x02
000ade 832a                      	STD Y+0x02,TEMP
000adf 9120 0103                 	LDS TEMP,_C5_UPTIME+0x03
000ae1 832b                      	STD Y+0x03,TEMP
000ae2 9120 0104                 	LDS TEMP,_C5_UPTIME+0x04
000ae4 832c                      	STD Y+0x04,TEMP
000ae5 912f                      	POP TEMP
000ae6 9320 005f                 	STS SREG,TEMP
000ae8 912f                      	POP TEMP
000ae9 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_TIME32_MARK:
                                 ;--------------------------------------------------------
                                 ;Записываем в выделенную память временную метку (4 байт)
                                 ;IN: PID,TEMP-смещение на выделенные 4 байт, для хранения
                                 ;временной метки
                                 ;--------------------------------------------------------
000aea 93df
000aeb 93cf                      	PUSH_Y
000aec 932f                      	PUSH TEMP
                                 
000aed 940e 073b                 	MCALL C5_RAM_OFFSET
000aef 0fc2                      	ADD YL,TEMP
000af0 1dd7                      	ADC YH,C0x00
                                 
000af1 9120 005f                 	LDS TEMP,SREG
000af3 932f                      	PUSH TEMP
000af4 94f8                      	CLI
                                 
000af5 9120 0102                 	LDS TEMP,_C5_UPTIME+0x02
000af7 8328                      	STD Y+0x00,TEMP
000af8 9120 0103                 	LDS TEMP,_C5_UPTIME+0x03
000afa 8329                      	STD Y+0x01,TEMP
000afb 9120 0104                 	LDS TEMP,_C5_UPTIME+0x04
000afd 832a                      	STD Y+0x02,TEMP
000afe 9120 0110                 	LDS TEMP,_C5_MAIN_TIMER_CNTR
000b00 832b                      	STD Y+0x03,TEMP
                                 
000b01 912f                      	POP TEMP
000b02 9320 005f                 	STS SREG,TEMP
                                 
000b04 912f                      	POP TEMP
000b05 91cf
000b06 91df                      	POP_Y
000b07 9508                      	RET
                                 .endif
                                 .include	"./core/time32_delta.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;02.02.2021  w5277c@gmail.com			Начало
                                 ;16.09.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_TIME32_DELTA
                                 .else
                                 .set DEF_C5_TIME32_DELTA = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./core/time32_delta.inc(12): included C5_TIME32_DELTA
                                 .message "included C5_TIME32_DELTA"
                                 .endif
                                 
                                 .include	"./core/time32_mark.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;02.02.2021  w5277c@gmail.com			Начало
                                 ;16.09.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_TIME32_MARK
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./math/mul32x16.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало
                                 ;08.01.2022	w5277c@gmail.com			Багфикс
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO перейти на использование MUL8X8
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL32X16
                                 .else
                                 .set DEF_MUL32X16 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/mul32x16.inc(14): included MUL32X16
                                 .message "included MUL32X16"
                                 .endif
                                 
                                 .include	"./math/mul8x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Программная реализация MUL для MUL_SUPPORT != 0x01
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL8X8
                                 .else
                                 .set DEF_MUL8X8 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/mul8x8.inc(15): included MUL8X8
                                 .message "included MUL8X8"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 MUL8X8:
                                 ;--------------------------------------------------------
                                 ;Умножение 8b числа на 8б число
                                 ;IN: TEMP_L-8b число, TEMP-8b число
                                 ;OUT: TEMP_H/L-16b результат
                                 ;--------------------------------------------------------
                                 .if MUL_SUPPORT != 0x01
                                 .endif
                                 .if MUL_SUPPORT == 0x01
000b08 921f                      	PUSH _RESULT_H
000b09 920f                      	PUSH _RESULT_L
                                 
000b0a 9f02                      	MUL TEMP_L,TEMP
000b0b 2d00                      	MOV TEMP_L,_RESULT_L
000b0c 2d11                      	MOV TEMP_H,_RESULT_H
                                 
000b0d 900f                      	POP _RESULT_L
000b0e 901f                      	POP _RESULT_H
                                 .endif
000b0f 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 MUL32X16:
                                 ;--------------------------------------------------------
                                 ;Умножение 32б числа на 16б число
                                 ;IN: TEMP_EH/EL/H/L-32б число, X-16б число
                                 ;OUT: TEMP_EH/EL/H/L-32б результат
                                 ;--------------------------------------------------------
000b10 921f                      	PUSH _RESULT_H
000b11 920f                      	PUSH _RESULT_L
000b12 93df
000b13 93cf                      	PUSH_Y
000b14 93ff
000b15 93ef                      	PUSH_Z
000b16 932f                      	PUSH TEMP
                                 
000b17 27ff                      	CLR ZH
000b18 27ee                      	CLR ZL
000b19 27cc                      	CLR YL
000b1a 27dd                      	CLR YH
000b1b 2722                      	CLR TEMP
                                 
000b1c 931f                      	PUSH TEMP_H
000b1d 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_L,XL
000b1e 2f2a                      	MOV TEMP,XL
000b1f 940e 0b08                 	MCALL MUL8X8
000b21 2fc0                      	MOV YL,TEMP_L
000b22 2fd1                      	MOV YH,TEMP_H
000b23 910f                      	POP TEMP_L
000b24 911f                      	POP TEMP_H
                                 
000b25 931f                      	PUSH TEMP_H
000b26 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_H,XL
000b27 2f01                      	MOV TEMP_L,TEMP_H
000b28 2f2a                      	MOV TEMP,XL
000b29 940e 0b08                 	MCALL MUL8X8
000b2b 0fd0                      	ADD YH,TEMP_L
000b2c 1fe1                      	ADC ZL,TEMP_H
000b2d 910f                      	POP TEMP_L
000b2e 911f                      	POP TEMP_H
000b2f 1df7                      	ADC ZH,C0x00
                                 
000b30 931f                      	PUSH TEMP_H
000b31 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_EL,XL
000b32 2f03                      	MOV TEMP_L,TEMP_EL
000b33 2f2a                      	MOV TEMP,XL
000b34 940e 0b08                 	MCALL MUL8X8
000b36 0fe0                      	ADD ZL,TEMP_L
000b37 1ff1                      	ADC ZH,TEMP_H
000b38 910f                      	POP TEMP_L
000b39 911f                      	POP TEMP_H
                                 
000b3a 931f                      	PUSH TEMP_H
000b3b 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_EH,XL
000b3c 2f04                      	MOV TEMP_L,TEMP_EH
000b3d 2f2a                      	MOV TEMP,XL
000b3e 940e 0b08                 	MCALL MUL8X8
000b40 0fd0                      	ADD YH,TEMP_L
000b41 910f                      	POP TEMP_L
000b42 911f                      	POP TEMP_H
                                 
000b43 931f                      	PUSH TEMP_H
000b44 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_L,XH
000b45 2f2b                      	MOV TEMP,XH
000b46 940e 0b08                 	MCALL MUL8X8
000b48 0fd0                      	ADD YH,TEMP_L
000b49 1fe1                      	ADC ZL,TEMP_H
000b4a 1df7                      	ADC ZH,C0x00
000b4b 910f                      	POP TEMP_L
000b4c 911f                      	POP TEMP_H
                                 
000b4d 931f                      	PUSH TEMP_H
000b4e 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_H,XH
000b4f 2f01                      	MOV TEMP_L,TEMP_H
000b50 2f2b                      	MOV TEMP,XH
000b51 940e 0b08                 	MCALL MUL8X8
000b53 0fe0                      	ADD ZL,TEMP_L
000b54 1ff1                      	ADC ZH,TEMP_H
000b55 910f                      	POP TEMP_L
000b56 911f                      	POP TEMP_H
                                 
000b57 931f                      	PUSH TEMP_H
000b58 930f                      	PUSH TEMP_L
                                 	;MUL TEMP_EL,XH
000b59 2f03                      	MOV TEMP_L,TEMP_EL
000b5a 2f2b                      	MOV TEMP,XH
000b5b 940e 0b08                 	MCALL MUL8X8
000b5d 0ff0                      	ADD ZH,TEMP_L
000b5e 910f                      	POP TEMP_L
000b5f 911f                      	POP TEMP_H
                                 
000b60 2f0c                      	MOV TEMP_L,YL
000b61 2f1d                      	MOV TEMP_H,YH
000b62 2f3e                      	MOV TEMP_EL,ZL
000b63 2f4f                      	MOV TEMP_EH,ZH
                                 
000b64 912f                      	POP TEMP
000b65 91ef
000b66 91ff                      	POP_Z
000b67 91cf
000b68 91df                      	POP_Y
000b69 900f                      	POP _RESULT_L
000b6a 901f                      	POP _RESULT_H
000b6b 9508                      	RET
                                 .endif
                                 .include	"./math/mul16x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Использование MUL8X8 (необходимо проверить!)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL16X8
                                 .else
                                 .set DEF_MUL16X8 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/mul16x8.inc(15): included MUL16X8
                                 .message "included MUL16X8"
                                 .endif
                                 
                                 .include	"./math/mul8x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Программная реализация MUL для MUL_SUPPORT != 0x01
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL8X8
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .if MUL_SUPPORT != 0x01
                                 .endif
                                 .if MUL_SUPPORT == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 MUL16X8:
                                 ;--------------------------------------------------------
                                 ;Умножение 16б числа на 8б число
                                 ;IN: TEMP_H/L-16б число, TEMP-8б число
                                 ;OUT: TEMP_EL/H/L-24б результат
                                 ;--------------------------------------------------------
000b6c 938f                      	PUSH ACCUM
                                 
000b6d 2f81                      	MOV ACCUM,TEMP_H
000b6e 940e 0b08                 	MCALL MUL8X8
000b70 931f                      	PUSH TEMP_H
000b71 930f                      	PUSH TEMP_L
                                 
000b72 2f08                      	MOV TEMP_L,ACCUM
000b73 940e 0b08                 	MCALL MUL8X8
000b75 2f31                      	MOV TEMP_EL,TEMP_H
000b76 2f10                      	MOV TEMP_H,TEMP_L
                                 
000b77 910f                      	POP TEMP_L
000b78 918f                      	POP ACCUM
000b79 0f18                      	ADD TEMP_H,ACCUM
000b7a 2788                      	CLR ACCUM
000b7b 1f38                      	ADC TEMP_EL,ACCUM
                                 
000b7c 918f                      	POP ACCUM
000b7d 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_TIME32_DELTA:
                                 ;--------------------------------------------------------
                                 ;Считаем дельту между текущей временной меткой и
                                 ;записанной в выделенной паямти (4 байта)
                                 ;IN: PID,TEMP-смещение на выделенные 4 байта, хранящие
                                 ;временную метку
                                 ;OUT: Дельта будет записана поверх временной метки в
                                 ;выделенную память
                                 ;--------------------------------------------------------
000b7e 93bf
000b7f 93af                      	PUSH_X
000b80 93df
000b81 93cf                      	PUSH_Y
000b82 934f                      	PUSH TEMP_EH
000b83 933f                      	PUSH TEMP_EL
000b84 931f                      	PUSH TEMP_H
000b85 930f                      	PUSH TEMP_L
000b86 932f                      	PUSH TEMP
                                 
000b87 940e 073b                 	MCALL C5_RAM_OFFSET
000b89 0fc2                      	ADD YL,TEMP
000b8a 1dd7                      	ADC YH,C0x00
                                 
000b8b 8148                      	LDD TEMP_EH,Y+0x00
000b8c 8139                      	LDD TEMP_EL,Y+0x01
000b8d 811a                      	LDD TEMP_H,Y+0x02
000b8e 810b                      	LDD TEMP_L,Y+0x03
                                 
                                 	;Используем TEMP!
000b8f 940e 0aea                 	MCALL C5_TIME32_MARK
                                 
000b91 812b                      	LDD TEMP,Y+0x03
000b92 1b20                      	SUB TEMP,TEMP_L
000b93 2f02                      	MOV TEMP_L,TEMP
000b94 812a                      	LDD TEMP,Y+0x02
000b95 1b21                      	SUB TEMP,TEMP_H
000b96 2f12                      	MOV TEMP_H,TEMP
000b97 8129                      	LDD TEMP,Y+0x01
000b98 0b23                      	SBC TEMP,TEMP_EL
000b99 2f32                      	MOV TEMP_EL,TEMP
000b9a 8128                      	LDD TEMP,Y+0x00
000b9b 0b24                      	SBC TEMP,TEMP_EH
000b9c 2f42                      	MOV TEMP_EH,TEMP
                                 
000b9d 3040                      	CPI TEMP_EH,0x00
000b9e f421                      	BRNE PC+0x05
000b9f 3030                      	CPI TEMP_EL,0x00
000ba0 f411                      	BRNE PC+0x03
000ba1 3016                      	CPI TEMP_H,0x06
000ba2 f060                      	BRCS _C5_TIME32_DELTA__BY_CNTR
000ba3 2f01                      	MOV TEMP_L,TEMP_H
000ba4 2f13                      	MOV TEMP_H,TEMP_EL
000ba5 2f34                      	MOV TEMP_EL,TEMP_EH
000ba6 2744                      	CLR TEMP_EH
000ba7 0f00                      	LSL TEMP_L
000ba8 1f11                      	ROL TEMP_H
000ba9 1f33                      	ROL TEMP_EL
000baa e0b3                      	LDI XH,high(1000)
000bab eea8                      	LDI XL,low(1000)
000bac 940e 0b10                 	MCALL MUL32X16
000bae c005                      	RJMP _C5_TIME32_DELTA__STORE
                                 _C5_TIME32_DELTA__BY_CNTR:
000baf 2711                      	CLR TEMP_H
000bb0 e322                      	LDI TEMP,0x32
000bb1 940e 0b6c                 	MCALL MUL16X8
000bb3 2744                      	CLR TEMP_EH
                                 _C5_TIME32_DELTA__STORE:
000bb4 8348                      	STD Y+0x00,TEMP_EH
000bb5 8339                      	STD Y+0x01,TEMP_EL
000bb6 831a                      	STD Y+0x02,TEMP_H
000bb7 830b                      	STD Y+0x03,TEMP_L
                                 
000bb8 912f                      	POP TEMP
000bb9 910f                      	POP TEMP_L
000bba 911f                      	POP TEMP_H
000bbb 913f                      	POP TEMP_EL
000bbc 914f                      	POP TEMP_EH
000bbd 91cf
000bbe 91df                      	POP_Y
000bbf 91af
000bc0 91bf                      	POP_X
000bc1 9508                      	RET
                                 .endif
                                 .include	"./conv/crc16_xmodem.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;01.02.2021  w5277c@gmail.com			Начало (не работает)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_CRC16_XMODEM
                                 .else
                                 .set DEF_CRC16_XMODEM = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./conv/crc16_xmodem.inc(11): included CRC16_XMODEM
                                 .message "included CRC16_XMODEM"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 CRC16_XMODEM:
                                 ;--------------------------------------------------------
                                 ;Подсчет CRC16 (x^16 + x^12 + x^5 + x^0)
                                 ;Изначально в TEMP_EH/EL должно быть 0x0000
                                 ;IN: TEMP-байт, TEMP_EH/EL-сумма
                                 ;OUT: TEMP_EH/EL-сумма
                                 ;--------------------------------------------------------
000bc2 935f                      	PUSH LOOP_CNTR
000bc3 2742                      	EOR TEMP_EH,TEMP
000bc4 e058                      	LDI LOOP_CNTR,0x08
                                 _CRC16_XMODEM_LOOP:
000bc5 0f33                      	LSL TEMP_EL
000bc6 1f44                      	ROL TEMP_EH
000bc7 f420                      	BRCC _CRC16_XMODEM__NO_XOR
000bc8 e120                      	LDI TEMP,0x10
000bc9 2742                      	EOR TEMP_EH,TEMP
000bca e221                      	LDI TEMP,0x21
000bcb 2732                      	EOR TEMP_EL,TEMP
                                 _CRC16_XMODEM__NO_XOR:
000bcc 955a                      	DEC LOOP_CNTR
000bcd f7b9                      	BRNE _CRC16_XMODEM_LOOP
000bce 915f                      	POP LOOP_CNTR
000bcf 9508                      	RET
                                 .endif
                                 .include	"./conv/crc16_block.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;01.02.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_CRC16_BLOCK
                                 .else
                                 .set DEF_CRC16_BLOCK = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./conv/crc16_block.inc(11): included CRC16_BLOCK
                                 .message "included CRC16_BLOCK"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 CRC16_BLOCK:
                                 ;--------------------------------------------------------
                                 ;Подсчет блока CRC(16 бит)
                                 ;IN: X-адрес начала блока, TEMP_H/L-длина
                                 ;TEMP_EH,EL-начальная сумма
                                 ;Z-адрес процедуры для вычисления байта
                                 ;OUT: TEMP_EH,EL-сумма
                                 ;--------------------------------------------------------
000bd0 93bf
000bd1 93af                      	PUSH_X
000bd2 931f                      	PUSH TEMP_H
000bd3 930f                      	PUSH TEMP_L
000bd4 932f                      	PUSH TEMP
                                 
                                 _CRC16_BLOCK__LOOP:
000bd5 912d                      	LD TEMP,X+
000bd6 9509                      	ICALL
                                 _CRC16_BLOCK__CODEPOINT:
000bd7 5001                      	SUBI TEMP_L,0x01
000bd8 4010                      	SBCI TEMP_H,0x00
000bd9 3000                      	CPI TEMP_L,0x00
000bda f7d1                      	BRNE _CRC16_BLOCK__LOOP
000bdb 3010                      	CPI TEMP_H,0x00
000bdc f7c1                      	BRNE _CRC16_BLOCK__LOOP
                                 
000bdd 912f                      	POP TEMP
000bde 910f                      	POP TEMP_L
000bdf 911f                      	POP TEMP_H
000be0 91af
000be1 91bf                      	POP_X
000be2 9508                      	RET
                                 .endif
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_GET_BLOCK:
                                 ;--------------------------------------------------------
                                 ;Прием блока данных
                                 ;IN: X-адрес на выделенную память,Y-адрес на переменные
                                 ;TEMP_H,L-максимальная длина данных
                                 ;OUT: TEMP_H,L-длина полученных данных
                                 ;ACCUM-0x00 успешное выполнение
                                 ;--------------------------------------------------------
000be3 937f                      	PUSH TRY_CNTR
000be4 932f                      	PUSH TEMP
000be5 934f                      	PUSH TEMP_EH
000be6 933f                      	PUSH TEMP_EL
000be7 93df
000be8 93cf                      	PUSH_Y
000be9 93ff
000bea 93ef                      	PUSH_Z
000beb 93bf
000bec 93af                      	PUSH_X
                                 
000bed 2ff1                      	MOV ZH,TEMP_H
000bee 2fe0                      	MOV ZL,TEMP_L
000bef e070                      	LDI TRY_CNTR,0x00
                                 _DRV_SD_GET_BLOCK__BEGIN_LOOP:
000bf0 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
000bf2 3f2e                      	CPI TEMP,0xfe
000bf3 f419                      	BRNE _DRV_SD_GET_BLOCK__DATA
                                 _DRV_SD_GET_BLOCK__NO_ERROR:
000bf4 957a                      	DEC TRY_CNTR
000bf5 f7d1                      	BRNE _DRV_SD_GET_BLOCK__BEGIN_LOOP
000bf6 c016                      	RJMP _DRV_SD_GET_BLOCK__FAIL
                                 
                                 _DRV_SD_GET_BLOCK__DATA:
000bf7 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
000bf9 932d                      	ST X+,TEMP
000bfa 9731                      	SBIW ZL,0x01
000bfb f7d9                      	BRNE _DRV_SD_GET_BLOCK__DATA
                                 	;Получаем CRC
000bfc 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
000bfe 2f82                      	MOV ACCUM,TEMP
000bff 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
000c01 91af
000c02 91bf                      	POP_X
                                 
000c03 93bf
000c04 93af                      	PUSH_X
000c05 e040                      	LDI TEMP_EH,0x00
000c06 e030                      	LDI TEMP_EL,0x00
000c07 e0fb
000c08 ece2                      	LDI_Z CRC16_XMODEM
000c09 940e 0bd0                 	MCALL CRC16_BLOCK
                                 ;TODO не сходится CRC
                                 ;	CP ACCUM,TEMP_EH
                                 ;	BRNE _DRV_SD_GET_BLOCK__FAIL
                                 ;	CP TEMP,TEMP_EL
                                 ;	BRNE _DRV_SD_GET_BLOCK__FAIL
                                 
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
000c0b e080                      	LDI ACCUM,0x00
000c0c c003                      	RJMP _DRV_SD_GET_BLOCK__END
                                 _DRV_SD_GET_BLOCK__FAIL:
000c0d ef8f                      	LDI ACCUM,0xff
000c0e e010                      	LDI TEMP_H,0x00
000c0f e000                      	LDI TEMP_L,0x00
                                 _DRV_SD_GET_BLOCK__END:
                                 
000c10 91af
000c11 91bf                      	POP_X
000c12 91ef
000c13 91ff                      	POP_Z
000c14 91cf
000c15 91df                      	POP_Y
000c16 913f                      	POP TEMP_EL
000c17 914f                      	POP TEMP_EH
000c18 912f                      	POP TEMP
000c19 917f                      	POP TRY_CNTR
000c1a 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_OP_GET_CSD:
                                 ;--------------------------------------------------------
                                 ;Получить CSD
                                 ;IN: X-адрес на выделенную память
                                 ;OUT: ACCUM-R1 ответ
                                 ;--------------------------------------------------------
000c1b 932f                      	PUSH TEMP
000c1c 931f                      	PUSH TEMP_H
000c1d 930f                      	PUSH TEMP_L
000c1e 93df
000c1f 93cf                      	PUSH_Y
                                 
000c20 2fdb                      	MOV YH,XH
000c21 2fca                      	MOV YL,XL
                                 
000c22 982a                      	CBI PORTB,SS & 0x0f
000c23 e029                      	LDI TEMP,_DRV_SD_CMD9
000c24 93bf
000c25 93af                      	PUSH_X
000c26 932d                      	ST X+,TEMP
000c27 927d                      	ST X+,C0x00
000c28 927d                      	ST X+,C0x00
000c29 927d                      	ST X+,C0x00
000c2a 927d                      	ST X+,C0x00
000c2b 91af
000c2c 91bf                      	POP_X
000c2d e005                      	LDI TEMP_L,0x05
000c2e 940e 1205                 	MCALL _DRV_SD__SEND_CMD
000c30 940e 0abf                 	MCALL _DRV_SD_GET_R1
000c32 3080                      	CPI ACCUM,0x00
000c33 f421                      	BRNE _DRV_SD_OP_GET_CSD__END
000c34 e010                      	LDI TEMP_H,0x00
000c35 e100                      	LDI TEMP_L,0x10
000c36 940e 0be3                 	MCALL _DRV_SD_GET_BLOCK
                                 _DRV_SD_OP_GET_CSD__END:
000c38 9a2a                      	SBI PORTB,SS & 0x0f
                                 
000c39 91cf
000c3a 91df                      	POP_Y
000c3b 910f                      	POP TEMP_L
000c3c 911f                      	POP TEMP_H
000c3d 912f                      	POP TEMP
000c3e 9508                      	RET
                                 .endif
                                 	.include "./core/drivers/sd/sd_log_csd.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_SD_LOG_CSD
                                 .else
                                 .set DEF_C5_SD_LOG_CSD = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_byte.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTE
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_num32.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало (не тестировано)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO Оптимизировать
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_NUM32
                                 .else
                                 .set DEF_C5_OUT_NUM32 = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./math/div32x16.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;29.10.2020	w5277c@gmail.com			Начало
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;18.10.2021	w5277c@gmail.com			Возврат остатка
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DIV32X16
                                 .else
                                 .set DEF_DIV32X16 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/div32x16.inc(13): included DIV32X16
                                 .message "included DIV32X16"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 DIV32X16:
                                 ;--------------------------------------------------------
                                 ;Деление 32b числа на 16б число
                                 ;IN: TEMP_EH/EL/H/L-32b делимое, X-16b делитель
                                 ;OUT: TEMP_EH/EL/H/L-32b результат, X-16b остаток
                                 ;--------------------------------------------------------
000c3f 935f                      	PUSH LOOP_CNTR
000c40 932f                      	PUSH TEMP
000c41 93df                      	PUSH YH
000c42 93cf                      	PUSH YL
000c43 93ef                      	PUSH ZL
                                 
000c44 e251                      	LDI LOOP_CNTR,0x21
000c45 1bcc                      	SUB YL,YL
000c46 27dd                      	CLR YH
000c47 27ee                      	CLR ZL
                                 _DIV32X16__LOOP:
000c48 1f00                      	ROL TEMP_L
000c49 1f11                      	ROL TEMP_H
000c4a 1f33                      	ROL TEMP_EL
000c4b 1f44                      	ROL TEMP_EH
000c4c 955a                      	DEC LOOP_CNTR
000c4d f071                      	BREQ _DIV32X16__END
000c4e 1fcc                      	ROL YL
000c4f 1fdd                      	ROL YH
000c50 1fee                      	ROL ZL
000c51 1bca                      	SUB YL,XL
000c52 0bdb                      	SBC YH,XH
000c53 09e7                      	SBC ZL,C0x00
000c54 f428                      	BRCC _DIV32X16__SKIP
000c55 0fca                      	ADD YL,XL
000c56 1fdb                      	ADC YH,XH
000c57 1de7                      	ADC ZL,C0x00
000c58 9488                      	CLC
000c59 cfee                      	RJMP _DIV32X16__LOOP
                                 _DIV32X16__SKIP:
000c5a 9408                      	SEC
000c5b cfec                      	RJMP _DIV32X16__LOOP
                                 _DIV32X16__END:
000c5c 01de                      	MOVW XL,YL
                                 
000c5d 91ef                      	POP ZL
000c5e 91cf                      	POP YL
000c5f 91df                      	POP YH
000c60 912f                      	POP TEMP
000c61 915f                      	POP LOOP_CNTR
000c62 9508                      	RET
                                 .endif
                                 .include	"./math/mul32x16.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало
                                 ;08.01.2022	w5277c@gmail.com			Багфикс
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO перейти на использование MUL8X8
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL32X16
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_NUM32:
                                 ;--------------------------------------------------------
                                 ;Логирование десятиричного числа(4 байта)
                                 ;IN: TEMP_EH/EL/H/L-двойное слово
                                 ;--------------------------------------------------------
000c63 934f
000c64 933f
000c65 931f
000c66 930f
000c67 932f                      	PUSH_FT
000c68 935f                      	PUSH LOOP_CNTR
000c69 93bf
000c6a 93af                      	PUSH_X
000c6b 93df
000c6c 93cf                      	PUSH_Y
000c6d 93ff
000c6e 93ef                      	PUSH_Z
                                 
000c6f 2fd4                      	MOV YH,TEMP_EH
000c70 2fc3                      	MOV YL,TEMP_EL
000c71 2ff1                      	MOV ZH,TEMP_H
000c72 2fe0                      	MOV ZL,TEMP_L
                                 
000c73 e0b0
000c74 e0aa                      	LDI_X 0x000a
000c75 e05a                      	LDI LOOP_CNTR,0x0a
                                 _C5_OUT_NUM32__LOOP1:
000c76 2f4d                      	MOV TEMP_EH,YH
000c77 2f3c                      	MOV TEMP_EL,YL
000c78 2f1f                      	MOV TEMP_H,ZH
000c79 2f0e                      	MOV TEMP_L,ZL
000c7a 930f                      	PUSH TEMP_L
000c7b 940e 0c3f                 	MCALL DIV32X16
000c7d 2fd4                      	MOV YH,TEMP_EH
000c7e 2fc3                      	MOV YL,TEMP_EL
000c7f 2ff1                      	MOV ZH,TEMP_H
000c80 2fe0                      	MOV ZL,TEMP_L
000c81 940e 0b10                 	MCALL MUL32X16
000c83 911f                      	POP TEMP_H
000c84 1b10                      	SUB TEMP_H,TEMP_L
000c85 931f                      	PUSH TEMP_H
000c86 955a                      	DEC LOOP_CNTR
000c87 f771                      	BRNE _C5_OUT_NUM32__LOOP1
                                 
000c88 e000                      	LDI TEMP_L,0x00
000c89 e05a                      	LDI LOOP_CNTR,0x0a
                                 _C5_OUT_NUM32__LOOP2:
000c8a 912f                      	POP TEMP
000c8b 3051                      	CPI LOOP_CNTR,0x01
000c8c f011                      	BREQ PC+0x03
000c8d 2b02                      	OR TEMP_L,TEMP
000c8e f019                      	BREQ PC+0x02+_MCALL_SIZE
000c8f 5d20                      	SUBI TEMP,(0x100-0x30)
000c90 940e 01cd                 	MCALL C5_OUT_CHAR
000c92 955a                      	DEC LOOP_CNTR
000c93 f7b1                      	BRNE _C5_OUT_NUM32__LOOP2
                                 
000c94 91ef
000c95 91ff                      	POP_Z
000c96 91cf
000c97 91df                      	POP_Y
000c98 91af
000c99 91bf                      	POP_X
000c9a 915f                      	POP LOOP_CNTR
000c9b 912f
000c9c 910f
000c9d 911f
000c9e 913f
000c9f 914f                      	POP_FT
000ca0 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_num16.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;25.01.2021	w5277c@gmail.com			Начало (не тестировано)
                                 ;18.10.2021	w5277c@gmail.com			Оптимизация
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_NUM16
                                 .else
                                 .set DEF_C5_OUT_NUM16 = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./math/div16x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;18.10.2021	w5277c@gmail.com			Возврат остатка
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DIV16X8
                                 .else
                                 .set DEF_DIV16X8 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/div16x8.inc(15): included DIV16X8
                                 .message "included DIV16X8"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 DIV16X8:
                                 ;--------------------------------------------------------
                                 ;Деление 16b числа на 8б число
                                 ;IN: TEMP_H/L-16b делимое, TEMP-8b делитель
                                 ;OUT: TEMP_H/L-16b результат, TEMP-8b остаток
                                 ;--------------------------------------------------------
000ca1 93bf
000ca2 93af                      	PUSH_X
000ca3 935f                      	PUSH LOOP_CNTR
                                 
000ca4 e151                      	LDI LOOP_CNTR,0x11
000ca5 1bbb                      	SUB XH,XH
000ca6 27aa                      	CLR XL
                                 
                                 _DIV16X8__LOOP:
000ca7 1f00                      	ROL TEMP_L
000ca8 1f11                      	ROL TEMP_H
000ca9 955a                      	DEC LOOP_CNTR
000caa f059                      	BREQ _DIV16X8__END
000cab 1faa                      	ROL XL
000cac 1fbb                      	ROL XH
000cad 1ba2                      	SUB XL,TEMP
000cae 09b7                      	SBC XH,C0x00
000caf f010                      	BRCS PC+0x03
000cb0 9408                      	SEC
000cb1 cff5                      	RJMP _DIV16X8__LOOP
000cb2 0fa2                      	ADD XL,TEMP
000cb3 1db7                      	ADC XH,C0x00 
000cb4 9488                      	CLC
000cb5 cff1                      	RJMP _DIV16X8__LOOP
                                 _DIV16X8__END:
000cb6 2f2a                      	MOV TEMP,XL
                                 
000cb7 915f                      	POP LOOP_CNTR
000cb8 91af
000cb9 91bf                      	POP_X
000cba 9508                      	RET
                                 .endif
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_NUM16:
                                 ;--------------------------------------------------------
                                 ;Логирование десятиричного 16b числа
                                 ;IN: TEMP_H/L-16b число
                                 ;--------------------------------------------------------
000cbb 931f                      	PUSH TEMP_H
000cbc 930f                      	PUSH TEMP_L
000cbd 932f                      	PUSH TEMP
000cbe 935f                      	PUSH LOOP_CNTR
                                 
000cbf e054                      	LDI LOOP_CNTR,0x04
                                 _C5_OUT_NUM16__LOOP:
000cc0 e02a                      	LDI TEMP,0x0a
000cc1 940e 0ca1                 	MCALL DIV16x8
000cc3 5d20                      	SUBI TEMP,(0x100-0x30)
000cc4 932f                      	PUSH TEMP
000cc5 955a                      	DEC LOOP_CNTR
000cc6 f7c9                      	BRNE _C5_OUT_NUM16__LOOP
000cc7 5d00                      	SUBI TEMP_L,(0x100-0x30)
000cc8 930f                      	PUSH TEMP_L
                                 
000cc9 e054                      	LDI LOOP_CNTR,0x04
                                 _C5_OUT_NUM16__LOOP2:
000cca 912f                      	POP TEMP
000ccb fd07                      	SBRC TEMP_L,0x07
000ccc f011                      	BREQ PC+0x03
000ccd 3320                      	CPI TEMP,0x30
000cce f019                      	BREQ PC+0x01+_MCALL_SIZE+0x01
000ccf 940e 01cd                 	MCALL C5_OUT_CHAR
000cd1 6860                      	ORI FLAGS,(1<<0x07)
000cd2 955a                      	DEC LOOP_CNTR
000cd3 f7b1                      	BRNE _C5_OUT_NUM16__LOOP2
000cd4 912f                      	POP TEMP
000cd5 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
000cd7 915f                      	POP LOOP_CNTR
000cd8 912f                      	POP TEMP
000cd9 910f                      	POP TEMP_L
000cda 911f                      	POP TEMP_H
000cdb 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_num.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;08.10.2020	w5277c@gmail.com			Начало
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;26.01.2021	w5277c@gmail.com			Не выводим лишние нули
                                 ;03.07.2021	w5277c@gmail.com			Багфикс
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO Оптимизировать
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_NUM
                                 .else
                                 .set DEF_C5_OUT_NUM = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./math/div16x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;18.10.2021	w5277c@gmail.com			Возврат остатка
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DIV16X8
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./math/div10.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2020	w5277c@gmail.com			Начало
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Использование MUL8X8
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DIV10
                                 .else
                                 .set DEF_DIV10 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/div10.inc(14): included DIV10
                                 .message "included DIV10"
                                 .endif
                                 
                                 .include	"./math/mul8x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Программная реализация MUL для MUL_SUPPORT != 0x01
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL8X8
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .if MUL_SUPPORT != 0x01
                                 .endif
                                 .if MUL_SUPPORT == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 DIV10:
                                 ;--------------------------------------------------------
                                 ;Деление 8b числа на 10
                                 ;IN: TEMP-8b число
                                 ;OUT: TEMP_L-8b результат
                                 ;--------------------------------------------------------
000cdc 931f                      	PUSH TEMP_H
                                 
000cdd ec0d                      	LDI TEMP_L,205														;204.8
000cde 940e 0b08                 	MCALL MUL8X8
000ce0 2f01                      	MOV TEMP_L,TEMP_H
000ce1 9506                      	LSR TEMP_L
000ce2 9506                      	LSR TEMP_L
000ce3 9506                      	LSR TEMP_L
                                 
000ce4 911f                      	POP TEMP_H
000ce5 9508                      	RET
                                 .endif
                                 .include	"./math/mul10.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;08.10.2020	w5277c@gmail.com			Начало
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Использование MUL8X8
                                 ;08.01.2022	w5277c@gmail.com			Оптимиация(существенно при программном MUL8x8)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL10
                                 .else
                                 .set DEF_MUL10 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/mul10.inc(15): included MUL10
                                 .message "included MUL10"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 MUL10:
                                 ;--------------------------------------------------------
                                 ;Умножение 8b числа на 10
                                 ;IN: TEMP-8b число
                                 ;OUT: TEMP_H/L-результат
                                 ;--------------------------------------------------------
000ce6 2711                      	CLR TEMP_H
000ce7 2f02                      	MOV TEMP_L,TEMP
000ce8 0f00                      	LSL TEMP_L
000ce9 1f11                      	ROL TEMP_H
000cea 0f00                      	LSL TEMP_L
000ceb 1f11                      	ROL TEMP_H
000cec 0f00                      	LSL TEMP_L
000ced 1f11                      	ROL TEMP_H
000cee 0f02                      	ADD TEMP_L,TEMP
000cef 1d17                      	ADC TEMP_H,C0x00
000cf0 0f02                      	ADD TEMP_L,TEMP
000cf1 1d17                      	ADC TEMP_H,C0x00
                                 
000cf2 9508                      	RET
                                 .endif
                                 .include	"./math/mul100.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;08.10.2020	w5277c@gmail.com			Начало
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Использование MUL8X8
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL100
                                 .else
                                 .set DEF_MUL100 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./math/mul100.inc(14): included MUL100
                                 .message "included MUL100"
                                 .endif
                                 
                                 .include	"./math/mul8x8.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;10.12.2020	w5277c@gmail.com			-с5
                                 ;29.05.2021	w5277c@gmail.com			Программная реализация MUL для MUL_SUPPORT != 0x01
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_MUL8X8
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .if MUL_SUPPORT != 0x01
                                 .endif
                                 .if MUL_SUPPORT == 0x01
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 MUL100:
                                 ;--------------------------------------------------------
                                 ;Умножение 8b числа на 100
                                 ;IN: TEMP-8b число
                                 ;OUT: TEMP_H/L-результат
                                 ;--------------------------------------------------------
000cf3 e604                      	LDI TEMP_L,0x64
000cf4 940e 0b08                 	MCALL MUL8X8
000cf6 9508                      	RET
                                 .endif
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_NUM:
                                 ;--------------------------------------------------------
                                 ;Логирование десятиричного числа(1байт)
                                 ;IN: TEMP-байт
                                 ;--------------------------------------------------------
000cf7 938f                      	PUSH ACCUM
000cf8 934f
000cf9 933f
000cfa 931f
000cfb 930f
000cfc 932f                      	PUSH_FT
000cfd 936f                      	PUSH FLAGS
                                 
000cfe e060                      	LDI FLAGS,0x00
000cff 2f82                      	MOV ACCUM,TEMP
000d00 e010                      	LDI TEMP_H,0x00
000d01 2f08                      	MOV TEMP_L,ACCUM
000d02 e624                      	LDI TEMP,0x64
000d03 940e 0ca1                 	MCALL DIV16x8
000d05 2b60                      	OR FLAGS,TEMP_L
000d06 f021                      	BREQ PC+0x03+_MCALL_SIZE
000d07 2f20                      	MOV TEMP,TEMP_L
000d08 5d20                      	SUBI TEMP,(0x100-0x30)											;+0x30
000d09 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
000d0b 2f20                      	MOV TEMP,TEMP_L
000d0c 940e 0cf3                 	MCALL MUL100
000d0e 1b80                      	SUB ACCUM,TEMP_L
000d0f 2f28                      	MOV TEMP,ACCUM
000d10 940e 0cdc                 	MCALL DIV10
000d12 2b60                      	OR FLAGS,TEMP_L
000d13 f021                      	BREQ PC+0x03+_MCALL_SIZE
000d14 2f20                      	MOV TEMP,TEMP_L
000d15 5d20                      	SUBI TEMP,(0x100-0x30)											;+0x30
000d16 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
000d18 2f20                      	MOV TEMP,TEMP_L
000d19 940e 0ce6                 	MCALL MUL10
000d1b 1b80                      	SUB ACCUM,TEMP_L
000d1c 5d80                      	SUBI ACCUM,(0x100-0x30)										;+0x30
000d1d 2f28                      	MOV TEMP,ACCUM
000d1e 940e 01cd                 	MCALL C5_OUT_CHAR
                                 
000d20 916f                      	POP FLAGS
000d21 912f
000d22 910f
000d23 911f
000d24 913f
000d25 914f                      	POP_FT
000d26 918f                      	POP ACCUM
000d27 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_cr.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_str_el.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;27.01.2021	w5277c@gmail.com			Начало
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STR_EL
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_str.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 .include	"./core/io/out_strn.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;15.01.2021	w5277c@gmail.com			Начало
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_STRN
                                 .else
                                 .set DEF_C5_OUT_STRN = 1
                                 .ifdef LOGGING_PORT
                                 
                                 .include	"./core/io/out_char.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020  w5277c@gmail.com        Начало
                                 ;01.08.2020  w5277c@gmail.com        Разбиение на файлы
                                 ;27.10.2020  w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_CHAR
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 C5_OUT_STRN:
                                 ;--------------------------------------------------------
                                 ;Логирование строки с указанной длинной
                                 ;IN: Z-адрес на строку,TEMP-длина(15-ый бит false-RAM,
                                 ;true-ROM)
                                 ;--------------------------------------------------------
000d28 935f                      	PUSH LOOP_CNTR
000d29 932f                      	PUSH TEMP
000d2a 93ff
000d2b 93ef                      	PUSH_Z
000d2c 938f                      	PUSH ACCUM
                                 
                                 	;Умножаем на 2 адрес рабоыт с ROM
000d2d fff7                      	SBRS ZH,0x07
000d2e c003                      	RJMP PC+0x04
000d2f 0fee                      	LSL ZL
000d30 1fff                      	ROL ZH
000d31 68f0                      	ORI ZH,0x80
000d32 2f8f                      	MOV ACCUM,ZH
000d33 77ff                      	ANDI ZH,0x7f
000d34 2f52                      	MOV LOOP_CNTR,TEMP
                                 _C5_OUT_STRN__BYTES_LOOP:
                                 	;Считываем байт
000d35 ff87                      	SBRS ACCUM,0x07
000d36 9121                      	LD TEMP,Z+
000d37 fd87                      	SBRC ACCUM,0x07
000d38 9125                      	LPM TEMP,Z+
000d39 3020                      	CPI TEMP,0x00
000d3a f021                      	BREQ _C5_OUT_STRN__END
000d3b 940e 01cd                 	MCALL C5_OUT_CHAR
000d3d 955a                      	DEC LOOP_CNTR
000d3e f7b1                      	BRNE _C5_OUT_STRN__BYTES_LOOP
                                 
                                 _C5_OUT_STRN__END:
000d3f 918f                      	POP ACCUM
000d40 91ef
000d41 91ff                      	POP_Z
000d42 912f                      	POP TEMP
000d43 915f                      	POP LOOP_CNTR
000d44 9508                      	RET
                                 .endif
                                 .endif
                                 .include	"./core/io/out_bytes.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;12.06.2020	w5277c@gmail.com        Начало
                                 ;01.08.2020	w5277c@gmail.com        Разбиение на файлы
                                 ;13.09.2020	w5277c@gmail.com        Восстанавливаем Y
                                 ;27.10.2020	w5277c@gmail.com        Обновлена информация об авторских правах
                                 ;05.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_OUT_BYTES
                                 .else
                                 .ifdef LOGGING_PORT
                                 .endif
                                 .endif
                                 
                                 
                                 _DRV_SD_LOG_STR_CSD:
000d45 5343
000d46 2044
000d47 6572
000d48 6967
000d49 7473
000d4a 7265
000d4b 0d3a
000d4c 000a                      	.db "CSD register:",0x0d,0x0a,0x00
                                 _DRV_SD_LOG_STR_CSD_STRUCTURE:
000d4d 4320
000d4e 4453
000d4f 535f
000d50 5254
000d51 4355
000d52 5554
000d53 4552
000d54 003a                      	.db " CSD_STRUCTURE:",0x00
                                 _DRV_SD_LOG_STR_CSD_TAAC:
000d55 5420
000d56 4141
000d57 3a43
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(29): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000d58 0000                      	.db " TAAC:",0x00
                                 _DRV_SD_LOG_STR_CSD_NSAC:
000d59 4e20
000d5a 4153
000d5b 2843
000d5c 3178
000d5d 3030
000d5e 6c63
000d5f 6b63
000d60 3a29
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(31): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000d61 0000                      	.db " NSAC(x100clck):",0x00
                                 _DRV_SD_LOG_STR_CSD_VALUES:
000d62 7372
000d63 0076
000d64 2e31
000d65 0030
000d66 2e31
000d67 0032
000d68 2e31
000d69 0033
000d6a 2e31
000d6b 0035
000d6c 2e32
000d6d 0030
000d6e 2e32
000d6f 0035
000d70 2e33
000d71 0030
000d72 2e33
000d73 0035
000d74 2e34
000d75 0030
000d76 2e34
000d77 0035
000d78 2e35
000d79 0030
000d7a 2e35
000d7b 0035
000d7c 2e36
000d7d 0030
000d7e 2e37
000d7f 0030
000d80 2e38
000d81 0030                      	.db "rsv",0x00,"1.0",0x00,"1.2",0x00,"1.3",0x00,"1.5",0x00,"2.0",0x00,"2.5",0x00,"3.0",0x00,"3.5",0x00,"4.0",0x00,"4.5",0x00,"5.0",0x00,"5.5",0x00,"6.0",0x00,"7.0",0x00,"8.0",0x00
                                 _DRV_SD_LOG_STR_CSD_TIMES:
000d82 6e31
000d83 0073
000d84 3031
000d85 736e
000d86 3100
000d87 3030
000d88 736e
000d89 3100
000d8a 7375
000d8b 3100
000d8c 7530
000d8d 0073
000d8e 3031
000d8f 7530
000d90 0073
000d91 6d31
000d92 0073
000d93 3031
000d94 736d
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(35): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000d95 0000                      	.db "1ns",0x00,"10ns",0x00,"100ns",0x00,"1us",0x00,"10us",0x00,"100us",0x00,"1ms",0x00,"10ms",0x00
                                 _DRV_SD_LOG_STR_CSD_TRAN_SPEED:
000d96 5420
000d97 4152
000d98 5f4e
000d99 5053
000d9a 4545
000d9b 3a44
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(37): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000d9c 0000                      	.db " TRAN_SPEED:",0x00
                                 _DRV_SD_LOG_STR_CSD_RATES:
000d9d 3031
000d9e 4b30
000d9f 6962
000da0 2f74
000da1 0073
000da2 4d31
000da3 6962
000da4 2f74
000da5 0073
000da6 3031
000da7 624d
000da8 7469
000da9 732f
000daa 3100
000dab 3030
000dac 624d
000dad 7469
000dae 732f
000daf 7200
000db0 7673
000db1 7200
000db2 7673
000db3 7200
000db4 7673
000db5 7200
000db6 7673
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(39): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000db7 0000                      	.db "100Kbit/s",0x00,"1Mbit/s",0x00,"10Mbit/s",0x00,"100Mbit/s",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00
                                 _DRV_SD_LOG_STR_CSD_CCC:
000db8 4320
000db9 4343
000dba 0d3a
000dbb 000a                      	.db " CCC:",0x0d,0x0a,0x00
                                 _DRV_SD_LOG_STR_CSD_CLASS:
000dbc 2020
000dbd 6c63
000dbe 7361
000dbf 2073
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(43): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000dc0 0000                      	.db "  class ",0x00
                                 _DRV_SD_LOG_STR_CSD_READ_BL_LEN:
000dc1 5220
000dc2 4145
000dc3 5f44
000dc4 4c42
000dc5 4c5f
000dc6 4e45
000dc7 003a                      	.db " READ_BL_LEN:",0x00
                                 _DRV_SD_LOG_STR_CSD_LENS:
000dc8 7372
000dc9 0076
000dca 7372
000dcb 0076
000dcc 7372
000dcd 0076
000dce 7372
000dcf 0076
000dd0 7372
000dd1 0076
000dd2 7372
000dd3 0076
000dd4 7372
000dd5 0076
000dd6 7372
000dd7 0076
000dd8 7372
000dd9 0076
000dda 3135
000ddb 2032
000ddc 7942
000ddd 6574
000dde 0073
000ddf 3031
000de0 3432
000de1 4220
000de2 7479
000de3 7365
000de4 3200
000de5 3430
000de6 2038
000de7 7942
000de8 6574
000de9 0073
000dea 7372
000deb 0076
000dec 7372
000ded 0076
000dee 7372
000def 0076
000df0 7372
000df1 0076                      	.db "rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"512 Bytes",0x00,"1024 Bytes",0x00,"2048 Bytes",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00,"rsv",0x00
                                 _DRV_SD_LOG_STR_CSD_READ_BL_PARTIAL:
000df2 5220
000df3 4145
000df4 5f44
000df5 4c42
000df6 505f
000df7 5241
000df8 4954
000df9 4c41
000dfa 003a                      	.db " READ_BL_PARTIAL:",0x00
                                 _DRV_SD_LOG_STR_CSD_WRITE_BLK_MISALIGN:
000dfb 5720
000dfc 4952
000dfd 4554
000dfe 425f
000dff 4b4c
000e00 4d5f
000e01 5349
000e02 4c41
000e03 4749
000e04 3a4e
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(51): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e05 0000                      	.db " WRITE_BLK_MISALIGN:",0x00
                                 _DRV_SD_LOG_STR_CSD_READ_BLK_MISALIGN:
000e06 5220
000e07 4145
000e08 5f44
000e09 4c42
000e0a 5f4b
000e0b 494d
000e0c 4153
000e0d 494c
000e0e 4e47
000e0f 003a                      	.db " READ_BLK_MISALIGN:",0x00
                                 _DRV_SD_LOG_STR_CSD_DSR_IMP:
000e10 5220
000e11 4145
000e12 5f44
000e13 5344
000e14 5f52
000e15 4d49
000e16 3a50
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(55): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e17 0000                      	.db " READ_DSR_IMP:",0x00
                                 _DRV_SD_LOG_STR_CSD_C_SIZE:
000e18 4320
000e19 535f
000e1a 5a49
000e1b 3a45
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(57): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e1c 0000                      	.db " C_SIZE:",0x00
                                 _DRV_SD_LOG_STR_CSD_VDD_R_CURR_MIN:
000e1d 5620
000e1e 4444
000e1f 525f
000e20 435f
000e21 5255
000e22 5f52
000e23 494d
000e24 3a4e
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(59): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e25 0000                      	.db " VDD_R_CURR_MIN:",0x00
                                 _DRV_SD_LOG_STR_CSD_CURRENTS_MIN:
000e26 2e30
000e27 6d35
000e28 0041
000e29 6d31
000e2a 0041
000e2b 6d35
000e2c 0041
000e2d 3031
000e2e 416d
000e2f 3200
000e30 6d35
000e31 0041
000e32 3533
000e33 416d
000e34 3600
000e35 6d30
000e36 0041
000e37 3031
000e38 6d30
000e39 0041                      	.db "0.5mA",0x00,"1mA",0x00,"5mA",0x00,"10mA",0x00,"25mA",0x00,"35mA",0x00,"60mA",0x00,"100mA",0x00
                                 _DRV_SD_LOG_STR_CSD_VDD_R_CURR_MAX:
000e3a 5620
000e3b 4444
000e3c 525f
000e3d 435f
000e3e 5255
000e3f 5f52
000e40 414d
000e41 3a58
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(63): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e42 0000                      	.db " VDD_R_CURR_MAX:",0x00
                                 _DRV_SD_LOG_STR_CSD_CURRENTS_MAX:
000e43 6d31
000e44 0041
000e45 6d35
000e46 0041
000e47 3031
000e48 416d
000e49 3200
000e4a 6d35
000e4b 0041
000e4c 3533
000e4d 416d
000e4e 3400
000e4f 6d35
000e50 0041
000e51 3038
000e52 416d
000e53 3200
000e54 3030
000e55 416d
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(65): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e56 0000                      	.db "1mA",0x00,"5mA",0x00,"10mA",0x00,"25mA",0x00,"35mA",0x00,"45mA",0x00,"80mA",0x00,"200mA",0x00
                                 _DRV_SD_LOG_STR_CSD_VDD_W_CURR_MIN:
000e57 5620
000e58 4444
000e59 575f
000e5a 435f
000e5b 5255
000e5c 5f52
000e5d 494d
000e5e 3a4e
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(67): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e5f 0000                      	.db " VDD_W_CURR_MIN:",0x00
                                 _DRV_SD_LOG_STR_CSD_VDD_W_CURR_MAX:
000e60 5620
000e61 4444
000e62 575f
000e63 435f
000e64 5255
000e65 5f52
000e66 414d
000e67 3a58
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(69): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e68 0000                      	.db " VDD_W_CURR_MAX:",0x00
                                 _DRV_SD_LOG_STR_CSD_C_SIZE_MULT:
000e69 4320
000e6a 535f
000e6b 5a49
000e6c 5f45
000e6d 554d
000e6e 544c
000e6f 003a                      	.db " C_SIZE_MULT:",0x00
                                 _DRV_SD_LOG_STR_CSD_ERASE_BLR_EN:
000e70 4520
000e71 4152
000e72 4553
000e73 425f
000e74 524c
000e75 455f
000e76 3a4e
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(73): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e77 0000                      	.db " ERASE_BLR_EN:",0x00
                                 _DRV_SD_LOG_STR_CSD_SECTOR_SIZE:
000e78 5320
000e79 4345
000e7a 4f54
000e7b 5f52
000e7c 4953
000e7d 455a
000e7e 3128
000e7f 312d
000e80 3832
000e81 6220
000e82 6b6c
000e83 3a29
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(75): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e84 0000                      	.db " SECTOR_SIZE(1-128 blk):",0x00
                                 _DRV_SD_LOG_STR_CSD_WP_GRP_SIZE:
000e85 5720
000e86 5f50
000e87 5247
000e88 5f50
000e89 4953
000e8a 455a
000e8b 3128
000e8c 312d
000e8d 3832
000e8e 7320
000e8f 6365
000e90 3a29
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(77): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000e91 0000                      	.db " WP_GRP_SIZE(1-128 sec):",0x00
                                 _DRV_SD_LOG_STR_CSD_WP_GRP_ENABLE:
000e92 5720
000e93 5f50
000e94 5247
000e95 5f50
000e96 4e45
000e97 4241
000e98 454c
000e99 003a                      	.db " WP_GRP_ENABLE:",0x00
                                 _DRV_SD_LOG_STR_CSD_R2W_FACTOR:
000e9a 5220
000e9b 5732
000e9c 465f
000e9d 4341
000e9e 4f54
000e9f 3a52
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(81): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000ea0 0000                      	.db " R2W_FACTOR:",0x00
                                 _DRV_SD_LOG_STR_CSD_WRITE_BL_LEN:
000ea1 5720
000ea2 4952
000ea3 4554
000ea4 425f
000ea5 5f4c
000ea6 454c
000ea7 3a4e
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(83): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000ea8 0000                      	.db " WRITE_BL_LEN:",0x00
                                 _DRV_SD_LOG_STR_CSD_WRITE_BL_PARTIAL:
000ea9 5720
000eaa 4952
000eab 4554
000eac 425f
000ead 5f4c
000eae 4150
000eaf 5452
000eb0 4149
000eb1 3a4c
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(85): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000eb2 0000                      	.db " WRITE_BL_PARTIAL:",0x00
                                 _DRV_SD_LOG_STR_CSD_FILE_FORMAT_GRP:
000eb3 4620
000eb4 4c49
000eb5 5f45
000eb6 4f46
000eb7 4d52
000eb8 5441
000eb9 475f
000eba 5052
000ebb 003a                      	.db " FILE_FORMAT_GRP:",0x00
                                 _DRV_SD_LOG_STR_CSD_COPY:
000ebc 4320
000ebd 504f
000ebe 3a59
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(89): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000ebf 0000                      	.db " COPY:",0x00
                                 _DRV_SD_LOG_STR_CSD_PERM_WRITE_PROTECT:
000ec0 5020
000ec1 5245
000ec2 5f4d
000ec3 5257
000ec4 5449
000ec5 5f45
000ec6 5250
000ec7 544f
000ec8 4345
000ec9 3a54
C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc(91): warning: .cseg .db misalignment - padding zero byte
C:\repos\w5277c\core5277\examples\5277_io_gayeway\SDcard\main.asm(40): 'C:\repos\w5277c\core5277\./core/drivers/sd/sd_log_csd.inc' included form here
000eca 0000                      	.db " PERM_WRITE_PROTECT:",0x00
                                 _DRV_SD_LOG_STR_CSD_TMP_WRITE_PROTECT:
000ecb 5420
000ecc 504d
000ecd 575f
000ece 4952
000ecf 4554
000ed0 505f
000ed1 4f52
000ed2 4554
000ed3 5443
000ed4 003a                      	.db " TMP_WRITE_PROTECT:",0x00
                                 _DRV_SD_LOG_STR_CSD_FILE_FORMAT:
000ed5 4620
000ed6 4c49
000ed7 5f45
000ed8 4f46
000ed9 4d52
000eda 5441
000edb 003a                      	.db " FILE_FORMAT:",0x00
                                 _DRV_SD_LOG_STR_CSD_FILE_FORMATS:
000edc 4820
000edd 7261
000ede 2064
000edf 6964
000ee0 6b73
000ee1 6c2d
000ee2 6b69
000ee3 2065
000ee4 5346
000ee5 7720
000ee6 7469
000ee7 2068
000ee8 5450
000ee9 4400
000eea 534f
000eeb 4620
000eec 5441
000eed 5500
000eee 696e
000eef 6576
000ef0 7372
000ef1 6c61
000ef2 4f00
000ef3 6874
000ef4 7265
000ef5 0073                      	.db " Hard disk-like FS with PT",0x00,"DOS FAT",0x00,"Universal",0x00,"Others",0x00
                                 _DRV_SD_LOG_STR_CSD_RSV:
000ef6 7372
000ef7 0076                      	.db "rsv",0x00
                                 
                                 ;--------------------------------------------------------
                                 DRV_SD_LOG_CSD:
                                 ;Логирование CSD
                                 ;IN: X-адрес на блок данных
                                 ;--------------------------------------------------------
000ef8 93ff
000ef9 93ef                      	PUSH_Z
000efa 93df
000efb 93cf                      	PUSH_Y
000efc 932f                      	PUSH TEMP
000efd 930f                      	PUSH TEMP_L
000efe 931f                      	PUSH TEMP_H
000eff 938f                      	PUSH ACCUM
                                 
000f00 01ed                      	MOVW YL,XL
                                 
000f01 e8fd
000f02 e4e5                      	LDI_Z _DRV_SD_LOG_STR_CSD|0x8000
000f03 940e 0200                 	MCALL C5_OUT_STR
                                 
000f05 8108                      	LDD TEMP_L,Y+0x00
000f06 e8fd
000f07 e4ed                      	LDI_Z _DRV_SD_LOG_STR_CSD_STRUCTURE|0x8000
000f08 940e 0200                 	MCALL C5_OUT_STR
000f0a 2f20                      	MOV TEMP,TEMP_L
000f0b 9522                      	SWAP TEMP
000f0c 9526                      	LSR TEMP
000f0d 9526                      	LSR TEMP
000f0e 940e 0227                 	MCALL C5_OUT_BYTE
000f10 940e 023f                 	MCALL C5_OUT_CR
                                 	;CSD ver
000f12 2f82                      	MOV ACCUM,TEMP
                                 
000f13 8109                      	LDD TEMP_L,Y+0x01
000f14 e8fd
000f15 e5e5                      	LDI_Z _DRV_SD_LOG_STR_CSD_TAAC|0x8000
000f16 940e 0200                 	MCALL C5_OUT_STR
000f18 2f20                      	MOV TEMP,TEMP_L
000f19 0f22                      	LSL TEMP
000f1a 9522                      	SWAP TEMP
000f1b 702f                      	ANDI TEMP,0x0f
000f1c e8fd
000f1d e6e2                      	LDI_Z _DRV_SD_LOG_STR_CSD_VALUES|0x8000
000f1e 940e 09d9                 	MCALL C5_OUT_STR_EL
000f20 e728                      	LDI TEMP,'x'
000f21 940e 01cd                 	MCALL C5_OUT_CHAR
000f23 2f20                      	MOV TEMP,TEMP_L
000f24 7027                      	ANDI TEMP,0x07
000f25 e8fd
000f26 e8e2                      	LDI_Z _DRV_SD_LOG_STR_CSD_TIMES|0x8000
000f27 940e 09d9                 	MCALL C5_OUT_STR_EL
000f29 940e 023f                 	MCALL C5_OUT_CR
                                 
000f2b 812a                      	LDD TEMP,Y+0x02
000f2c e8fd
000f2d e5e9                      	LDI_Z _DRV_SD_LOG_STR_CSD_NSAC|0x8000
000f2e 940e 0200                 	MCALL C5_OUT_STR
000f30 940e 0cf7                 	MCALL C5_OUT_NUM
000f32 940e 023f                 	MCALL C5_OUT_CR
                                 
000f34 810b                      	LDD TEMP_L,Y+0x03
000f35 e8fd
000f36 e9e6                      	LDI_Z _DRV_SD_LOG_STR_CSD_TRAN_SPEED|0x8000
000f37 940e 0200                 	MCALL C5_OUT_STR
000f39 2f20                      	MOV TEMP,TEMP_L
000f3a 0f22                      	LSL TEMP
000f3b 9522                      	SWAP TEMP
000f3c 702f                      	ANDI TEMP,0x0f
000f3d e8fd
000f3e e6e2                      	LDI_Z _DRV_SD_LOG_STR_CSD_VALUES|0x8000
000f3f 940e 09d9                 	MCALL C5_OUT_STR_EL
000f41 e728                      	LDI TEMP,'x'
000f42 940e 01cd                 	MCALL C5_OUT_CHAR
000f44 2f20                      	MOV TEMP,TEMP_L
000f45 7027                      	ANDI TEMP,0x07
000f46 e8fd
000f47 e9ed                      	LDI_Z _DRV_SD_LOG_STR_CSD_RATES|0x8000
000f48 940e 09d9                 	MCALL C5_OUT_STR_EL
000f4a 940e 023f                 	MCALL C5_OUT_CR
                                 
000f4c 811c                      	LDD TEMP_H,Y+0x04
000f4d 810d                      	LDD TEMP_L,Y+0x05
000f4e e8fd
000f4f ebe8                      	LDI_Z _DRV_SD_LOG_STR_CSD_CCC|0x8000
000f50 940e 0200                 	MCALL C5_OUT_STR
000f52 9502                      	SWAP TEMP_L
000f53 9512                      	SWAP TEMP_H
000f54 700f                      	ANDI TEMP_L,0x0f
000f55 2f21                      	MOV TEMP,TEMP_H
000f56 701f                      	ANDI TEMP_H,0x0f
000f57 7f20                      	ANDI TEMP,0xf0
000f58 2b02                      	OR TEMP_L,TEMP
                                 
000f59 e020                      	LDI TEMP,0x00
000f5a e8fd
000f5b ebec                      	LDI_Z _DRV_SD_LOG_STR_CSD_CLASS|0x8000
                                 _DRV_SD_LOG_CSD__CLASS_LOOP:
000f5c 9516                      	LSR TEMP_H
000f5d 9507                      	ROR TEMP_L
000f5e f430                      	BRCC PC+0x01+(3*_MCALL_SIZE)
000f5f 940e 0200                 	MCALL C5_OUT_STR
000f61 940e 0cf7                 	MCALL C5_OUT_NUM
000f63 940e 023f                 	MCALL C5_OUT_CR
000f65 9523                      	INC TEMP
000f66 302c                      	CPI TEMP,0x0c
000f67 f7a1                      	BRNE _DRV_SD_LOG_CSD__CLASS_LOOP
                                 
000f68 e8fd
000f69 ece1                      	LDI_Z _DRV_SD_LOG_STR_CSD_READ_BL_LEN|0x8000
000f6a 940e 0200                 	MCALL C5_OUT_STR
000f6c 812d                      	LDD TEMP,Y+0x05
000f6d 702f                      	ANDI TEMP,0x0f
000f6e e8fd
000f6f ece8                      	LDI_Z _DRV_SD_LOG_STR_CSD_LENS|0x8000
000f70 940e 09d9                 	MCALL C5_OUT_STR_EL
000f72 940e 023f                 	MCALL C5_OUT_CR
                                 
000f74 e8fd
000f75 efe2                      	LDI_Z _DRV_SD_LOG_STR_CSD_READ_BL_PARTIAL|0x8000
000f76 940e 0200                 	MCALL C5_OUT_STR
000f78 810e                      	LDD TEMP_L,Y+0x06
000f79 e020                      	LDI TEMP,0x00
000f7a fd07                      	SBRC TEMP_L,0x07
000f7b e021                      	LDI TEMP,0x01
000f7c 940e 0cf7                 	MCALL C5_OUT_NUM
000f7e 940e 023f                 	MCALL C5_OUT_CR
                                 
000f80 e8fd
000f81 efeb                      	LDI_Z _DRV_SD_LOG_STR_CSD_WRITE_BLK_MISALIGN|0x8000
000f82 940e 0200                 	MCALL C5_OUT_STR
000f84 e020                      	LDI TEMP,0x00
000f85 fd06                      	SBRC TEMP_L,0x06
000f86 e021                      	LDI TEMP,0x01
000f87 940e 0cf7                 	MCALL C5_OUT_NUM
000f89 940e 023f                 	MCALL C5_OUT_CR
                                 
000f8b e8fe
000f8c e0e6                      	LDI_Z _DRV_SD_LOG_STR_CSD_READ_BLK_MISALIGN|0x8000
000f8d 940e 0200                 	MCALL C5_OUT_STR
000f8f e020                      	LDI TEMP,0x00
000f90 fd05                      	SBRC TEMP_L,0x05
000f91 e021                      	LDI TEMP,0x01
000f92 940e 0cf7                 	MCALL C5_OUT_NUM
000f94 940e 023f                 	MCALL C5_OUT_CR
                                 
000f96 e8fe
000f97 e1e0                      	LDI_Z _DRV_SD_LOG_STR_CSD_DSR_IMP|0x8000
000f98 940e 0200                 	MCALL C5_OUT_STR
000f9a e020                      	LDI TEMP,0x00
000f9b fd04                      	SBRC TEMP_L,0x04
000f9c e021                      	LDI TEMP,0x01
000f9d 940e 0cf7                 	MCALL C5_OUT_NUM
000f9f 940e 023f                 	MCALL C5_OUT_CR
                                 
000fa1 3080                      	CPI ACCUM,0x00
000fa2 f419                      	BRNE PC+0x04
000fa3 940e 105b                 	MCALL _DRV_SD_LOG_CSD_PART_V1
000fa5 c007                      	RJMP PC+0x04+(2*_MCALL_SIZE)
000fa6 3081                      	CPI ACCUM,0x01
000fa7 f419                      	BRNE PC+0x01+_MCALL_SIZE+0x01
000fa8 940e 10bd                 	MCALL _DRV_SD_LOG_CSD_PART_V2
000faa c002                      	RJMP PC+0x01+_MCALL_SIZE
000fab 940e 10cb                 	MCALL _DRV_SD_LOG_CSD_PART_V3
                                 
000fad e8fe
000fae e7e0                      	LDI_Z _DRV_SD_LOG_STR_CSD_ERASE_BLR_EN|0x8000
000faf 940e 0200                 	MCALL C5_OUT_STR
000fb1 850a                      	LDD TEMP_L,Y+0x0a
000fb2 e020                      	LDI TEMP,0x00
000fb3 fd06                      	SBRC TEMP_L,0x06
000fb4 e021                      	LDI TEMP,0x01
000fb5 940e 0cf7                 	MCALL C5_OUT_NUM
000fb7 940e 023f                 	MCALL C5_OUT_CR
                                 
000fb9 e8fe
000fba e7e8                      	LDI_Z _DRV_SD_LOG_STR_CSD_SECTOR_SIZE|0x8000
000fbb 940e 0200                 	MCALL C5_OUT_STR
000fbd 852a                      	LDD TEMP,Y+0x0a
000fbe 850b                      	LDD TEMP_L,Y+0x0b
000fbf 0f00                      	LSL TEMP_L
000fc0 1f22                      	ROL TEMP
000fc1 732f                      	ANDI TEMP,0x3f
000fc2 9523                      	INC TEMP
000fc3 940e 0cf7                 	MCALL C5_OUT_NUM
000fc5 940e 023f                 	MCALL C5_OUT_CR
                                 
000fc7 e8fe
000fc8 e8e5                      	LDI_Z _DRV_SD_LOG_STR_CSD_WP_GRP_SIZE|0x8000
000fc9 940e 0200                 	MCALL C5_OUT_STR
000fcb 852b                      	LDD TEMP,Y+0x0b
000fcc 772f                      	ANDI TEMP,0x7f
000fcd 9523                      	INC TEMP
000fce 940e 0cf7                 	MCALL C5_OUT_NUM
000fd0 940e 023f                 	MCALL C5_OUT_CR
                                 
000fd2 e8fe
000fd3 e9e2                      	LDI_Z _DRV_SD_LOG_STR_CSD_WP_GRP_ENABLE|0x8000
000fd4 940e 0200                 	MCALL C5_OUT_STR
000fd6 850c                      	LDD TEMP_L,Y+0x0c
000fd7 e020                      	LDI TEMP,0x00
000fd8 fd07                      	SBRC TEMP_L,0x07
000fd9 e021                      	LDI TEMP,0x01
000fda 940e 0cf7                 	MCALL C5_OUT_NUM
000fdc 940e 023f                 	MCALL C5_OUT_CR
                                 
000fde e8fe
000fdf e9ea                      	LDI_Z _DRV_SD_LOG_STR_CSD_R2W_FACTOR|0x8000
000fe0 940e 0200                 	MCALL C5_OUT_STR
000fe2 852c                      	LDD TEMP,Y+0x0c
000fe3 9526                      	LSR TEMP
000fe4 9526                      	LSR TEMP
000fe5 7027                      	ANDI TEMP,0x07
000fe6 3026                      	CPI TEMP,0x06
000fe7 f028                      	BRCS PC+0x03+_MCALL_SIZE+0x01
000fe8 e8fe
000fe9 efe6                      	LDI_Z _DRV_SD_LOG_STR_CSD_RSV|0x8000
000fea 940e 0200                 	MCALL C5_OUT_STR
000fec c004                      	RJMP PC+0x01+(2*_MCALL_SIZE)
000fed 940e 00a3                 	MCALL BITNUM_TO_NUM
000fef 940e 0cf7                 	MCALL C5_OUT_NUM
000ff1 940e 023f                 	MCALL C5_OUT_CR
                                 
000ff3 e8fe
000ff4 eae1                      	LDI_Z _DRV_SD_LOG_STR_CSD_WRITE_BL_LEN|0x8000
000ff5 940e 0200                 	MCALL C5_OUT_STR
000ff7 852c                      	LDD TEMP,Y+0x0c
000ff8 850d                      	LDD TEMP_L,Y+0x0d
000ff9 0f00                      	LSL TEMP_L
000ffa 1f22                      	ROL TEMP
000ffb 0f00                      	LSL TEMP_L
000ffc 1f22                      	ROL TEMP
000ffd 702f                      	ANDI TEMP,0x0f
000ffe e8fd
000fff ece8                      	LDI_Z _DRV_SD_LOG_STR_CSD_LENS|0x8000
001000 940e 09d9                 	MCALL C5_OUT_STR_EL
001002 940e 023f                 	MCALL C5_OUT_CR
                                 
001004 e8fe
001005 eae9                      	LDI_Z _DRV_SD_LOG_STR_CSD_WRITE_BL_PARTIAL|0x8000
001006 940e 0200                 	MCALL C5_OUT_STR
001008 e020                      	LDI TEMP,0x00
001009 fd07                      	SBRC TEMP_L,0x07
00100a e021                      	LDI TEMP,0x01
00100b 940e 0cf7                 	MCALL C5_OUT_NUM
00100d 940e 023f                 	MCALL C5_OUT_CR
                                 
00100f e8fe
001010 ebe3                      	LDI_Z _DRV_SD_LOG_STR_CSD_FILE_FORMAT_GRP|0x8000
001011 940e 0200                 	MCALL C5_OUT_STR
001013 850e                      	LDD TEMP_L,Y+0x0e
001014 e020                      	LDI TEMP,0x00
001015 fd07                      	SBRC TEMP_L,0x07
001016 e021                      	LDI TEMP,0x01
001017 940e 0cf7                 	MCALL C5_OUT_NUM
001019 940e 023f                 	MCALL C5_OUT_CR
00101b 2f12                      	MOV TEMP_H,TEMP
                                 
00101c e8fe
00101d ebec                      	LDI_Z _DRV_SD_LOG_STR_CSD_COPY|0x8000
00101e 940e 0200                 	MCALL C5_OUT_STR
001020 e020                      	LDI TEMP,0x00
001021 fd06                      	SBRC TEMP_L,0x06
001022 e021                      	LDI TEMP,0x01
001023 940e 0cf7                 	MCALL C5_OUT_NUM
001025 940e 023f                 	MCALL C5_OUT_CR
                                 
001027 e8fe
001028 ece0                      	LDI_Z _DRV_SD_LOG_STR_CSD_PERM_WRITE_PROTECT|0x8000
001029 940e 0200                 	MCALL C5_OUT_STR
00102b e020                      	LDI TEMP,0x00
00102c fd05                      	SBRC TEMP_L,0x05
00102d e021                      	LDI TEMP,0x01
00102e 940e 0cf7                 	MCALL C5_OUT_NUM
001030 940e 023f                 	MCALL C5_OUT_CR
                                 
001032 e8fe
001033 eceb                      	LDI_Z _DRV_SD_LOG_STR_CSD_TMP_WRITE_PROTECT|0x8000
001034 940e 0200                 	MCALL C5_OUT_STR
001036 e020                      	LDI TEMP,0x00
001037 fd04                      	SBRC TEMP_L,0x04
001038 e021                      	LDI TEMP,0x01
001039 940e 0cf7                 	MCALL C5_OUT_NUM
00103b 940e 023f                 	MCALL C5_OUT_CR
                                 
00103d e8fe
00103e ede5                      	LDI_Z _DRV_SD_LOG_STR_CSD_FILE_FORMAT|0x8000
00103f 940e 0200                 	MCALL C5_OUT_STR
001041 3011                      	CPI TEMP_H,0x01
001042 f429                      	BRNE _DRV_SD_LOG_CSD__FILE_FORMAT_NO_RSV
001043 e8fe
001044 efe6                      	LDI_Z _DRV_SD_LOG_STR_CSD_RSV|0x8000
001045 940e 0200                 	MCALL C5_OUT_STR
001047 c008                      	RJMP _DRV_SD_LOG_CSD__FILE_FORMAT_DONE
                                 _DRV_SD_LOG_CSD__FILE_FORMAT_NO_RSV:
001048 9506                      	LSR TEMP_L
001049 9506                      	LSR TEMP_L
00104a 7003                      	ANDI TEMP_L,0x03
00104b 2f20                      	MOV TEMP,TEMP_L
00104c e8fe
00104d edec                      	LDI_Z _DRV_SD_LOG_STR_CSD_FILE_FORMATS|0x8000
00104e 940e 09d9                 	MCALL C5_OUT_STR_EL
                                 _DRV_SD_LOG_CSD__FILE_FORMAT_DONE:
001050 940e 023f                 	MCALL C5_OUT_CR
                                 
001052 918f                      	POP ACCUM
001053 911f                      	POP TEMP_H
001054 910f                      	POP TEMP_L
001055 912f                      	POP TEMP
001056 91cf
001057 91df                      	POP_Y
001058 91ef
001059 91ff                      	POP_Z
00105a 9508                      	RET
                                 
                                 
                                 _DRV_SD_LOG_CSD_PART_V1:
00105b e8fe
00105c e1e8                      	LDI_Z _DRV_SD_LOG_STR_CSD_C_SIZE|0x8000
00105d 940e 0200                 	MCALL C5_OUT_STR
00105f 811e                      	LDD TEMP_H,Y+0x06
001060 0f11                      	LSL TEMP_H
001061 0f11                      	LSL TEMP_H
001062 701c                      	ANDI TEMP_H,0x0c
001063 810f                      	LDD TEMP_L,Y+0x07
001064 8528                      	LDD TEMP,Y+0x08
001065 0f22                      	LSL TEMP
001066 1f00                      	ROL TEMP_L
001067 1f11                      	ROL TEMP_H
001068 0f22                      	LSL TEMP
001069 1f00                      	ROL TEMP_L
00106a 1f11                      	ROL TEMP_H
00106b 701f                      	ANDI TEMP_H,0x0f
00106c 940e 0cbb                 	MCALL C5_OUT_NUM16
00106e 940e 023f                 	MCALL C5_OUT_CR
                                 
001070 e8fe
001071 e1ed                      	LDI_Z _DRV_SD_LOG_STR_CSD_VDD_R_CURR_MIN|0x8000
001072 940e 0200                 	MCALL C5_OUT_STR
001074 8528                      	LDD TEMP,Y+0x08
001075 9526                      	LSR TEMP
001076 9526                      	LSR TEMP
001077 9526                      	LSR TEMP
001078 7027                      	ANDI TEMP,0x07
001079 e8fe
00107a e2e6                      	LDI_Z _DRV_SD_LOG_STR_CSD_CURRENTS_MIN|0x8000
00107b 940e 09d9                 	MCALL C5_OUT_STR_EL
00107d 940e 023f                 	MCALL C5_OUT_CR
                                 
00107f e8fe
001080 e3ea                      	LDI_Z _DRV_SD_LOG_STR_CSD_VDD_R_CURR_MAX|0x8000
001081 940e 0200                 	MCALL C5_OUT_STR
001083 8528                      	LDD TEMP,Y+0x08
001084 7027                      	ANDI TEMP,0x07
001085 e8fe
001086 e4e3                      	LDI_Z _DRV_SD_LOG_STR_CSD_CURRENTS_MAX|0x8000
001087 940e 09d9                 	MCALL C5_OUT_STR_EL
001089 940e 023f                 	MCALL C5_OUT_CR
                                 
00108b e8fe
00108c e5e7                      	LDI_Z _DRV_SD_LOG_STR_CSD_VDD_W_CURR_MIN|0x8000
00108d 940e 0200                 	MCALL C5_OUT_STR
00108f 8529                      	LDD TEMP,Y+0x09
001090 9522                      	SWAP TEMP
001091 9526                      	LSR TEMP
001092 7027                      	ANDI TEMP,0x07
001093 e8fe
001094 e2e6                      	LDI_Z _DRV_SD_LOG_STR_CSD_CURRENTS_MIN|0x8000
001095 940e 09d9                 	MCALL C5_OUT_STR_EL
001097 940e 023f                 	MCALL C5_OUT_CR
                                 
001099 e8fe
00109a e6e0                      	LDI_Z _DRV_SD_LOG_STR_CSD_VDD_W_CURR_MAX|0x8000
00109b 940e 0200                 	MCALL C5_OUT_STR
00109d 8529                      	LDD TEMP,Y+0x09
00109e 9526                      	LSR TEMP
00109f 9526                      	LSR TEMP
0010a0 7027                      	ANDI TEMP,0x07
0010a1 e8fe
0010a2 e4e3                      	LDI_Z _DRV_SD_LOG_STR_CSD_CURRENTS_MAX|0x8000
0010a3 940e 09d9                 	MCALL C5_OUT_STR_EL
0010a5 940e 023f                 	MCALL C5_OUT_CR
                                 
0010a7 e8fe
0010a8 e6e9                      	LDI_Z _DRV_SD_LOG_STR_CSD_C_SIZE_MULT|0x8000
0010a9 940e 0200                 	MCALL C5_OUT_STR
0010ab 8529                      	LDD TEMP,Y+0x09
0010ac 850a                      	LDD TEMP_L,Y+0x0a
0010ad 0f00                      	LSL TEMP_L
0010ae 1f22                      	ROL TEMP
0010af 7027                      	ANDI TEMP,0x07
0010b0 940e 00a3                 	MCALL BITNUM_TO_NUM
0010b2 2711                      	CLR TEMP_H
0010b3 2f02                      	MOV TEMP_L,TEMP
0010b4 0f00                      	LSL TEMP_L
0010b5 1f11                      	ROL TEMP_H
0010b6 0f00                      	LSL TEMP_L
0010b7 1f11                      	ROL TEMP_H
0010b8 940e 0cbb                 	MCALL C5_OUT_NUM16
0010ba 940e 023f                 	MCALL C5_OUT_CR
0010bc 9508                      	RET
                                 
                                 _DRV_SD_LOG_CSD_PART_V2:
0010bd e8fe
0010be e1e8                      	LDI_Z _DRV_SD_LOG_STR_CSD_C_SIZE|0x8000
0010bf 940e 0200                 	MCALL C5_OUT_STR
0010c1 e040                      	LDI TEMP_EH,0x00
0010c2 813f                      	LDD TEMP_EL,Y+0x07
0010c3 733f                      	ANDI TEMP_EL,0x3f
0010c4 8518                      	LDD TEMP_H,Y+0x08
0010c5 8509                      	LDD TEMP_L,Y+0x09
0010c6 940e 0c63                 	MCALL C5_OUT_NUM32
0010c8 940e 023f                 	MCALL C5_OUT_CR
0010ca 9508                      	RET
                                 
                                 _DRV_SD_LOG_CSD_PART_V3:
0010cb e8fe
0010cc e1e8                      	LDI_Z _DRV_SD_LOG_STR_CSD_C_SIZE|0x8000
0010cd 940e 0200                 	MCALL C5_OUT_STR
0010cf 814e                      	LDD TEMP_EH,Y+0x06
0010d0 704f                      	ANDI TEMP_EH,0x0f
0010d1 813f                      	LDD TEMP_EL,Y+0x07
0010d2 8518                      	LDD TEMP_H,Y+0x08
0010d3 8509                      	LDD TEMP_L,Y+0x09
0010d4 940e 0c63                 	MCALL C5_OUT_NUM32
0010d6 940e 023f                 	MCALL C5_OUT_CR
0010d8 9508                      	RET
                                 .endif
                                 .endif
                                 
                                 	.INCLUDE "./core/drivers/sd_spi.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;Драйвер карты памяти (режим SPI)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;TODO переписать регистры ACCUM-тип операции, FLAGS-результат
                                 ;TODO C5_RAM_OFFSET Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 .ifdef DEF__C5_DRV_SD_SPI
                                 .else
                                 .set DEF__C5_DRV_SD_SPI = 1
C:\repos\w5277c\core5277\./core/drivers/sd_spi.inc(15): Included driver SD Card SPI mode v0.1
                                 .message "Included driver SD Card SPI mode v0.1"
                                 
                                 .include	"./core/ram/ram_offset.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			+Z,+Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 
                                 .ifdef DEF_C5_RAM_OFFSET
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./core/ram/ram_realloc.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;28.05.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;03.07.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_RAM_REALLOC
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./core/drivers/sd/sd_reset.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;10.02.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_RESET
                                 .else
                                 .set DEF_DRIVER_SD_RESET = 1
                                 
                                 .include	"./core/drivers/sd/sd_get_r1.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_R1
                                 .else
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_OP_RESET:
                                 ;--------------------------------------------------------
                                 ;Получить CID
                                 ;IN: X-адрес на выделенную память
                                 ;OUT: ACCUM-R1 ответ
                                 ;Y-адрес на буфер
                                 ;--------------------------------------------------------
0010d9 932f                      	PUSH TEMP
0010da 930f                      	PUSH TEMP_L
                                 
0010db 982a                      	CBI PORTB,SS & 0x0f
                                 
0010dc e020                      	LDI TEMP,_DRV_SD_CMD0
0010dd 93bf
0010de 93af                      	PUSH_X
0010df 932d                      	ST X+,TEMP
0010e0 e020                      	LDI TEMP,0x00
0010e1 932d                      	ST X+,TEMP
0010e2 e020                      	LDI TEMP,0x00
0010e3 932d                      	ST X+,TEMP
0010e4 e020                      	LDI TEMP,0x00
0010e5 932d                      	ST X+,TEMP
0010e6 e020                      	LDI TEMP,0x00
0010e7 932d                      	ST X+,TEMP
0010e8 91af
0010e9 91bf                      	POP_X
0010ea e005                      	LDI TEMP_L,0x05
0010eb 940e 1205                 	MCALL _DRV_SD__SEND_CMD
0010ed 940e 0abf                 	MCALL _DRV_SD_GET_R1
                                 
0010ef 9a2a                      	SBI PORTB,SS & 0x0f
                                 
0010f0 910f                      	POP TEMP_L
0010f1 912f                      	POP TEMP
0010f2 9508                      	RET
                                 .endif
                                 .include	"./core/drivers/sd/sd_get_status.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_STATUS
                                 .else
                                 .set DEF_DRIVER_SD_GET_STATUS = 1
                                 
                                 .include	"./core/drivers/sd/sd_get_r2.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_R2
                                 .else
                                 .set DEF_DRIVER_SD_GET_R2 = 1
                                 
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_GET_R2:
                                 ;--------------------------------------------------------
                                 ;Прием R2
                                 ;IN: X-адрес на буфер
                                 ;OUT: TEMP_H,TEMP_L
                                 ;--------------------------------------------------------
0010f3 932f                      	PUSH TEMP
                                 
0010f4 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
0010f6 2f12                      	MOV TEMP_H,TEMP
0010f7 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
0010f9 2f02                      	MOV TEMP_L,TEMP
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
0010fa 912f                      	POP TEMP
0010fb 9508                      	RET
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_OP_GET_STATUS:
                                 ;--------------------------------------------------------
                                 ;Получить состояние карты
                                 ;IN: X-адрес на выделенную память
                                 ;OUT: TEMP_H/L-R2 ответ
                                 ;--------------------------------------------------------
0010fc 938f                      	PUSH ACCUM
0010fd 932f                      	PUSH TEMP
0010fe 937f                      	PUSH TRY_CNTR
                                 
0010ff e073                      	LDI TRY_CNTR,0x03
                                 _DRV_SD_OP_GET_STATUS__LOOP:
001100 e02d                      	LDI TEMP,_DRV_SD_CMD13
001101 93bf
001102 93af                      	PUSH_X
001103 932d                      	ST X+,TEMP
001104 2722                      	CLR TEMP
001105 932d                      	ST X+,TEMP
001106 932d                      	ST X+,TEMP
001107 932d                      	ST X+,TEMP
001108 932d                      	ST x+,TEMP
001109 91af
00110a 91bf                      	POP_X
00110b e005                      	LDI TEMP_L,0x05
00110c 940e 1205                 	MCALL _DRV_SD__SEND_CMD
00110e 940e 10f3                 	MCALL _DRV_SD_GET_R2
001110 ff17                      	SBRS TEMP_H,0x07
001111 c002                      	RJMP _DRV_SD_OP_GET_STATUS__DONE
001112 957a                      	DEC TRY_CNTR
001113 f761                      	BRNE _DRV_SD_OP_GET_STATUS__LOOP
                                 _DRV_SD_OP_GET_STATUS__DONE:
                                 
001114 917f                      	POP TRY_CNTR
001115 912f                      	POP TEMP
001116 918f                      	POP ACCUM
001117 9508                      	RET
                                 .endif
                                 .include	"./core/drivers/sd/sd_get_r1.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_R1
                                 .else
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 .endif
                                 .include	"./core/drivers/sd/sd_get_r3r7.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;18.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_DRIVER_SD_GET_R3R7
                                 .else
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 .endif
                                 .include	"./core/time32_mark.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;02.02.2021  w5277c@gmail.com			Начало
                                 ;16.09.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_TIME32_MARK
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./core/time32_delta.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;02.02.2021  w5277c@gmail.com			Начало
                                 ;16.09.2021	w5277c@gmail.com			Z->Y
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_TIME32_DELTA
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 .include	"./core/wait_2ms.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;07.10.2019	w5277c@gmail.com			Начало
                                 ;09.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;22.01.2020	w5277c@gmail.com			Учет CORE_FREQ
                                 ;31.05.2021	w5277c@gmail.com			Реализация на таймере
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_C5_WAIT_2MS
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .if TS_MODE == TS_MODE_TIME
                                 .else
                                 .endif
                                 .endif
                                 .include	"./conv/crc7_730.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;19.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_CRC7_730
                                 .else
                                 .set DEF_CRC7_730 = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./conv/crc7_730.inc(11): included CRC7_730
                                 .message "included CRC7_730"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 CRC7_730:
                                 ;--------------------------------------------------------
                                 ;Подсчет CRC7 (x^7 + x^3 + x^0)
                                 ;IN: TEMP - байт, ACCUM - сумма
                                 ;OUT: ACCUM - сумма
                                 ;--------------------------------------------------------
001118 930f                      	PUSH TEMP_L
001119 935f                      	PUSH LOOP_CNTR
                                 
00111a e102                      	LDI TEMP_L,0x12
00111b 2782                      	EOR ACCUM,TEMP
00111c e058                      	LDI LOOP_CNTR,0x08
                                 _CRC7_730__LOOP:
00111d 0f88                      	LSL ACCUM
00111e f408                      	BRCC PC+0x02
00111f 2780                      	EOR ACCUM,TEMP_L
001120 955a                      	DEC LOOP_CNTR
001121 f7d9                      	BRNE _CRC7_730__LOOP
                                 
001122 915f                      	POP LOOP_CNTR
001123 910f                      	POP TEMP_L
001124 9508                      	RET
                                 .endif
                                 .include	"./conv/crc8_block.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;19.01.2021  w5277c@gmail.com			Начало
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_CRC8_BLOCK
                                 .else
                                 .set DEF_CRC8_BLOCK = 1
                                 
                                 .if REPORT_INCLUDES == 0x01
C:\repos\w5277c\core5277\./conv/crc8_block.inc(11): included CRC8_BLOCK
                                 .message "included CRC8_BLOCK"
                                 .endif
                                 
                                 ;--------------------------------------------------------
                                 CRC8_BLOCK:
                                 ;--------------------------------------------------------
                                 ;Подсчет блока CRC(8 бит)
                                 ;IN: X-адрес начала блока, LOOP_CNTR - длина
                                 ;Z-адрес процедуры для вычисления байта
                                 ;ACCUM-начальная сумма
                                 ;OUT: ACCUM-сумма
                                 ;--------------------------------------------------------
001125 93bf
001126 93af                      	PUSH_X
001127 935f                      	PUSH LOOP_CNTR
001128 932f                      	PUSH TEMP
                                 
                                 _CRC8_BLOCK__LOOP:
001129 912d                      	LD TEMP,X+
00112a 9509                      	ICALL
00112b 955a                      	DEC LOOP_CNTR
00112c f7e1                      	BRNE _CRC8_BLOCK__LOOP
                                 
00112d 912f                      	POP TEMP
00112e 915f                      	POP LOOP_CNTR
00112f 91af
001130 91bf                      	POP_X
001131 9508                      	RET
                                 .endif
                                 
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
                                 
                                 ;TODO перейти на внешнюю реализацию spi
                                 
                                 	;---OPERATIONS---
                                 	.EQU	DRV_SD_OP_RESET									= 0x00;Перевод SD в изначальное состояние
                                 	.EQU	DRV_SD_OP_INIT										= 0x01;Инициализация
                                 	.EQU	DRV_SD_OP_GET_OCR									= 0x02;Получить OCR
                                 	.EQU	DRV_SD_OP_GET_CSD									= 0x03;Получить CSD
                                 	.EQU	DRV_SD_OP_GET_CID									= 0x04;Получить CID
                                 	.EQU	DRV_SD_OP_READ_BLOCK								= 0x05;Считать блок
                                 	.EQU	DRV_SD_OP_READ_DUMMY_BLOCK						= 0x06;Фиктивное чтение блока
                                 	.EQU	DRV_SD_OP_WRITE_BLOCK							= 0x07;Записать блок
                                 	.EQU	DRV_SD_OP_WRITE_DUMMY_BLOCK					= 0x08;Фиктивная запись блока
                                 	.EQU	DRV_SD_OP_ERASE_BLOCKS							= 0x09;Очистка блоков
                                 	.EQU	DRV_SD_OP_GET_STATUS								= 0x0a;Чтение статуса карты
                                 	.EQU	DRV_SD_OP_GEN_CMD									= 0x0b;Чтение/запись данных контроллера?
                                 
                                 ;---CONSTANTS--------------------------------------------
                                 	.EQU	DRV_SD_VARS_SIZE									= 0x0a;Размер данных под переменные
                                 	;---OFFSETS---
                                 	.EQU	_DRV_SD_EXT_BUFFER_ADDR							= 0x00;2Б адрес внешнего буффера размером в 512Б
                                 	.EQU	_DRV_SD_VAR_BLOCK_SIZE							= 0x02;2Б размер блока для чтения/записи
                                 	.EQU	_DRV_SD_WRITE_CMD_BUFFER						= 0x04;6Б
                                 
                                 	.EQU	_DRV_SD_CMD0										= 0x00;Reset
                                 	.EQU	_DRV_SD_CMD8										= 0x08;Send interface condition
                                 	.EQU	_DRV_SD_CMD9										= 0x09;Read CSD
                                 	.EQU	_DRV_SD_CMD10										= 0x0a;Read CID
                                 	.EQU	_DRV_SD_CMD13										= 0x0d;Read status
                                 	.EQU	_DRV_SD_CMD17										= 0x11;Read single block
                                 	.EQU	_DRV_SD_CMD24										= 0x18;Write single block
                                 	.EQU	_DRV_SD_CMD32										= 0x20;First erase block
                                 	.EQU	_DRV_SD_CMD33										= 0x21;Last erase block
                                 	.EQU	_DRV_SD_CMD38										= 0x26;Erases all selected blocks
                                 	.EQU	_DRV_SD_CMD55										= 0x37;Exec application CMD
                                 	.EQU	_DRV_SD_CMD56										= 0x38;General command
                                 	.EQU	_DRV_SD_CMD58										= 0x3a;Read OCR
                                 	.EQU	_DRV_SD_ACMD41										= 0x29;Activate inicialization
                                 	;---DATA-RESPONSE-TOKEN---
                                 	.EQU	_DRV_SD_DR_TOKEN_ACCEPTED						= 0x05
                                 	.EQU	_DRV_SD_DR_TOKEN_CRC_ERROR						= 0x0b
                                 	.EQU	_DRV_SD_DR_TOKEN_WRITE_ERROR					= 0x0d
                                 
                                 	;---FLAGS---
                                 	.EQU	DRV_SD_FLAG_VER1									= 0x01;
                                 	.EQU	DRV_SD_FLAG_VER2SC								= 0x02;
                                 	.EQU	DRV_SD_FLAG_VER2HC								= 0x03;
                                 	;---
                                 
                                 ;--------------------------------------------------------
                                 DRV_SD_INIT:
                                 ;--------------------------------------------------------
                                 ;Инициализация драйвера
                                 ;IN: X-адрес на буффер в 512 байт
                                 ;--------------------------------------------------------
                                 	;Инициализируем порт CLCK
001132 982d                      	CBI PORTB,SCK & 0x0f
001133 9a25                      	SBI DDRB,SCK & 0x0f
                                 	;Инициализируем порт MOSI
001134 982b                      	CBI PORTB,MOSI & 0x0f
001135 9a23                      	SBI DDRB,MOSI & 0x0f
                                 	;Инициализируем порт MISO
001136 9a2c                      	SBI PORTB,MISO & 0x0f
001137 9824                      	CBI DDRB,MISO & 0x0f
                                 	;Инициализируем порт SS (чип отключен)
001138 9a2a                      	SBI PORTB,SS & 0x0f
001139 9a22                      	SBI DDRB,SS & 0x0f
                                 
                                 	;Выделяем память
00113a e08a                      	LDI ACCUM,DRV_SD_VARS_SIZE
00113b 940e 0851                 	MCALL C5_RAM_REALLOC
                                 
00113d 83b8                      	STD Y+_DRV_SD_EXT_BUFFER_ADDR+0x00,XH
00113e 83a9                      	STD Y+_DRV_SD_EXT_BUFFER_ADDR+0x01,XL
                                 
00113f 940e 05b8                 	MCALL C5_READY
                                 ;--------------------------------------------------------
                                 ;Основной код, коммуникация
                                 ;IN: FLAGS - тип операции
                                 ;OUT: ACCUM - R1 ответ или
                                 ;TEMP_H/L-R2 ответ
                                 ;--------------------------------------------------------
001141 93bf
001142 93af                      	PUSH_X
001143 93ff
001144 93ef                      	PUSH_Z
                                 
                                 	;Получаем адрес выделенной памяти
001145 940e 073b                 	MCALL C5_RAM_OFFSET
                                 
001147 81b8                      	LDD XH,Y+_DRV_SD_EXT_BUFFER_ADDR+0x00
001148 81a9                      	LDD XL,Y+_DRV_SD_EXT_BUFFER_ADDR+0x01
                                 
001149 3060                      	CPI FLAGS,DRV_SD_OP_RESET
00114a f419                      	BRNE PC+0x01+_MCALL_SIZE+0x01
00114b 940e 10d9                 	MCALL _DRV_SD_OP_RESET
00114d c015                      	RJMP _DRV_SD__END
00114e 3061                      	CPI FLAGS,DRV_SD_OP_INIT
00114f f419                      	BRNE PC+0x01+_MCALL_SIZE+0x01
001150 940e 1168                 	MCALL _DRV_SD_OP_INIT
001152 c010                      	RJMP _DRV_SD__END
001153 306a                      	CPI FLAGS,DRV_SD_OP_GET_STATUS
001154 f419                      	BRNE PC+0x01+_MCALL_SIZE+0x01
001155 940e 10fc                 	MCALL _DRV_SD_OP_GET_STATUS
001157 c00b                      	RJMP _DRV_SD__END
                                 .ifdef DEF_DRIVER_SD_GET_CSD
001158 3063                      	CPI FLAGS,DRV_SD_OP_GET_CSD
001159 f419                      	BRNE PC+0x01+_MCALL_SIZE+0x01
00115a 940e 0c1b                 	MCALL _DRV_SD_OP_GET_CSD
00115c c006                      	RJMP _DRV_SD__END
                                 .endif
                                 .ifdef DEF_DRIVER_SD_GET_CID
                                 .endif
                                 .ifdef DEF_DRIVER_SD_GET_OCR
00115d 3062                      	CPI FLAGS,DRV_SD_OP_GET_OCR
00115e f419                      	BRNE PC+0x01+_MCALL_SIZE+0x01
00115f 940e 09be                 	MCALL _DRV_SD_OP_GET_OCR
001161 c001                      	RJMP _DRV_SD__END
                                 .endif
                                 .ifdef DEF_DRIVER_SD_READ_BLOCK
                                 .endif
                                 .ifdef DEF_DRIVER_SD_READ_DUMMY_BLOCK
                                 .endif
                                 .ifdef DEF_DRIVER_SD_WRITE_BLOCK
                                 .endif
                                 .ifdef DEF_DRIVER_SD_WRITE_DUMMY_BLOCK
                                 .endif
                                 .ifdef DEF_DRIVER_SD_ERASE_BLOCKS
                                 .endif
                                 .ifdef DEF_DRIVER_SD_GEN_CMD
                                 .endif
                                 	;...
001162 ef8f                      	LDI ACCUM,0xff
                                 _DRV_SD__END:
                                 
001163 91ef
001164 91ff                      	POP_Z
001165 91af
001166 91bf                      	POP_X
001167 9508                      	RET
                                 
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_OP_INIT:
                                 ;--------------------------------------------------------
                                 ;Инициализация карты
                                 ;IN: Y-адрес на переменные, X-адрес на буфер
                                 ;OUT: ACCUM-R1 ответ(0x80-сбой инициализации),
                                 ;FLAGS-версия
                                 ;--------------------------------------------------------
001168 937f                      	PUSH TRY_CNTR
001169 932f                      	PUSH TEMP
00116a 935f                      	PUSH LOOP_CNTR
00116b 93df
00116c 93cf                      	PUSH_Y
                                 
00116d 2766                      	CLR FLAGS
                                 
00116e 982d                      	CBI PORTB,SCK & 0x0f
00116f 9a23                      	SBI DDRB,MOSI & 0x0f
001170 9a2a                      	SBI PORTB,SS & 0x0f
                                 
001171 9a2b                      	SBI PORTB,MOSI & 0x0f
001172 e550                      	LDI LOOP_CNTR,80
                                 _DRV_SD_OP_INIT__LOOP:
001173 9a2d                      	SBI PORTB,SCK & 0x0f
001174 0000                      	NOP
001175 0000                      	NOP
001176 0000                      	NOP
001177 982d                      	CBI PORTB,SCK &0x0f
001178 955a                      	DEC LOOP_CNTR
001179 f7c9                      	BRNE _DRV_SD_OP_INIT__LOOP
                                 
00117a 982a                      	CBI PORTB,SS & 0x0f
                                 
00117b 940e 10d9                 	MCALL _DRV_SD_OP_RESET
00117d 3081                      	CPI ACCUM,0x01
00117e f009                      	BREQ PC+0x02
00117f c05c                      	RJMP _DRV_SD_OP_INIT__END
001180 982a                      	CBI PORTB,SS & 0x0f
                                 
001181 e028                      	LDI TEMP,_DRV_SD_CMD8
001182 93bf
001183 93af                      	PUSH_X
001184 932d                      	ST X+,TEMP
001185 927d                      	ST X+,C0x00
001186 927d                      	ST X+,C0x00
001187 e021                      	LDI TEMP,0x01
001188 932d                      	ST X+,TEMP
001189 e522                      	LDI TEMP,0x52
00118a 932d                      	ST X+,TEMP
00118b 91af
00118c 91bf                      	POP_X
00118d e005                      	LDI TEMP_L,0x05
00118e 940e 1205                 	MCALL _DRV_SD__SEND_CMD
001190 940e 09ae                 	MCALL _DRV_SD_GET_R3R7
001192 9a2a                      	SBI PORTB,SS & 0x0f
001193 3085                      	CPI ACCUM,0x05
001194 f411                      	BRNE PC+0x03
001195 e061                      	LDI FLAGS,DRV_SD_FLAG_VER1
001196 c004                      	RJMP PC+0x05
001197 7f8e                      	ANDI ACCUM,0xfe
001198 3080                      	CPI ACCUM,0x00
001199 f009                      	BREQ PC+0x02
00119a c041                      	RJMP _DRV_SD_OP_INIT__END
                                 
00119b e372                      	LDI TRY_CNTR,0x32
                                 _DRV_SD_OP_INIT__WAIT:
00119c 982a                      	CBI PORTB,SS & 0x0f
00119d e229                      	LDI TEMP,_DRV_SD_ACMD41
00119e 93bf
00119f 93af                      	PUSH_X
0011a0 932d                      	ST X+,TEMP
0011a1 e420                      	LDI TEMP,0x40
0011a2 932d                      	ST X+,TEMP
0011a3 927d                      	ST X+,C0x00
0011a4 927d                      	ST X+,C0x00
0011a5 927d                      	ST X+,C0x00
0011a6 91af
0011a7 91bf                      	POP_X
0011a8 e005                      	LDI TEMP_L,0x05
0011a9 940e 11e3                 	MCALL _DRV_SD__SEND_ACMD
0011ab 3080                      	CPI ACCUM,0x00
0011ac f009                      	BREQ PC+0x02
0011ad c008                      	RJMP _DRV_SD_OP_INIT__ACMD41_ERR
0011ae 940e 0abf                 	MCALL _DRV_SD_GET_R1
0011b0 9a2a                      	SBI PORTB,SS & 0x0f
0011b1 3080                      	CPI ACCUM,0x00
0011b2 f081                      	BREQ _DRV_SD_OP_INIT_SD_READY
0011b3 3081                      	CPI ACCUM,0x01
0011b4 f009                      	BREQ PC+0x02
0011b5 c026                      	RJMP _DRV_SD_OP_INIT__END
                                 _DRV_SD_OP_INIT__ACMD41_ERR:
0011b6 931f                      	PUSH TEMP_H
0011b7 930f                      	PUSH TEMP_L
0011b8 e010                      	LDI TEMP_H,0x00
0011b9 e000                      	LDI TEMP_L,0x00
0011ba e322                      	LDI TEMP,0x32
0011bb 940e 00ad                 	MCALL C5_WAIT_2MS
0011bd 910f                      	POP TEMP_L
0011be 911f                      	POP TEMP_H
0011bf 957a                      	DEC TRY_CNTR
0011c0 f6d9                      	BRNE _DRV_SD_OP_INIT__WAIT
0011c1 e880                      	LDI ACCUM,0x80
0011c2 c019                      	RJMP _DRV_SD_OP_INIT__END
                                 _DRV_SD_OP_INIT_SD_READY:
0011c3 3061                      	CPI FLAGS,DRV_SD_FLAG_VER1
0011c4 f0b9                      	BREQ _DRV_SD_OP_INIT__END
                                 
0011c5 982a                      	CBI PORTB,SS & 0x0f
0011c6 e32a                      	LDI TEMP,_DRV_SD_CMD58
0011c7 93bf
0011c8 93af                      	PUSH_X
0011c9 932d                      	ST X+,TEMP
0011ca 927d                      	ST X+,C0x00
0011cb 927d                      	ST X+,C0x00
0011cc 927d                      	ST X+,C0x00
0011cd 927d                      	ST X+,C0x00
0011ce 91af
0011cf 91bf                      	POP_X
0011d0 e005                      	LDI TEMP_L,0x05
0011d1 940e 1205                 	MCALL _DRV_SD__SEND_CMD
0011d3 940e 09ae                 	MCALL _DRV_SD_GET_R3R7
0011d5 9a2a                      	SBI PORTB,SS & 0x0f
0011d6 912c                      	LD TEMP,X
0011d7 fd21                      	SBRC TEMP,0x01
0011d8 e062                      	LDI FLAGS,DRV_SD_FLAG_VER2SC
0011d9 ff21                      	SBRS TEMP,0x01
0011da e063                      	LDI FLAGS,DRV_SD_FLAG_VER2HC
0011db e080                      	LDI ACCUM,0x00
                                 _DRV_SD_OP_INIT__END:
0011dc 9a2a                      	SBI PORTB,SS & 0x0f
                                 
0011dd 91cf
0011de 91df                      	POP_Y
0011df 915f                      	POP LOOP_CNTR
0011e0 912f                      	POP TEMP
0011e1 917f                      	POP TRY_CNTR
0011e2 9508                      	RET
                                 
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD__SEND_ACMD:
                                 ;--------------------------------------------------------
                                 ;Отправка команды
                                 ;IN: X-адрес на команду, TEMP_L-длина команды (без CRC)
                                 ;OUT: ACCUM-R1 ответ
                                 ;--------------------------------------------------------
0011e3 930f                      	PUSH TEMP_L
0011e4 93df
0011e5 93cf                      	PUSH_Y
0011e6 93bf
0011e7 93af                      	PUSH_X
                                 
0011e8 9650                      	ADIW XL,0x10
0011e9 e327                      	LDI TEMP,_DRV_SD_CMD55
0011ea 93bf
0011eb 93af                      	PUSH_X
0011ec 932d                      	ST X+,TEMP
0011ed e020                      	LDI TEMP,0x00
0011ee 932d                      	ST X+,TEMP
0011ef e020                      	LDI TEMP,0x00
0011f0 932d                      	ST X+,TEMP
0011f1 e020                      	LDI TEMP,0x00
0011f2 932d                      	ST X+,TEMP
0011f3 e020                      	LDI TEMP,0x00
0011f4 932d                      	ST X+,TEMP
0011f5 91af
0011f6 91bf                      	POP_X
0011f7 e005                      	LDI TEMP_L,0x05
0011f8 940e 1205                 	MCALL _DRV_SD__SEND_CMD
0011fa 940e 0abf                 	MCALL _DRV_SD_GET_R1
                                 
0011fc 91af
0011fd 91bf                      	POP_X
0011fe 91cf
0011ff 91df                      	POP_Y
001200 910f                      	POP TEMP_L
                                 
001201 7f8e                      	ANDI ACCUM,0xfe
001202 3080                      	CPI ACCUM,0x00
001203 f009                      	BREQ _DRV_SD__SEND_CMD
001204 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD__SEND_CMD:
                                 ;--------------------------------------------------------
                                 ;Отправка команды
                                 ;IN: X-адрес на команду, TEMP_L-длина команды (без CRC)
                                 ;--------------------------------------------------------
001205 93bf
001206 93af                      	PUSH_X
001207 935f                      	PUSH LOOP_CNTR
001208 938f                      	PUSH ACCUM
001209 932f                      	PUSH TEMP
00120a 930f                      	PUSH TEMP_L
                                 
00120b 912c                      	LD TEMP,X
00120c 6420                      	ORI TEMP,0x40
00120d 932c                      	ST X,TEMP
                                 
00120e 93bf
00120f 93af                      	PUSH_X
001210 93ff
001211 93ef                      	PUSH_Z
001212 e1f1
001213 e1e8                      	LDI_Z CRC7_730
001214 2f50                      	MOV LOOP_CNTR,TEMP_L
001215 e080                      	LDI ACCUM,0x00
001216 940e 1125                 	MCALL CRC8_BLOCK
001218 91ef
001219 91ff                      	POP_Z
00121a 0fa0                      	ADD XL,TEMP_L
00121b 1db7                      	ADC XH,C0x00
00121c 6081                      	ORI ACCUM,0x01
00121d 938c                      	ST X,ACCUM
00121e 9503                      	INC TEMP_L
00121f 91af
001220 91bf                      	POP_X
                                 
                                 .ifdef LOGGING_PORT
                                 	.if LOGGING_LEVEL >= LOGGING_LVL_PNC
                                 	.endif
                                 .endif
001221 982b                      	CBI PORTB,MOSI & 0x0f
001222 ef2f                      	LDI TEMP,0xff
001223 940e 1235                 	MCALL _DRV_SD_BYTE_SEND
                                 
001225 2f50                      	MOV LOOP_CNTR,TEMP_L
                                 _DRV_SD__SEND_CMD__LOOP:
001226 912d                      	LD TEMP,X+
001227 940e 1235                 	MCALL _DRV_SD_BYTE_SEND
001229 955a                      	DEC LOOP_CNTR
00122a f7d9                      	BRNE _DRV_SD__SEND_CMD__LOOP
00122b ef2f                      	LDI TEMP,0xff
00122c 940e 1235                 	MCALL _DRV_SD_BYTE_SEND
                                 
00122e 910f                      	POP TEMP_L
00122f 912f                      	POP TEMP
001230 918f                      	POP ACCUM
001231 915f                      	POP LOOP_CNTR
001232 91af
001233 91bf                      	POP_X
001234 9508                      	RET
                                 
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_BYTE_SEND:
                                 ;--------------------------------------------------------
                                 ;Передача байта
                                 ;IN: TEMP-значение
                                 ;--------------------------------------------------------
001235 935f                      	PUSH LOOP_CNTR
001236 932f                      	PUSH TEMP
                                 
001237 e058                      	LDI LOOP_CNTR,0x08
                                 _DRV_SD_BYTE_SEND__LOOP:
001238 ff27                      	SBRS TEMP,0x07
001239 982b                      	CBI PORTB,MOSI & 0x0f
00123a fd27                      	SBRC TEMP,0x07
00123b 9a2b                      	SBI PORTB,MOSI & 0x0f
00123c 0f22                      	LSL TEMP
00123d 940e 126a                 	MCALL _DRV_SD_WAIT
00123f 9a2d                      	SBI PORTB,SCK & 0x0f
001240 940e 126a                 	MCALL _DRV_SD_WAIT
001242 982d                      	CBI PORTB,SCK & 0x0f
001243 955a                      	DEC LOOP_CNTR
001244 f799                      	BRNE _DRV_SD_BYTE_SEND__LOOP
                                 
001245 982d                      	CBI PORTB,SCK & 0x0f
001246 940e 126a                 	MCALL _DRV_SD_WAIT
                                 
                                 	;Низкий уровень приводил к боям в логике некотороых SD после записи блока
001248 9a2b                      	SBI PORTB,MOSI & 0x0f
                                 
001249 912f                      	POP TEMP
00124a 915f                      	POP LOOP_CNTR
00124b 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_BYTE_RECV:
                                 ;--------------------------------------------------------
                                 ;Прием байта
                                 ;OUT: TEMP-значение
                                 ;--------------------------------------------------------
00124c 935f                      	PUSH LOOP_CNTR
                                 
00124d e058                      	LDI LOOP_CNTR,0x08
                                 _DRV_SD_BYTE_RECV__LOOP:
00124e 0f22                      	LSL TEMP
00124f 991c                      	SBIC PINB,MISO & 0x0f
001250 6021                      	ORI TEMP,0x01
001251 9a2d                      	SBI PORTB,SCK & 0x0f
001252 940e 126a                 	MCALL _DRV_SD_WAIT
001254 982d                      	CBI PORTB,SCK & 0x0f
001255 940e 126a                 	MCALL _DRV_SD_WAIT
001257 955a                      	DEC LOOP_CNTR
001258 f7a9                      	BRNE _DRV_SD_BYTE_RECV__LOOP
                                 
001259 915f                      	POP LOOP_CNTR
00125a 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_BYTES_RECV:
                                 ;--------------------------------------------------------
                                 ;Прием данных
                                 ;IN: X-адрес на буффер
                                 ;TEMP-длина данных
                                 ;--------------------------------------------------------
00125b 932f                      	PUSH TEMP
00125c 935f                      	PUSH LOOP_CNTR
00125d 93bf
00125e 93af                      	PUSH_X
                                 
00125f 2f52                      	MOV LOOP_CNTR,TEMP
                                 _DRV_SD_BYTES_RECV__LOOP:
001260 940e 124c                 	MCALL _DRV_SD_BYTE_RECV
001262 932d                      	ST X+,TEMP
001263 955a                      	DEC LOOP_CNTR
001264 f7d9                      	BRNE _DRV_SD_BYTES_RECV__LOOP
                                 
001265 91af
001266 91bf                      	POP_X
001267 915f                      	POP LOOP_CNTR
001268 912f                      	POP TEMP
001269 9508                      	RET
                                 
                                 ;--------------------------------------------------------
                                 _DRV_SD_WAIT:
                                 ;--------------------------------------------------------
                                 ;Выдерживаем паузу
                                 ;--------------------------------------------------------
00126a 9508                      	RET
                                 .endif
                                 	;---
                                 	;Блок задач
                                 	;---
                                 	;Дополнительно (по мере использования)
                                 	.include "./io/port_mode_out.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_MODE_OUT
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 	.include "./io/port_set_hi.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET_HI
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 	.include "./io/port_set_lo.inc"
                                 
                                 ;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 ;05.03.2020	w5277c@gmail.com			Начало
                                 ;01.08.2020	w5277c@gmail.com			Разбиение на файлы
                                 ;03.10.2020	w5277c@gmail.com			Атомарность
                                 ;27.10.2020	w5277c@gmail.com			Обновлена информация об авторских правах
                                 ;05.12.2020	w5277c@gmail.com			-с5
                                 ;18.08.2021	w5277c@gmail.com			Ничего не делаем, если порт не задан(0xff)
                                 ;-----------------------------------------------------------------------------------------------------------------------
                                 .ifdef DEF_PORT_SET_LO
                                 .else
                                 .if REPORT_INCLUDES == 0x01
                                 .endif
                                 .endif
                                 
                                 	;---
                                 
                                 
                                 ;--------------------------------------------------------;Выполняемый код при старте контроллера
                                 MAIN:
                                 
                                 	;Инициализация портов
00126b e182                      	LDI ACCUM,INIT_LED_PORT
00126c 940e 08d2                 	MCALL PORT_MODE_OUT
00126e 940e 08ee                 	MCALL PORT_SET_LO
001270 e385                      	LDI ACCUM,ACT_LED_PORT
001271 940e 08d2                 	MCALL PORT_MODE_OUT
001273 940e 08ee                 	MCALL PORT_SET_LO
                                 
                                 	
                                 	;Инициализация ядра
001275 940e 044f                 	MCALL C5_INIT
                                 
                                 	;Инициализация драйвера
001277 e891                      	LDI PID,PID_SD_DRV
001278 e1f1
001279 e3e2                      	LDI_Z DRV_SD_INIT
00127a e0b3
00127b e1a1                      	LDI_X C5_BUFFER
00127c 940e 055b                 	MCALL C5_CREATE
                                 
                                 	;Инициализация задачи
00127e e090                      	LDI PID,PID_TASK
00127f e1f2
001280 e8e8                      	LDI_Z TASK__INIT
001281 940e 055b                 	MCALL C5_CREATE
                                 
001283 e182                      	LDI ACCUM,INIT_LED_PORT
001284 940e 090b                 	MCALL PORT_SET_HI
                                 
001286 940c 053f                 	MJMP C5_START
                                 
                                 ;--------------------------------------------------------;Задача
                                 TASK__INIT:
001288 940e 05b8                 	MCALL C5_READY
                                 ;--------------------------------------------------------
                                 TASK__INFINITE_LOOP:
00128a e821                      	LDI TEMP,PID_SD_DRV
00128b e061                      	LDI FLAGS,DRV_SD_OP_INIT
00128c 940e 05fd                 	MCALL C5_EXEC
00128e 3080                      	CPI ACCUM,0x00
00128f f4a1                      	BRNE TASK__DONE
                                 
001290 e821                      	LDI TEMP,PID_SD_DRV
001291 e062                      	LDI FLAGS,DRV_SD_OP_GET_OCR
001292 940e 05fd                 	MCALL C5_EXEC
001294 3080                      	CPI ACCUM,0x00
001295 f471                      	BRNE TASK__DONE
001296 e0b3
001297 e1a1                      	LDI_X C5_BUFFER
001298 940e 0a6f                 	MCALL DRV_SD_LOG_OCR
                                 
00129a e821                      	LDI TEMP,PID_SD_DRV
00129b e063                      	LDI FLAGS,DRV_SD_OP_GET_CSD
00129c 940e 05fd                 	MCALL C5_EXEC
00129e 3080                      	CPI ACCUM,0x00
00129f f421                      	BRNE TASK__DONE
0012a0 e0b3
0012a1 e1a1                      	LDI_X C5_BUFFER
0012a2 940e 0a6f                 	MCALL DRV_SD_LOG_OCR
                                 
                                 TASK__DONE:
0012a4 9508                      	RET
                                 
                                 ;	LDI TEMP,0x01														;Пауза в 1 сеунду
                                 ;	MCALL C5_WAIT_1S
                                 ;	RJMP TASK__INFINITE_LOOP


RESOURCE USE INFORMATION
------------------------

Notice:
The register and instruction counts are symbol table hit counts,
and hence implicitly used resources are not counted, eg, the
'lpm' instruction without operands implicitly uses r0 and z,
none of which are counted.

x,y,z are separate entities in the symbol table and are
counted separately from r26..r31 here.

.dseg memory usage only counts static data declared with .byte

"ATmega328P" register use summary:
x  :  53 y  :  81 z  : 145 r0 :  21 r1 :  17 r2 :   4 r3 :   0 r4 :   0 
r5 :   4 r6 :   0 r7 :  53 r8 :   1 r9 :   2 r10:   2 r11:   2 r12:   1 
r13:   9 r14:   7 r15:  11 r16: 282 r17: 221 r18: 685 r19:  44 r20:  37 
r21: 146 r22:  43 r23:  30 r24: 279 r25:  46 r26: 134 r27: 116 r28:  94 
r29:  75 r30: 302 r31: 305 
Registers used: 32 out of 35 (91.4%)

"ATmega328P" instruction use summary:
.lds  :   0 .lds.l:   0 .sts  :   0 .sts.l:   0 adc   :  32 add   :  34 
adiw  :   9 and   :   4 andi  :  54 asr   :   0 bclr  :   0 bld   :   0 
brbc  :   0 brbs  :   0 brcc  :  18 brcs  :  23 break :   0 breq  :  46 
brge  :   0 brhc  :   0 brhs  :   0 brid  :   0 brie  :   0 brlo  :   0 
brlt  :   0 brmi  :   0 brne  : 108 brpl  :   0 brsh  :   0 brtc  :   0 
brts  :   0 brvc  :   0 brvs  :   0 bset  :   0 bst   :   0 call  : 384 
cbi   :  17 cbr   :   0 clc   :   2 clh   :   0 cli   :  20 cln   :   0 
clr   :  35 cls   :   0 clt   :   0 clv   :   0 clz   :   6 com   :   2 
cp    :  20 cpc   :   0 cpi   :  85 cpse  :   0 dec   :  45 des   :   0 
eor   :   6 fmul  :   0 fmuls :   0 fmulsu:   0 icall :   3 ijmp  :   0 
in    :   0 inc   :  14 jmp   :  10 lac   :   0 las   :   0 lat   :   0 
ld    :  35 ldd   : 110 ldi   : 443 lds   :  89 lpm   :  26 lsl   :  33 
lsr   :  20 mov   : 168 movw  :  16 mul   :   1 muls  :   0 mulsu :   0 
neg   :   0 nop   :   8 or    :   9 ori   :  25 out   :   0 pop   : 481 
push  : 505 rcall :   1 ret   : 109 reti  :   3 rjmp  :  73 rol   :  31 
ror   :   1 sbc   :  14 sbci  :   5 sbi   :  20 sbic  :   1 sbis  :   0 
sbiw  :   7 sbr   :   0 sbrc  :  25 sbrs  :  30 sec   :   2 seh   :   0 
sei   :   4 sen   :   0 ser   :   0 ses   :   0 set   :   0 sev   :   0 
sez   :   5 sleep :   1 spm   :   0 st    :  62 std   :  56 sts   :  79 
sub   :  22 subi  :  14 swap  :   8 tst   :   2 wdr   :   1 xch   :   0 

Instructions used: 63 out of 120 (52.5%)

"ATmega328P" memory use summary [bytes]:
Segment   Begin    End      Code   Data   Used    Size   Use%
---------------------------------------------------------------
[.cseg] 0x000000 0x00254a   8148   1398   9546   32768  29.1%
[.dseg] 0x000100 0x000100      0      0      0    2048   0.0%
[.eseg] 0x000000 0x000000      0      0      0    1024   0.0%

Assembly complete, 0 errors, 25 warnings
