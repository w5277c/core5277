;-----------------------------------------------------------------------------------------------------------------------
;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
;-----------------------------------------------------------------------------------------------------------------------
;02.01.2021  w5277c@gmail.com			Начало
;-----------------------------------------------------------------------------------------------------------------------

.include	"./core/ram/ram_realloc.inc"
.include	"./core/ram/ram_offset.inc"
.include	"./str/str_to_ram.inc"
.include	"./str/str_find.inc"
.include	"./conv/num16_to_str.inc"
.include	"./core/uptime_copy.inc"
.include	"./prim/prim_sub.inc"
.include	"./prim/prim_cp.inc"

;---CONSTANTS--------------------------------------------
	;---VARS---
	.EQU	_DRV_ESP8266_BUFFER_SIZE						= 0x80;Размер буфера
	;---OFFSETS---
	.EQU	_DRV_ESP8266_UART_DRV_ID						= 0x00;Идентификатор драйвера UART
	.EQU	_DRV_ESP8266_UPTIME_START						= 0x01;Переменная1 UPTIME (5 байт)
	.EQU	_DRV_ESP8266_UPTIME_CURRENT					= 0x06;Переменная2 UPTIME (5 байт)
	.EQU	_DRV_ESP8266_BUFFER_OFFSET						= 0x0b;Адрес начала буфера в выделенной памяти
	;---OPERATIONS---
	.EQU	DRV_ESP8266_OP_INIT								= 0x00;Инициализация работы
	.EQU	DRV_ESP8266_OP_RAW								= 0x01;Свободный формат данных
	.EQU	DRV_ESP8266_OP_SET_WIFI							= 0x02;Установить параметры Wi-Fi
	.EQU	DRV_ESP8266_OP_TCP_SERVER						= 0x03;Поднять TCP сервер
	.EQU	DRV_ESP8266_OP_TCP_CLIENT						= 0x04;Установить TCP подключение
	.EQU	DRV_ESP8266_OP_WAIT_DATA						= 0x05;Ждать данные
	.EQU	DRV_ESP8266_OP_SEND_DATA						= 0x06;Передать данные
	.EQU	DRV_ESP8266_OP_TCP_CLOSE						= 0x07;Положить TCP соединение
	;---RESULTS---
	.EQU	DRV_ESP8266_RESULT_OK							= 0x00
	.EQU	DRV_ESP8266_RESULT_ERROR						= 0x01
	;---AT-CONSTANTS---
_DRV_ESP8266_AT_ECHO_OFF:					.db "ATE0",0x0d,0x0a,0x00
_DRV_ESP8266_AT_SET_WIFI1:					.db "AT+CWJAP_DEF=",0x22,0x00;+APN+
_DRV_ESP8266_AT_SET_WIFI2:					.db 0x22,",",0x22,0x00;+PASSWORD+
_DRV_ESP8266_AT_SET_WIFI3:					.db 0x22,0x0d,0x0a,0x00
_DRV_ESP8266_AT_SET_MULTIPLE_CONNS:		.db "AT+CIPMUX=1,",0x0d,0x0a,0x00
_DRV_ESP8266_AT_RES_MULTIPLE_CONNS:		.db "AT+CIPMUX=0,",0x0d,0x0a,0x00
_DRV_ESP8266_AT_SET_MAX_CONNS:			.db "AT+CIPSERVERMAXCONN=1,",0x0d,0x0a,0x00
_DRV_ESP8266_AT_SET_SERVER_TIMEOUT:		.db "AT+CIPSTO=5,",0x0d,0x0a,0x00
_DRV_ESP8266_AT_SET_RECV_MODE:			.db "AT+CIPRECVMODE=1,",0x0d,0x0a,0x00
_DRV_ESP8266_AT_CREATE_TCP_SERVER:		.db "AT+CIPSERVER=1,";+IP+END
_DRV_ESP8266_AT_CLOSE_TCP_SERVER:		.db "AT+CIPSERVER=0",0x0d,0x0a,0x00
_DRV_ESP8266_AT_SET_TCP_CLIENT1:			.db "AT+CIPSTART=0,",0x22,"TCP",0x22,",",0x22,0x00;+IP+
_DRV_ESP8266_AT_SET_TCP_CLIENT2:			.db 0x22,",",0x00;+PORT+
_DRV_ESP8266_AT_SET_TCP_CLIENT3:			.db ",5",0x0d,0x0a,0x00
_DRV_ESP8266_AT_CLOSE_TCP:					.db "AT+CIPCLOSE=0",0x0d,0x0a,0x00

_DRV_ESP8266_AT_RECV:						.db "AT+CIPRECVDATA=0,40",0x0d,0x0a,0x00
_DRV_ESP8266_AT_SEND:						.db "AT+CIPSEND=0,",0x00;+XXX+END
_DRV_ESP8266_AT_END:							.db 0x0d,0x0a,0x00

_DRV_ESP8266_AT_RESP_OK:					.db 0x0d,0x0a,"OK",0x0d,0x0a,0x00
;_DRV_ESP8266_AT_WIFI_CONNECTED:			.db 0x0d,0x0a,"WIFI CONNECTED",0x0d,0x0a,0x00

_DRV_ESP8266_WIFI_CONNECT_TIMEOUT:		.db 0x00,0x00,0x00,0x1d,0x4c	;UPTIME VAR = 15 сек.
	;---
	.EQU	_DRV_ESP8266_VARS_SIZE							= 0x0b

;--------------------------------------------------------
DRV_ESP8266_INIT:
;--------------------------------------------------------
;Инициализация
;IN: TEMP - ид драйвера UART
;--------------------------------------------------------
	PUSH ACCUM

	LDI ACCUM,_DRV_ESP8266_VARS_SIZE+_DRV_ESP8266_BUFFER_SIZE
	MCALL C5_RAM_REALLOC

	STD Z+_DRV_ESP8266_UART_DRV_ID,TEMP

	POP ACCUM
	MCALL C5_READY

;--------------------------------------------------------
;Основной код, коммуникация
;--------------------------------------------------------
;IN: ACCUM - тип операции
;--------------------------------------------------------
	PUSH_Z
	PUSH TEMP

	MCALL C5_RAM_OFFSET

	CPI ACCUM,DRV_ESP8266_OP_INIT
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_INIT
	RJMP _DRV_ESP8266_PROC_END
	CPI ACCUM,DRV_ESP8266_OP_RAW
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_RAW
	RJMP _DRV_ESP8266_PROC_END
	CPI ACCUM,DRV_ESP8266_OP_SET_WIFI
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_SET_WIFI
	RJMP _DRV_ESP8266_PROC_END
	CPI ACCUM,DRV_ESP8266_OP_TCP_SERVER
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_TCP_SERVER
	RJMP _DRV_ESP8266_PROC_END
	CPI ACCUM,DRV_ESP8266_OP_WAIT_DATA
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_WAIT_DATA
	RJMP _DRV_ESP8266_PROC_END
	CPI ACCUM,DRV_ESP8266_OP_SEND_DATA
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_SEND_DATA
	RJMP _DRV_ESP8266_PROC_END
	CPI ACCUM,DRV_ESP8266_OP_TCP_CLOSE
	BRNE PC+0x04
	MCALL _DRV_ESP8266__OP_TCP_CLOSE
	RJMP _DRV_ESP8266_PROC_END
_DRV_ESP8266_PROC_END:
	POP TEMP
	POP_Z
	RET

;--------------------------------------------------------
_DRV_ESP8266__OP_RAW:
;--------------------------------------------------------
;Выполнение AT команды
;IN: X-адрес на буфер, содержащий команду,
;он же для ответа, TEMP_H-длина команды
;Z-адрес на выделенную память
;OUT:TEMP_H-результат, TEMP_L-длина
;--------------------------------------------------------
	PUSH TRY_CNTR
	PUSH TEMP_EH
	PUSH TEMP_EL
	PUSH TEMP
	PUSH_Y

	LDI TRY_CNTR,0x03
_DRV_ESP8266__OP_RAW__LOOP:
	MOV TEMP_EH,TEMP_H
	LDI TEMP_EL,(_DRV_ESP8266_BUFFER_SIZE-0x01)
	LDI TEMP_H,high(1000/2)
	LDI TEMP_L,low(1000/2)
	MOV YH,XH
	MOV YL,XL
	LDD TEMP,Z+_DRV_ESP8266_UART_DRV_ID
	MCALL C5_EXEC
	CPI TEMP_H,DRV_UART_ST_READY
	BRNE _DRV_ESP8266__OP_RAW__ERROR
	CPI TEMP_L,0x00
	BREQ _DRV_ESP8266__OP_RAW__ERROR
	LDI TEMP_H,DRV_ESP8266_RESULT_OK
	RJMP _DRV_ESP8266__OP_RAW__END
_DRV_ESP8266__OP_RAW__ERROR:
	LDI TEMP,(100/2)
	MCALL C5_WAIT_2MS
	DEC TRY_CNTR
	BRNE _DRV_ESP8266__OP_RAW__LOOP
	LDI TEMP_H,DRV_ESP8266_RESULT_ERROR
_DRV_ESP8266__OP_RAW__END:

	POP_Y
	POP TEMP
	POP TEMP_EL
	POP TEMP_EH
	POP TRY_CNTR
	RET

;--------------------------------------------------------
_DRV_ESP8266_CHECK_RESP_OK:
;--------------------------------------------------------
;Проверяем на ответ содержащий 'OK'
;IN: X-адрес на буфер содержащий ответ.
;TEMP_H-код результата выполнения команды
;TEMP_L-длина данных
;OUT:TEMP_H-результат
;--------------------------------------------------------
	PUSH_Y
	PUSH TEMP

	CPI TEMP_H,DRV_ESP8266_RESULT_OK
	BRNE __DRV_ESP8266_CHECK_RESP_OK__FAIL
	PUSH_X
	ADD XL,TEMP_L
	LDI TEMP,0x00
	ADC XH,TEMP
	ST X,TEMP
	POP_X
	LDI YH,high(_DRV_ESP8266_AT_RESP_OK)|0x80
	LDI YL,low(_DRV_ESP8266_AT_RESP_OK)
	MCALL STR_FIND
	CPI TEMP,0xff
	BREQ __DRV_ESP8266_CHECK_RESP_OK__FAIL
	LDI TEMP_H,DRV_ESP8266_RESULT_OK
	RJMP __DRV_ESP8266_CHECK_RESP_OK__END
__DRV_ESP8266_CHECK_RESP_OK__FAIL:

	LDI TEMP_H,DRV_ESP8266_RESULT_ERROR
__DRV_ESP8266_CHECK_RESP_OK__END:
	POP TEMP
	POP_Y
	RET

;--------------------------------------------------------
_DRV_ESP8266__OP_INIT:
;--------------------------------------------------------
;Инициализация ESP8266
;OUT:TEMP_H - RESULT
;--------------------------------------------------------
	PUSH_X
	PUSH_Y
	PUSH TEMP_EH
	PUSH TEMP_EL
	PUSH TEMP_L

	;ECHO OFF
	LDI XH,0x00
	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
	ADD XL,ZL
	ADC XH,ZH
	PUSH_X
	LDI_Y _DRV_ESP8266_AT_ECHO_OFF|0x8000
	MCALL STR_TO_RAM
	MOV TEMP_H,XL
	SUB TEMP_H,ZL
	SUBI TEMP_H,_DRV_ESP8266_BUFFER_OFFSET
	POP_X
	MCALL _DRV_ESP8266__OP_RAW
	MCALL _DRV_ESP8266_CHECK_RESP_OK

	CPI TEMP_H,DRV_ESP8266_RESULT_OK
	BREQ PC+0x02
	RJMP __DRV_ESP8266__OP_INIT__END

	;SET MULTIPLE CONNECTIONS
	LDI XH,0x00
	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
	ADD XL,ZL
	ADC XH,ZH
	PUSH_X
	LDI_Y _DRV_ESP8266_AT_SET_MULTIPLE_CONNS|0x8000
	MCALL STR_TO_RAM
	MOV TEMP_H,XL
	SUB TEMP_H,ZL
	SUBI TEMP_H,_DRV_ESP8266_BUFFER_OFFSET
	POP_X
	MCALL _DRV_ESP8266__OP_RAW
	MCALL _DRV_ESP8266_CHECK_RESP_OK
	CPI TEMP_H,DRV_ESP8266_RESULT_OK
	BRNE __DRV_ESP8266__OP_INIT__END

	;SET MAX CONNECTIONS
	LDI XH,0x00
	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
	ADD XL,ZL
	ADC XH,ZH
	PUSH_X
	LDI_Y _DRV_ESP8266_AT_SET_MAX_CONNS|0x8000
	MCALL STR_TO_RAM
	MOV TEMP_H,XL
	SUB TEMP_H,ZL
	SUBI TEMP_H,_DRV_ESP8266_BUFFER_OFFSET
	POP_X
	MCALL _DRV_ESP8266__OP_RAW
	MCALL _DRV_ESP8266_CHECK_RESP_OK
	CPI TEMP_H,DRV_ESP8266_RESULT_OK
	BRNE __DRV_ESP8266__OP_INIT__END

	;SET SERVER TIMEOUT
	LDI XH,0x00
	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
	ADD XL,ZL
	ADC XH,ZH
	PUSH_X
	LDI_Y _DRV_ESP8266_AT_SET_SERVER_TIMEOUT|0x8000
	MCALL STR_TO_RAM
	MOV TEMP_H,XL
	SUB TEMP_H,ZL
	SUBI TEMP_H,_DRV_ESP8266_BUFFER_OFFSET
	POP_X
	MCALL _DRV_ESP8266__OP_RAW
	MCALL _DRV_ESP8266_CHECK_RESP_OK
	CPI TEMP_H,DRV_ESP8266_RESULT_OK
	BRNE __DRV_ESP8266__OP_INIT__END

	;SET RECIEVE MODE
	LDI XH,0x00
	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
	ADD XL,ZL
	ADC XH,ZH
	PUSH_X
	LDI_Y _DRV_ESP8266_AT_SET_RECV_MODE|0x8000
	MCALL STR_TO_RAM
	MOV TEMP_H,XL
	SUB TEMP_H,ZL
	SUBI TEMP_H,_DRV_ESP8266_BUFFER_OFFSET
	POP_X
	MCALL _DRV_ESP8266__OP_RAW
	MCALL _DRV_ESP8266_CHECK_RESP_OK
;	CPI TEMP_H,DRV_ESP8266_RESULT_OK
;	BRNE __DRV_ESP8266__OP_INIT__END

__DRV_ESP8266__OP_INIT__END:
	POP TEMP_L
	POP TEMP_EL
	POP TEMP_EH
	POP_Y
	POP_X
	RET


;--------------------------------------------------------
_DRV_ESP8266__OP_SET_WIFI:
;--------------------------------------------------------
;Задаем подключение к WI-FI точке доступа
;IN; Z-адрес выделенной памяти
;OUT:TEMP_H - RESULT
;--------------------------------------------------------
	PUSH_X
	PUSH_Y
	PUSH TEMP_EH
	PUSH TEMP_EL
	PUSH TEMP_H
	PUSH TEMP_L
	PUSH TRY_CNTR

	LDI XH,0x00
	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
	ADD XL,ZL
	ADC XH,ZH
	PUSH_X
	LDI YH,high(_DRV_ESP8266_AT_SET_WIFI1)|0x80
	LDI YL,low(_DRV_ESP8266_AT_SET_WIFI1)
	MCALL STR_TO_RAM
	LDI_Y C5_BUFFER+SETTINGS_OFFSET+SET_ESP_WIFI_AP
	MCALL STR_TO_RAM
	LDI_Y _DRV_ESP8266_AT_SET_WIFI2|0x8000
	MCALL STR_TO_RAM
	LDI_Y C5_BUFFER+SETTINGS_OFFSET+SET_ESP_WIFI_PASSWORD
	MCALL STR_TO_RAM
	LDI_Y _DRV_ESP8266_AT_SET_WIFI3|0x8000
	MCALL STR_TO_RAM
	MOV TEMP_EH,XL
	SUB TEMP_EH,ZL
	SUBI TEMP_EH,_DRV_ESP8266_BUFFER_OFFSET
	POP_X
	LDI TEMP_EL,(_DRV_ESP8266_BUFFER_SIZE-0x01)
	LDI TEMP_H,high(1000/2)
	LDI TEMP_L,low(1000/2)
	MOV YH,XH
	MOV YL,XL
	LDD TEMP,Z+_DRV_ESP8266_UART_DRV_ID
	MCALL C5_EXEC
	;Если ответ не получен - выходим с ошибкой
	CPI TEMP_H,DRV_UART_ST_READY
	BRNE __DRV_ESP8266__OP_SET_WIFI__FAIL
	CPI TEMP_L,0x00
	BREQ __DRV_ESP8266__OP_SET_WIFI__FAIL

	;Считываем сообщения ожидая "OK" в течении 15 секунд
	LDI_Y _DRV_ESP8266_UPTIME_START
	MCALL C5_UPTIME_COPY
	RJMP __DRV_ESP8266__OP_SET_WIFI__FIRST_READ_SKIP
__DRV_ESP8266__OP_SET_WIFI__READ_LOOP:
	;Только читаем
	LDI TEMP_EH,0x00
	LDI TEMP_EL,(_DRV_ESP8266_BUFFER_SIZE-0x01)
	LDI TEMP_H,high(1000/2)
	LDI TEMP_L,low(1000/2)
	LDD TEMP,Z+_DRV_ESP8266_UART_DRV_ID
	MCALL C5_EXEC
	CPI TEMP_H,DRV_UART_ST_READY
	BRNE __DRV_ESP8266__OP_SET_WIFI__FAIL
	CPI TEMP_L,0x00
	BREQ __DRV_ESP8266__OP_SET_WIFI__FAIL

__DRV_ESP8266__OP_SET_WIFI__FIRST_READ_SKIP:
	PUSH_X
	ADD XL,TEMP_L
	LDI TEMP,0x00
	ADC XH,TEMP
	ST X,TEMP
	POP_X
	LDI_Y _DRV_ESP8266_AT_RESP_OK|0x8000
	MCALL STR_FIND
	CPI TEMP,0xff
	BRNE __DRV_ESP8266__OP_SET_WIFI__SUCCESS

	LDI_Y _DRV_ESP8266_UPTIME_CURRENT
	MCALL C5_UPTIME_COPY
	LDI_X _DRV_ESP8266_UPTIME_START
	PRIM_SUB UPTIME
	MOV XH,YH
	MOV XL,YL
	LDI_Y _DRV_ESP8266_WIFI_CONNECT_TIMEOUT|0x8000
	PRIM_CP UPTIME
	BRCS __DRV_ESP8266__OP_SET_WIFI__READ_LOOP
	RJMP __DRV_ESP8266__OP_SET_WIFI__FAIL
__DRV_ESP8266__OP_SET_WIFI__SUCCESS:
	LDI TEMP_H,DRV_ESP8266_RESULT_OK
	RJMP __DRV_ESP8266__OP_SET_WIFI__END
__DRV_ESP8266__OP_SET_WIFI__FAIL:
	LDI TEMP_H,DRV_ESP8266_RESULT_ERROR
__DRV_ESP8266__OP_SET_WIFI__END:

	POP TRY_CNTR
	POP TEMP_L
	POP TEMP_H
	POP TEMP_EL
	POP TEMP_EH
	POP_Y
	POP_X
	RET







;--------------------------------------------------------
_DRV_ESP8266__OP_TCP_SERVER:
;--------------------------------------------------------
;Активируем TCP сервер
;IN; Y-адрес на строку с IP адресом, TEMP_H/L - TCP порт
;OUT:TEMP_H - RESULT
;--------------------------------------------------------
	PUSH_X
	PUSH TEMP_EH
	PUSH TEMP_EL
	PUSH TEMP_L

;	LDI XH,0x00
;	LDI XL,_DRV_ESP8266_BUFFER_OFFSET
;	ADD XL,ZL
;	ADC XH,ZH
;	PUSH_X
;	PUSH_Y
;	LDI YH,high(_DRV_ESP8266_AT_SET_TCP_SERVER1)|0x80
;	LDI YL,low(_DRV_ESP8266_AT_SET_TCP_SERVER1)
;	MCALL STR_TO_RAM
;	POP_Y
;	MCALL STR_TO_RAM
;	LDI YH,high(_DRV_ESP8266_AT_SET_TCP_SERVER2)|0x80
;	LDI YL,low(_DRV_ESP8266_AT_SET_TCP_SERVER2)
;	MCALL STR_TO_RAM
;	PUSH_Z
;	MOV ZH,XH
;	MOV ZL,XL
;	MCALL NUM16_TO_STR
;	MOV XH,ZH
;	MOV XL,ZL
;	POP_Z

;TODO ...
	POP TEMP_L
	POP TEMP_EL
	POP TEMP_EH
	POP_Y
	POP_X
	RET




_DRV_ESP8266__OP_WAIT_DATA:
_DRV_ESP8266__OP_SEND_DATA:
_DRV_ESP8266__OP_TCP_CLOSE:
	RET
