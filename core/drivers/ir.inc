;-----------------------------------------------------------------------------------------------------------------------
;Файл распространяется под лицензией GPL-3.0-or-later, https://www.gnu.org/licenses/gpl-3.0.txt
;-----------------------------------------------------------------------------------------------------------------------
;10.06.2021	w5277c@gmail.com			Начало
;-----------------------------------------------------------------------------------------------------------------------
;Драйвер инфракрасного приемника и передачтика
;-----------------------------------------------------------------------------------------------------------------------
.ifdef DEF__C5_DRV_IR
.else
.set DEF__C5_DRV_IR = 1
.message "Included driver IR v0.1"

.include	"./core/ram/ram_offset.inc"
.include	"./core/ram/ram_realloc.inc"

;---CONSTANTS--------------------------------------------
	;---VARS---
	.EQU	_DRV_IR_RX_PORT						= 0x00			;1B - Порт для приема данных
	.EQU	_DRV_IR_TX_PORT						= 0x01			;1B - Порт для передачи данных
	.EQU	_DRV_IR_LED_PORT						= 0x02			;1B - Порт индикации
	.EQU	_DRV_IR_TIMER_ID						= 0x03			;1B - ИД программного таймера
	.EQU	_DRV_IR_INT_ID							= 0x04			;1B - ИД прерывания C5_IR_INTn
	.EQU	_DRV_IR_STATE							= 0x05			;1B - Состояние драйвера
	;---
	.EQU	_DRV_IR_SRC_ADDR						= 0x06			;2B - Адрес блока данных для передачи
	.EQU	_DRV_IR_DST_ADDR						= 0x08			;2B - Адрес блока данных для приема
	;---
	.EQU	_DRV_IR_POS								= 0x0a			;1B - Позиция в буфере
	.EQU	_DRV_IR_BITNUM							= 0x0b			;1B - Номер бита для примема/передачи
	.EQU	_DRV_IR_ACCUM							= 0x0c			;1B - Аккумулятор
	;---
	.EQU	_DRV_IR_RAM_SIZE						= 0x0d			;13B - необходимо выделить

;--------------------------------------------------------
DRV_IR_INIT:
;--------------------------------------------------------
;Инициализация
;IN: TEMP_H-порт RX, TEMP_L-порт TX
;TEMP_EH-ид прерывания C5_IR_INTn
;TEMP_EL-порт индикации передачи (0xff-не используется)
;ACCUM-ид таймера
;--------------------------------------------------------
	PUSH_Z
	PUSH ACCUM
	PUSH YH
	PUSH TEMP

	PUSH ACCUM
	LDI ACCUM,_DRV_IR_RAM_SIZE
	MCALL C5_RAM_REALLOC
	POP ACCUM

	;Записываю ID таймера
	STD Z+_DRV_IR_TIMER_ID,ACCUM

	;Записываю ID прерывания
	STD Z+_DRV_IR_INT_ID,TEMP_H
;	;Устанавливаю состояние READY
;	LDI ACCUM,DRV_UART_ST_READY
;	STD Z+_DRV_IR_STATE,ACCUM

	;TODO


.endif