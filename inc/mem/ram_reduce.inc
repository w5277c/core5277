;-----------------------------------------------------------------------------------------------------------------------
;Владельцем данного исходного кода является Удовиченко Константин Александрович, емайл:w5277c@gmail.com, по всем
;правовым вопросам обращайтесь на email.
;-----------------------------------------------------------------------------------------------------------------------
;28.05.2020  w5277c@gmail.com        Начало
;01.08.2020  w5277c@gmail.com        Разбиение на файлы
;-----------------------------------------------------------------------------------------------------------------------
.ifdef DEF_CORE5277_RAM_REDUCE
.else
.set DEF_CORE5277_RAM_REDUCE = 1

.include	"./inc/mem/ram_realloc.inc"

;--------------------------------------------------------
CORE5277_RAM_REDUCE:
;--------------------------------------------------------
;Освобождаем часть памяти
;IN: TEMP - PID, ACCUM - размер, на который нужно
;освободить
;OUT: Z - адрес на выделенную часть, TEMP - общий объем
;flag Z(false - error,owerflow)
;--------------------------------------------------------
	PUSH_X
	PUSH_Y
	PUSH ACCUM
	PUSH TEMP
	MCALL CORE5277_DISPATCHER_LOCK

	;Получаем заголовок
	MCALL _CORE5277_PROC_HEADER_GET
	;Получаем размер уже выделенной памяти
	LDD TEMP,Z+_CORE5277_PROC_RAM_SIZE
	SUB TEMP,ACCUM
	BRCS _CORE5277_RAM_REDUCE__ERROR
	RJMP _CORE5277_RAM_REALLOC__EP2
_CORE5277_RAM_REDUCE__ERROR:
	CLZ
	MOV ZH,YH
	MOV ZL,YL
	MCALL CORE5277_DISPATCHER_UNLOCK
	POP TEMP
	POP ACCUM
	POP_Y
	POP_X
	RET
.endif
